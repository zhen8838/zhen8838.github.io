<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Zheng&#39;s Notes</title>
<link>https://zhen8838.github.io/</link>
<atom:link href="https://zhen8838.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog built with Quarto</description>
<generator>quarto-1.8.27</generator>
<lastBuildDate>Sun, 08 Feb 2026 10:49:45 GMT</lastBuildDate>
<item>
  <title>Axe: A Simple Unified Layout Abstraction for Machine Learning Compilers</title>
  <link>https://zhen8838.github.io/posts/Axe-0.html</link>
  <description><![CDATA[ 




<p>这篇论文是陈天奇团队的成果，提出一个统一的硬件感知抽象（Axe Layout），将逻辑张量坐标映射到多维物理空间，并设计基于此的多粒度、分布式感知的编译器DSL。今天就来解析一下Axe Layout的设计思路和实现细节。</p>
<section id="核心公式" class="level2">
<h2 class="anchored" data-anchor-id="核心公式">核心公式</h2>
<p>Axe Layout将逻辑张量索引映射到物理坐标集合：</p>
<p><img src="https://latex.codecogs.com/png.latex?L(x)%20=%20%5C%7B%20D(x)%20+%20r%20+%20O%20%5Cmid%20r%20%5Cin%20R%20%5C%7D"></p>
<p>其中：</p>
<section id="d-shard---分片映射" class="level3">
<h3 class="anchored" data-anchor-id="d-shard---分片映射">D (Shard) - 分片映射</h3>
<ul>
<li>是一个<strong>有序的iter列表</strong></li>
<li>每个iter = (extent, stride, <span class="citation" data-cites="axis">@axis</span>)</li>
<li><strong>extent</strong>: 硬件维度的逻辑大小</li>
<li><strong>stride</strong>: 相邻逻辑元素在硬件维度上的距离</li>
<li><strong><span class="citation" data-cites="axis">@axis</span></strong>: 物理轴的标签（device, warp, lane等）</li>
<li>作用：将<strong>逻辑索引</strong>转换为<strong>物理坐标</strong></li>
</ul>
</section>
<section id="r-replica---复制维度" class="level3">
<h3 class="anchored" data-anchor-id="r-replica---复制维度">R (Replica) - 复制维度</h3>
<ul>
<li>是一个<strong>集合</strong>（无序），独立于逻辑索引</li>
<li>格式：{axis_name: replica_count, …}</li>
<li>作用：为<strong>并行执行</strong>添加额外维度</li>
<li>例如：4个线程独立执行相同的计算</li>
</ul>
</section>
<section id="o-offset---偏移" class="level3">
<h3 class="anchored" data-anchor-id="o-offset---偏移">O (Offset) - 偏移</h3>
<ul>
<li>固定的<strong>基地址</strong>或<strong>资源保留</strong></li>
<li>格式：{axis_name: offset_value, …}</li>
<li>例如：数据在内存中的起始位置、执行器件偏移</li>
</ul>
<div id="aa038435" class="cell" data-execution_count="86">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itertools</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pycute <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> cute</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Tuple, Dict</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb1-6"></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb1-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Iter:</span>
<span id="cb1-10">  extent: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb1-11">  stride: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb1-12">  axis: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>extent<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb1-16"></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb1-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AxeLayout:</span>
<span id="cb1-20">  D: List[Iter]</span>
<span id="cb1-21">  R: List[Iter]</span>
<span id="cb1-22">  O: Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]</span>
<span id="cb1-23"></span>
<span id="cb1-24">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-25">    d_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" × "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D))</span>
<span id="cb1-26">    r_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" × "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"∅"</span></span>
<span id="cb1-27">    o_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join([<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>v<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O.items()]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"∅"</span></span>
<span id="cb1-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"D: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>d_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | R: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>r_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | O: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-29"></span>
<span id="cb1-30">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>):</span>
<span id="cb1-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> name:</span>
<span id="cb1-32">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb1-33"></span>
<span id="cb1-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D:</span>
<span id="cb1-35">      d_extent_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( )"</span></span>
<span id="cb1-36">      d_stride_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( )"</span></span>
<span id="cb1-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-38">      col_widths <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-39">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D:</span>
<span id="cb1-40">        extent_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(iter_obj.extent)</span>
<span id="cb1-41">        stride_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-42">        col_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(extent_str), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stride_str))</span>
<span id="cb1-43">        col_widths.append(col_width)</span>
<span id="cb1-44"></span>
<span id="cb1-45">      extent_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-46">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D):</span>
<span id="cb1-47">        extent_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(iter_obj.extent)</span>
<span id="cb1-48">        padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extent_str.center(col_widths[i])</span>
<span id="cb1-49">        extent_parts.append(padded)</span>
<span id="cb1-50">      d_extent_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>.join(extent_parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" )"</span></span>
<span id="cb1-51"></span>
<span id="cb1-52">      stride_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-53">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D):</span>
<span id="cb1-54">        stride_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-55">        padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride_str.rjust(col_widths[i])</span>
<span id="cb1-56">        stride_parts.append(padded)</span>
<span id="cb1-57">      d_stride_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join(stride_parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" )"</span></span>
<span id="cb1-58"></span>
<span id="cb1-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R:</span>
<span id="cb1-60">      r_col_widths <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-61">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R:</span>
<span id="cb1-62">        extent_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(iter_obj.extent)</span>
<span id="cb1-63">        stride_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-64">        col_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(extent_str), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stride_str))</span>
<span id="cb1-65">        r_col_widths.append(col_width)</span>
<span id="cb1-66"></span>
<span id="cb1-67">      r_extent_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-68">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R):</span>
<span id="cb1-69">        extent_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(iter_obj.extent)</span>
<span id="cb1-70">        padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extent_str.center(r_col_widths[i])</span>
<span id="cb1-71">        r_extent_parts.append(padded)</span>
<span id="cb1-72">      r_extent_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>.join(r_extent_parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" )"</span></span>
<span id="cb1-73"></span>
<span id="cb1-74">      r_stride_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-75">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, iter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R):</span>
<span id="cb1-76">        stride_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>iter_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-77">        padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride_str.rjust(r_col_widths[i])</span>
<span id="cb1-78">        r_stride_parts.append(padded)</span>
<span id="cb1-79">      r_stride_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"( "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join(r_stride_parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" )"</span></span>
<span id="cb1-80"></span>
<span id="cb1-81">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d_extent_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"   "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r_extent_line)</span>
<span id="cb1-82">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d_stride_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" + "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r_stride_line, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb1-83">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-84">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d_extent_line)</span>
<span id="cb1-85">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d_stride_line, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb1-86"></span>
<span id="cb1-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O:</span>
<span id="cb1-88">      o_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>offset<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">@</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>axis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> axis, offset <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O.items()]</span>
<span id="cb1-89">      o_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" + "</span>.join(o_items)</span>
<span id="cb1-90">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" + "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> o_str, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb1-91"></span>
<span id="cb1-92">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<section id="nvidia-tensor-core-tile" class="level3">
<h3 class="anchored" data-anchor-id="nvidia-tensor-core-tile">NVIDIA Tensor Core tile</h3>
<p>有了基础的定义后， 我们可以尝试实现论文中的第一个例子， 映射逻辑 <img src="https://latex.codecogs.com/png.latex?8%C3%9716"> tile到GPU的2个warp（各32 lane）+ 2个寄存器：</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D8%20&amp;%202%20&amp;%204%20&amp;%202%20%5C%5C%204@%5Ctexttt%7Blane%7D%20&amp;%201@%5Ctexttt%7Bwarp%7D%20&amp;%201@%5Ctexttt%7Blane%7D%20&amp;%201@%5Ctexttt%7Breg%7D%5Cend%7Bpmatrix%7D%20+%20%5Cbegin%7Bbmatrix%7D2%20%5C%5C%204@%5Ctexttt%7Bwarp%7D%5Cend%7Bbmatrix%7D%20+%205@%5Ctexttt%7Bwarp%7D"></p>
<p><img src="https://zhen8838.github.io/posts/axe-0/example_1.png" class="img-fluid"></p>
<div id="e6c398a2" class="cell" data-execution_count="88">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">layout_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AxeLayout(D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb2-2">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lane"</span>),</span>
<span id="cb2-3">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"warp"</span>),</span>
<span id="cb2-4">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lane"</span>),</span>
<span id="cb2-5">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reg"</span>),</span>
<span id="cb2-6">],</span>
<span id="cb2-7">    R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"warp"</span>)],</span>
<span id="cb2-8">    O<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"warp"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>})</span>
<span id="cb2-9"></span>
<span id="cb2-10">layout_a.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"layout_a"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
layout_a:
(   8       2       4       2   )   (   2    )
( 4@lane, 1@warp, 1@lane, 1@reg ) + ( 4@warp ) + 5@warp</code></pre>
</div>
</div>
</section>
<section id="distributed-sharding-on-a-22-gpu-mesh" class="level3">
<h3 class="anchored" data-anchor-id="distributed-sharding-on-a-22-gpu-mesh">Distributed sharding on a 2×2 GPU mesh</h3>
<p>假设一个<img src="https://latex.codecogs.com/png.latex?64%C3%97128">张量在4个GPU上的分片+复制混合：</p>
<p><img src="https://zhen8838.github.io/posts/axe-0/example_2.png" class="img-fluid"></p>
<p><strong>完全切分</strong>（行按GPU行，列按GPU列分）： <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D2%20&amp;%2032%20&amp;%202%20&amp;%2064%20%5C%5C%201@%5Ctexttt%7Bgpuid%7D%20&amp;%20128@%5Ctexttt%7Bm%7D%20&amp;%202@%5Ctexttt%7Bgpuid%7D%20&amp;%201@%5Ctexttt%7Bm%7D%5Cend%7Bpmatrix%7D"></p>
<p>这里的<code>gpuid</code>表示设备维度，这里的<code>m</code>表示内存维度，如果把内存维度的Iter单独抽取出来，就可以计算在每个设备中Local Tensor的Layout。把gpuid的Iter出来，可以用stride来隐式体现gpu mesh的分布方式。</p>
<p><strong>行切分+列复制</strong>（行切分，每行shard复制到行内两GPU）： <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D2%20&amp;%2032%20&amp;%20128%20%5C%5C%201@%5Ctexttt%7Bgpuid%7D%20&amp;%20128@%5Ctexttt%7Bm%7D%20&amp;%201@%5Ctexttt%7Bm%7D%5Cend%7Bpmatrix%7D%20+%20%5Cbegin%7Bbmatrix%7D2%20%5C%5C%202@%5Ctexttt%7Bgpuid%7D%5Cend%7Bbmatrix%7D"></p>
<p>实际上这两个就是经典的分布式张量切分方式，对应到SBP里面分别为：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20(split(0),%20split(1))%20%5C%5C%0A%20%20%20%20(split(0),%20broadcast)%0A%5Cend%7Baligned%7D%0A"></p>
<div id="4cfd8d99" class="cell" data-execution_count="89">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">layout_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AxeLayout(D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb4-2">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpuid"</span>),</span>
<span id="cb4-3">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>),</span>
<span id="cb4-4">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpuid"</span>),</span>
<span id="cb4-5">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>)],</span>
<span id="cb4-6">    R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[],</span>
<span id="cb4-7">    O<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})</span>
<span id="cb4-8">layout_b.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"layout_b"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
layout_b:
(    2       32      2      64 )
( 1@gpuid, 128@m, 2@gpuid, 1@m )</code></pre>
</div>
</div>
</section>
<section id="native-multidimensional-memory-in-accelerators" class="level3">
<h3 class="anchored" data-anchor-id="native-multidimensional-memory-in-accelerators">Native multidimensional memory in Accelerators</h3>
<p><img src="https://zhen8838.github.io/posts/axe-0/example_3.png" class="img-fluid"></p>
<p>这里是对于物理内存硬件的映射，认为P是<code>memory bank partitions</code>, F为<code>free dimensions</code>。主要体现的是Axe Layout是同时支持并行硬件维度和存储硬件的表达，所以当不考虑并行维度时，可以完成传统layout的功能。</p>
<div id="24739207" class="cell" data-execution_count="90">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">layout_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AxeLayout(D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb6-2">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>),</span>
<span id="cb6-3">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span>),</span>
<span id="cb6-4">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)],</span>
<span id="cb6-5">    R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[],</span>
<span id="cb6-6">    O<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})</span>
<span id="cb6-7"></span>
<span id="cb6-8">layout_d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AxeLayout(D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb6-9">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Col"</span>),</span>
<span id="cb6-10">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lane"</span>),</span>
<span id="cb6-11">    Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Col"</span>)],</span>
<span id="cb6-12">    R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[],</span>
<span id="cb6-13">    O<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})</span>
<span id="cb6-14"></span>
<span id="cb6-15">layout_c.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"layout_c"</span>)</span>
<span id="cb6-16">layout_d.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"layout_d"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
layout_c:
(   2    128  512 )
( 512@F, 1@P, 1@F )

layout_d:
(    2      128     112  )
( 112@Col, 1@Lane, 1@Col )</code></pre>
</div>
</div>
</section>
</section>
<section id="forward-mapping" class="level1">
<h1>Forward Mapping</h1>
<p>AxeLayout实际上是定义了logical index与hardware index的relation，基于此所实现的 logical index -&gt; parallel index的映射称为forward mapping。</p>
<p>我这里拿第一个例子，具体计算前向过程。首先<code>shard</code>部分负责分解原始的logical index，而他的stride是应用于hardware axes的。而后<code>replica</code>则会扩展映射集合，和<code>offset</code>部分一起将偏移作用到hardware axes上。</p>
<pre><code>logical coord: (i=2, j=9)
          ▼
shape: (8, 16)
          ▼
linear index: 2 * 16 + 9 = 41
          ▼
decomposed index as:
    &gt; 41 ÷ 16 = 2
    &gt; (41 % 16) ÷ 8 = 1
    &gt; ((41 % 16) % 8) // 2 = 0
    &gt; ((41 % 16) % 8) % 2 = 1
          ▼
shard coord:
    (  2   ,   1   ,   0   ,   1   )
          ▼
    (  8       2       4       2   )             (  2   )  
D = (4@lane, 1@warp, 1@lane, 1@reg)     +    R = (4@warp)    +    O = (5@warp)
          ▼
    &gt; lane = 2*4 + 0*1 = 8                &gt; warp0 = 0*4 = 0       &gt;  warp = 5
    &gt; warp = 1*1 = 1                      &gt; warp1 = 1*4 = 4     
    &gt; reg = 1*1 = 1                              
          ▼
  {lane: 8, warp: 1, reg: 1}            +  [{warp: 0}, {warp: 4}]  +   {warp: 5}
          ▼
offset = [
    {warp: 1+0+5 = 6 , lane: 8, reg: 1},
    {warp: 1+4+5 = 10, lane: 8, reg: 1}
]</code></pre>
<p>上述流程也许有些抽象，我们可以通过代码来更直观地理解Axe Layout的前向计算过程。 这里我复用了cute中的一些函数来辅助计算映射过程：</p>
<div id="806b53d5" class="cell" data-execution_count="91">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"></span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>: AxeLayout, coord: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, ...], shape: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, ...]):</span>
<span id="cb9-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. map layout to AxeLayout's shard</span></span>
<span id="cb9-4">  shard_extents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(i.extent <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D)</span>
<span id="cb9-5">  org_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.crd2idx(coord, shape, cute.suffix_product(shape))</span>
<span id="cb9-6">  shard_crd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(org_idx, shard_extents[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reverse for correct order</span></span>
<span id="cb9-7">  shards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> it.stride, it.axis) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (idx, it) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(shard_crd, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D)]</span>
<span id="cb9-8">  rep_set <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb9-9">  replica <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.R) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> [Iter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)]</span>
<span id="cb9-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> reps <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.product([(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> it.stride, it.axis) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> it <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> replica <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(it.extent)]):</span>
<span id="cb9-11">    d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>()</span>
<span id="cb9-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> val, axis <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> shards:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># D</span></span>
<span id="cb9-13">      d[axis] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d.get(axis, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> val</span>
<span id="cb9-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> val, axis <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reps:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># R</span></span>
<span id="cb9-15">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> axis <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb9-16">        d[axis] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d.get(axis, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> val</span>
<span id="cb9-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> axis, val <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O.items():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># O</span></span>
<span id="cb9-18">      d[axis] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d.get(axis, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> val</span>
<span id="cb9-19">    rep_set.append(d)</span>
<span id="cb9-20"></span>
<span id="cb9-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rep_set</span></code></pre></div></div>
</details>
</div>
<p>接下来我们给定一个具体的logical coordinate (2, 9)，并通过Axe Layout的forward函数来计算映射到的并行轴坐标集合：</p>
<div id="83b13ded" class="cell" data-execution_count="92">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> pretty_print(crd: List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb10-2">  key_order <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>()</span>
<span id="cb10-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kwargs.items():</span>
<span id="cb10-4">    key_order[k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v</span>
<span id="cb10-5">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>([{k: d[k] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(d, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> k: key_order.get(k, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>))} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> crd])</span>
<span id="cb10-6"></span>
<span id="cb10-7">AxeLayout.forward <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward</span>
<span id="cb10-8">hardware_coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layout_a.forward((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb10-9"></span>
<span id="cb10-10">pretty_print(hardware_coords, warp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, lane<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, reg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[{'warp': 6, 'lane': 8, 'reg': 1}, {'warp': 10, 'lane': 8, 'reg': 1}]</code></pre>
</div>
</div>
</section>
<section id="backward-mapping" class="level1">
<h1>Backward Mapping</h1>
<p>Axe Layout同样支持从 hardware index -&gt; logical index的映射过程，称为backward mapping。这个过程就会比之前稍微简单一些，因为不需要考虑replica的扩展，只需要将offset和shard的过程反过来即可。具体流程我就不赘述，直接给出代码：</p>
<div id="96da7a21" class="cell" data-execution_count="93">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> backward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>: AxeLayout, indices: List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]], shape: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, ...]):</span>
<span id="cb12-2">  index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> indices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].copy()</span>
<span id="cb12-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. remove O</span></span>
<span id="cb12-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> axis, offset <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.O.items():</span>
<span id="cb12-5">    index[axis] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index.get(axis, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offset</span>
<span id="cb12-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. skip R</span></span>
<span id="cb12-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. remove D</span></span>
<span id="cb12-8">  shard_domains: Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, List[Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb12-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, it <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D):</span>
<span id="cb12-10">    sdomain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shard_domains.get(it.axis, ([]))</span>
<span id="cb12-11">    sdomain.append((i, it.extent, it.stride))</span>
<span id="cb12-12">    shard_domains[it.axis] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sdomain</span>
<span id="cb12-13">  </span>
<span id="cb12-14">  scoords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D) </span>
<span id="cb12-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> axis, tps <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> shard_domains.items():</span>
<span id="cb12-16">    tps.sort(key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> it: it[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb12-17">    slayout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(tp[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tp <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tps), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(tp[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tp <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tps))</span>
<span id="cb12-18">    sindex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index[axis]</span>
<span id="cb12-19">    scrd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(sindex, slayout.shape, slayout.stride)</span>
<span id="cb12-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (idx, _, _) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(tps):</span>
<span id="cb12-21">      scoords[idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scrd[i]</span>
<span id="cb12-22">  </span>
<span id="cb12-23">  shard_extents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(it.extent <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> it <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.D)</span>
<span id="cb12-24">  linear_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.crd2idx(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(scoords), shard_extents, cute.suffix_product(shard_extents))</span>
<span id="cb12-25">  logical_coord <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(linear_idx, shape, cute.suffix_product(shape))</span>
<span id="cb12-26"></span>
<span id="cb12-27">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> logical_coord</span></code></pre></div></div>
</details>
</div>
<p>我们逆推之前layout a的backward结果，可以检查backward的结果和forward给的输入是一致的：</p>
<div id="0a80ff7f" class="cell" data-execution_count="94">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"></span>
<span id="cb13-2">AxeLayout.backward <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> backward</span>
<span id="cb13-3"></span>
<span id="cb13-4">logical_coord <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layout_a.backward(hardware_coords, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb13-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> logical_coord <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb13-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(logical_coord)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(2, 9)</code></pre>
</div>
</div>
</section>
<section id="总结" class="level1">
<h1>总结</h1>
<p>这篇论文里面还提到支持Tile，Slice等操作，实际上也都是可以复用cute Layout Algorithm来实现的，这里就不进一步展开了。 同时还有一些编译器语法的前端支持，比如如何定义Tensor，Execution scopes， 这些内容不是我关注的重点，也就不展开了。 总的来说Axe Layout还是一个比较简洁且强大的张量布局抽象，他察觉到了在sharding的时候，实际上需要绑定tensor logical shape和hardware shape，因此可以把两部分放到一个<code>Shard</code>结构中进行统一处理，这样把parallel resource和memory resource都可以纳入同一个layout framework下进行处理，能在兼容原始layout的同时方便的扩展分布式能力。</p>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/Axe-0.html</guid>
  <pubDate>Sun, 08 Feb 2026 10:49:45 GMT</pubDate>
</item>
<item>
  <title>Cute概念速通</title>
  <link>https://zhen8838.github.io/posts/cute-concepts.html</link>
  <description><![CDATA[ 




<p>这篇文章将快速的介绍Cute中的一些基本概念、 layout algorithm、swizzle等，具体代码位于<a href="https://github.com/zhen8838/handson-polyhedral/blob/main/16_cute_concepts.ipynb">cute概念速通</a>。</p>
<!--more-->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pycute <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> cute</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itertools</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ml_dtypes</span>
<span id="cb1-5">np.set_printoptions(linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div></div>
<section id="layout-component" class="level1">
<h1>Layout Component</h1>
<p>先介绍Layout本身， 是由Shape,Stride组成的一个结构体， 其中Shape/Stride都是一个可嵌套的向量。</p>
<p>他们组成的Layout是一个从index到offset的函数，它的数学表示为：</p>
<pre><code>Layout(coord) = offset</code></pre>
<p>实际计算过程如下：</p>
<pre><code>Coord ∘ Shape =&gt; Index
Index ∘ Stride =&gt; Offset</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb4-2">coord <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'offset: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layout(coord)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
<pre><code>offset: 15</code></pre>
<section id="mode" class="level2">
<h2 class="anchored" data-anchor-id="mode">Mode</h2>
<p>layout可以通过mode取其中的每个元素</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'mode 0: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layout[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb6-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'mode 1: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layout[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
<pre><code>mode 0: 2:3
mode 1: 3:6</code></pre>
</section>
<section id="domain-codomain" class="level2">
<h2 class="anchored" data-anchor-id="domain-codomain">Domain &amp; Codomain</h2>
<p>domain是layout的索引空间，codomain是layout的访问空间。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'domain: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layout<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb8-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'codomain: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layout<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cosize()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
<pre><code>domain: 6
codomain: 16</code></pre>
</section>
</section>
<section id="complement" class="level1">
<h1>Complement</h1>
<p>先解释一下为什么需要补集，观察上面，可以发现Layout的domain != codomain，这就意味着在内存中某些位置是不能被访问到的。 而补集就是这些不能被访问到的位置所构成的layout。</p>
<p>Complement是许多layout algorithm中常用的一个操作。 他的主要原理是通过计算codomain，再分解当前的Shape/Stride得到无法访问到的位置，剩余部分所构成的原layout就是补集。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">comp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.complement(layout)</span>
<span id="cb10-2">comp</span></code></pre></div></div>
<pre><code>Layout(3,1)</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">full <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.make_layout(layout, comp) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># layout ⋆ comp(layout) 得到当前全集 </span></span>
<span id="cb12-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(full)</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> full.size() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> full.cosize() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size 和 cosize 相等，说明是全集</span></span></code></pre></div></div>
<pre><code>((2, 3), 3):((3, 6), 1)</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 补集的逻辑很简单，就是从最大N开始不停的除shape*stride</span></span>
<span id="cb14-2">comp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.complement(layout) </span>
<span id="cb14-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(comp) </span>
<span id="cb14-4">comp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.complement(layout, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 也可以设置更大codom来构建补集</span></span>
<span id="cb14-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(comp) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 也就是说如果补的len实际上得先看内部有个多少空洞， 然后最后再添加一个能重复到max idx的。</span></span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(cute.size(layout), cute.cosize(layout))</span>
<span id="cb14-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(cute.size(comp), cute.cosize(comp))</span></code></pre></div></div>
<pre><code>3:1
(3, 3):(1, 18)
6 16
9 39</code></pre>
</section>
<section id="composition" class="level1">
<h1>Composition</h1>
<p>C = A ∘ B 表示用B的codomain映射到A的domain上, 这里需要注意是B的codomain需要和A的domain匹配，并且C的domain是C的domain，而codomain是A的domain。</p>
<pre><code>C(coord) = A(B(coord))</code></pre>
<p>composition后的取offsetC等价于如下的公式。</p>
<pre><code>B(coord) =&gt; offsetB
index2crd(offsetB, A.shape) =&gt; coordA
A(coordA) =&gt; offsetC</code></pre>
<p>这里还有一个细节需要注意, 实际index2crd的过程是从左向右进行拆分的，这其实和cute中默认column major的布局对应。这也就是为什么cute中通常把tile的内层放到最左边，而剩余部分放到右边。这样composite出来的结果索引和cute中默认的column major布局是一致的。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb18-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x ∘ y:'</span>, cute.composition(x, y)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 此时输出的dom变成了y的dom</span></span>
<span id="cb18-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y ∘ x:'</span>, cute.composition(y, x)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 此时输出的dom变成了x的dom</span></span></code></pre></div></div>
<pre><code>x ∘ y: 4:4
y ∘ x: 8:4</code></pre>
</section>
<section id="divide" class="level1">
<h1>Divide</h1>
<p>他的公式如下</p>
<pre><code>C = A ∘ (B ⋆ comp(B, size(A))). </code></pre>
<p>扩展B的codomain到A的domain，然后进行composite。</p>
<p>实际上divide通常是用于实现tiling， 设想B作为一个固定的inner factor， 将他补到A的domain， 那么(B * restB)匹配A的domain，此时restB就相当于outer factor。 最后再进行一次composite， 就得到了C，此时C的domain由(inner factor,outer factor)组成, 也就是呈现了tiled A。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb21-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original:'</span>, a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 对于128，采用不同的factor去divide，会得到不同的结果</span></span>
<span id="cb21-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'divide by 8:'</span>, cute.logical_divide(a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cute.Layout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)))</span>
<span id="cb21-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'divide by 4:'</span>, cute.logical_divide(a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cute.Layout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)))</span></code></pre></div></div>
<pre><code>original: 128:32
divide by 8: (8, 16):(32, 256)
divide by 4: (4, 32):(32, 128)</code></pre>
<section id="zipped_dividetiled_divide" class="level2">
<h2 class="anchored" data-anchor-id="zipped_dividetiled_divide">zipped_divide/tiled_divide</h2>
<p>不同divide的区别在于返回的layout的group方式不同:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zipped_divide:'</span>, cute.zipped_divide(a, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)))</span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tiled_divide:'</span>, cute.tiled_divide(a, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)))</span></code></pre></div></div>
<pre><code>zipped_divide: ((8, 4), (16, 8)):((32, 1), (256, 4))
tiled_divide: ((8, 4), 16, 8):((32, 1), 256, 4)</code></pre>
</section>
</section>
<section id="product" class="level1">
<h1>Product</h1>
<p>公式如下：</p>
<pre><code>C = A ⋆ (comp(A, size(A) * cosize(B)) ∘ B)</code></pre>
<p>如果是divide是拆分layout A，那么product就是重复layout A。保持A本身不变，然后整体是需要把A重复B次，所以需要先补到(size A) * (cosize B)， 再配合一个composite让B映射每一个A上。最后再拼接原始的A，得到C具备 (size A) * (size B) 的domain。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">ta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb26-2">tb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb26-3">max_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ta.size() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tb.cosize()</span>
<span id="cb26-4">comp_ta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.complement(ta, max_idx)</span>
<span id="cb26-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_idx:'</span>, max_idx, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'complement:'</span>, comp_ta)</span>
<span id="cb26-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"composite"</span>, cute.composition(comp_ta, tb))</span>
<span id="cb26-7">tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.make_layout(ta, cute.composition(comp_ta, tb))</span>
<span id="cb26-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'product:'</span>, tc)</span></code></pre></div></div>
<pre><code>max_idx: 24 complement: (2, 3):(2, 8)
composite (2, 3):(2, 8)
product: ((2, 2), (2, 3)):((4, 1), (2, 8))</code></pre>
<section id="zipped-product-tiled-product" class="level2">
<h2 class="anchored" data-anchor-id="zipped-product-tiled-product">Zipped Product &amp; Tiled Product</h2>
<p>同样也是把inner part放到左边，并且也是在group方式上存在区别。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zipped:'</span>, cute.zipped_product(a, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)))</span>
<span id="cb28-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tiled:'</span>, cute.tiled_product(a, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)))</span></code></pre></div></div>
<pre><code>zipped: ((128, 32), (8, 4)):((32, 1), (1, 32))
tiled: ((128, 32), 8, 4):((32, 1), 1, 32)</code></pre>
</section>
<section id="block-rroduct" class="level2">
<h2 class="anchored" data-anchor-id="block-rroduct">Block Rroduct</h2>
<p>如果是logical product，那么最后的domain就是(A, B)，按照cute默认的迭代方式进行访问，就是先访问A的所有元素，然后按B的方式访问扩展后的A元素。</p>
<p>但是有没有可能，通过调整domain，在默认的迭代方式下实现不同的访问模式呢？ 比如我们有一个小的2维矩阵tiledA(m,n)，它匹配硬件计算的粒度，但是在内存中他是以A(3m, 4n)的形式存储的。 那么我们希望在默认的迭代方式下， 先将A的n维度访问完，再访问m维度，这个需求就需要blocked product来实现。</p>
<p>其实blocked product的本质就是调整logical product的domain顺序， 让inner part的维度在左边， outer part的维度在右边。 这样在默认的迭代方式下，就实现了先访问inner part，再访问outer part的效果。而实际上在内存上的元素顺序并没有任何改变。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hier_zip(layoutA, layoutB):</span>
<span id="cb30-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(layoutA) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(layoutB)</span>
<span id="cb30-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cute.make_layout(itertools.chain((cute.make_layout(layoutA[i], layoutB[i]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(layoutA)))))</span>
<span id="cb30-4"></span>
<span id="cb30-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> blocked_product(block, tiler):</span>
<span id="cb30-6">  res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.logical_product(block, tiler)</span>
<span id="cb30-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> hier_zip(res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb30-8"></span>
<span id="cb30-9">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb30-10">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb30-11">logical_producted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.logical_product(a, b)</span>
<span id="cb30-12">blocked_producted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blocked_product(a, b)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 实际上就是把logical product拆分且zip</span></span>
<span id="cb30-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logical_producted"</span>, logical_producted)</span>
<span id="cb30-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blocked_producted"</span>, blocked_producted)</span></code></pre></div></div>
<pre><code>logical_producted ((2, 5), (3, 4)):((5, 1), (10, 30))
blocked_producted ((2, 3), (5, 4)):((5, 10), (1, 30))</code></pre>
<p>我写了一个print_offsets的函数，打印按默认的访问顺序下，layout所映射的offset的情况， 用于展示blocked product的效果。 首先是看logical product的情况，这里crd默认也是按col major生成的，所以layout a会按列呈现在offset矩阵中：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_offsets(layout: cute.Layout):</span>
<span id="cb32-2">  rk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(layout)</span>
<span id="cb32-3">  shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [layout[i].size() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rk)]</span>
<span id="cb32-4">  arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(shape, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.int32)</span>
<span id="cb32-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> crd <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.product(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(shape[i]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rk)]):</span>
<span id="cb32-6">    arr[crd] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layout(crd)</span>
<span id="cb32-7">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(arr)</span>
<span id="cb32-8"></span>
<span id="cb32-9">print_offsets(logical_producted)</span></code></pre></div></div>
<pre><code>[[  0  10  20  30  40  50  60  70  80  90 100 110]
 [  5  15  25  35  45  55  65  75  85  95 105 115]
 [  1  11  21  31  41  51  61  71  81  91 101 111]
 [  6  16  26  36  46  56  66  76  86  96 106 116]
 [  2  12  22  32  42  52  62  72  82  92 102 112]
 [  7  17  27  37  47  57  67  77  87  97 107 117]
 [  3  13  23  33  43  53  63  73  83  93 103 113]
 [  8  18  28  38  48  58  68  78  88  98 108 118]
 [  4  14  24  34  44  54  64  74  84  94 104 114]
 [  9  19  29  39  49  59  69  79  89  99 109 119]]</code></pre>
<p>但是如果采用blocked product，则是按<code>[m * 3, n * 4]</code>这样的shape来采样，当我们访问A的n维度时，是优先访问完一个tile的n维度，然后跳到下一个tile的n维度进行访问：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">print_offsets(blocked_producted)</span></code></pre></div></div>
<pre><code>[[  0   1   2   3   4  30  31  32  33  34  60  61  62  63  64  90  91  92  93  94]
 [  5   6   7   8   9  35  36  37  38  39  65  66  67  68  69  95  96  97  98  99]
 [ 10  11  12  13  14  40  41  42  43  44  70  71  72  73  74 100 101 102 103 104]
 [ 15  16  17  18  19  45  46  47  48  49  75  76  77  78  79 105 106 107 108 109]
 [ 20  21  22  23  24  50  51  52  53  54  80  81  82  83  84 110 111 112 113 114]
 [ 25  26  27  28  29  55  56  57  58  59  85  86  87  88  89 115 116 117 118 119]]</code></pre>
<p>本质上两个layout表达的offset是相同的，区别在于使用<code>cute默认的迭代顺序</code>下他们的行为，这一点其实是十分重要的，这会令logical/blocked layout进行composite的时候得到完全不同的结果。</p>
<p>当然cute layout的自由度还是很大的，比如对于logical product的结果，我们也可以自行按block coord来采样，再采样tile内部，也是可以得到相同的offset序列的：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logical_producted[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb36-2">block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logical_producted[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb36-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> block_crd <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.product(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(mode.size()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mode <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> block]):</span>
<span id="cb36-4">  block_offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block(block_crd)</span>
<span id="cb36-5">  array <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(tile.shape, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.int32)</span>
<span id="cb36-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tile_crd <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.product(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(mode.size()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mode <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tile]):</span>
<span id="cb36-7">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tile(tile_crd)</span>
<span id="cb36-8">    array[tile_crd] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> block_offset</span>
<span id="cb36-9">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"block </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>block_crd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, array)</span></code></pre></div></div>
<pre><code>block (0, 0):
 [[0 1 2 3 4]
 [5 6 7 8 9]]
block (0, 1):
 [[30 31 32 33 34]
 [35 36 37 38 39]]
block (0, 2):
 [[60 61 62 63 64]
 [65 66 67 68 69]]
block (0, 3):
 [[90 91 92 93 94]
 [95 96 97 98 99]]
block (1, 0):
 [[10 11 12 13 14]
 [15 16 17 18 19]]
block (1, 1):
 [[40 41 42 43 44]
 [45 46 47 48 49]]
block (1, 2):
 [[70 71 72 73 74]
 [75 76 77 78 79]]
block (1, 3):
 [[100 101 102 103 104]
 [105 106 107 108 109]]
block (2, 0):
 [[20 21 22 23 24]
 [25 26 27 28 29]]
block (2, 1):
 [[50 51 52 53 54]
 [55 56 57 58 59]]
block (2, 2):
 [[80 81 82 83 84]
 [85 86 87 88 89]]
block (2, 3):
 [[110 111 112 113 114]
 [115 116 117 118 119]]</code></pre>
</section>
<section id="raked-product" class="level2">
<h2 class="anchored" data-anchor-id="raked-product">Raked product</h2>
<p>Raked product和blocked product类似，也是调整logical product的domain顺序，不过是把outer part的维度放到左边， inner part的维度放到右边。 这样在默认的迭代方式下，就实现了先访问outer part，再访问inner part的效果。而实际上在内存上的元素顺序并没有任何改变。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> raked_product(block, tiler):</span>
<span id="cb38-2">  res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.logical_product(block, tiler)</span>
<span id="cb38-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> hier_zip(res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb38-4"></span>
<span id="cb38-5">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb38-6">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb38-7">logical_producted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.logical_product(a, b)</span>
<span id="cb38-8">raked_producted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raked_product(a, b) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 实际上就是把logical layout进行了拆分zip, 不过顺序反过来了。</span></span>
<span id="cb38-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logical_producted'</span>, logical_producted)</span>
<span id="cb38-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'raked_producted'</span>, raked_producted)</span></code></pre></div></div>
<pre><code>logical_producted ((2, 5), (3, 4)):((5, 1), (10, 30))
raked_producted ((3, 2), (4, 5)):((10, 5), (30, 1))</code></pre>
<p>它同样也是先遍历完A的某一个维度，只是遍历维度内部的顺序从inner优先变成了outer优先。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">print_offsets(raked_producted)</span></code></pre></div></div>
<pre><code>[[  0  30  60  90   1  31  61  91   2  32  62  92   3  33  63  93   4  34  64  94]
 [ 10  40  70 100  11  41  71 101  12  42  72 102  13  43  73 103  14  44  74 104]
 [ 20  50  80 110  21  51  81 111  22  52  82 112  23  53  83 113  24  54  84 114]
 [  5  35  65  95   6  36  66  96   7  37  67  97   8  38  68  98   9  39  69  99]
 [ 15  45  75 105  16  46  76 106  17  47  77 107  18  48  78 108  19  49  79 109]
 [ 25  55  85 115  26  56  86 116  27  57  87 117  28  58  88 118  29  59  89 119]]</code></pre>
</section>
</section>
<section id="inverse" class="level1">
<h1>Inverse</h1>
<section id="right-inverse" class="level2">
<h2 class="anchored" data-anchor-id="right-inverse">Right Inverse</h2>
<p>它的数学表示为：</p>
<p>Layout_Rinv(Layout(index)) = index</p>
<p>原始的layout是一个从index到offset的函数，所以right inverse就是得到一个layout invese可以从offset 到 index。</p>
<pre><code>crd2idx(coord)
      |
      v
    index
      |
      v
  F_L(index) -&gt; offset
      ∧             |
      |             v
   index &lt;- F_Linv(offset)</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb43-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.crd2idx((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), layout.shape)</span>
<span id="cb43-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layout:'</span>, layout, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index:"</span>, x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"offset:"</span>, layout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 * 64 + 4</span></span></code></pre></div></div>
<pre><code>layout: (32, 64):(64, 1) index: 131 offset: 196</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">layout_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.right_inverse(layout)</span>
<span id="cb45-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layout_inv(cute.idx2crd(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">196</span>, layout_inv.shape))</span>
<span id="cb45-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layout_inv'</span>, layout_inv, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index:"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">196</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"offset:"</span>, x)</span></code></pre></div></div>
<pre><code>layout_inv (64, 32):(32, 1) index: 196 offset: 131</code></pre>
<p>所以其实它比较大的用处是, 这样可以快速找到原来的一个coord所对应的index</p>
<p>F_Linv(F_L(coord)) = index</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">crd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb47-2">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layout_inv(layout(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>crd))</span>
<span id="cb47-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> layout(index) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> layout(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>crd)</span>
<span id="cb47-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"we find the coord </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>crd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'s index is:"</span>, index)</span></code></pre></div></div>
<pre><code>we find the coord (3, 4)'s index is: 131</code></pre>
</section>
</section>
<section id="thread-value-layout" class="level1">
<h1>Thread Value layout</h1>
<p>我的理解是这样，thread value layout(tv layout)本质上是提供了一个在thread level的sharding tensor在各个thread上访问local data的方式。 在cute的一个教程中，是这样描述tv layout的使用的：</p>
<pre><code>    (16,256)   :  (2048,1)
     ~~~~~~        ~~~~~~
        |             |        Tiled/Composed with TV Layout
        |             |    
        |             |    o   ((32,4),(8,4)):((128,4),(16,1))
        V             V         
~~~~~~~~~~~~~~~     ~~~~~~~~~~~~~~~~~~~ 
((32,4), (8,4))  :  ((4,8192),(1,2048))
    |      |
    |      `--------&gt; per thread fragment
    |
Thread Block
  Shape

Sliced to Thread local sub-tensor (a (4,8) tile):  tidfrgA[(tidx, None)]</code></pre>
<p>将一个<code>(16,256)</code>的tensor，按32线程，4warp的方式sharding到每个thread上， 每个thread访问一个<code>(4,8)</code>的local tile。 此时tv layout的作用就是提供一个方式，让每个thread可以访问到自己local tile的数据。</p>
<p>注意到这里<code>32线程，4warp的方式</code>是按照<code>(32,4)</code>的shape来描述的，这是因为cute的index to coord是按照从左向右拆分的，所以需要把thread维度放到左边， warp维度放到右边。 这样在默认的迭代方式下，<code>tidfrgA[(tidx, None)]</code>的<code>tidx</code>才能被正确映射到thread，warp上。</p>
<p>在<code>cutlass/python/CuTeDSL/cutlass/cute/core.py#L5093</code>中有一个make tv layout实现，我们来拆解一下：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 首先cute的逻辑不是对原始tensor做拆分，而是对thread和value的layout做组合来构建tv layout</span></span>
<span id="cb50-2">thr_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 32 threads, 4warps</span></span>
<span id="cb50-3">val_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 每个thread访问4行， 每行8个元素</span></span>
<span id="cb50-4"></span>
<span id="cb50-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. 此时thr layout作为block，val layout作为tiler，由于 raked product的结果是tiler优先</span></span>
<span id="cb50-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 得到((val_m, thr_m), (val_n, thr_n)) -&gt; [1~M*N]的映射</span></span>
<span id="cb50-7">layout_mn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raked_product(thr_layout, val_layout)</span>
<span id="cb50-8"></span>
<span id="cb50-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 然后构建tv domain，即(thr_size, val_size)，这里thr_size=128, val_size=32</span></span>
<span id="cb50-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 得到 (threads, values) -&gt; [1~M*N]的映射</span></span>
<span id="cb50-11">thr_size, val_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.size(thr_layout), cute.size(val_layout)</span>
<span id="cb50-12">tv_domain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((thr_size, val_size))</span>
<span id="cb50-13"></span>
<span id="cb50-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. layout_mn的右逆是得到了 [1~M*N] -&gt; ((val_m, thr_m), (val_n, thr_n))，</span></span>
<span id="cb50-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 进行composite： (threads, values) -&gt; [1~M*N] -&gt; [1~M*N] -&gt; ((val_m, thr_m), (val_n, thr_n))</span></span>
<span id="cb50-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 得到 (threads, values) -&gt; ((val_m, thr_m), (val_n, thr_n))的映射</span></span>
<span id="cb50-17">layout_tv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.composition(cute.right_inverse(layout_mn), tv_domain)</span>
<span id="cb50-18">tiler_mn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(cute.product(s) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> layout_mn.shape)</span>
<span id="cb50-19"></span>
<span id="cb50-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tiler_mn:'</span>, tiler_mn)</span>
<span id="cb50-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layout_tv:'</span>, layout_tv)</span></code></pre></div></div>
<pre><code>tiler_mn: (16, 256)
layout_tv: ((32, 4), (8, 4)):((128, 4), (16, 1))</code></pre>
<p>至此得到了layout tv，但实际上它只映射到一个logical的(M,N)上。使用一个实际上的tiled tensor与它进行compose后，可以用layout tv去采样tiled tensor内的元素。 回想之前设计的value layout是<code>((4, 8), (8, 1))</code>，那么去取一个row major矩阵就可以是8个元素连续读，而取一个col major的矩阵就是4个元素连续读：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">tiledA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># row major tiled tensor</span></span>
<span id="cb52-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"row major   tiledA: "</span>, cute.composition(tiledA, layout_tv)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... (8, 4) : ... (1,512)</span></span>
<span id="cb52-3">tiledA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># colum marjor tiled tensor</span></span>
<span id="cb52-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"colum major tiledA: "</span>, cute.composition(tiledA, layout_tv)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... (8, 4) : ... (512,1)</span></span></code></pre></div></div>
<pre><code>row major   tiledA:  ((32, 4), (8, 4)):((8, 2048), (1, 512))
colum major tiledA:  ((32, 4), (8, 4)):((4096, 4), (512, 1))</code></pre>
</section>
<section id="swizzle" class="level1">
<h1>Swizzle</h1>
<p>Swizzle的本质上是将offset进行重映射到新的offset上，cute这里选择将offset的值拆分为行和列部分的组合，通过移动行和列所对应的bits实现行列交错， 从而将逻辑上同一列的地址映射到物理的不同列上。</p>
<pre><code>0bxxxxxxxxxxxxxxxYYYxxxxxxxZZZxxxx
                 ^-^       ^-^      B 是要移动的位个数
                              ^--^  M 保持不变的位个数
                   ^---------^      S 是移动的距离
                                      (pos shifts YYY to the right, neg shifts YYY to the left)
e.g. Given
0bxxxxxxxxxxxxxxxxYYxxxxxxxxxZZxxx
the result is
0bxxxxxxxxxxxxxxxxYYxxxxxxxxxAAxxx where AA = ZZ xor YY</code></pre>
<p>简单来说， Swizzle这里三个参数可理解为M是保持不变的位个数，对应连续读取的元素个数。S是移动的距离，看做逻辑上的列数。B是要移动的位个数，看作逻辑上的行数。 我下面设计了一个visualize_bank_distribution函数，用于展示swizzle前后，线程访问内存bank的分布情况。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> visualize_bank_distribution(access_indices_per_thread, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, cols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>):</span>
<span id="cb55-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) 先收集所有物理地址</span></span>
<span id="cb55-3">    phys_addrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb55-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tid, indices <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> access_indices_per_thread.items():</span>
<span id="cb55-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ptr <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indices:</span>
<span id="cb55-6">            phys_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swizzle(ptr) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> swizzle <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> ptr</span>
<span id="cb55-7">            phys_addrs.append(phys_ptr)</span>
<span id="cb55-8"></span>
<span id="cb55-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> phys_addrs:</span>
<span id="cb55-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No accesses."</span>)</span>
<span id="cb55-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb55-12"></span>
<span id="cb55-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) 以访问的最大地址决定可视化的“memory”规模</span></span>
<span id="cb55-14">    max_addr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(phys_addrs)</span>
<span id="cb55-15">    total_elems <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> max_addr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb55-16">    rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (total_elems <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> cols</span>
<span id="cb55-17"></span>
<span id="cb55-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) 用 cute.Layout 表示 bank 的二维布局 (row, col) -&gt; linear addr</span></span>
<span id="cb55-19">    bank_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((rows, cols), (cols, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb55-20"></span>
<span id="cb55-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4) 建立二维表记录每个地址的线程集合</span></span>
<span id="cb55-22">    table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cols)] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rows)]</span>
<span id="cb55-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tid, indices <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> access_indices_per_thread.items():</span>
<span id="cb55-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ptr <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indices:</span>
<span id="cb55-25">            phys_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swizzle(ptr) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> swizzle <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> ptr</span>
<span id="cb55-26">            r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(phys_ptr, bank_layout.shape, bank_layout.stride)</span>
<span id="cb55-27">            table[r][c].add(tid)</span>
<span id="cb55-28"></span>
<span id="cb55-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5) 打印整个 memory 的 bank 视图</span></span>
<span id="cb55-30">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>title<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] | "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Swizzle: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>swizzle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> swizzle <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No Swizzle"</span>))</span>
<span id="cb55-31">    header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"      "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>.join(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> "</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cols))</span>
<span id="cb55-32">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(header)</span>
<span id="cb55-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"      "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb55-34"></span>
<span id="cb55-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rows):</span>
<span id="cb55-36">        row_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb55-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cols):</span>
<span id="cb55-38">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> table[r][c]:</span>
<span id="cb55-39">                row_cells.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>.join(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(table[r][c])))</span>
<span id="cb55-40">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb55-41">                row_cells.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>)</span>
<span id="cb55-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"R</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:&gt;2}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> row_cells))</span>
<span id="cb55-43"></span>
<span id="cb55-44">    bank_threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cols)]</span>
<span id="cb55-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rows):</span>
<span id="cb55-46">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cols):</span>
<span id="cb55-47">            bank_threads[c].update(table[r][c])</span>
<span id="cb55-48">    max_conflicts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(s) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bank_threads)</span>
<span id="cb55-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"最大冲突深度: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_conflicts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<p>假设我们有一个32x64的f32矩阵，采用row-major布局。 32个线程，每个线程访问一列元素，此时这个32个线程刚好访问同一个bank的不同地址，产生严重的bank conflict：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> my_access_pattern(layout, threads, v_size):</span>
<span id="cb56-2">    access_map <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb56-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads):</span>
<span id="cb56-4">        access_map[tid] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [layout(tid, v) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(v_size)]</span>
<span id="cb56-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> access_map</span>
<span id="cb56-6"></span>
<span id="cb56-7">num_threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb56-8">vec_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb56-9">a_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb56-10"></span>
<span id="cb56-11">thread_accesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> my_access_pattern(a_layout, num_threads, vec_size)</span>
<span id="cb56-12"></span>
<span id="cb56-13">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Row-Major Vector Read"</span>)</span></code></pre></div></div>
<pre><code>[Row-Major Vector Read] | No Swizzle
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00                                                                                             
R01 |                                                                                                
R02 | 01                                                                                             
R03 |                                                                                                
R04 | 02                                                                                             
R05 |                                                                                                
R06 | 03                                                                                             
R07 |                                                                                                
R08 | 04                                                                                             
R09 |                                                                                                
R10 | 05                                                                                             
R11 |                                                                                                
R12 | 06                                                                                             
R13 |                                                                                                
R14 | 07                                                                                             
R15 |                                                                                                
R16 | 08                                                                                             
R17 |                                                                                                
R18 | 09                                                                                             
R19 |                                                                                                
R20 | 10                                                                                             
R21 |                                                                                                
R22 | 11                                                                                             
R23 |                                                                                                
R24 | 12                                                                                             
R25 |                                                                                                
R26 | 13                                                                                             
R27 |                                                                                                
R28 | 14                                                                                             
R29 |                                                                                                
R30 | 15                                                                                             
R31 |                                                                                                
R32 | 16                                                                                             
R33 |                                                                                                
R34 | 17                                                                                             
R35 |                                                                                                
R36 | 18                                                                                             
R37 |                                                                                                
R38 | 19                                                                                             
R39 |                                                                                                
R40 | 20                                                                                             
R41 |                                                                                                
R42 | 21                                                                                             
R43 |                                                                                                
R44 | 22                                                                                             
R45 |                                                                                                
R46 | 23                                                                                             
R47 |                                                                                                
R48 | 24                                                                                             
R49 |                                                                                                
R50 | 25                                                                                             
R51 |                                                                                                
R52 | 26                                                                                             
R53 |                                                                                                
R54 | 27                                                                                             
R55 |                                                                                                
R56 | 28                                                                                             
R57 |                                                                                                
R58 | 29                                                                                             
R59 |                                                                                                
R60 | 30                                                                                             
R61 |                                                                                                
R62 | 31                                                                                             
最大冲突深度: 32</code></pre>
<p>根据之前对swizzle的理解，它的参数实际上在描述一个逻辑的访问矩阵，要将行和列进行交错实现conflict free。此时一个元素占一个bank，所以M=0 (2^0=1)。然后是访问32行时，每一行都交错开，B=5 (2^5=32)。 最后S=6 (2^6=64)，表示每行有64个元素。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"With Swizzle Optimization"</span>)</span></code></pre></div></div>
<pre><code>[With Swizzle Optimization] | Swizzle: SW_5_0_6
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00                                                                                             
R01 |                                                                                                
R02 |    01                                                                                          
R03 |                                                                                                
R04 |       02                                                                                       
R05 |                                                                                                
R06 |          03                                                                                    
R07 |                                                                                                
R08 |             04                                                                                 
R09 |                                                                                                
R10 |                05                                                                              
R11 |                                                                                                
R12 |                   06                                                                           
R13 |                                                                                                
R14 |                      07                                                                        
R15 |                                                                                                
R16 |                         08                                                                     
R17 |                                                                                                
R18 |                            09                                                                  
R19 |                                                                                                
R20 |                               10                                                               
R21 |                                                                                                
R22 |                                  11                                                            
R23 |                                                                                                
R24 |                                     12                                                         
R25 |                                                                                                
R26 |                                        13                                                      
R27 |                                                                                                
R28 |                                           14                                                   
R29 |                                                                                                
R30 |                                              15                                                
R31 |                                                                                                
R32 |                                                 16                                             
R33 |                                                                                                
R34 |                                                    17                                          
R35 |                                                                                                
R36 |                                                       18                                       
R37 |                                                                                                
R38 |                                                          19                                    
R39 |                                                                                                
R40 |                                                             20                                 
R41 |                                                                                                
R42 |                                                                21                              
R43 |                                                                                                
R44 |                                                                   22                           
R45 |                                                                                                
R46 |                                                                      23                        
R47 |                                                                                                
R48 |                                                                         24                     
R49 |                                                                                                
R50 |                                                                            25                  
R51 |                                                                                                
R52 |                                                                               26               
R53 |                                                                                                
R54 |                                                                                  27            
R55 |                                                                                                
R56 |                                                                                     28         
R57 |                                                                                                
R58 |                                                                                        29      
R59 |                                                                                                
R60 |                                                                                           30   
R61 |                                                                                                
R62 |                                                                                              31
最大冲突深度: 1</code></pre>
<p>上面的swizzle是直接异或，对于理解起来不怎么直观，所以我准备了一个更加符合直觉的图示。 实际上我们可以把swizzle还原到一个cute layout，他表示的是一个逻辑上的box，通过将原始tensor offset映射到这个box上，再通过box的coord得到逻辑行和列号（irow，icol），对icol进行异或得到xicol, 保证了<strong>不同行的相同列被映射到不同的列</strong>上。 再使用<code>(irow,xicol)</code>得到的index去访问shared memory bank， 同样通过idx2crd得到<code>(prow,pcol)</code>，即可发现所有的pcol的值都不相同， 实现了bank conflict free。</p>
<pre><code>┌─────────────────────┐          ┌──────────────────────┐          ┌──────────────────────┐
│   TENSOR LAYOUT     │          │   SWIZZLE LAYOUT     │          │  BANK LAYOUT         │
│   stride=64         │          │                      │          │  (32 banks)          │
│   32x64 row-major   │          │  shape: (1,64,32)    │          │                      │
│                     │          │  stride:(1,1,64)     │          │  Bank distribution   │
│ tid=0→addr 0        │---------&gt;│                      │---------&gt;│                      │
│ tid=1→addr 64       │  idx2crd │  (base,icol,irow)    │ idx2crd  │  tid=0→Bank 0        │
│ tid=2→addr 128      │          │  icol%width ^ irow   │          │  tid=1→Bank 1        │
│ tid=3→addr 192      │          │                      │          │  tid=2→Bank 2        │
│ tid=4→addr 256      │          │  (base,xicol,irow)   │          │  tid=3→Bank 3        │
│ tid=5→addr 320      │          │         │            │          │  tid=4→Bank 4        │
│ tid=6→addr 384      │          │         v            │          │  tid=5→Bank 5        │
│ tid=7→addr 448      │          │     phy_offset       │          │  tid=6→Bank 6        │
│                     │          └──────────────────────┘          │  tid=7→Bank 7        │
└─────────────────────┘                                            │                      │
                                                                   │ 已映射到不同 bank      │
                                                                   │ (冲突深度 = 1)        │
                                                                   │ 不存在 bank conflict  │
                                                                   └──────────────────────┘</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"></span>
<span id="cb61-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> decompose_swizzle_mapping(access_indices_per_thread, swizzle: cute.Swizzle):</span>
<span id="cb61-3">  base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> swizzle.base</span>
<span id="cb61-4">  width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> swizzle.shift</span>
<span id="cb61-5">  height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> swizzle.bits</span>
<span id="cb61-6">  swizzle_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((base, width, height), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, base, base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width))</span>
<span id="cb61-7"></span>
<span id="cb61-8">  max_offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>([offset <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, indices <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> access_indices_per_thread.items() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> offset <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indices])</span>
<span id="cb61-9">  bank_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, (max_offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>))</span>
<span id="cb61-10"></span>
<span id="cb61-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tid, indices <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> access_indices_per_thread.items():</span>
<span id="cb61-12">      accesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb61-13">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> offset <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indices:</span>
<span id="cb61-14">        (_, icol, irow) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(offset, swizzle_layout.shape)</span>
<span id="cb61-15">        micol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> icol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> width <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> abs(shift) &gt;= bits</span></span>
<span id="cb61-16">        xicol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> micol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> irow</span>
<span id="cb61-17">        </span>
<span id="cb61-18">        phy_offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swizzle_layout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, xicol, irow)</span>
<span id="cb61-19">        (pcol, prow) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.idx2crd(phy_offset, bank_layout.shape)</span>
<span id="cb61-20">        accesses.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'(R</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prow<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pcol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>)</span>
<span id="cb61-21">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'T</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> accesses: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>, accesses)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb61-22"></span>
<span id="cb61-23"></span>
<span id="cb61-24">decompose_swizzle_mapping(thread_accesses, cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span></code></pre></div></div>
<pre><code>T00 accesses: (R00, 00)
T01 accesses: (R02, 01)
T02 accesses: (R04, 02)
T03 accesses: (R06, 03)
T04 accesses: (R08, 04)
T05 accesses: (R10, 05)
T06 accesses: (R12, 06)
T07 accesses: (R14, 07)
T08 accesses: (R16, 08)
T09 accesses: (R18, 09)
T10 accesses: (R20, 10)
T11 accesses: (R22, 11)
T12 accesses: (R24, 12)
T13 accesses: (R26, 13)
T14 accesses: (R28, 14)
T15 accesses: (R30, 15)
T16 accesses: (R32, 16)
T17 accesses: (R34, 17)
T18 accesses: (R36, 18)
T19 accesses: (R38, 19)
T20 accesses: (R40, 20)
T21 accesses: (R42, 21)
T22 accesses: (R44, 22)
T23 accesses: (R46, 23)
T24 accesses: (R48, 24)
T25 accesses: (R50, 25)
T26 accesses: (R52, 26)
T27 accesses: (R54, 27)
T28 accesses: (R56, 28)
T29 accesses: (R58, 29)
T30 accesses: (R60, 30)
T31 accesses: (R62, 31)</code></pre>
<p>下面再看一个例子，32x48的f32矩阵，依旧row major。 当进行load matrix，每一行load 4个元素(16Byte)，此时8个线程就能组成一个transaction，同样也会访问同一个bank的不同地址，产生严重的bank conflict：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1">num_threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb63-2">vec_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb63-3">a_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb63-4"></span>
<span id="cb63-5">thread_accesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> my_access_pattern(a_layout, num_threads, vec_size)</span>
<span id="cb63-6"></span>
<span id="cb63-7">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32x64 Row-Major vec4 (No Swizzle)"</span>)</span></code></pre></div></div>
<pre><code>[32x64 Row-Major vec4 (No Swizzle)] | No Swizzle
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                                                                                
R02 | 01 01 01 01                                                                                    
R03 |                                                                                                
R04 | 02 02 02 02                                                                                    
R05 |                                                                                                
R06 | 03 03 03 03                                                                                    
R07 |                                                                                                
R08 | 04 04 04 04                                                                                    
R09 |                                                                                                
R10 | 05 05 05 05                                                                                    
R11 |                                                                                                
R12 | 06 06 06 06                                                                                    
R13 |                                                                                                
R14 | 07 07 07 07                                                                                    
最大冲突深度: 8</code></pre>
<p>现在开始计算Swizzle的参数。首先4个元素保持连续，因此M=2 (2^2=4)。需要让每一行的开头位于不同位置，刚好当前tensor stride为64，可以令此时4个元素组成的16个单元作为一行(宽64)，因此S=4 (2^4=16)。最后需要访问8行，因此B=3 (2^3=8)：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb65-2">                           title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32x64 Row-Major vec4"</span>)</span></code></pre></div></div>
<pre><code>[32x64 Row-Major vec4] | Swizzle: SW_3_2_4
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                                                                                
R02 |             01 01 01 01                                                                        
R03 |                                                                                                
R04 |                         02 02 02 02                                                            
R05 |                                                                                                
R06 |                                     03 03 03 03                                                
R07 |                                                                                                
R08 |                                                 04 04 04 04                                    
R09 |                                                                                                
R10 |                                                             05 05 05 05                        
R11 |                                                                                                
R12 |                                                                         06 06 06 06            
R13 |                                                                                                
R14 |                                                                                     07 07 07 07
最大冲突深度: 1</code></pre>
<p>我们修改上一个例子的配置为32x48的f32矩阵，依旧row major。同样也会访问同一个bank的不同地址，产生4路冲突的bank conflict：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1">num_threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb67-2">vec_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb67-3">a_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb67-4"></span>
<span id="cb67-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> my_access_pattern(layout, threads, v_size):</span>
<span id="cb67-6">    access_map <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb67-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads):</span>
<span id="cb67-8">        access_map[tid] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [layout(tid, v) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(v_size)]</span>
<span id="cb67-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> access_map</span>
<span id="cb67-10"></span>
<span id="cb67-11">thread_accesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> my_access_pattern(a_layout, num_threads, vec_size)</span>
<span id="cb67-12"></span>
<span id="cb67-13">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32x48 Row-Major vec4"</span>)</span></code></pre></div></div>
<pre><code>[32x48 Row-Major vec4] | No Swizzle
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                                 01 01 01 01                                    
R02 |                                                                                                
R03 | 02 02 02 02                                                                                    
R04 |                                                 03 03 03 03                                    
R05 |                                                                                                
R06 | 04 04 04 04                                                                                    
R07 |                                                 05 05 05 05                                    
R08 |                                                                                                
R09 | 06 06 06 06                                                                                    
R10 |                                                 07 07 07 07                                    
最大冲突深度: 4</code></pre>
<p>依旧4个元素保持连续，因此M=2 (2^2=4)。但是此时访问的stride为48，并且4个元素为一个单元，再叠加cute Swizzle 2的幂次限制，我们只能选择<code>4*8=32</code>或者<code>4*16=64</code>作为行宽度。 由于32/64都并不是48的倍数，所以不能通过匹配S的大小刚好令每一行的开头按顺序错开。 这里其实会存在余数，也就是余数所造成icol的周期循环<code>icol: [(i * 48 % 64) // 4 for i in range(8)] = [0, 12, 8, 4, 0, 12, 8, 4]</code>，但是最终的<code>xicol</code>实际上还需要取决于<code>irow</code>的，因此我目前也没有理清楚对于swizzle的影响公式，需要后续进一步研究：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32x48 Row-Major vec4"</span>)</span></code></pre></div></div>
<pre><code>[32x48 Row-Major vec4] | Swizzle: SW_3_2_4
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                                 01 01 01 01                                    
R02 |                                                                                                
R03 |             02 02 02 02                                                                        
R04 |                                                                         03 03 03 03            
R05 |                                                                                                
R06 |                                     04 04 04 04                                                
R07 |                                                                                     05 05 05 05
R08 |                                                                                                
R09 |                                                 06 06 06 06                                    
R10 |             07 07 07 07                                                                        
最大冲突深度: 2</code></pre>
<p>所以我们选择更小的行宽度，32为一行。同样也有周期循环 <code>icol: [(i * 48 % 32) // 4 for i in range(8)] = [0, 4, 0, 4, 0, 4, 0, 4]</code>， 但是这样最终的xicol反而并不会有重叠：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32x48 Row-Major vec4"</span>)</span></code></pre></div></div>
<pre><code>[32x48 Row-Major vec4] | Swizzle: SW_2_2_3
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                                             01 01 01 01                        
R02 |                                                                                                
R03 |                                     02 02 02 02                                                
R04 |                                                 03 03 03 03                                    
R05 |                                                                                                
R06 |                         04 04 04 04                                                            
R07 |                                                                                     05 05 05 05
R08 |                                                                                                
R09 |             06 06 06 06                                                                        
R10 |                                                                         07 07 07 07            
最大冲突深度: 1</code></pre>
<p>下面这个例子好像就没办法做到完全bank conflict free：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1">num_threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb73-2">vec_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb73-3">a_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cute.Layout((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb73-4">thread_accesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> my_access_pattern(a_layout, num_threads, vec_size)</span>
<span id="cb73-5"></span>
<span id="cb73-6">visualize_bank_distribution(thread_accesses, swizzle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cute.Swizzle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Swizzle"</span>)</span></code></pre></div></div>
<pre><code>[Swizzle] | Swizzle: SW_2_2_3
      00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 
      ------------------------------------------------------------------------------------------------
R00 | 00 00 00 00                                                                                    
R01 |                                     01 01 01 01                                                
R02 |                                                                         02 02 02 02            
R03 |                                                             03 03 03 03                        
R04 |                                                                                                
R05 |             04 04 04 04                                                                        
R06 | 05 05 05 05                                                                                    
R07 |                                                                                     06 06 06 06
R08 |                                                                         07 07 07 07            
最大冲突深度: 2</code></pre>


</section>

 ]]></description>
  <category>推理框架</category>
  <guid>https://zhen8838.github.io/posts/cute-concepts.html</guid>
  <pubDate>Tue, 03 Feb 2026 14:29:32 GMT</pubDate>
</item>
<item>
  <title>探究jax reshard优化</title>
  <link>https://zhen8838.github.io/posts/jax-reshard.html</link>
  <description><![CDATA[ 




<p>Google在分布式系统上有非常深厚的积累，本文主要尝试检查jax的行为来探究数据重分布<code>reshard</code>算子的优化方案。</p>
<!--more-->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># os.environ['TF_CPP_MAX_VLOG_LEVEL'] = '5'</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># os.environ['TF_CPP_MIN_LOG_LEVEL'] = '5'</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># os.environ['ABSL_VLOG_LEVEL'] = '4'</span></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.sharding <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PartitionSpec <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> P, AxisType, get_abstract_mesh, reshard</span></code></pre></div></div>
<p>配置当前环境下的device/mesh：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">jax.config.update(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'jax_num_cpu_devices'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># jax.config.update('jax_logging_level', 'DEBUG')</span></span>
<span id="cb2-3">mesh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.make_mesh((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>), axis_types<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(AxisType.Explicit, AxisType.Explicit))</span>
<span id="cb2-4">jax.set_mesh(mesh)</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Current mesh is: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>get_abstract_mesh()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1">    Current mesh is<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> AbstractMesh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> axis_types<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> device_kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_cores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>None<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<section id="resharding-m-xn---m-y-n-x" class="level1">
<h1>resharding <code>[M @ X,N] -&gt; [M @ Y, N @ X]</code></h1>
<p>这是两个维度都需要发生变化的例子，数据在M上需要再次切分发送到Y上，然后在N上需要进行切分。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.jit</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reshard_1(x):</span>
<span id="cb4-3">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard(x, P(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>))</span>
<span id="cb4-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>), jnp.float32, out_sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>P(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>))</span>
<span id="cb5-2">compilation_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb5-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_to'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tmp/reshard_1'</span>,</span>
<span id="cb5-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_hlo_pass_re'</span> : <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.*'</span></span>
<span id="cb5-5">}</span>
<span id="cb5-6">traced_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard_1.trace(x)</span>
<span id="cb5-7">lowered_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> traced_1.lower()</span>
<span id="cb5-8">compiled_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowered_1.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(compilation_args)</span></code></pre></div></div>
<p>lower之后可以查看hlo的ir:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(lowered_1.as_text())</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">module</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">@</span>jit_reshard_1 attributes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mhlo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>num_partitions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> i32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> mhlo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>num_replicas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> i32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">      sdy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mesh <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">@</span>mesh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&gt;</span></span>
<span id="cb7-3">      func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>func <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">public</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">@</span>main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>arg0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x2048xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sdy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>sharding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">#sdy.sharding&lt;@mesh, [{"X"}, {}]&gt;}) -&gt; (tensor&lt;2048x2048xf32&gt; {jax.result_info = "result", sdy.sharding = #sdy.sharding&lt;@mesh, [{"Y"}, {"X"}]&gt;}) {</span></span>
<span id="cb7-4">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sdy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>sharding_constraint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">@</span>mesh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}]&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x2048xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x2048xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-6">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>compile之后可以参考spmd/mpmd的ir：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(compiled_1.as_text())</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1">    HloModule jit_reshard_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> is_scheduled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> entry_computation_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})-&gt;</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> num_partitions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb9-2">    </span>
<span id="cb9-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[],</span> param_3<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_4<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-4">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-5">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_4<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-6">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_4<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-8">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_3<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-9">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_3<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-10">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>subtract<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> subtract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-11">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>subtract<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-12">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-13">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-14">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-15">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-17">    </span>
<span id="cb9-18">    ENTRY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>main<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">_spmd</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-19">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb9-20">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-21">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-22">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-23">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-24">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb9-25">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast_dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice_fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_target_pairs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<section id="ir解读" class="level2">
<h2 class="anchored" data-anchor-id="ir解读">IR解读</h2>
<p>检查spmd的ir，先查看module信息：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1">HloModule jit_reshard_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> is_scheduled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> entry_computation_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})-&gt;</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> num_partitions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span></code></pre></div></div>
<p>这里有一个<code>num_partitions</code>是定义程序所执行的分区数量，在hlo中还有一个<code>num_replicas</code>定义的是副本数， 我理解<code>num_replicas</code>是用于描述数据并行的，虽然在sharding的描述中看起来数据并行也是切分，但是他们属于不同的数据了，所以hlo这里会有一些特殊优化存在。</p>
<p>然后查看主函数参数为:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>这表示了在spmd的ir下，并不会使用global view来表示分布式的数据。 同时这里<code>f32[1024, 2048]{1, 0}</code>中花括号部分表示的是数据的<a href="https://openxla.org/xla/hlo_to_thunks#layout_assignment_passes">layout</a>， 就表明此时的param为列主序。</p>
<p>然后查看下面的三个constant和函数<code>bitcast_dynamic-slice_fusion</code>调用， 并将其简化:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb12-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_8 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_6 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sub_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> subtract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>slice_8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sub_3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice_6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>可以发现xla通过分析reshard，把需要进行数据传输的范围进行了提前计算，一共8个设备并行，然后每个设备上对应的slice 范围为：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-4"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>,    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-5"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-6"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-7"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb13-8"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> dynamic_slice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f32[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>], start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>,    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span></code></pre></div></div>
<p>因为mesh的维度 <code>Y = 2X</code>, 所以上述操作在每个设备上对数据在M，N维度在此切分即可得到分布为<code>[M @ Y,N @ X]</code>的数据<code>f32[512,1024]</code>, 但数据的位置还是错乱的，因此还需要调用一次高性能的primitive: <code>collective-permute</code>，数据设备上交错之后就可以得到最终所需要的分布式布局：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1">ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast_dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice_fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_target_pairs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_1)/reshard"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
</section>
<section id="resharding-m-yn---m-x-n-y" class="level1">
<h1>resharding <code>[M @ Y,N] -&gt; [M @ X, N @ Y]</code></h1>
<p>上一个例子中由于X小于Y导致他可以使用本地tile进行计算，这次交换切分的位置进行测试。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.jit</span></span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reshard_2(x):</span>
<span id="cb15-3">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard(x, P(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>))</span>
<span id="cb15-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>), jnp.float32, out_sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>P(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>))</span>
<span id="cb16-2">compilation_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb16-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_to'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tmp/reshard_2'</span>,</span>
<span id="cb16-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_hlo_pass_re'</span> : <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.*'</span></span>
<span id="cb16-5">}</span>
<span id="cb16-6">traced_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard_2.trace(x)</span>
<span id="cb16-7">lowered_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> traced_2.lower()</span>
<span id="cb16-8">compiled_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowered_2.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(compilation_args)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(compiled_2.as_text())</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1">    HloModule jit_reshard_2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> is_scheduled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> entry_computation_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})-&gt;</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> num_partitions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb18-2">    </span>
<span id="cb18-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-4">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-5">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-6">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>concatenate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> concatenate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>transpose<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> transpose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>concatenate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-8">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>transpose<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-9">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-11">    </span>
<span id="cb18-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-13">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-14">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-15">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-16">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-17">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-18">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-19">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-20">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-21">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-23">    </span>
<span id="cb18-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-25">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-26">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-27">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-28">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-29">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-30">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-31">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-32">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-33">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-35">    </span>
<span id="cb18-36">    ENTRY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>main<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">_spmd</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-37">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb18-38">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-39">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-40">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb18-41">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb18-42">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})</span> all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> replica_groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-43">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb18-44">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-45">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy_bitcast_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb18-46">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> collective<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>permute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>copy_bitcast_fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_target_pairs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_2)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-47">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>这次就可以发现xla对这种情况拆分为了两次的ccl操作，首先切分出小块后进行<code>all-to-all</code>，合并后再执行<code>collective-permute</code>得到最终的分布。</p>
</section>
<section id="resharding-m-n-xt---m-dyxt-n" class="level1">
<h1>resharding <code>[M, N @ (X,T)] -&gt; [M @ (D,Y,X,T), N]</code></h1>
<p>测试一个比较复杂的例子</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb19-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb19-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.sharding <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PartitionSpec <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> P, AxisType, get_abstract_mesh, reshard</span>
<span id="cb19-4"></span>
<span id="cb19-5">jax.config.update(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'jax_num_cpu_devices'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb19-6">mesh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.make_mesh((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>),</span>
<span id="cb19-7">                     axis_types<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(AxisType.Explicit, AxisType.Explicit, AxisType.Explicit, AxisType.Explicit, AxisType.Explicit))</span>
<span id="cb19-8">jax.set_mesh(mesh)</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Current mesh is: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>get_abstract_mesh()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb20-1">    Current mesh is<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> AbstractMesh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> axis_types<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Explicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> device_kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_cores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>None<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.jit</span></span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reshard_3(x):</span>
<span id="cb21-3">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard(x, P((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>))</span>
<span id="cb21-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span>
<span id="cb21-5"></span>
<span id="cb21-6">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>), jnp.float32, out_sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>P(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>)))</span>
<span id="cb21-7">compilation_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_to'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tmp/reshard_3'</span>,</span>
<span id="cb21-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_hlo_pass_re'</span> : <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.*'</span></span>
<span id="cb21-10">}</span>
<span id="cb21-11"></span>
<span id="cb21-12">traced_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard_3.trace(x)</span>
<span id="cb21-13">lowered_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> traced_3.lower()</span>
<span id="cb21-14">compiled_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowered_3.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(compilation_args)</span>
<span id="cb21-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(compiled_3.as_text())</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"></span>
<span id="cb22-2">    HloModule jit_reshard_3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> is_scheduled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> entry_computation_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})-&gt;</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> num_partitions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span></span>
<span id="cb22-3">    </span>
<span id="cb22-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-5">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-6">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>transpose<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> transpose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>transpose<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-8">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-10">    </span>
<span id="cb22-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-12">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-13">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-14">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-15">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-16">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-17">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-18">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-19">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-20">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-22">    </span>
<span id="cb22-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-24">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-25">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-26">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-27">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-28">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-29">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-30">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-31">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-32">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-34">    </span>
<span id="cb22-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-36">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-37">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-38">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-39">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-40">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-41">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-42">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-43">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-44">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-45">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-46">    </span>
<span id="cb22-47">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-48">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-49">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-50">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-51">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-52">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-53">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-54">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-55">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-56">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-57">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-58">    </span>
<span id="cb22-59">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-60">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-61">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-62">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-63">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-64">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-65">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-66">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-67">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-68">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-69">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-70">    </span>
<span id="cb22-71">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-72">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-73">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-74">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-75">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-76">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-77">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-78">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-79">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-80">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-81">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-82">    </span>
<span id="cb22-83">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-84">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-85">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-86">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-87">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-88">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-89">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-90">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-91">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-92">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-93">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-94">    </span>
<span id="cb22-95">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-96">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-97">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-98">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-99">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-100">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-101">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-102">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-103">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-104">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.18</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-105">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-106">    </span>
<span id="cb22-107">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-108">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-109">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-110">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-111">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-112">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-113">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-114">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-115">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-116">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-117">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-118">    </span>
<span id="cb22-119">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-120">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-121">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-122">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-123">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-124">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-125">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-126">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-127">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-128">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.22</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-129">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-130">    </span>
<span id="cb22-131">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-132">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-133">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-134">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-135">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.21</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-136">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-137">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-138">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-139">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-140">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.24</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-141">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-142">    </span>
<span id="cb22-143">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-144">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-145">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-146">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-147">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-148">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-149">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-150">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-151">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-152">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.26</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-153">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-154">    </span>
<span id="cb22-155">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-156">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-157">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-158">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-159">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-160">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-161">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-162">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-163">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-164">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-165">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-166">    </span>
<span id="cb22-167">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-168">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-169">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-170">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-171">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.36</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.41</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-172">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.36</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-173">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-174">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-175">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-176">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-177">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-178">    </span>
<span id="cb22-179">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-180">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-181">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-182">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-183">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.44</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.29</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-184">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.38</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-185">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.36</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-186">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.37</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.33</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.36</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-187">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.37</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-188">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.30</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-189">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-190">    </span>
<span id="cb22-191">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-192">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.50</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-193">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-194">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb22-195">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.40</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-196">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.40</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-197">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.37</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-198">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.39</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.35</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.37</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-199">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> bitcast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.39</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-200">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.34</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-201">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-202">    </span>
<span id="cb22-203">    ENTRY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>main<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">_spmd</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-204">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-205">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-206">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({...}),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-207">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-208">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-209">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-210">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-211">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-212">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-213">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-214">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-215">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-216">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-217">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-218">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-219">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-220">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-221">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-222">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-223">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=5*/</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=10*/</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=15*/</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})</span> all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=5*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=10*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=15*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>bitcast_slice_fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> replica_groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-224">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb22-225">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb22-226">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb22-227">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb22-228">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb22-229">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb22-230">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb22-231">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb22-232">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb22-233">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb22-234">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb22-235">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span></span>
<span id="cb22-236">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb22-237">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span></span>
<span id="cb22-238">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span></span>
<span id="cb22-239">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>all<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span></span>
<span id="cb22-240">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>concatenate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> concatenate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=5*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=10*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*index=15*/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>element<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-241">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy_bitcast_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>concatenate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_3)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-242">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>这里通过拆分为细粒度的tile后进行all-to-all的方式数据交换，最后再把一个节点上多个tile合并起来得到结果。</p>
</section>
<section id="resharding-m-d-n-xy---m-n-dyxt" class="level1">
<h1>resharding <code>[M @ D, N @ (X,Y)] -&gt; [M, N @ (D,Y,X,T)]</code></h1>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.jit</span></span>
<span id="cb23-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reshard_4(x):</span>
<span id="cb23-3">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard(x, P(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>)))</span>
<span id="cb23-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span>
<span id="cb23-5"></span>
<span id="cb23-6">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>), jnp.float32, out_sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>P(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>)))</span>
<span id="cb23-7">compilation_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb23-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_to'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tmp/reshard_4'</span>,</span>
<span id="cb23-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xla_dump_hlo_pass_re'</span> : <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.*'</span></span>
<span id="cb23-10">}</span>
<span id="cb23-11"></span>
<span id="cb23-12">traced_4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reshard_4.trace(x)</span>
<span id="cb23-13">lowered_4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> traced_4.lower()</span>
<span id="cb23-14">compiled_4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowered_4.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(compilation_args)</span>
<span id="cb23-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(compiled_4.as_text())</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb24-1">    HloModule jit_reshard_4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> is_scheduled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> entry_computation_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={(</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">})-&gt;</span>f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span> num_partitions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span></span>
<span id="cb24-2">    </span>
<span id="cb24-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>fused_computation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-4">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-5">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-6">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>convert<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> convert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-8">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> constant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-9">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>multiply<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> multiply<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>convert<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-10">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>constant<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>multiply<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dynamic_slice_sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-12">    </span>
<span id="cb24-13">    ENTRY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>main<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">_spmd</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-14">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> u32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-15">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-16">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb24-17">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> replica_groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> use_global_device_ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-18">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> backend_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outer_dimension_partitions"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span></span>
<span id="cb24-19">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>copy<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> channel_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> replica_groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> dimensions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> use_global_device_ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-20">      ROOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>multiply_dynamic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>slice_fusion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> fusion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(%</span>all<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gather<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>partition<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kLoop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> calls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=%</span>fused_computation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jit(reshard_4)/reshard"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-22">    </span>
<span id="cb24-23">    </span>
<span id="cb24-24"></span>
<span id="cb24-25"></span>
<span id="cb24-26">    W1015 <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">08.668874</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12979952</span> spmd_partitioner<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">645</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>SPMD<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> Involuntary full rematerialization<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span> The compiler cannot go from sharding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> to <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]}</span> efficiently <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> HLO operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> parameter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>devices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]&lt;=[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> last_tile_dim_replicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">={</span>op_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}.</span> As the last resort<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SPMD will replicate the tensor <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> then partition it to obtain the target sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> which is inefficient<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span> This issue will be fixed by Shardy partitioner in the future<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> which is tracked in b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">433785288.</span> Contact Shardy <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> XLA team <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> help<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span></span></code></pre></div></div>
<p>这个例子xla无法handle了，他只能每个节点完全gather到所有数据之后重新切分。</p>
</section>
<section id="spmd-partitioning-pass" class="level1">
<h1>spmd-partitioning pass</h1>
<p>上面我对编译过程进行了dump，然后通过翻阅IR的变化定位到了reshard的具体优化pass为<code>spmd-partitioning</code>. 在deepwiki上可以看到对它的<a href="https://deepwiki.com/openxla/xla/7.1-spmd-partitioning#spmd-partitioning">初步分析</a>， 这里再对其做一些记录。</p>
<p>这个pass最主要的逻辑在于<a href="https://github.com/openxla/xla/blob/b253947e64fef974e2a8b9209f97ce8a807f4296/xla/service/spmd/spmd_partitioner.cc#L511">ReshardNoCache</a>, 内部主要以模式识别分发为主：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CanReshardWithCollectivePermute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ReshardWithCollectivePermute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-3">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-4"></span>
<span id="cb25-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> src_tgt_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb25-6">          GetReshardAllToAllSourceTargetDims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ReshardWithAllToAll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>src_tgt_dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-8">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-9"></span>
<span id="cb25-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>IsTileMaximal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>ReplicateOnLastTileDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> try_reshard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReshardFromPartialReplicateWithDynamicSlice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* or */</span> try_reshard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReshardPartialReplicateWithAllToAll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-13">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-14"></span>
<span id="cb25-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>IsTileMaximal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ReplicateOnLastTileDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> try_reshard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReshardToPartialReplicateWithAllGather<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* or */</span> try_reshard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReshardPartialReplicateWithAllToAll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-18">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-19"></span>
<span id="cb25-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>IsReplicated<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>IsReplicated<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-22">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sharding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>IsTiled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>IsTiled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-23">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> reshard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TryComplexReshardHandling<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-24">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-26">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<ol type="1">
<li><p><code>ReshardWithCollectivePermute</code>, 通过检查source sharding在当前tile或切分后tile是否满足<a href="https://github.com/openxla/stablehlo/blob/main/docs/spec.md#collective_permute">CollectivePermute</a>的spec， 他这里的约束就是src/dst的rank id只能出现一次。</p></li>
<li><p><code>ReshardWithAllToAll</code>, 这也是检查当前tile或切分后tile是否满足<a href="https://github.com/openxla/stablehlo/blob/main/docs/spec.md#all_to_all">all_to_all</a>。</p></li>
<li><p><code>ReshardPartialReplicateWithAllToAll</code>, 是一个更加特化的调用all_to_all的分支，支持最后一个维度为复制的情况下进行优化</p></li>
<li><p><code>TryComplexReshardHandling</code>， 最后不支持的情况是都转移到这里，这里的逻辑是先reshape distributed tensor，然后去match target sharding的tile，检查是否有机会调用ccl primitive，如果不支持只能走all gather + slice的分支了。</p></li>
</ol>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/jax-reshard.html</guid>
  <pubDate>Wed, 15 Oct 2025 04:05:10 GMT</pubDate>
</item>
<item>
  <title>Flash Attention记录</title>
  <link>https://zhen8838.github.io/posts/flashattn.html</link>
  <description><![CDATA[ 




<p>简单记录一下flash attention的推导和实现。</p>
<!--more-->
<section id="naive-attention" class="level1">
<h1>Naive Attention</h1>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20S%20&amp;=%20QK%5ET%20%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%5Ctimes%20N%7D%20%5C%5C%0A%20%20P%20&amp;=%20softmax(S)%20%5C%5C%0A%20%20O%20&amp;=%20PV%20%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%20%5Ctimes%20d%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>本质上就是两个matmul中间有一个伪elementwise操作。 主要由于softmax每个输出点依赖了他的所有input，导致无法进行tiling fusion。原因如下</p>
</section>
<section id="softmax" class="level1">
<h1>SoftMax</h1>
<section id="naive-softmax实现" class="level2">
<h2 class="anchored" data-anchor-id="naive-softmax实现">naive softmax实现：</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Asoftmax(x_i,%20%5Cldots,%20x_N)%20=%20%5Cfrac%7Be%20%5E%20%7Bx_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7BN%7D%20e%5E%7Bx_j%7D%7D,%20i%20%5Cin%20%5B1,%20N%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>由于<img src="https://latex.codecogs.com/png.latex?e%5Ex">会很大，容易出现数值溢出，因此出现safe softmax</p>
</section>
<section id="safe-softmax实现" class="level2">
<h2 class="anchored" data-anchor-id="safe-softmax实现">safe softmax实现</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20max_%7BN%7D%20&amp;=%20max(x_i),%20%5C%20i%20%5Cin%20%5B1,%20N%5D%20%5C%5C%0A%20%20softmax(x_i,%20%5Cldots,%20x_N)%20&amp;=%20%5Cfrac%7Be%20%5E%20%7Bx_i%20-%20max_%7BN%7D%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7BN%7D%20e%5E%7Bx_j%20-%20max_%7BN%7D%7D%7D,%20i%20%5Cin%20%5B1,%20N%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>但是在实现上需要循环三次，因为<img src="https://latex.codecogs.com/png.latex?max_N">和<img src="https://latex.codecogs.com/png.latex?x_%7Bsum%7D">都需要单独的循环</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20max_i%20&amp;=%20max(m_%7Bi-1%7D,%20x_i)%5C%5C%0A%20%20sum_i%20&amp;=%20sum_%7Bi-1%7D%20+%20e%5E%7Bx_i%20-%20max_N%7D%20%5C%5C%0A%20%20a_i%20&amp;=%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Bsum_N%7D,%20%5C%20i%20%5Cin%20%5B1,%20N%5D%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="pass-softmax" class="level2">
<h2 class="anchored" data-anchor-id="pass-softmax">2-pass softmax</h2>
<p>说实话，让我是没办法能想出来融合max以及sum的公式，可能作者也是受Welford方法启发的。 首先我们考虑把<img src="https://latex.codecogs.com/png.latex?sum_N">的公式展开，通过<img src="https://latex.codecogs.com/png.latex?exp">的计算性质把<img src="https://latex.codecogs.com/png.latex?-%20max_N">这个拆分为两个部分 <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20sum_%7BN%7D%20&amp;=%20%5Csum_%7Bj%20=%201%7D%20%5E%20N%20e%5E%7Bx_j%20-%20max_N%7D%20%5C%5C%20%5C%5C%0A%20%20%20%20&amp;=%20%5Csum_%7Bj%20=%201%7D%20%5E%20%7BN-1%7D%20e%5E%7Bx_j%20-%20max_N%7D%20+%20e%5E%7Bx_N%20-%20max_N%7D%20%20%5C%5C%0A%20%20%20%20&amp;=%20%5Csum_%7Bj%20=%201%7D%20%5E%20%7BN-1%7D%20e%5E%7Bx_j%20-%20max_%7BN-1%7D%20+%20max_%7BN-1%7D%20-%20max_N%7D%20+%20e%5E%7Bx_N%20-%20max_N%7D%20%5C%5C%0A%20%20%20%20&amp;=%20(%5Csum_%7Bj%20=%201%7D%20%5E%20%7BN-1%7D%20e%5E%7Bx_j%20-%20max_%7BN-1%7D%7D)%20e%5E%7Bmax_%7BN-1%7D%20-%20max_N%7D%20+e%5E%7Bx_N%20-%20max_N%7D%20%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>观察上面的公式，发现如果从另一个视角去定义变量就可以让他们递归起来 <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Blet%7D%5C%20sum_%7BN%7D%5E%5Cprime%20&amp;=%5Csum_%7Bj=1%7D%5E%7BN%7D%20e%5E%7Bx_j%20-%20max_N%7D%20=%20sum_%7BN%7D%20%5C%5C%0A%20%20&amp;=%20(%5Csum_%7Bj%20=%201%7D%20%5E%20%7BN-1%7D%20e%5E%7Bx_j%20-%20max_%7BN-1%7D%7D)%20e%5E%7Bmax_%7BN-1%7D%20-%20max_N%7D%20+e%5E%7Bx_N%20-%20max_N%7D%20%20%5C%5C%0A%20%20&amp;=%20sum_%7BN-1%7D%5E%5Cprime%20e%5E%7Bmax_%7BN-1%7D%20-%20max_N%7D%20+e%5E%7Bx_N%20-%20max_N%7D%20%5C%5C%0A%20%20sum_i%20%5E%5Cprime%20&amp;=%20sum_%7Bi-1%7D%20%5E%5Cprime%20e%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+e%5E%7Bx_i%20-%20max_i%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>通过视角的转换将<img src="https://latex.codecogs.com/png.latex?max_N">与<img src="https://latex.codecogs.com/png.latex?sum_%7Bi%7D">进行了解耦，并且当迭代到最后时<img src="https://latex.codecogs.com/png.latex?sum_%7BN%7D%5E%5Cprime%20=%20sum_%7BN%7D">。 虽然2-pass的方式需要在每次迭代添加额外的乘<img src="https://latex.codecogs.com/png.latex?e%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D">的运算，但显然比访存开销低很多。</p>
</section>
</section>
<section id="flash-attention" class="level1">
<h1>Flash Attention</h1>
<section id="pass-attention" class="level2">
<h2 class="anchored" data-anchor-id="pass-attention">2-pass Attention</h2>
<p>首先使用2-pass的softmax来实现一个attention,这里为了不混淆<code>query len</code>和<code>seq len</code>， 分别用<code>k</code>和<code>i</code>来表示。</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Bfor%20i%20in%20%5B1,%20N%5D%7D:&amp;%5C%5C%0A%20%20x_i%20&amp;=%20Q%5Bk,%20:%5DK%5ET%5B:,%20i%5D%5C%5C%0A%20%20max_i%20&amp;=%20%5Cmax(max_%7Bi-1%7D,%20x_i)%20%5C%5C%0A%20%20sum_i%5E%5Cprime%20&amp;=%20sum_%7Bi-1%7D%20%5E%5Cprime%20e%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+e%5E%7Bx_i%20-%20max_i%7D%5C%5C%0A%5Ctext%7Bend%7D%20%5Cqquad%20%5Cqquad%20%5C%5C%0A%5Ctext%7Bfor%20i%20in%20%5B1,%20N%5D%7D:&amp;%5C%5C%0A%20%20a_i%20&amp;=%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20%5C%5C%0A%20%20o_i%20&amp;=%20o_%7Bi-1%7D%20+%20a_i%20V%5Bi,:%5D%20%5C%5C%0A%5Ctext%7Bend%7D%20%5Cqquad%20%5Cqquad%20%5C%5C%0A%20%20O%5Bk,:%5D%20&amp;%20=%20o_N%0A%5Cend%7Baligned%7D%0A"> <!-- 这里的o_{i-1} + a_i 是因为第二个矩阵乘k维度对应的N，也就是要进行mul add的操作 --></p>
</section>
<section id="pass-attention-1" class="level2">
<h2 class="anchored" data-anchor-id="pass-attention-1">1-pass Attention</h2>
<p>在和V做矩阵乘时，每一个<img src="https://latex.codecogs.com/png.latex?o_i">还是依赖了<img src="https://latex.codecogs.com/png.latex?max_N">。 接下来就是找到办法把<img src="https://latex.codecogs.com/png.latex?max_N">的依赖消除。参考<code>2-pass softmax</code>的套路先定义： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Ao_N%5E%5Cprime%20&amp;=%20%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN%7D%20a_i%20V%5Bi,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5Bi,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20(%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN-1%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5Bi,:%5D)%20+%20%5Cfrac%7Be%5E%7Bx_N%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5BN,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20(%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN-1%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20%5Cfrac%7Bsum_%7BN-1%7D%5E%5Cprime%7D%7Bsum_%7BN-1%7D%5E%5Cprime%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_%7BN-1%7D%7D%7D%7Be%5E%7Bx_i%20-%20max_%7BN-1%7D%7D%7D%20%20V%5Bi,:%5D)%20+%20%5Cfrac%7Be%5E%7Bx_N%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5BN,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20(%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN-1%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_%7BN-1%7D%7D%7D%7Bsum_%7BN-1%7D%5E%5Cprime%7D%20V%5Bi,:%5D)%20%5Cfrac%7Bsum_%7BN-1%7D%5E%5Cprime%7D%7Bsum_%7BN%7D%5E%5Cprime%7D%5Cfrac%7Be%5E%7Bx_i%20-%20max_N%7D%7D%7Be%5E%7Bx_i%20-%20max_%7BN-1%7D%7D%7D%20+%20%5Cfrac%7Be%5E%7Bx_N%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5BN,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20(%5Csum_%7Bi%20=%201%7D%20%5E%20%7BN-1%7D%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_%7BN-1%7D%7D%7D%7Bsum_%7BN-1%7D%5E%5Cprime%7D%20V%5Bi,:%5D)%20%5Cfrac%7Bsum_%7BN-1%7D%5E%5Cprime%7D%7Bsum_%7BN%7D%5E%5Cprime%7De%5E%7Bmax_%7BN-1%7D%20-%20max_N%7D%20+%20%5Cfrac%7Be%5E%7Bx_N%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5BN,:%5D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20&amp;=%20o_%7BN-1%7D%5E%5Cprime%20%5Cfrac%7Bsum_%7BN-1%7D%5E%5Cprime%7D%7Bsum_%7BN%7D%5E%5Cprime%7De%5E%7Bmax_%7BN-1%7D%20-%20max_N%7D%20+%20%5Cfrac%7Be%5E%7Bx_N%20-%20max_N%7D%7D%7Bsum_N%5E%5Cprime%7D%20V%5BN,:%5D%20%5C%5C%0A%5Cend%7Baligned%7D%0A"> 然后归纳得到不包含<img src="https://latex.codecogs.com/png.latex?max_N">的<img src="https://latex.codecogs.com/png.latex?o_i%5E%5Cprime">公式为： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20o_i%5E%5Cprime%20&amp;=%20o_%7Bi-1%7D%5E%5Cprime%20%5Cfrac%7Bsum_%7Bi-1%7D%5E%5Cprime%7D%7Bsum_%7Bi%7D%5E%5Cprime%7De%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_i%7D%7D%7Bsum_i%5E%5Cprime%7D%20V%5Bi,:%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>最终列出标量化的1-pass Attention形式： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Bfor%20i%20in%20%5B1,%20N%5D%7D:&amp;%5C%5C%0A%20%20x_i%20&amp;=%20Q%5Bk,%20:%5DK%5ET%5B:,%20i%5D%5C%5C%0A%20%20max_i%20&amp;=%20%5Cmax(max_%7Bi-1%7D,%20x_i)%20%5C%5C%0A%20%20sum_i%5E%5Cprime%20&amp;=%20sum_%7Bi-1%7D%20%5E%5Cprime%20e%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+e%5E%7Bx_i%20-%20max_i%7D%5C%5C%0A%20%20%20%20o_i%5E%5Cprime%20&amp;=%20o_%7Bi-1%7D%5E%5Cprime%20%5Cfrac%7Bsum_%7Bi-1%7D%5E%5Cprime%7D%7Bsum_%7Bi%7D%5E%5Cprime%7De%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+%20%5Cfrac%7Be%5E%7Bx_i%20-%20max_i%7D%7D%7Bsum_i%5E%5Cprime%7D%20V%5Bi,:%5D%20%5C%5C%0A%5Ctext%7Bend%7D%20%5Cqquad%20%5Cqquad%5C%5C%0A%20%20O%5Bk,:%5D%20&amp;%20=%20o_N%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="flash-attention-v1" class="level2">
<h2 class="anchored" data-anchor-id="flash-attention-v1">Flash Attention v1</h2>
<p>上面推导出来的1-pass attention是基于标量循环的，对于flash attention是需要按tile进行计算的，所以具体的公式还需要稍作修改。</p>
<p>首先列出普通的softmax计算公式：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AX%20&amp;%20=%20%20%5Bx_1,%20%5Cldots%20,%20x_N%5D%20%5C%5C%0Amax_N%20&amp;%20=%20%5Cmax(X)%20%5C%5C%0A%20%20&amp;=%20%5Cmax(%5Bx_1,%20%5Cldots%20,%20x_N%5D)%20%5C%5C%0Af(X)%20&amp;%20=%20%5Bf(x_1),%20%5Cldots%20,%20f(x_N)%5D%20%5C%5C%0A%20%20&amp;=%20%5Be%5E%7Bx_1%20-%20max_N%7D,%20%5Cldots,%20e%5E%7Bx_N%20-%20max_N%7D%5D%20%5C%5C%0Asum_N%20&amp;%20=%20%5Csum_%7Bi%20=%201%7D%5EN%20f(x_i)%20%5C%5C%0A%20%20&amp;%20=%20%5Csum_%7Bi%20=%201%7D%5EN%20e%5E%7Bx_i%20-%20max_N%7D%20%5C%5C%0Asoftmax(X)%20&amp;%20=%20%5Cfrac%7B%20f(X)%7D%7Bsum_N%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>现在来推导tiled softmax的计算公式， 那么假设现在的<img src="https://latex.codecogs.com/png.latex?X">是由两个长度为<img src="https://latex.codecogs.com/png.latex?N">的子向量组成的, 那么首先把它看成单个向量计算，然后拆分转换为可分治的公式： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AX%20&amp;%20=%20%5Bx%5E1,%20x%5E2%5D%20%5C%5C%0Amax_%7B2N%7D%20&amp;%20=%20%5Cmax(%5B%5Cmax(x%5E1),%5Cmax(x%5E2)%5D)%20%5C%5C%0A%20%20&amp;%20=%20%5Cmax(%5Bmax_N%5E1,%20max_N%5E2%5D)%20%5C%5C%0Af(X)%20&amp;=%20%5Cleft%5B%20%5Be%5E%7Bx_1%5E1%20-%20max_%7B2N%7D%7D,%5Cldots,%20e%5E%7Bx_N%5E1%20-%20max_%7B2N%7D%7D%5D%20,%20%5Be%5E%7Bx_1%5E2%20-%20max_%7B2N%7D%7D,%5Cldots,%20e%5E%7Bx_N%5E2%20-%20max_%7B2N%7D%7D%5D%20%5Cright%5D%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cleft%5B%20e%5E%7Bmax_N%5E1%20-%20max_%7B2N%7D%7D%20%5Be%5E%7Bx_1%5E1%20-%20max_N%5E1%7D,%5Cldots,%20e%5E%7Bx_N%5E1%20-%20max_N%5E1%7D%5D%20,%20e%5E%7Bmax_N%5E2%20-%20max_%7B2N%7D%7D%20%5Be%5E%7Bx_1%5E2%20-%20max_N%5E2%7D,%5Cldots,%20e%5E%7Bx_N%5E2%20-%20max_N%5E2%7D%5D%20%5Cright%5D%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cleft%5B%20e%5E%7Bmax_N%5E1%20-%20max_%7B2N%7D%7D%20f(x%5E1)%20,%20e%5E%7Bmax_N%5E2%20-%20max_%7B2N%7D%7D%20f(x%5E2)%20%5Cright%5D%20%5C%5C%0Asum_%7B2N%7D%20&amp;%20=%20%5Csum_%7Bi%20=%201%7D%5EN%20e%5E%7Bx_i%5E1%20-%20max_%7B2N%7D%7D%20+%20%5Csum_%7Bi%20=%201%7D%5EN%20e%5E%7Bx_i%5E2%20-%20max_%7B2N%7D%7D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20&amp;%20=%20e%5E%7Bmax_N%5E1%20-%20max_%7B2N%7D%7D%20%5Csum_%7Bi%20=%201%7D%5EN%20e%5E%7Bx_i%5E1%20-%20max_%7BN%7D%5E1%7D%20+%20e%5E%7Bmax_N%5E2%20-%20max_%7B2N%7D%7D%20%5Csum_%7Bi%20=%201%7D%5EN%20e%5E%7Bx_i%5E2%20-%20max_%7BN%7D%5E2%7D%20%5C%5C%0A%20%20%20%20%20%20%20%20%20&amp;%20=%20e%5E%7Bmax_N%5E1%20-%20max_%7B2N%7D%7D%20sum_N%5E1%20+%20e%5E%7Bmax_N%5E2%20-%20max_%7B2N%7D%7D%20sum_N%5E2%20%5C%5C%0Asoftmax(X)%20&amp;=%20%5Cfrac%7Bf(X)%7D%7Bsum_%7B2N%7D%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>此时可以发现，除了每个子向量的 <img src="https://latex.codecogs.com/png.latex?max%5Ej"> 用于计算 <img src="https://latex.codecogs.com/png.latex?f(x%5Ej),%20sum%5Ej">，还需要维护整体的<img src="https://latex.codecogs.com/png.latex?max,%20sum">用于计算最终的结果。</p>
<p>flash attention的tiling就是将<img src="https://latex.codecogs.com/png.latex?x_i">向量化,基于1-pass attention的公式，结合tiled softmax公式，只需要略微修改<img src="https://latex.codecogs.com/png.latex?max_i,sum_i">的计算即可得到flash attention的公式： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Bfor%20i%20in%20%5B1,%20N/b%5D%7D:&amp;%5C%5C%0A%20%20x_i%20&amp;=%20Q%5Bk,%20:%5DK%5ET%5B:,%20i:i+b%5D%5C%5C%0A%20%20max_i%5E%7Blocal%7D%20&amp;=%20max(x_i)%20%5C%5C%0A%20%20max_i%20&amp;=%20%5Cmax(max_%7Bi-1%7D,%20max_i%5E%7Blocal%7D)%20%5C%5C%0A%20%20sum_i%5E%5Cprime%20&amp;=%20sum_%7Bi-1%7D%20%5E%5Cprime%20e%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+%20%5Csum_%7Bj=1%7D%5E%7Bb%7D%20e%5E%7Bx_i%5Bj%5D%20-%20max_i%7D%5C%5C%0A%20%20o_i%5E%5Cprime%20&amp;=%20o_%7Bi-1%7D%5E%5Cprime%20%5Cfrac%7Bsum_%7Bi-1%7D%5E%5Cprime%7D%7Bsum_%7Bi%7D%5E%5Cprime%7De%5E%7Bmax_%7Bi-1%7D%20-%20max_i%7D%20+%20%5Csum_%7Bj=1%7D%5Eb%20%5Cfrac%7Be%5E%7Bx_i%5Bj%5D%20-%20max_i%7D%7D%7Bsum_i%5E%5Cprime%7D%20V%5B(i-1)b+j,:%5D%20%5C%5C%0A%5Ctext%7Bend%7D%5Cqquad%20%5Cqquad%5C%5C%0A%20%20O%5Bk,:%5D%20&amp;%20=%20o_N%0A%5Cend%7Baligned%7D%0A"></p>
<p>附上一个简易的flash attention实现供参考：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pytest</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-6"></span>
<span id="cb1-7"></span>
<span id="cb1-8">np.set_printoptions(suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> flash_attn(query: np.ndarray, key: np.ndarray, value: np.ndarray, attn_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, dropout_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>,</span>
<span id="cb1-12">               is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, enable_gqa<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb1-13">  L, S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], key.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-14">  scale_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> math.sqrt(query.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> scale <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> scale</span>
<span id="cb1-15">  attn_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros((L, S), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query.dtype)</span>
<span id="cb1-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> is_causal:</span>
<span id="cb1-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> attn_mask <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb1-18">    temp_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.tril(np.ones((L, S), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.bool_), k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-19">    attn_bias[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> temp_mask] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-inf"</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attn_mask <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attn_mask.dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> np.bool_:</span>
<span id="cb1-23">      attn_bias[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> attn_mask] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.inf</span>
<span id="cb1-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-25">      attn_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attn_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> attn_bias</span>
<span id="cb1-26"></span>
<span id="cb1-27">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> enable_gqa <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GQA not implemented"</span></span>
<span id="cb1-28"></span>
<span id="cb1-29">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> head <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(query.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb1-30">    Q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query[head]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [query_len, dim]</span></span>
<span id="cb1-31">    K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> key[head]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [seq_len, dim]</span></span>
<span id="cb1-32">    V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value[head]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [seq_len, dim]</span></span>
<span id="cb1-33">    O <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros_like(Q, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [query_len, dim]</span></span>
<span id="cb1-34">    Tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-35">    Tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb1-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-38"></span>
<span id="cb1-39">    global_maxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros([Tr, L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Tr], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32)</span>
<span id="cb1-40">    global_sums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros([Tr, L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Tr], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32)</span>
<span id="cb1-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, S, Tc):</span>
<span id="cb1-42">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outer loop is seq_len, because seq_len is `K` dimension, we can reuse Kj,Vj `query_len/Tc` times</span></span>
<span id="cb1-43">      Kj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> K[j:j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tc, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tc, dim]</span></span>
<span id="cb1-44">      Vj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> V[j:j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tc, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tc, dim]</span></span>
<span id="cb1-45">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (ii, i) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, L, Tr)):</span>
<span id="cb1-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load</span></span>
<span id="cb1-47">        Qi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Q[i:i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tr, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, dim]</span></span>
<span id="cb1-48">        O_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> O[i:i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tr, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, dim]</span></span>
<span id="cb1-49">        max_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.zeros([Tr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.inf) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> global_maxs[:, ii:ii <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-50">        sum_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros([Tr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> global_sums[:, ii:ii <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-51"></span>
<span id="cb1-52">        a_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (Qi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Kj.T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale_factor  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, Tc]</span></span>
<span id="cb1-53">        a_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> attn_bias[i:i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tr, j:j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tc]</span>
<span id="cb1-54">        max_local <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(a_ij, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, 1]</span></span>
<span id="cb1-55">        max_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.maximum(max_last, max_local)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, 1]</span></span>
<span id="cb1-56">        p_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(a_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> max_i)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, Tc]</span></span>
<span id="cb1-57">        sum_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sum_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.exp(max_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> max_i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p_ij, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, 1]</span></span>
<span id="cb1-58">        O_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> O_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (sum_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.exp(max_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> max_i)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sum_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (p_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sum_i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Vj  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [Tr, dim]</span></span>
<span id="cb1-59"></span>
<span id="cb1-60">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store</span></span>
<span id="cb1-61">        O[i:i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Tr, :] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> O_i</span>
<span id="cb1-62">        global_maxs[:, ii:ii <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> max_i</span>
<span id="cb1-63">        global_sums[:, ii:ii <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sum_i</span>
<span id="cb1-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> O</span>
<span id="cb1-65"></span>
<span id="cb1-66"></span>
<span id="cb1-67"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"head_q, head_kv"</span>, [(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)])</span>
<span id="cb1-68"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query_len, seq_len"</span>, [(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)])</span>
<span id="cb1-69"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim"</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb1-70"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_causal"</span>, [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>])</span>
<span id="cb1-71"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>])</span>
<span id="cb1-72"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_flash_attention(head_q, head_kv, query_len, seq_len, dim, is_causal, scale):</span>
<span id="cb1-73">  query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.rand(head_q, query_len, dim).astype(np.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [head_q, query_len, dim]</span></span>
<span id="cb1-74">  key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.rand(head_kv, seq_len, dim).astype(np.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [head_kv, seq_len, dim]</span></span>
<span id="cb1-75">  value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.rand(head_kv, seq_len, dim).astype(np.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [head_kv, seq_len, dim]</span></span>
<span id="cb1-76"></span>
<span id="cb1-77">  o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.scaled_dot_product_attention(</span>
<span id="cb1-78">      torch.tensor(query), torch.tensor(key), torch.tensor(value), is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>is_causal, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale)</span>
<span id="cb1-79">  o_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o.numpy()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [q_head,query,dim]</span></span>
<span id="cb1-80"></span>
<span id="cb1-81">  o_actual <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flash_attn(query, key, value, is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>is_causal, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale)</span>
<span id="cb1-82"></span>
<span id="cb1-83">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> np.allclose(o_np, o_actual, atol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-7</span>)</span>
<span id="cb1-84"></span>
<span id="cb1-85"></span>
<span id="cb1-86"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb1-87">  pytest.main([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__file__</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-vvs"</span>])</span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>推理框架</category>
  <guid>https://zhen8838.github.io/posts/flashattn.html</guid>
  <pubDate>Fri, 26 Sep 2025 15:36:24 GMT</pubDate>
</item>
<item>
  <title>Chimera: An Analytical Optimizing Framework for Effective Compute-intensive Operators Fusion</title>
  <link>https://zhen8838.github.io/posts/chimera.html</link>
  <description><![CDATA[ 




<p>这是zheng size的一篇分析建模的文章，思路和<a href="https://zhen8838.github.io/2024/04/30/model-driven-optimization/">Model Driven Optimization</a>类似，但是细节上有一些差异，简单总结一下。</p>
<!--more-->
<section id="block-decomposition" class="level1">
<h1>Block Decomposition</h1>
<p>首先给定一个两个矩阵乘的例子, 下图中隐含了他的reuse dim的计算方式：</p>
<p><img src="https://zhen8838.github.io/posts/chimera/order_with_reuse.png" class="img-fluid"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 当前所有循环中最后参与访问的循环内部的循环即为reuse dims</span></span>
<span id="cb1-2">reuse_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> perms[last_access_dim(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span>, perms) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]</span></code></pre></div></div>
<p>比如上图中<code>mnkl</code>的顺序，其中<code>m,k</code>参与访问<code>A</code>， 因此只有<code>l</code>是reuse dim.</p>
<p>分层是为了单独求解当前层的循环顺序，因为在<code>Model Driven Optimization</code>中说了，如果两个层级，那么他们的循环并不是全部组合，而是分层组合。</p>
<p>然后每个层在给定的loop order中计算DV，MU，这里的<code>Decomposition parameters S</code>就是tile var。计算DM的逻辑比<code>Model Driven Optimization</code>进行了一些简化，如果是reuse dim就跳过，否则就乘上。 我理解他是认为他后面已经限制了<code>sum(MU) &lt; capacity</code>，所以不存在超过cachesize的问题了。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> : Operator chain Ops</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> : Permutation Perm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (lp1, lp2, ..., lpI )</span>
<span id="cb2-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> : Decomposition parameters S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (s1, s2, ..., sI)</span>
<span id="cb2-4">output : data movement volume DV</span>
<span id="cb2-5">output : memory usage MU</span>
<span id="cb2-6"></span>
<span id="cb2-7">DV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, MU <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> op <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span>  Ops:</span>
<span id="cb2-9">    total_DF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tensor T <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> op.allTensors():</span>
<span id="cb2-11">        DF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getFootprint(T, S)</span>
<span id="cb2-12">        total_DF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> DF</span>
<span id="cb2-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> T <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Ops.IOTensors():</span>
<span id="cb2-14">            DM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DF</span>
<span id="cb2-15">            keep_reuse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> true</span>
<span id="cb2-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> loop lpi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reversed</span>(Perm):</span>
<span id="cb2-17">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> lpi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> op.allLoops():</span>
<span id="cb2-18">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> lpi accesses tensor T:</span>
<span id="cb2-19">                        keep_reuse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> false</span>
<span id="cb2-20">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> keep_reuse:</span>
<span id="cb2-21">                        DM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> ceil(Lpi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> spi)</span>
<span id="cb2-22">            DV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> DM</span>
<span id="cb2-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> loop lpi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Perm:</span>
<span id="cb2-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> lpi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> private to op:</span>
<span id="cb2-25">            Perm.erase(lpi)</span>
<span id="cb2-26">    MU <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(MU, total_DF)</span>
<span id="cb2-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> DV, MU</span></code></pre></div></div>
<p>通过这个算法计算之后，在<code>mlkn</code>的顺序下得到：</p>
<table class="caption-top table">
<colgroup>
<col style="width: 3%">
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 9%">
<col style="width: 22%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
<th>E</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DM</td>
<td><img src="https://latex.codecogs.com/png.latex?MK%20%5Cfrac%7BL%7D%7BT_L%7D"></td>
<td><img src="https://latex.codecogs.com/png.latex?KL%20%5Cfrac%7BM%7D%7BT_M%7D"></td>
<td>0</td>
<td>$ NL $</td>
<td>MN <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BL%7D%7BT_L%7D"></td>
</tr>
<tr class="even">
<td>DF</td>
<td><img src="https://latex.codecogs.com/png.latex?T_MT_K"></td>
<td><img src="https://latex.codecogs.com/png.latex?T_KT_L"></td>
<td><img src="https://latex.codecogs.com/png.latex?T_MT_L"></td>
<td><img src="https://latex.codecogs.com/png.latex?T_LT_N"></td>
<td><img src="https://latex.codecogs.com/png.latex?T_M%20T_N"></td>
</tr>
</tbody>
</table>
<p>所有访问到的数据都存在cache中，所以DF是通过access dim的tile来计算，DM这里是全部的access dim乘非reuse的次数。但是我还是有点疑惑，如果数据都在cache中，以<code>MLK</code>的顺序访问A真的会有重复load吗。</p>
<p>然后在约束MU的情况下最小化DV， <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0ADV_%7BGEMM%5C%20Chain%7D%20&amp;=D%20M_%7BA%7D+D%20M_%7BB%7D+D%20M_%7BC%7D+D%20M_%7BD%7D+D%20M_%7BE%7D%20%5C%5C%0A&amp;%20=%20M%20K%5Cleft%5Clceil%5Cfrac%7BL%7D%7BT_%7BL%7D%7D%5Cright%5Crceil+K%20L%5Cleft%5Clceil%5Cfrac%7BM%7D%7BT_%7BM%7D%7D%5Cright%5Crceil+N%20L%5Cleft%5Clceil%5Cfrac%7BM%7D%7BT_%7BM%7D%7D%5Cright%5Crceil+M%20N%5Cleft%5Clceil%5Cfrac%7BL%7D%7BT_%7BL%7D%7D%5Cright%5Crceil%20%5C%5C%0AMU%20&amp;=max%20%5Cleft%5C%7BGEMM%201_%7BM%20U%7D,%20GEMM%202_%7BM%20U%7D%5Cright%5C%7D%20%5C%5C%0AGEMM1_%7BM%20U%7D%20&amp;=D%20F_%7BA%7D+D%20F_%7BB%7D+D%20F_%7BC%7D=T_%7BM%7D%20T_%7BK%7D+T_%7BK%7D%20T_%7BL%7D+T_%7BM%7D%20T_%7BL%7D%20%5C%5C%0AGEMM%202_%7BM%20U%7D%20&amp;=D%20F_%7BC%7D+D%20F_%7BD%7D+D%20F_%7BE%7D=T_%7BM%7D%20T_%7BL%7D+T_%7BL%7D%20T_%7BN%7D+T_%7BM%7D%20T_%7BN%7D%20%5C%5C%0Amin_%7B%5Cvec%7BS%7D%7D%5C%20DV_%7BGEMM%5C%20Chain%7D,%5C%20&amp;s.t.%20MU%20%5Cleq%20MemoryCapacity%20(1)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="optimization-for-multi-level-memory-hierarchy" class="level1">
<h1>Optimization for Multi-level Memory Hierarchy</h1>
<p>对于多内存层级，他的思路与<code>Model Driven Optimization</code>一致，也是假设数据移动可以并行，最小化最大的数据移动cost。</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bgathered%7D%20min%20_%7B%5Cvec%7BS_%7B1%7D%7D,%20%5Cvec%7BS_%7B2%7D%7D,%20...,%20%5Cvec%7BS_%7BD%7D%7D%7D%5Cleft%5C%7Bmax%20%5Cleft%5C%7BCost_%7B1%7D%5Cleft(%5Cvec%7BS_%7B1%7D%7D%5Cright),%20...,%20Cost_%7BD%7D%5Cleft(%5Cvec%7BS_%7BD%7D%7D%5Cright)%5Cright%5C%7D%5Cright%5C%7D,%20%5C%5C%20s.t.%20MU_%7B1%7D%20%5Cleq%20M%20C_%7B1%7D,%20...,%20MU_%7BD%7D%20%5Cleq%20M%20C_%7BD%7D%20%5Cend%7Bgathered%7D%0A"></p>
</section>
<section id="implementation" class="level1">
<h1>Implementation</h1>
<p>我尝试对这篇论文做了一下复现, 最后的结果如下, 但感觉搜索到的k还是比较小，循环顺序还是比较合理的，倾向于把k移动到最内层:</p>
<pre><code>best perm:  ('m', 'n', 'k'), ('m', 'n', 'k') 
best tile:  ( 1 ,  1,  512), ( 4,   4,   1), (m:64, k:4, n:16), 180866</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itertools</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> amplpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AMPL</span>
<span id="cb4-3"></span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> solve_with_perms(all_perms: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]):</span>
<span id="cb4-6">    ap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AMPL()</span>
<span id="cb4-7">    ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reset;'</span>)</span>
<span id="cb4-8"></span>
<span id="cb4-9">    ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_m integer;</span></span>
<span id="cb4-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_k integer;</span></span>
<span id="cb4-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_n integer;</span></span>
<span id="cb4-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_m integer;</span></span>
<span id="cb4-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_k integer;</span></span>
<span id="cb4-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_n integer;</span></span>
<span id="cb4-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L0_m integer;</span></span>
<span id="cb4-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L0_k integer;</span></span>
<span id="cb4-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L0_n integer;</span></span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_A_DF = (L1_m * L0_m) * (L1_k * L0_k) * 4;</span></span>
<span id="cb4-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_B_DF = (L1_n * L0_n) * (L1_k * L0_k) * 4 * 4 * 4;</span></span>
<span id="cb4-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L2_C_DF = (L1_m * L0_m) * (L1_n * L0_n) * 4 * 4 * 4;</span></span>
<span id="cb4-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_A_DF = (L0_m) * (L0_k) * 4;</span></span>
<span id="cb4-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_B_DF = (L0_n) * (L0_k) * 4 * 4 * 4;</span></span>
<span id="cb4-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var L1_C_DF = (L0_m) * (L0_n) * 4 * 4 * 4;</span></span>
<span id="cb4-26"></span>
<span id="cb4-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  """</span>)</span>
<span id="cb4-28"></span>
<span id="cb4-29">    access <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'m'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>],</span>
<span id="cb4-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>],</span>
<span id="cb4-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'m'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>]</span>
<span id="cb4-33">    }</span>
<span id="cb4-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> level <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb4-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> bf <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>]:</span>
<span id="cb4-36">            level_perms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> all_perms[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(all_perms) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> level]</span>
<span id="cb4-37"></span>
<span id="cb4-38">            params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'L</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>level<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_DF'</span>]</span>
<span id="cb4-39">            axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(level_perms) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-40">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> level_perms[axis] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> access[bf]:</span>
<span id="cb4-41">              axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-42">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb4-43">              params.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'L</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>level<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>level_perms[axis]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-44">              axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-45">            dm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'var L</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>level<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_DM = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" * "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(params)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">;'</span></span>
<span id="cb4-46">            ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(dm)</span>
<span id="cb4-47"></span>
<span id="cb4-48">    ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L2_m_c: L2_m &gt;= 1;</span></span>
<span id="cb4-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L2_k_c: L2_k &gt;= 1;</span></span>
<span id="cb4-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L2_n_c: L2_n &gt;= 1;</span></span>
<span id="cb4-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L1_m_c: L1_m &gt;= 1;</span></span>
<span id="cb4-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L1_k_c: L1_k &gt;= 1;</span></span>
<span id="cb4-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L1_n_c: L1_n &gt;= 1;</span></span>
<span id="cb4-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L0_m_c: L0_m &gt;= 1;</span></span>
<span id="cb4-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L0_k_c: L0_k &gt;= 1;</span></span>
<span id="cb4-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to L0_n_c: L0_n &gt;= 1;</span></span>
<span id="cb4-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to M_c: (L0_m*L1_m*L2_m) = 256;</span></span>
<span id="cb4-59"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to K_c: (L0_k*L1_k*L2_k) = 2048;</span></span>
<span id="cb4-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to N_c: (L0_n*L1_n*L2_n) = 64;</span></span>
<span id="cb4-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var l1_DF = (L1_A_DF + L1_B_DF + L1_C_DF);</span></span>
<span id="cb4-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var l2_DF = (L2_A_DF + L2_B_DF + L2_C_DF);</span></span>
<span id="cb4-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to l1_capacity_c: l1_DF &lt;= (512 * 1024);</span></span>
<span id="cb4-64"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to l2_capacity_c: l2_DF &lt;= (1024 * 1024);</span></span>
<span id="cb4-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  """</span>)</span>
<span id="cb4-66">    ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  var mem_cost integer;</span></span>
<span id="cb4-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to max_c2: ((L2_A_DM + L2_B_DM + L2_C_DM) / 64) &lt;= mem_cost;</span></span>
<span id="cb4-69"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  subject to max_c1: ((L1_A_DM + L1_B_DM + L1_C_DM) / 16) &lt;= mem_cost;</span></span>
<span id="cb4-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  minimize total_cost: mem_cost;</span></span>
<span id="cb4-71"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  """</span>)</span>
<span id="cb4-72"></span>
<span id="cb4-73">    ap.solve(solver<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'couenne'</span>) </span>
<span id="cb4-74"></span>
<span id="cb4-75">    L2_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_m'</span>)</span>
<span id="cb4-76">    L2_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_k'</span>)</span>
<span id="cb4-77">    L2_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_n'</span>)</span>
<span id="cb4-78">    L1_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_m'</span>)</span>
<span id="cb4-79">    L1_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_k'</span>)</span>
<span id="cb4-80">    L1_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_n'</span>)</span>
<span id="cb4-81">    L0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_m'</span>)</span>
<span id="cb4-82">    L0_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_k'</span>)</span>
<span id="cb4-83">    L0_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_n'</span>)</span>
<span id="cb4-84">    total_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_cost'</span>)</span>
<span id="cb4-85">    l1_DF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l1_DF'</span>)</span>
<span id="cb4-86">    l2_DF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ap.get_value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l2_DF'</span>)</span>
<span id="cb4-87">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_perms:"</span>, all_perms, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_m'</span>, L2_m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_k'</span>, L2_k, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L2_n'</span>, L2_n, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_m'</span>, L1_m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_k'</span>,</span>
<span id="cb4-88">          L1_k, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L1_n'</span>, L1_n, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_m'</span>, L0_m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_k'</span>, L0_k, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L0_n'</span>, L0_n, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_cost'</span>, total_cost, </span>
<span id="cb4-89">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l1_DF'</span>, l1_DF,</span>
<span id="cb4-90">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l2_DF'</span>, l2_DF)</span>
<span id="cb4-91">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (L2_m, L2_k, L2_n, L1_m, L1_k, L1_n, L0_m, L0_k, L0_n, total_cost)</span>
<span id="cb4-92"></span>
<span id="cb4-93"></span>
<span id="cb4-94"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb4-95">    max_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9999999</span></span>
<span id="cb4-96">    best_res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-97">    best_perm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-98">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> l2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.permutations([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'m'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb4-99">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> l1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itertools.permutations([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'m'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb4-100">            res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solve_with_perms([l2, l1])</span>
<span id="cb4-101">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> res[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> max_cost:</span>
<span id="cb4-102">                max_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-103">                best_res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res</span>
<span id="cb4-104">                best_perm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (l2, l1)</span>
<span id="cb4-105">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best perm: "</span>, best_perm, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best tile: "</span>, best_res)</span></code></pre></div></div>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/chimera.html</guid>
  <pubDate>Thu, 28 Aug 2025 02:51:52 GMT</pubDate>
</item>
<item>
  <title>推理框架调研</title>
  <link>https://zhen8838.github.io/posts/vllm.html</link>
  <description><![CDATA[ 




<p>记录一下学习vllm/trt llm等框架的内容。</p>
<!--more-->
<section id="llm模型结构" class="level1">
<h1>LLM模型结构</h1>
<p>虽然用编译器编译了挺久的LLM，但其实对于宏观上的模型结构还是理解的不够深入。</p>
<p><img src="https://zhen8838.github.io/posts/vllm/llama_arch.png" class="img-fluid"></p>
<p>首先现在的LLM基本上是重复Attention + FFN的结构，Attention里面首先有三个权重矩阵来计算得到QKV。 然后把QKV转换为<code>[batch,num_head,seq_len,head_size]</code>的形式, 然后是<code>Q*K^T</code>,这一步是计算每个head的相似度，计算完之后head size进行了规约，得到<code>[batch,num_head,seq_len,total_seq_len]</code>，然后是scaling以及softmax。后面再和V的<code>total seq len</code>维度进行规约，最后又得到<code>[batch,num_head,seq_len,head_size]</code>的输出。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">q: [batch,num_head,target_len,head_size]</span>
<span id="cb1-2">k: [batch,num_head,source_len,head_size]</span>
<span id="cb1-3">v: [batch,num_head,source_len,head_size]</span>
<span id="cb1-4">s: [batch,num_head,target_len,source_len] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> k.T</span>
<span id="cb1-5">s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mask</span>
<span id="cb1-6">s: [batch,num_head,target_len,source_len] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> softmax(s,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-7">d: [batch,num_head,target_len,head_size] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> v</span></code></pre></div></div>
<p><img src="https://zhen8838.github.io/posts/vllm/attention.png" class="img-fluid"></p>
</section>
<section id="vllm" class="level1">
<h1>vllm</h1>
<p>vll支持的优化： 1. Continuous Batching 2. Paged Attention 3. Chunked Prefill 要把decode融合到prefill中一起执行，当然比如要求<code>[prefill_token,decode_token]</code>的排列顺序。</p>
<section id="安装-开发" class="level2">
<h2 class="anchored" data-anchor-id="安装-开发">安装 &amp; 开发</h2>
<p>为了构建一个方便调试的开发环境，可以采用官方镜像, 并且需要自己修改entrypoint：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gpus</span> all <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--name</span> vllm_dev <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--cap-add</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>NET_ADMIN <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--network</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>host <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--privileged</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--shm-size</span> 50g <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--entrypoint</span> /bin/bash <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-9">  vllm/vllm-openai:latest <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"while true; do sleep 10; done"</span></span></code></pre></div></div>
<p>进入官方镜像之后，他自带一个python3的环境，并且安装好了所有依赖，所以直接clone最新的vllm的并只安装python部分即可：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://gitee.com/mirrors/vllm.git</span>
<span id="cb3-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> vllm</span>
<span id="cb3-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">VLLM_TARGET_DEVICE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cuda</span>
<span id="cb3-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">VLLM_USE_PRECOMPILED</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span>
<span id="cb3-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> use_existing_torch.py</span>
<span id="cb3-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-build-isolation</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span> .</span></code></pre></div></div>
</section>
<section id="cuda-graph" class="level2">
<h2 class="anchored" data-anchor-id="cuda-graph">cuda graph</h2>
<p>基于qwen 2.5 0.5b， 在<code>vllm/worker/model_runner.py</code>中1915行，注意他这里capture并不是一次，而是类似shape bucket, 迭代这些batch size<code>[256, 248, 240, 232, 224, 216, 208, 200, 192, 184, 176, 168, 160, 152, 144, 136, 128, 120, 112, 104, 96, 88, 80, 72, 64, 56, 48, 40, 32, 24, 16, 8, 4, 2, 1]</code>，他们也只会在batch上进行capture。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._graph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cuda.CUDAGraph()</span>
<span id="cb4-2">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._graph.enable_debug_mode()</span>
<span id="cb4-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.cuda.graph(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._graph, pool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>memory_pool, stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stream):</span>
<span id="cb4-4">            output_hidden_or_intermediate_states <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model(</span>
<span id="cb4-5">                input_ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>input_ids, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [256]</span></span>
<span id="cb4-6">                positions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>positions, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [256]</span></span>
<span id="cb4-7">                kv_caches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kv_caches, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [[2, 103168, 16, 2, 64], [2, 103168, 16, 2, 64],...] 24个</span></span>
<span id="cb4-8">                attn_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>attn_metadata,</span>
<span id="cb4-9">                intermediate_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>intermediate_inputs,</span>
<span id="cb4-10">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs,</span>
<span id="cb4-11">            )</span>
<span id="cb4-12"></span>
<span id="cb4-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(output_hidden_or_intermediate_states, torch.Tensor):</span>
<span id="cb4-14">                hidden_or_intermediate_states <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weak_ref_tensor(</span>
<span id="cb4-15">                    output_hidden_or_intermediate_states)</span>
<span id="cb4-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(output_hidden_or_intermediate_states,</span>
<span id="cb4-17">                            IntermediateTensors):</span>
<span id="cb4-18">                hidden_or_intermediate_states <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> IntermediateTensors(</span>
<span id="cb4-19">                    tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb4-20">                        key: weak_ref_tensor(value)</span>
<span id="cb4-21">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb4-22">                        output_hidden_or_intermediate_states.tensors.items()</span>
<span id="cb4-23">                    })</span>
<span id="cb4-24"></span>
<span id="cb4-25">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> output_hidden_or_intermediate_states</span>
<span id="cb4-26">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make sure `output_hidden_or_intermediate_states` is deleted</span></span>
<span id="cb4-27">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in the graph's memory pool</span></span>
<span id="cb4-28">            gc.collect()</span>
<span id="cb4-29">        torch.cuda.synchronize()</span>
<span id="cb4-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._graph.debug_dump(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/vllm_learn/graph.dot"</span>)</span></code></pre></div></div>
<p>不过他这里生成的cuda graph是这样的，并没有shape。 <img src="https://zhen8838.github.io/posts/vllm/cuda_graph.png" class="img-fluid"></p>
</section>
<section id="attention-layer-size-trace" class="level2">
<h2 class="anchored" data-anchor-id="attention-layer-size-trace">attention layer size trace</h2>
<p>在模型初始化的时候，会用最大的batch size trace一次， 这是每一个att的打印代码：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(</span>
<span id="cb5-2">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb5-3">        positions: torch.Tensor,</span>
<span id="cb5-4">        hidden_states: torch.Tensor,</span>
<span id="cb5-5">        kv_cache: torch.Tensor,</span>
<span id="cb5-6">        attn_metadata: AttentionMetadata,</span>
<span id="cb5-7">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> torch.Tensor:</span>
<span id="cb5-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hidden_states"</span>, hidden_states.shape) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [1, 896]</span></span>
<span id="cb5-9">        qkv, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.qkv_proj(hidden_states) </span>
<span id="cb5-10">        q, k, v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qkv.split([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q_size, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kv_size, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kv_size], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"q"</span>, q.shape,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, k.shape,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v"</span>, v.shape)</span>
<span id="cb5-12">        q, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.rotary_emb(positions, q, k)</span>
<span id="cb5-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ro q"</span>, q.shape,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ro k"</span>, k.shape)</span>
<span id="cb5-14">        attn_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attn(q, k, v, kv_cache, attn_metadata)</span>
<span id="cb5-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"attn_output"</span>, attn_output.shape)</span>
<span id="cb5-16">        output, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.o_proj(attn_output)</span>
<span id="cb5-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>, output.shape)</span>
<span id="cb5-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span>
<span id="cb5-19"></span>
<span id="cb5-20">hidden_states torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb5-21">q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>]) v torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb5-22">ro q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) ro k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb5-23">attn_output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb5-24">output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span></code></pre></div></div>
<p>然后是prefill：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">hidden_states torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb6-2">q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>]) v torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb6-3">ro q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) ro k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb6-4">attn_output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb6-5">output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span></code></pre></div></div>
<p>接下来是decode:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">hidden_states torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb7-2">q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>]) v torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb7-3">ro q torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>]) ro k torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb7-4">attn_output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span>
<span id="cb7-5">output torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">896</span>])</span></code></pre></div></div>
<p>所以最重要的就是看decode的时候是如何适配seq len增长的。</p>
</section>
<section id="vllm-attention-detail" class="level2">
<h2 class="anchored" data-anchor-id="vllm-attention-detail">vllm attention detail</h2>
<p>这是vllm中对于attention类的的设计： <img src="https://zhen8838.github.io/posts/vllm/vllm_attn.png" class="img-fluid"></p>
<p>这是vllm调度出来的请求与attention的meta data的对应关系图： <img src="https://zhen8838.github.io/posts/vllm/vllm scheduled requests.png" class="img-fluid"></p>
<p>在decode的时候，会调用<code>vllm/attention/layer.py</code>的attention：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(</span>
<span id="cb8-2">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb8-3">        query: torch.Tensor,</span>
<span id="cb8-4">        key: torch.Tensor,</span>
<span id="cb8-5">        value: torch.Tensor,</span>
<span id="cb8-6">        kv_cache: torch.Tensor,</span>
<span id="cb8-7">        attn_metadata: AttentionMetadata,</span>
<span id="cb8-8">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> torch.Tensor:</span>
<span id="cb8-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: please avoid accessing `kv_cache` and `attn_metadata` arguments</span></span>
<span id="cb8-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># directly, use `self.kv_cache` and</span></span>
<span id="cb8-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `get_forward_context().attn_metadata` instead.</span></span>
<span id="cb8-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.calculate_kv_scales:</span>
<span id="cb8-13">            ctx_attn_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_forward_context().attn_metadata</span>
<span id="cb8-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ctx_attn_metadata.enable_kv_scales_calculation:</span>
<span id="cb8-15">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.calc_kv_scales(key, value)</span>
<span id="cb8-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.use_output:</span>
<span id="cb8-17">            output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty_like(query)</span>
<span id="cb8-18">            hidden_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape the query, key, and value tensors.</span></span>
<span id="cb8-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(woosuk): We do this outside the custom op to minimize the</span></span>
<span id="cb8-21">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CPU overheads from the non-CUDA-graph regions.</span></span>
<span id="cb8-22">            query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.num_heads, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.head_size)</span>
<span id="cb8-23">            output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.num_heads, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.head_size)</span>
<span id="cb8-24">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> key <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-25">                key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> key.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.num_kv_heads, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.head_size)</span>
<span id="cb8-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-27">                value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.num_kv_heads, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.head_size)</span>
<span id="cb8-28">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.use_direct_call:</span>
<span id="cb8-29">                forward_context: ForwardContext <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_forward_context()</span>
<span id="cb8-30">                ctx_attn_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_context.attn_metadata</span>
<span id="cb8-31">                self_kv_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kv_cache[forward_context.virtual_engine]</span>
<span id="cb8-32">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.impl.forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb8-33">                                  query,</span>
<span id="cb8-34">                                  key,</span>
<span id="cb8-35">                                  value,</span>
<span id="cb8-36">                                  self_kv_cache,</span>
<span id="cb8-37">                                  ctx_attn_metadata,</span>
<span id="cb8-38">                                  output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>output)</span>
<span id="cb8-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-40">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note 上面把q都reshape到 [batch,num_heads,head_size]， kv转换为[num_kv_heads, head_size]</span></span>
<span id="cb8-41">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># q [1,1,64] , k,v [1,2,64]</span></span>
<span id="cb8-42">                torch.ops.vllm.unified_attention_with_output(</span>
<span id="cb8-43">                    query, key, value, output, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layer_name)</span>
<span id="cb8-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, hidden_size)</span>
<span id="cb8-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.use_direct_call:</span>
<span id="cb8-47">                forward_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_forward_context()</span>
<span id="cb8-48">                ctx_attn_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_context.attn_metadata</span>
<span id="cb8-49">                self_kv_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kv_cache[forward_context.virtual_engine]</span>
<span id="cb8-50">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.impl.forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, query, key, value,</span>
<span id="cb8-51">                                         self_kv_cache, ctx_attn_metadata)</span>
<span id="cb8-52">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-53">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.ops.vllm.unified_attention(</span>
<span id="cb8-54">                    query, key, value, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layer_name)</span>
<span id="cb8-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 虽然torch.ops.vllm.unified_attention_with_output看起来没有使用kv cache，但是实际上是使用了的。</span></span>
<span id="cb8-56"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> unified_attention_with_output(</span>
<span id="cb8-57">    query: torch.Tensor,</span>
<span id="cb8-58">    key: torch.Tensor,</span>
<span id="cb8-59">    value: torch.Tensor,</span>
<span id="cb8-60">    output: torch.Tensor,</span>
<span id="cb8-61">    layer_name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb8-62">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-63">    forward_context: ForwardContext <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_forward_context()</span>
<span id="cb8-64">    attn_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_context.attn_metadata</span>
<span id="cb8-65">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_context.attn_layers[layer_name]</span>
<span id="cb8-66">    kv_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kv_cache[forward_context.virtual_engine]</span>
<span id="cb8-67">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.impl.forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb8-68">                      query,</span>
<span id="cb8-69">                      key,</span>
<span id="cb8-70">                      value,</span>
<span id="cb8-71">                      kv_cache,</span>
<span id="cb8-72">                      attn_metadata,</span>
<span id="cb8-73">                      output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>output)</span></code></pre></div></div>
<p>检查当前的attn metadata：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">FlashAttentionMetadata(num_prefills<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_prefill_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_decode_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>), multi_modal_placeholder_index_maps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{}, enable_kv_scales_calculation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), max_prefill_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, max_decode_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>, context_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), use_cuda_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, max_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_decode_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, query_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([ <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), _cached_prefill_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, _cached_decode_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>FlashAttentionMetadata(num_prefills<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_prefill_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_decode_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>), multi_modal_placeholder_index_maps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, enable_kv_scales_calculation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), max_prefill_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, max_decode_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>, context_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), use_cuda_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, max_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_decode_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, query_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([ <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), _cached_prefill_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, _cached_decode_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>FlashAttentionMetadata(num_prefills<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_prefill_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, num_decode_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>), multi_modal_placeholder_index_maps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, enable_kv_scales_calculation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), max_prefill_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, max_decode_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>, context_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), use_cuda_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, max_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_decode_query_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, query_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tensor([ <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32), _cached_prefill_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, _cached_decode_metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, max_encoder_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, num_encoder_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), encoder_seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, max_encoder_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, num_encoder_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), encoder_seq_lens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_lens_tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, encoder_seq_start_loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, max_encoder_seq_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, num_encoder_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_slot_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cross_block_tables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb9-2"></span>
<span id="cb9-3">kv_cache: torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101291</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>])</span></code></pre></div></div>
<p>然后走到了<code>FlashAttentionImpl</code>.</p>
<p>注意这里在启用chunked prefill之后，一批token里面会同时存在prefill和decode，因此需要拆分为两个部分分别执行prefill的decode的attention。 同时这个只是在动态的情况下会被执行到，如果开启了cuda graph，那么decode阶段会直接走cuda graph replay，同时</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If the input tensors contain prompt tokens, the layout is as follows:</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;--------------- num_prefill_tokens -----------------&gt;|    </span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;--prefill_0--&gt;|&lt;--prefill_1--&gt;|...|&lt;--prefill_N-1---&gt;|</span></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Otherwise, the layout is as follows:    </span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;----------------- num_decode_tokens ------------------&gt;|  </span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;--decode_0--&gt;|..........|&lt;--decode_M-1--&gt;|&lt;--padding--&gt;|</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Generation tokens can contain padding when cuda-graph is used.</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Currently, prompt tokens don't contain any padding.</span></span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    The prompts might have different lengths, while the generation tokens</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    always have length 1.</span></span>
<span id="cb10-15"></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If chunked prefill is enabled, prefill tokens and decode tokens can be</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    batched together in a flattened 1D query.</span></span>
<span id="cb10-18"></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;----- num_prefill_tokens ----&gt;|&lt;------- num_decode_tokens ---------&gt;|</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    |&lt;-prefill_0-&gt;|...|&lt;-prefill_N-1-&gt;|&lt;--decode_0--&gt;|...|&lt;--decode_M-1--&gt;|</span></span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Currently, cuda graph is disabled for chunked prefill, meaning there's no</span></span>
<span id="cb10-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    padding between prefill and decode tokens.</span></span>
<span id="cb10-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(</span>
<span id="cb10-26">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb10-27">        layer: AttentionLayer,</span>
<span id="cb10-28">        query: torch.Tensor,</span>
<span id="cb10-29">        key: torch.Tensor,</span>
<span id="cb10-30">        value: torch.Tensor,</span>
<span id="cb10-31">        kv_cache: torch.Tensor,</span>
<span id="cb10-32">        attn_metadata: FlashAttentionMetadata,</span>
<span id="cb10-33">        output: Optional[torch.Tensor] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb10-34">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> torch.Tensor:</span>
<span id="cb10-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Forward pass with FlashAttention.</span></span>
<span id="cb10-36"></span>
<span id="cb10-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb10-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            query: shape = [num_tokens, num_heads, head_size]</span></span>
<span id="cb10-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            key: shape = [num_tokens, num_kv_heads, head_size]</span></span>
<span id="cb10-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            value: shape = [num_tokens, num_kv_heads, head_size]</span></span>
<span id="cb10-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            output: shape = [num_tokens, num_heads, head_size]</span></span>
<span id="cb10-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            kv_cache = [2, num_blocks, block_size, num_kv_heads, head_size]</span></span>
<span id="cb10-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: kv_cache will be an empty tensor with shape [0]</span></span>
<span id="cb10-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                for profiling run.</span></span>
<span id="cb10-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            attn_metadata: Metadata for attention.</span></span>
<span id="cb10-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: It in-place updates the output tensor.</span></span>
<span id="cb10-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb10-48">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(woosuk): FlashAttention does not support FP8 KV cache.</span></span>
<span id="cb10-49"></span>
<span id="cb10-50">        (num_prefill_query_tokens, num_prefill_kv_tokens,</span>
<span id="cb10-51">        num_decode_query_tokens) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb10-52">            get_num_prefill_decode_query_kv_tokens(attn_metadata, attn_type)</span>
<span id="cb10-53">        decode_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query[num_prefill_query_tokens:]</span>
<span id="cb10-54">        decode_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[num_prefill_query_tokens:]</span>
<span id="cb10-55">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># QKV for prefill.</span></span>
<span id="cb10-56">        query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query[:num_prefill_query_tokens]</span>
<span id="cb10-57">        prefill_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[:num_prefill_query_tokens]</span>
<span id="cb10-58">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> query.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> num_prefill_query_tokens</span>
<span id="cb10-59">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> decode_query.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> num_decode_query_tokens</span>
<span id="cb10-60">        </span>
<span id="cb10-61">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prefill_meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> attn_metadata.prefill_metadata:</span>
<span id="cb10-62">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prompt run.</span></span>
<span id="cb10-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (kv_cache.numel() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> prefill_meta.block_tables <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb10-64">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> prefill_meta.block_tables.numel() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb10-65">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normal attention</span></span>
<span id="cb10-66">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># When block_tables are not filled, it means q and k are the</span></span>
<span id="cb10-67">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prompt, and they have the same length.</span></span>
<span id="cb10-68">                q_seq_start_loc, q_seq_len, k_seq_start_loc, k_seq_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb10-69">                    _get_query_key_seq_metadata(prefill_meta, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, attn_type)</span>
<span id="cb10-70"></span>
<span id="cb10-71">                key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> key[:num_prefill_kv_tokens]</span>
<span id="cb10-72">                value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value[:num_prefill_kv_tokens]</span>
<span id="cb10-73"></span>
<span id="cb10-74">                flash_attn_varlen_func(</span>
<span id="cb10-75">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query,</span>
<span id="cb10-76">                    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key,</span>
<span id="cb10-77">                    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value,</span>
<span id="cb10-78">                    cu_seqlens_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>q_seq_start_loc,</span>
<span id="cb10-79">                    cu_seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k_seq_start_loc,</span>
<span id="cb10-80">                    max_seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>q_seq_len,</span>
<span id="cb10-81">                    max_seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k_seq_len,</span>
<span id="cb10-82">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb10-83">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_get_causal_option(attn_type),</span>
<span id="cb10-84">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb10-85">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb10-86">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb10-87">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_output,</span>
<span id="cb10-88">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb10-89">                )</span>
<span id="cb10-90">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb10-91">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prefix-enabled attention</span></span>
<span id="cb10-92">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> attn_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> AttentionType.DECODER, (</span>
<span id="cb10-93">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Only decoder-only models support prefix caching"</span>)</span>
<span id="cb10-94">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> prefill_meta.seq_lens <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb10-95">                max_seq_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(prefill_meta.seq_lens)</span>
<span id="cb10-96">                flash_attn_varlen_func(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># noqa</span></span>
<span id="cb10-97">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query,</span>
<span id="cb10-98">                    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key_cache,</span>
<span id="cb10-99">                    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value_cache,</span>
<span id="cb10-100">                    cu_seqlens_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_meta.query_start_loc,</span>
<span id="cb10-101">                    max_seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_meta.max_query_len,</span>
<span id="cb10-102">                    seqused_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_meta.seq_lens_tensor,</span>
<span id="cb10-103">                    max_seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_seq_len,</span>
<span id="cb10-104">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb10-105">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-106">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb10-107">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb10-108">                    block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_meta.block_tables,</span>
<span id="cb10-109">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb10-110">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prefill_output,</span>
<span id="cb10-111">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb10-112">                )</span>
<span id="cb10-113"></span>
<span id="cb10-114">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> decode_meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> attn_metadata.decode_metadata:</span>
<span id="cb10-115">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Decoding run.</span></span>
<span id="cb10-116">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use flash_attn_varlen_func kernel for speculative decoding</span></span>
<span id="cb10-117">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># because different queries might have different lengths.</span></span>
<span id="cb10-118"></span>
<span id="cb10-119">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> decode_meta.max_decode_query_len <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb10-120">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use only for actual varlen decoding</span></span>
<span id="cb10-121">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> decode_meta.max_decode_query_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb10-122">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> attn_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> AttentionType.DECODER, (</span>
<span id="cb10-123">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Only decoder-only models support max_decode_query_len &gt; 1"</span></span>
<span id="cb10-124">                )</span>
<span id="cb10-125">                flash_attn_varlen_func(</span>
<span id="cb10-126">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_query,</span>
<span id="cb10-127">                    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key_cache,</span>
<span id="cb10-128">                    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value_cache,</span>
<span id="cb10-129">                    cu_seqlens_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.query_start_loc,</span>
<span id="cb10-130">                    max_seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.max_decode_query_len,</span>
<span id="cb10-131">                    seqused_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.seq_lens_tensor,</span>
<span id="cb10-132">                    max_seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.max_decode_seq_len,</span>
<span id="cb10-133">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb10-134">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-135">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb10-136">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb10-137">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb10-138">                    block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.block_tables,</span>
<span id="cb10-139">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_output,</span>
<span id="cb10-140">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb10-141">                )</span>
<span id="cb10-142">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb10-143">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use flash_attn_with_kvcache for normal decoding.</span></span>
<span id="cb10-144">                (</span>
<span id="cb10-145">                    seq_lens_arg,</span>
<span id="cb10-146">                    _,</span>
<span id="cb10-147">                    block_tables_arg,</span>
<span id="cb10-148">                ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_seq_len_block_table_args(decode_meta, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, attn_type)</span>
<span id="cb10-149">                flash_attn_with_kvcache(</span>
<span id="cb10-150">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_query.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb10-151">                    k_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key_cache,</span>
<span id="cb10-152">                    v_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value_cache,</span>
<span id="cb10-153">                    block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>block_tables_arg,</span>
<span id="cb10-154">                    cache_seqlens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seq_lens_arg,</span>
<span id="cb10-155">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb10-156">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-157">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb10-158">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb10-159">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb10-160">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_output.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb10-161">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb10-162">                )</span>
<span id="cb10-163">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span></code></pre></div></div>
<p>他上面实际上就是分三部分，首先是kv的reshape:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> kv_cache.numel() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb11-2">            key_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kv_cache[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-3">            value_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kv_cache[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-4">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We skip updating the KV cache under two conditions:</span></span>
<span id="cb11-5">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  a. When the Attention Type is ENCODER. In this phase, we compute</span></span>
<span id="cb11-6">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     only the encoder attention without updating the cache.</span></span>
<span id="cb11-7">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  b. When both Key and Value are None. This occurs during</span></span>
<span id="cb11-8">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     cross-attention computation in the decoding phase, where the</span></span>
<span id="cb11-9">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     KV cache is already populated with the cross-attention</span></span>
<span id="cb11-10">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     tensor. Thus, we skip cache updates during this time.</span></span>
<span id="cb11-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (attn_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> AttentionType.ENCODER) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> (key <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> (</span>
<span id="cb11-12">                    value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb11-13">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attn_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> AttentionType.ENCODER_DECODER:</span>
<span id="cb11-14">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update cross-attention KV cache (prefill-only)</span></span>
<span id="cb11-15">                    updated_slot_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attn_metadata.cross_slot_mapping</span>
<span id="cb11-16">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb11-17">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update self-attention KV cache (prefill/decode)</span></span>
<span id="cb11-18">                    updated_slot_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attn_metadata.slot_mapping</span>
<span id="cb11-19"></span>
<span id="cb11-20">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape the input keys and values and store them in the cache.</span></span>
<span id="cb11-21">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If kv_cache is not provided, the new key and value tensors are</span></span>
<span id="cb11-22">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># not cached. This happens during the initial memory</span></span>
<span id="cb11-23">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># profiling run.</span></span>
<span id="cb11-24">                torch.ops._C_cache_ops.reshape_and_cache_flash(</span>
<span id="cb11-25">                    key,</span>
<span id="cb11-26">                    value,</span>
<span id="cb11-27">                    kv_cache[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb11-28">                    kv_cache[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb11-29">                    updated_slot_mapping.flatten(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># type: ignore[union-attr]</span></span>
<span id="cb11-30">                    kv_cache_dtype,</span>
<span id="cb11-31">                    layer._k_scale,</span>
<span id="cb11-32">                    layer._v_scale,</span>
<span id="cb11-33">                )</span>
<span id="cb11-34"></span>
<span id="cb11-35">        (num_prefill_query_tokens, num_prefill_kv_tokens,</span>
<span id="cb11-36">        num_decode_query_tokens) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb11-37">            get_num_prefill_decode_query_kv_tokens(attn_metadata, attn_type)</span>
<span id="cb11-38">        decode_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query[num_prefill_query_tokens:]</span>
<span id="cb11-39">        decode_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[num_prefill_query_tokens:]</span>
<span id="cb11-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># QKV for prefill.</span></span>
<span id="cb11-41">        query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query[:num_prefill_query_tokens]</span>
<span id="cb11-42">        prefill_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[:num_prefill_query_tokens]</span>
<span id="cb11-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> query.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> num_prefill_query_tokens</span>
<span id="cb11-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> decode_query.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> num_decode_query_tokens</span></code></pre></div></div>
<p>然后根据场景走prefill和decode的flash attn,这里我主要关注decode部分。 在reshape kv的过程中，他的updated_slot_mapping是<code>[54]</code>，而实际上当前的seq_lens_arg是<code>[55]</code>, block_tables_arg为<code>[1,2,3,4]</code>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> decode_meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> attn_metadata.decode_metadata:</span>
<span id="cb12-2">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Decoding run.</span></span>
<span id="cb12-3">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use flash_attn_varlen_func kernel for speculative decoding</span></span>
<span id="cb12-4">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># because different queries might have different lengths.</span></span>
<span id="cb12-5"></span>
<span id="cb12-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> decode_meta.max_decode_query_len <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb12-7">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use only for actual varlen decoding</span></span>
<span id="cb12-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> decode_meta.max_decode_query_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb12-9">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> attn_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> AttentionType.DECODER, (</span>
<span id="cb12-10">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Only decoder-only models support max_decode_query_len &gt; 1"</span></span>
<span id="cb12-11">                )</span>
<span id="cb12-12">                flash_attn_varlen_func(</span>
<span id="cb12-13">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_query,</span>
<span id="cb12-14">                    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key_cache,</span>
<span id="cb12-15">                    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value_cache,</span>
<span id="cb12-16">                    cu_seqlens_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.query_start_loc,</span>
<span id="cb12-17">                    max_seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.max_decode_query_len,</span>
<span id="cb12-18">                    seqused_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.seq_lens_tensor,</span>
<span id="cb12-19">                    max_seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.max_decode_seq_len,</span>
<span id="cb12-20">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb12-21">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb12-22">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb12-23">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb12-24">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb12-25">                    block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_meta.block_tables,</span>
<span id="cb12-26">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_output,</span>
<span id="cb12-27">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb12-28">                )</span>
<span id="cb12-29">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-30">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use flash_attn_with_kvcache for normal decoding.</span></span>
<span id="cb12-31">                (</span>
<span id="cb12-32">                    seq_lens_arg,</span>
<span id="cb12-33">                    _,</span>
<span id="cb12-34">                    block_tables_arg,</span>
<span id="cb12-35">                ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_seq_len_block_table_args(decode_meta, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, attn_type)</span>
<span id="cb12-36">                flash_attn_with_kvcache(</span>
<span id="cb12-37">                    q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_query.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb12-38">                    k_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key_cache,</span>
<span id="cb12-39">                    v_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>value_cache,</span>
<span id="cb12-40">                    block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>block_tables_arg,</span>
<span id="cb12-41">                    cache_seqlens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seq_lens_arg,</span>
<span id="cb12-42">                    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>softmax_scale,</span>
<span id="cb12-43">                    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb12-44">                    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>window_size,</span>
<span id="cb12-45">                    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alibi_slopes,</span>
<span id="cb12-46">                    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits_soft_cap,</span>
<span id="cb12-47">                    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decode_output.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb12-48">                    fa_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fa_version,</span>
<span id="cb12-49">                )</span>
<span id="cb12-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span></code></pre></div></div>
<p>目前调用的是flash attn 2:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> flash_attn_with_kvcache(</span>
<span id="cb13-2">    q,</span>
<span id="cb13-3">    k_cache,</span>
<span id="cb13-4">    v_cache,</span>
<span id="cb13-5">    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-6">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-7">    rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-8">    rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-9">    cache_seqlens: Optional[Union[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, torch.Tensor)]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-10">    cache_batch_idx: Optional[torch.Tensor] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-11">    cache_leftpad: Optional[torch.Tensor] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-12">    block_table: Optional[torch.Tensor] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-13">    softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-14">    causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb13-15">    window_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1 means infinite context window</span></span>
<span id="cb13-16">    softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.0 means deactivated</span></span>
<span id="cb13-17">    rotary_interleaved<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb13-18">    alibi_slopes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-19">    num_splits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb13-20">    return_softmax_lse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb13-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>,</span>
<span id="cb13-22">    out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-23">    fa_version: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DEFAULT_FA_VERSION,</span>
<span id="cb13-24">):</span>
<span id="cb13-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If k and v are not None, k_cache and v_cache will be updated *inplace* with the new values from</span></span>
<span id="cb13-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    k and v. This is useful for incremental decoding: you can pass in the cached keys/values from</span></span>
<span id="cb13-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    the previous step, and update them with the new keys/values from the current step, and do</span></span>
<span id="cb13-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    attention with the updated cache, all in 1 kernel.</span></span>
<span id="cb13-30"></span>
<span id="cb13-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If you pass in k / v, you must make sure that the cache is large enough to hold the new values.</span></span>
<span id="cb13-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    For example, the KV cache could be pre-allocated with the max sequence length, and you can use</span></span>
<span id="cb13-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    cache_seqlens to keep track of the current sequence lengths of each sequence in the batch.</span></span>
<span id="cb13-34"></span>
<span id="cb13-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Also apply rotary embedding if rotary_cos and rotary_sin are passed in. The key @k will be</span></span>
<span id="cb13-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    rotated by rotary_cos and rotary_sin at indices cache_seqlens, cache_seqlens + 1, etc.</span></span>
<span id="cb13-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If causal or local (i.e., window_size != (-1, -1)), the query @q will be rotated by rotary_cos</span></span>
<span id="cb13-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    and rotary_sin at indices cache_seqlens, cache_seqlens + 1, etc.</span></span>
<span id="cb13-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If not causal and not local, the query @q will be rotated by rotary_cos and rotary_sin at</span></span>
<span id="cb13-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    indices cache_seqlens only (i.e. we consider all tokens in @q to be at position cache_seqlens).</span></span>
<span id="cb13-41"></span>
<span id="cb13-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    See tests/test_flash_attn.py::test_flash_attn_kvcache for examples of how to use this function.</span></span>
<span id="cb13-43"></span>
<span id="cb13-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Supports multi-query and grouped-query attention (MQA/GQA) by passing in KV with fewer heads</span></span>
<span id="cb13-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    than Q. Note that the number of heads in Q must be divisible by the number of heads in KV.</span></span>
<span id="cb13-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    For example, if Q has 6 heads and K, V have 2 heads, head 0, 1, 2 of Q will attention to head</span></span>
<span id="cb13-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    0 of K, V, and head 3, 4, 5 of Q will attention to head 1 of K, V.</span></span>
<span id="cb13-48"></span>
<span id="cb13-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If causal=True, the causal mask is aligned to the bottom right corner of the attention matrix.</span></span>
<span id="cb13-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    For example, if seqlen_q = 2 and seqlen_k = 5, the causal mask (1 = keep, 0 = masked out) is:</span></span>
<span id="cb13-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1 1 1 1 0</span></span>
<span id="cb13-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1 1 1 1 1</span></span>
<span id="cb13-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If seqlen_q = 5 and seqlen_k = 2, the causal mask is:</span></span>
<span id="cb13-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        0 0</span></span>
<span id="cb13-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        0 0</span></span>
<span id="cb13-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        0 0</span></span>
<span id="cb13-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1 0</span></span>
<span id="cb13-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1 1</span></span>
<span id="cb13-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If the row of the mask is all zero, the output will be zero.</span></span>
<span id="cb13-60"></span>
<span id="cb13-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    If window_size != (-1, -1), implements sliding window local attention. Query at position i</span></span>
<span id="cb13-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    will only attend to keys between</span></span>
<span id="cb13-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    [i + seqlen_k - seqlen_q - window_size[0], i + seqlen_k - seqlen_q + window_size[1]] inclusive.</span></span>
<span id="cb13-64"></span>
<span id="cb13-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Note: Does not support backward pass.</span></span>
<span id="cb13-66"></span>
<span id="cb13-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Arguments:</span></span>
<span id="cb13-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        q: (batch_size, seqlen, nheads, headdim)</span></span>
<span id="cb13-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k_cache: (batch_size_cache, seqlen_cache, nheads_k, headdim) if there's no block_table,</span></span>
<span id="cb13-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            or (num_blocks, page_block_size, nheads_k, headdim) if there's a block_table (i.e. paged KV cache)</span></span>
<span id="cb13-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            page_block_size must be a multiple of 256.</span></span>
<span id="cb13-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        v_cache: (batch_size_cache, seqlen_cache, nheads_k, headdim) if there's no block_table,</span></span>
<span id="cb13-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            or (num_blocks, page_block_size, nheads_k, headdim) if there's a block_table (i.e. paged KV cache)</span></span>
<span id="cb13-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k [optional]: (batch_size, seqlen_new, nheads_k, headdim). If not None, we concatenate</span></span>
<span id="cb13-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            k with k_cache, starting at the indices specified by cache_seqlens.</span></span>
<span id="cb13-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        v [optional]: (batch_size, seqlen_new, nheads_k, headdim). Similar to k.</span></span>
<span id="cb13-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        rotary_cos [optional]: (seqlen_ro, rotary_dim / 2). If not None, we apply rotary embedding</span></span>
<span id="cb13-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            to k and q. Only applicable if k and v are passed in. rotary_dim must be divisible by 16.</span></span>
<span id="cb13-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        rotary_sin [optional]: (seqlen_ro, rotary_dim / 2). Similar to rotary_cos.</span></span>
<span id="cb13-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        cache_seqlens: int, or (batch_size,), dtype torch.int32. The sequence lengths of the</span></span>
<span id="cb13-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            KV cache.</span></span>
<span id="cb13-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        block_table [optional]: (batch_size, max_num_blocks_per_seq), dtype torch.int32.</span></span>
<span id="cb13-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        cache_batch_idx: (batch_size,), dtype torch.int32. The indices used to index into the KV cache.</span></span>
<span id="cb13-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            If None, we assume that the batch indices are [0, 1, 2, ..., batch_size - 1].</span></span>
<span id="cb13-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            If the indices are not distinct, and k and v are provided, the values updated in the cache</span></span>
<span id="cb13-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                 might come from any of the duplicate indices.</span></span>
<span id="cb13-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        softmax_scale: float. The scaling of QK^T before applying softmax.</span></span>
<span id="cb13-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Default to 1 / sqrt(headdim).</span></span>
<span id="cb13-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        causal: bool. Whether to apply causal attention mask (e.g., for auto-regressive modeling).</span></span>
<span id="cb13-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        window_size: (left, right). If not (-1, -1), implements sliding window local attention.</span></span>
<span id="cb13-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        softcap: float. Anything &gt; 0 activates softcapping attention.</span></span>
<span id="cb13-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        rotary_interleaved: bool. Only applicable if rotary_cos and rotary_sin are passed in.</span></span>
<span id="cb13-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            If True, rotary embedding will combine dimensions 0 &amp; 1, 2 &amp; 3, etc. If False,</span></span>
<span id="cb13-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            rotary embedding will combine dimensions 0 &amp; rotary_dim / 2, 1 &amp; rotary_dim / 2 + 1</span></span>
<span id="cb13-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            (i.e. GPT-NeoX style).</span></span>
<span id="cb13-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        alibi_slopes: (nheads,) or (batch_size, nheads), fp32. A bias of</span></span>
<span id="cb13-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            (-alibi_slope * |i + seqlen_k - seqlen_q - j|)</span></span>
<span id="cb13-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            is added to the attention score of query i and key j.</span></span>
<span id="cb13-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        num_splits: int. If &gt; 1, split the key/value into this many chunks along the sequence.</span></span>
<span id="cb13-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">           If num_splits == 1, we don't split the key/value. If num_splits == 0, we use a heuristic</span></span>
<span id="cb13-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">           to automatically determine the number of splits.</span></span>
<span id="cb13-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">           Don't change this unless you know what you are doing.</span></span>
<span id="cb13-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        return_softmax_lse: bool. Whether to return the logsumexp of the attention scores.</span></span>
<span id="cb13-104"></span>
<span id="cb13-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Return:</span></span>
<span id="cb13-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out: (batch_size, seqlen, nheads, headdim).</span></span>
<span id="cb13-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        softmax_lse [optional, if return_softmax_lse=True]: (batch_size, nheads, seqlen). The</span></span>
<span id="cb13-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            logsumexp of each row of the matrix QK^T * scaling (e.g., log of the softmax</span></span>
<span id="cb13-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            normalization factor).</span></span>
<span id="cb13-110"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb13-111">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> k_cache.stride(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k_cache must have contiguous last dimension"</span></span>
<span id="cb13-112">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> v_cache.stride(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v_cache must have contiguous last dimension"</span></span>
<span id="cb13-113">    q, k, v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [maybe_contiguous(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (q, k, v)]</span>
<span id="cb13-114">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> softmax_scale <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb13-115">        softmax_scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb13-116">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cache_seqlens <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(cache_seqlens, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb13-117">        cache_seqlens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.full(</span>
<span id="cb13-118">            (k_cache.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],), cache_seqlens, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k_cache.device</span>
<span id="cb13-119">        )</span>
<span id="cb13-120">        cache_seqlens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> maybe_contiguous(cache_seqlens)</span>
<span id="cb13-121">    cache_batch_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> maybe_contiguous(cache_batch_idx)</span>
<span id="cb13-122">    block_table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> maybe_contiguous(block_table)</span>
<span id="cb13-123">    </span>
<span id="cb13-124">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> fa_version <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb13-125">        out, softmax_lse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ops._vllm_fa2_C.fwd_kvcache(</span>
<span id="cb13-126">            q, k_cache, v_cache,</span>
<span id="cb13-127">            k, v,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k_new, v_new</span></span>
<span id="cb13-128">            cache_seqlens,</span>
<span id="cb13-129">            rotary_cos,</span>
<span id="cb13-130">            rotary_sin,</span>
<span id="cb13-131">            cache_batch_idx,</span>
<span id="cb13-132">            cache_leftpad,</span>
<span id="cb13-133">            block_table,</span>
<span id="cb13-134">            alibi_slopes,</span>
<span id="cb13-135">            out,</span>
<span id="cb13-136">            softmax_scale,</span>
<span id="cb13-137">            causal,</span>
<span id="cb13-138">            window_size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb13-139">            window_size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb13-140">            softcap,</span>
<span id="cb13-141">            rotary_interleaved,</span>
<span id="cb13-142">            num_splits,</span>
<span id="cb13-143">        )</span>
<span id="cb13-144">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (out, softmax_lse) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> return_softmax_lse <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> out</span></code></pre></div></div>
<p>其中这个<code>torch.ops._vllm_fa2_C.fwd_kvcache</code>实际上位于vllm的flash attention的<code>csrc/flash_attn/flash_api_torch_lib.cpp</code>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"></span>
<span id="cb14-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb14-3">mha_fwd_kvcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size x seqlen_q x num_heads x head_size</span></span>
<span id="cb14-4">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size_c x seqlen_k x num_heads_k x head_size or num_blocks x page_block_size x num_heads_k x head_size if there's a block_table.</span></span>
<span id="cb14-5">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size_c x seqlen_k x num_heads_k x head_size or num_blocks x page_block_size x num_heads_k x head_size if there's a block_table.</span></span>
<span id="cb14-6">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size x seqlen_knew x num_heads_k x head_size</span></span>
<span id="cb14-7">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">v_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size x seqlen_knew x num_heads_k x head_size</span></span>
<span id="cb14-8">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">seqlens_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size</span></span>
<span id="cb14-9">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_cos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// seqlen_ro x (rotary_dim / 2)</span></span>
<span id="cb14-10">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_sin_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// seqlen_ro x (rotary_dim / 2)</span></span>
<span id="cb14-11">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cache_batch_idx_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// indices to index into the KV cache</span></span>
<span id="cb14-12">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">leftpad_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size</span></span>
<span id="cb14-13">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">block_table_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size x max_num_blocks_per_seq</span></span>
<span id="cb14-14">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">alibi_slopes_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// num_heads or batch_size x num_heads</span></span>
<span id="cb14-15">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">out_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// batch_size x seqlen_q x num_heads x head_size</span></span>
<span id="cb14-16">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-17">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-18">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> window_size_left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-19">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> window_size_right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-20">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> softcap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-21">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_rotary_interleaved<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if true, rotary combines indices 0 &amp; 1, else indices 0 &amp; rotary_dim / 2</span></span>
<span id="cb14-22">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> num_splits</span>
<span id="cb14-23">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-24"></span>
<span id="cb14-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Otherwise the kernel will be launched from cuda:0 device</span></span>
<span id="cb14-26">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>CUDAGuard device_guard<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()};</span></span>
<span id="cb14-27"></span>
<span id="cb14-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cc_major<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cc_minor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_compute_capability<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>get_current_device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-29">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_sm8x_min <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cc_major <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-30">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_sm8x_min<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FlashAttention only supports Ampere GPUs or newer."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-31"></span>
<span id="cb14-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> q_dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-33">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q_dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kFloat16 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> q_dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kBFloat16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-34">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FlashAttention only support fp16 and bf16 data type"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-35">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query and key must have the same dtype"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-36">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query and value must have the same dtype"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-37"></span>
<span id="cb14-38">    CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-39"></span>
<span id="cb14-40">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-41">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-42">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-43"></span>
<span id="cb14-44">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">block_table_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>paged_KV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-47">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cache_batch_idx_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Paged KVcache does not support cache_batch_idx"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-48">        block_table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">block_table_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-49">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-50">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kInt32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_table must have dtype torch.int32"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-51">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_table must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-52">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-53"></span>
<span id="cb14-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-55"></span>
<span id="cb14-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-57">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-58">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> num_heads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sizes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_q_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> num_heads_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-62"></span>
<span id="cb14-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> max_num_blocks_per_seq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> num_blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-65">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> page_block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-66">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> page_block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Paged KV cache block size must be divisible by 16"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> max_num_blocks_per_seq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-68">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> num_heads_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-69">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> batch_size_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>paged_KV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-70">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batch size must be positive"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-71">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FlashAttention forward only supports head dimension at most 256"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-72">    TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>num_heads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> num_heads_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of heads in key/value must divide number of heads in query"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-73"></span>
<span id="cb14-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// causal=true is the same as causal=false in this case</span></span>
<span id="cb14-75">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlen_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">alibi_slopes_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> is_causal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> window_size_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-77"></span>
<span id="cb14-78">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Faster to transpose q from (b, 1, (nheads_kv ngroups), d) to (b, ngroups, nheads_kv, d) in this case</span></span>
<span id="cb14-79">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// H/t Daniel Haziza</span></span>
<span id="cb14-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlenq_ngroups_swapped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> seqlen_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> num_heads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> num_heads_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> window_size_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> window_size_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">alibi_slopes_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-81">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlenq_ngroups_swapped<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-82">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ngroups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> num_heads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-83">        q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reshape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ngroups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}).</span>transpose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-84">        seqlen_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ngroups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-85">        num_heads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-86">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-87"></span>
<span id="cb14-88">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>window_size_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> window_size_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-89">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>window_size_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> window_size_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-90"></span>
<span id="cb14-91">    CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-92">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>paged_KV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-93">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-94">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-95">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-96">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-97">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-98">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> max_num_blocks_per_seq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-99">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-100"></span>
<span id="cb14-101">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor q_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> kcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> vcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-102">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-103">        q_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>PadFuncOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb14-104">        kcache_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>PadFuncOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb14-105">        vcache_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>PadFuncOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb14-106">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-107">        q_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-108">        kcache_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-109">        vcache_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-110">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-111"></span>
<span id="cb14-112">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">out_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-114">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">out_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-115">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output must have the same dtype as inputs"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-116">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-117">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-118">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_q_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-119">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-120">            out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>empty_like<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-121">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlenq_ngroups_swapped<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-122">            out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reshape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}).</span>transpose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-123">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-124">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-125">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>empty_like<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>q_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-126">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-127"></span>
<span id="cb14-128">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> round_multiple <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-129">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> head_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> round_multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-130">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> head_size_rounded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> head_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> round_multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-131">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_q_rounded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> round_multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-132">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_k_rounded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> round_multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-133"></span>
<span id="cb14-134">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> opts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-135"></span>
<span id="cb14-136">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> softmax_lse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> opts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kFloat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb14-137"></span>
<span id="cb14-138">    Flash_fwd_params params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-139">    set_params_fprop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-140">                     batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-141">                     seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-142">                     seqlen_q_rounded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_k_rounded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-143">                     num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-144">                     head_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_rounded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-145">                     q_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> kcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> vcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-146">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*cu_seqlens_q_d=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-147">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*cu_seqlens_k_d=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-148">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*seqused_k=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-149">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*p_ptr=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-150">                     softmax_lse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb14-151">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*p_dropout=*/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-152">                     softmax_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-153">                     window_size_left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-154">                     window_size_right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-155">                     softcap</span>
<span id="cb14-156">                     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-157"></span>
<span id="cb14-158">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> k_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-159">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-160">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">v_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If key is supplied, value must also be passed in"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-161">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">seqlens_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If key is supplied, seqlens_k must also be passed in"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-162">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlen_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If key is supplied, it must have seqlen &lt;= the seqlen of the KV cache"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-163">        k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-164">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">v_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-165">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Key must have the same dtype as query"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-166">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value must have the same dtype as query"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-167">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-168">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Key tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-169">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value tensor must have contiguous last dimension"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-170">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_knew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-171">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_knew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-172">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_knew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-173">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-174">            k_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>PadFuncOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb14-175">            v_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>functional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>PadFuncOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb14-176">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-177">            k_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-178">            v_padded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-179">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-180">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>seqlen_knew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> seqlen_knew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-181">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>knew_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-182">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>vnew_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-183">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// All stride are in elements, not bytes.</span></span>
<span id="cb14-184">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>knew_batch_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-185">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>vnew_batch_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-186">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>knew_row_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-187">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>vnew_row_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-188">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>knew_head_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-189">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>vnew_head_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-190">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-191"></span>
<span id="cb14-192">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">seqlens_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-193">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> seqlens_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">seqlens_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-194">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kInt32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seqlens_k must have dtype int32"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-195">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-196">        CHECK_CONTIGUOUS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-197">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-198">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cu_seqlens_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>seqlens_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-199">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-200">    params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_seqlens_k_cumulative <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">seqlens_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-201">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">leftpad_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-202">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>paged_KV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"We don't support Paged KV and leftpad_k running at the same time yet"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-203">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> leftpad_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">leftpad_k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-204">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>leftpad_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kInt32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leftpad_k must have dtype int32"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-205">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>leftpad_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-206">        CHECK_CONTIGUOUS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>leftpad_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-207">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>leftpad_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-208">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>leftpad_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>leftpad_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-209">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-210"></span>
<span id="cb14-211">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_cos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-212">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If rotary cos/sin are provided, new key / value to be appended to KV cache must also be provided"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-213">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> rotary_cos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_cos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-214">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-215">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-216">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> head_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rotary_dim must be &lt;= headdim"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-217">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Only rotary dimensions divisible by 16 are currently supported"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-218">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> seqlen_ro <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-219">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlen_ro <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cos/sin seqlen must be at least the seqlen of KV cache"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-220">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_ro<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-221">        CHECK_CONTIGUOUS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-222">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">scalar_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rotary_cos must have the same dtype as query"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-223"></span>
<span id="cb14-224">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_sin_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If rotary cos is provided, rotary sin must also be provided"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-225">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> rotary_sin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rotary_sin_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-226">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-227">        CHECK_SHAPE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_ro<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-228">        CHECK_CONTIGUOUS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-229">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">scalar_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rotary_cos must have the same dtype as query"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-230">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_cos_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rotary_cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-231">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_sin_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rotary_sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-232">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_rotary_interleaved <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_rotary_interleaved<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-233">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-234">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rotary_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-235">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-236"></span>
<span id="cb14-237">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cache_batch_idx_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-238">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> cache_batch_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cache_batch_idx_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-239">        CHECK_DEVICE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache_batch_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-240">        CHECK_CONTIGUOUS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache_batch_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-241">        TORCH_CHECK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache_batch_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">scalar_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kInt32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cache_batch_idx must have dtype int32"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-242">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cache_batch_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">reinterpret_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>cache_batch_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-243">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-244"></span>
<span id="cb14-245">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Keep references to these tensors to extend their lifetime</span></span>
<span id="cb14-246">    at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Tensor softmax_lse_accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out_accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-247">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>tie<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>softmax_lse_accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out_accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> set_params_splitkv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb14-248">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-249">        head_size_rounded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*dropout*/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_splits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> get_num_sm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>get_current_device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()),</span> opts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-250"></span>
<span id="cb14-251">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>paged_KV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-252">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>block_table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;();</span></span>
<span id="cb14-253">        params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>block_table_batch_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-254">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-255">    params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-256"></span>
<span id="cb14-257"></span>
<span id="cb14-258">    set_params_alibi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">alibi_slopes_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-259"></span>
<span id="cb14-260">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> stream <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>getCurrentCUDAStream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-261">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Only split kernel supports appending to KV cache, or indexing to the cache with cache_batch_idx,</span></span>
<span id="cb14-262">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// or paged KV cache</span></span>
<span id="cb14-263">    run_mha_fwd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*force_split_kernel=*/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cache_batch_idx_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> paged_KV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-264"></span>
<span id="cb14-265">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head_size_og <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-266">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>None<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)});</span></span>
<span id="cb14-267">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">out_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">out_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">copy_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-268">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">k_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-269">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It's expensive to copy the KV cache here for the case where head size not divisible by 8,</span></span>
<span id="cb14-270">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// but we don't expect to get this case in practice. This is just so that the code works for that case.</span></span>
<span id="cb14-271">            kcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">copy_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>None<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}));</span></span>
<span id="cb14-272">            vcache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">copy_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vcache_padded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>torch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>None<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}));</span></span>
<span id="cb14-273">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-274">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-275"></span>
<span id="cb14-276">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>seqlenq_ngroups_swapped<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-277">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>transpose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>reshape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> head_size_og<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb14-278">        softmax_lse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> softmax_lse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reshape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_heads_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> seqlen_q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb14-279">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-280">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> softmax_lse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-281"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>实际上他这里也是有padding的。当k存在时，强行走split k:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> run_mha_fwd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Flash_fwd_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">cudaStream_t</span> stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> force_split_kernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-2">    FP16_SWITCH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_bf16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-3">        HEADDIM_SWITCH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-4">            BOOL_SWITCH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-5">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>num_splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>force_split_kernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If we don't set it num_splits == 0</span></span>
<span id="cb15-6">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">run_mha_fwd_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">elem_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> kHeadDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-7">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-8">                    run_mha_fwd_splitkv_dispatch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">elem_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> kHeadDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-9">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-10">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb15-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb15-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb15-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>然后在这个dispatch中还有许多变体，不过重要的就是tile的kv都是从远端读取过来的。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>block_table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-2">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> final_block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> binfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>actual_seqlen_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n_block_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kBlockN<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-3">        tKgK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> flash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>resolve_thread_kv_page_slice_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Kernel_traits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tidx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n_block_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-4">            block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>k_batch_stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>k_row_stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> final_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-5">        tVgV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gV<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> flash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>resolve_thread_kv_page_slice_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Kernel_traits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tidx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n_block_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-6">            block_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>v_batch_stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>v_row_stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> final_block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="vllm-fused-moe" class="level2">
<h2 class="anchored" data-anchor-id="vllm-fused-moe">vllm fused moe</h2>
<p>要理解vllm fused moe，首先从最naive的huggingface版来理解moe的执行流程，首先整体流程如下：</p>
<p><img src="https://zhen8838.github.io/posts/vllm/moe_ep.png" class="img-fluid"></p>
<p>实际上就是一共64个expert，假设4个设备，ep=4，那么每个设备放8个expert。到gating时的输入都需要是broadcast的，然后gating计算hidden states对应每个expert的概率，将概率排序后进行all to all后使用当前设备中expert的计算outputs。注意他这里的all to all之后实际上每个设备还是算64个expert，只不过是8个expert重复了4次。 等计算完outpus之后再all to all就可以恢复到每个节点64个expert的输出。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>()</span>
<span id="cb17-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> moe_infer(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, topk_ids, topk_weight):</span>
<span id="cb17-3">        cnts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> topk_ids.new_zeros((topk_ids.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.experts))) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [global batch, n_experts]</span></span>
<span id="cb17-4">        cnts.scatter_(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, topk_ids, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assgin activated experts to 1</span></span>
<span id="cb17-5">        tokens_per_expert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cnts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 每个token会选择不同的，那么一个专家会处理多个token，统计每个专家要处理的token数量</span></span>
<span id="cb17-6">        idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> topk_ids.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).argsort() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 先sort topk id, 这样idx 为 [global batch * n_experts], 其中expert的索引从小到大排序</span></span>
<span id="cb17-7">        sorted_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> topk_ids.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 因为他前面是先view再argsort，除shape[1]是为了保证只选当前token对应的expert。</span></span>
<span id="cb17-8">        sorted_tokens_shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sorted_tokens.shape</span>
<span id="cb17-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb17-10">            tokens_per_ep_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_expert.view(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_size, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [ep_size, n_experts/ep_size] -&gt; [ep_size]</span></span>
<span id="cb17-11">            tokens_per_expert_group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_expert.new_empty(</span>
<span id="cb17-12">                tokens_per_expert.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb17-13">            )</span>
<span id="cb17-14">            dist.all_to_all_single(tokens_per_expert_group, tokens_per_expert) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 先all to all拿到当前的节点上每个expert要处理的token数量</span></span>
<span id="cb17-15">            output_splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb17-16">                tokens_per_expert_group.view(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_size, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-17">                .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-18">                .cpu()</span>
<span id="cb17-19">                .numpy()</span>
<span id="cb17-20">                .tolist()</span>
<span id="cb17-21">            )</span>
<span id="cb17-22">            gathered_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sorted_tokens.new_empty(</span>
<span id="cb17-23">                tokens_per_expert_group.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).cpu().item(), sorted_tokens.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb17-24">            )</span>
<span id="cb17-25">            input_split_sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_ep_rank.cpu().numpy().tolist()</span>
<span id="cb17-26">            dist.all_to_all(</span>
<span id="cb17-27">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(gathered_tokens.split(output_splits)),</span>
<span id="cb17-28">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(sorted_tokens.split(input_split_sizes)),</span>
<span id="cb17-29">            ) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all to all拿到当前的节点上每个expert要处理的token</span></span>
<span id="cb17-30">            tokens_per_expert_post_gather <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_expert_group.view(</span>
<span id="cb17-31">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_size, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.experts_per_rank</span>
<span id="cb17-32">            ).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb17-33">            gatherd_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(gathered_tokens.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.int32)</span>
<span id="cb17-34">            s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(tokens_per_expert_group.cpu().numpy()):</span>
<span id="cb17-36">                gatherd_idxs[s : s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.experts_per_rank</span>
<span id="cb17-37">                s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> k</span>
<span id="cb17-38">            gatherd_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gatherd_idxs.argsort()</span>
<span id="cb17-39">            sorted_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gathered_tokens[gatherd_idxs]</span>
<span id="cb17-40">            tokens_per_expert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_expert_post_gather</span>
<span id="cb17-41">        tokens_per_expert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_per_expert.cpu().numpy()</span>
<span id="cb17-42"></span>
<span id="cb17-43">        outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-44">        start_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, num_tokens <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(tokens_per_expert):</span>
<span id="cb17-46">            end_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_tokens</span>
<span id="cb17-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> num_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-48">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb17-49">            expert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.experts[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.experts_per_rank]</span>
<span id="cb17-50">            tokens_for_this_expert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sorted_tokens[start_idx:end_idx] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 由于sort之后，分到同一个expert上token已经都排好了，所以直接取</span></span>
<span id="cb17-51">            expert_out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> expert(tokens_for_this_expert)</span>
<span id="cb17-52">            outputs.append(expert_out)</span>
<span id="cb17-53">            start_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end_idx</span>
<span id="cb17-54"></span>
<span id="cb17-55">        outs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat(outputs, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(outputs) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> sorted_tokens.new_empty(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [global batch*n_act_experts, hidden_size]</span></span>
<span id="cb17-56">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ep_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb17-57">            new_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty_like(outs)</span>
<span id="cb17-58">            new_x[gatherd_idxs] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outs</span>
<span id="cb17-59">            gathered_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_x.new_empty(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sorted_tokens_shape)</span>
<span id="cb17-60">            dist.all_to_all(</span>
<span id="cb17-61">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(gathered_tokens.split(input_split_sizes)),</span>
<span id="cb17-62">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(new_x.split(output_splits)),</span>
<span id="cb17-63">            )</span>
<span id="cb17-64">            outs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gathered_tokens <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 再来一次all to all拿到当前节点处理好的gathered tokens</span></span>
<span id="cb17-65"></span>
<span id="cb17-66">        new_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty_like(outs)</span>
<span id="cb17-67">        new_x[idxs] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outs</span>
<span id="cb17-68">        final_out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb17-69">            new_x.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>topk_ids.shape, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-70">            .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(topk_weight.dtype)</span>
<span id="cb17-71">            .mul_(topk_weight.unsqueeze(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb17-72">            .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-73">            .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(new_x.dtype)</span>
<span id="cb17-74">        )</span>
<span id="cb17-75">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> final_out</span></code></pre></div></div>
</section>
<section id="vllm并行模式" class="level2">
<h2 class="anchored" data-anchor-id="vllm并行模式">vllm并行模式</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 31%">
<col style="width: 19%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Attention</strong></th>
<th><strong>MoE - Shared Experts</strong></th>
<th><strong>MoE - Routed Experts</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>DP</strong></td>
<td>权重复制 <br> <em>可在推理框架外部处理</em></td>
<td>权重复制</td>
<td><strong>EP关闭:</strong> 权重复制<br><strong>EP开启:</strong> 按EP(=DP)数量切分</td>
</tr>
<tr class="even">
<td><strong>TP</strong></td>
<td>按head切分<br><em>需同步LM head</em><br><em>需支持广播meta data</em></td>
<td>切分n和k维度<br><em>需做all-reduce</em></td>
<td><strong>EP关闭:</strong> 权重复制<br><strong>EP开启:</strong> 按EP(=TP)数量切分</td>
</tr>
<tr class="odd">
<td><strong>TP+DP</strong></td>
<td>TP组内切分<br>DP组内复制</td>
<td>TP组内切分<br>DP组内复制</td>
<td><strong>EP关闭:</strong> 权重复制<br><strong>EP开启:</strong> 按EP(=TP*DP)总数切分</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>EP是依赖于DP/TP的MoE专用切分模式，EP = TP * DP</strong>，主要影响Routed Experts的分布</li>
</ul>
<p><img src="https://zhen8838.github.io/posts/vllm/dp_and_tp.png" class="img-fluid"></p>
<p>同时开启DP + TP时，对于权重分布如上图所示，在group 0/group 1间为权重复制，在每个group内为权重切分。此时需要主要attn metadata是group间不同，group内相同。</p>
</section>
</section>
<section id="trt-llm" class="level1">
<h1>trt llm</h1>
<p>trt llm的整体流程其实还蛮像一个端到端的AI编译器的。他可以直接吃整个模型，然后直接生成c代码，并且替换已有的plugin算子。</p>
<section id="plugin" class="level2">
<h2 class="anchored" data-anchor-id="plugin">plugin</h2>
<p>先看看他如何定义plugin的，首先他在python端提供了一些辅助函数用于定义plugin算子的输入输出信息。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_fmha_kernel_meta_data():</span>
<span id="cb18-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> KernelMetaData(</span>
<span id="cb18-3">        kernel_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fused_attention_kernel'</span>,</span>
<span id="cb18-4">        ios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb18-5">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outputs</span></span>
<span id="cb18-6">            OutputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Out'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp16]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-7">            OutputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp32]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-8">            OutputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp16]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-9">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># inputs</span></span>
<span id="cb18-10">            InputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp16]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-11">            InputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'K'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp16]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-12">            InputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'V'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tensor[fp16]'</span>), hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-13">            ParamArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sm_scale'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fp32'</span>)),</span>
<span id="cb18-14">            DimSizeArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'batch_size'</span>),</span>
<span id="cb18-15">            ParamArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_heads'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'i32'</span>)),</span>
<span id="cb18-16">            DimSizeArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'seq_len'</span>, hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span>]),</span>
<span id="cb18-17">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># constexprs</span></span>
<span id="cb18-18">            Constexpr(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>),</span>
<span id="cb18-19">            Constexpr(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>),</span>
<span id="cb18-20">            Constexpr(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>),</span>
<span id="cb18-21">        ],</span>
<span id="cb18-22">        shape_infer_rules<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb18-23">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The following rules helps to deduce the shapes of the output tensors</span></span>
<span id="cb18-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q[*] -&gt; Out[*]"</span>,</span>
<span id="cb18-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q[m,n,k,*] -&gt; L[m,n,k]"</span>,</span>
<span id="cb18-26">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q[m,n,k,*] -&gt; M[m,n,k]"</span>,</span>
<span id="cb18-27"></span>
<span id="cb18-28">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The following rules helps to deduce both DimSizeArgs: batch_size and seq_len</span></span>
<span id="cb18-29">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q[m,n,k,*] : m -&gt; batch_size"</span>,</span>
<span id="cb18-30">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q[m,n,k,*] : k -&gt; seq_len"</span>,</span>
<span id="cb18-31">        ],</span>
<span id="cb18-32">        version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-33">        kernel_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>openai_triton_example_root<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/fmha_triton.py'</span>,</span>
<span id="cb18-34">        num_warps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb18-35">        grid_dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(seq_len + 127) / 128"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batch_size * num_heads"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>))</span>
<span id="cb18-36"></span>
<span id="cb18-37"></span>
<span id="cb18-38">KERNELS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-39">    get_fmha_kernel_meta_data(),</span>
<span id="cb18-40">]</span></code></pre></div></div>
<p>甚至还支持了一套读取复杂计算表达式参数的转换器，用于把算子的计算逻辑转换成c接口代码。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pytest.mark.parametrize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'expr, target'</span>, [</span>
<span id="cb19-2">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[m,n,k]:m*2+k+(n+1) -&gt; b"</span>,</span>
<span id="cb19-3">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"((inputDesc[0].dims.d[0] * 2) + (inputDesc[0].dims.d[2] + (inputDesc[0].dims.d[1] + 1)))"</span></span>
<span id="cb19-4">     ),</span>
<span id="cb19-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[m,n,k]:m*(2+k)+n+1 -&gt; b"</span>,</span>
<span id="cb19-6">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"((inputDesc[0].dims.d[0] * (2 + inputDesc[0].dims.d[2])) + (inputDesc[0].dims.d[1] + 1))"</span></span>
<span id="cb19-7">     ),</span>
<span id="cb19-8">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[m,n,k] -&gt; b[m*((((n+1))))]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">if (outputIndex == 0) {</span></span>
<span id="cb19-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.nbDims = 1;</span></span>
<span id="cb19-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.d[0] = (inputDims[0].d[0] * (inputDims[0].d[1] + 1));</span></span>
<span id="cb19-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">     """</span>),</span>
<span id="cb19-14">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[m,n,k] -&gt; b[m*(n+k), 2*n, k+3]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nvinfer1::DimsExprs outputDims;</span></span>
<span id="cb19-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">if (outputIndex == 0) {</span></span>
<span id="cb19-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.nbDims = 3;</span></span>
<span id="cb19-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.d[0] = (inputDims[0].d[0] * (inputDims[0].d[1] + inputDims[0].d[2]));</span></span>
<span id="cb19-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.d[1] = (2 * inputDims[0].d[1]);</span></span>
<span id="cb19-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  outputDims.d[2] = (inputDims[0].d[2] + 3);</span></span>
<span id="cb19-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"""</span>)</span>
<span id="cb19-22">])</span>
<span id="cb19-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_CppCodeTranspiler(expr: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, target: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb19-24">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(</span>
<span id="cb19-25">        a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>InputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fp16'</span>)),</span>
<span id="cb19-26">        b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>InputArg(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, Type(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fp16'</span>)),</span>
<span id="cb19-27">    )</span>
<span id="cb19-28">    target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> target.strip()</span>
<span id="cb19-29"></span>
<span id="cb19-30">    transpiler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CppCodeTranspiler(args)</span>
<span id="cb19-31"></span>
<span id="cb19-32">    shape_infer_code, dim_infer_code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> transpiler([expr])</span>
<span id="cb19-33"></span>
<span id="cb19-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we don't check the correctness of the code since the lark produces unstable ast tree</span></span>
<span id="cb19-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># refer to https://github.com/lark-parser/lark/issues/324</span></span>
<span id="cb19-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> shape_infer_code <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> dim_infer_code</span></code></pre></div></div>
</section>
<section id="auto-parallel" class="level2">
<h2 class="anchored" data-anchor-id="auto-parallel">auto parallel</h2>
<p>首先是切分描述，trt llm和shardy类似，是对一个维度来描述切分，如果为空，那么当前维度就是复制，否则在对应的mesh上进行切分：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DimSpec:</span>
<span id="cb20-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, shard_list):</span>
<span id="cb20-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.is_replica <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(shard_list) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb20-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.shard_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shard_list</span>
<span id="cb20-5"></span>
<span id="cb20-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb20-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.is_replica:</span>
<span id="cb20-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R'</span></span>
<span id="cb20-9">        target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"S(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">','</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(dim) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.shard_list)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb20-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> target</span></code></pre></div></div>
<p>然后一个tensor的切分信息由多个dim spec组成:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ShardingSpec:</span>
<span id="cb21-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entire_shape, sharding_sequence, device_mesh):</span>
<span id="cb21-3">      ...</span>
<span id="cb21-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb21-5">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DistSpec("</span></span>
<span id="cb21-6">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shape=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>entire_shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">,"</span></span>
<span id="cb21-7">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shard=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>sharding_sequence<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">,"</span></span>
<span id="cb21-8">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mesh=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>device_mesh<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mesh_shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb21-9">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span></span>
<span id="cb21-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> res</span></code></pre></div></div>
<p>然后构造一个分布式切分搜索图：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_cost_graph(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, lmesh):</span>
<span id="cb22-2">        leaf_strategies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb22-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nodes:</span>
<span id="cb22-4">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> node.is_replicated:</span>
<span id="cb22-5">                node.set_strategy(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, lmesh)</span>
<span id="cb22-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb22-7">                node.collect_strategies(lmesh)</span>
<span id="cb22-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nodes:</span>
<span id="cb22-9">            strategies_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> node.update_resharding_cost()</span>
<span id="cb22-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(strategies_vector) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb22-11">                leaf_strategies.append(strategies_vector)</span>
<span id="cb22-12">        cost_graph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CostGraph(leaf_strategies)</span>
<span id="cb22-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cost_graph</span></code></pre></div></div>
<p>首先是遍历所有节点，如果这个是<code>is_replicated</code>，也就是提前标记了不可分布式，那么直接设置为None，否则遍历所有可能的切分策略，然后计算这个节点的cost（包含了通信和计算）。其中<code>collect_strategies</code>核心代码如下, 他似乎是只考虑在2维拓扑以下进行分布式，但是这里加的策略还是全的，不过好像只添加考虑输出节点的切分，并不是SBP的基于推导的方法。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _collect_strategies(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, device_mesh):</span>
<span id="cb23-2">        dim_partition_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-3">        dim_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.op_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output0'</span>].shape)</span>
<span id="cb23-4">        dim_partition_list.append({})</span>
<span id="cb23-5">        dim_partition_list.extend(</span>
<span id="cb23-6">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._enumerate_all_possible_1d_sharding([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim_size))</span>
<span id="cb23-7">        dim_partition_list.extend(</span>
<span id="cb23-8">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._enumerate_all_possible_2d_sharding([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim_size))</span>
<span id="cb23-9">        dim_partition_list.extend(</span>
<span id="cb23-10">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._enumerate_all_possible_1d_sharding([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dim_size))</span>
<span id="cb23-11">        dim_partition_list.extend(</span>
<span id="cb23-12">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._enumerate_all_possible_1d_sharding([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim_size))</span>
<span id="cb23-13"></span>
<span id="cb23-14">        strategies_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StrategiesVector(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)</span>
<span id="cb23-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dim_partition_dict <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dim_partition_list:</span>
<span id="cb23-16">            dim_partition_dict_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output0'</span>: dim_partition_dict}</span>
<span id="cb23-17">            sharding_spec_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._to_sharding_spec_mapping(</span>
<span id="cb23-18">                dim_partition_dict_mapping, device_mesh)</span>
<span id="cb23-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sharding_spec_mapping):</span>
<span id="cb23-20">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb23-21">            sharding_seq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sharding_spec_mapping[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output0'</span>].sharding_sequence</span>
<span id="cb23-22">            sharding_strategy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_sharding_strategy(</span>
<span id="cb23-23">                name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'constant-op </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sharding_seq<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>,</span>
<span id="cb23-24">                sharding_spec_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sharding_spec_mapping,</span>
<span id="cb23-25">                communication_action_mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})</span>
<span id="cb23-26">            strategies_vector.append(sharding_strategy)</span>
<span id="cb23-27"></span>
<span id="cb23-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> strategies_vector</span></code></pre></div></div>
<p>然后发现实际上这个方法是可以被override的，对于matmul来说有自己的collect方法：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _collect_strategies(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, device_mesh):</span>
<span id="cb24-2">        strategies_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StrategiesVector(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)</span>
<span id="cb24-3">        dp_strategies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._dp_strategies(device_mesh)</span>
<span id="cb24-4">        tp_strategies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._tp_strategies(device_mesh)</span>
<span id="cb24-5">        mix_strategies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._mix_strategies(device_mesh)</span>
<span id="cb24-6">        bmm_strategies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._bmm_strategies(device_mesh)</span>
<span id="cb24-7">        strategies_vector.extend(dp_strategies)</span>
<span id="cb24-8">        strategies_vector.extend(tp_strategies)</span>
<span id="cb24-9">        strategies_vector.extend(mix_strategies)</span>
<span id="cb24-10">        strategies_vector.extend(bmm_strategies)</span>
<span id="cb24-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> strategies_vector</span></code></pre></div></div>
<p>这是matmul所collect出来的切分方式：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">RR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) x S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)R_allreduceS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-2">RR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) x S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)R_allreduceS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-3">RR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) x S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)R_allreduceS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-4">[R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)] x [S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), R]_reducescatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb25-5">[R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] x [S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), R]_reducescatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb25-6">[R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [R, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] x [S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), R]_reducescatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb25-7">RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RR x RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-8">RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RR x RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-9">RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RR x RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-10">RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) x S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)_allreduceS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-11">RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) x S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)S(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)_allreduceS(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-12">RR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RR x RR</span></code></pre></div></div>
<p>同样attention或其他节点也有自己的分布式切分收集函数，这里和oneflow不同的是，他并不会传播partial的切分，我的理解是拆分的越细那么灵活性更高，可以后续做自动的通算融合，大粒度后面还是走匹配替换来优化。</p>
<p>每个算子的分布式策略收集好之后，还需要构建reshard cost，因为可能上一个节点的切分策略并不是下一个节点所需要的切分策略，所以需要计算reshard cost。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _update_resharding_cost(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, strategies):</span>
<span id="cb26-2">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> strategy <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> strategies:</span>
<span id="cb26-3">            resharding_costs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb26-4">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pre_node, out_index <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.predecessor_nodes_out_index.items():</span>
<span id="cb26-5">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pre_node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb26-6">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb26-7">                pre_node_out_data_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pre_node.get_output(out_index).name</span>
<span id="cb26-8">                pre_node_out_data_lname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pre_node.global_to_local_op_name[</span>
<span id="cb26-9">                    pre_node_out_data_name]</span>
<span id="cb26-10">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pre_node_out_data_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.global_to_local_op_name:</span>
<span id="cb26-11">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pre_node_out_data_name = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pre_node_out_data_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb26-12">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb26-13">                cur_node_inp_data_lname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.global_to_local_op_name[</span>
<span id="cb26-14">                    pre_node_out_data_name]</span>
<span id="cb26-15">                cur_sharding_spec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> strategy.sharding_specs[</span>
<span id="cb26-16">                    cur_node_inp_data_lname]</span>
<span id="cb26-17"></span>
<span id="cb26-18">                pre_node_out_sharding_specs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb26-19">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pre_strategy <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pre_node.strategies_vector:</span>
<span id="cb26-20">                    pre_node_out_sharding_specs.append(</span>
<span id="cb26-21">                        pre_strategy.sharding_specs[pre_node_out_data_lname])</span>
<span id="cb26-22"></span>
<span id="cb26-23">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pre_node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> resharding_costs:</span>
<span id="cb26-24">                    resharding_costs[pre_node.node_name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb26-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prev_sharding_spec <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pre_node_out_sharding_specs:</span>
<span id="cb26-26">                    resharding_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compute_resharding_cost(</span>
<span id="cb26-27">                        prev_sharding_spec, cur_sharding_spec,</span>
<span id="cb26-28">                        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.op_data[cur_node_inp_data_lname]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 话说为什么他要限制这个op的切分类型，本来这个gather就可以切输入啊</span></span>
<span id="cb26-29">                    resharding_costs[pre_node.node_name].append(resharding_cost)</span>
<span id="cb26-30">            strategy.resharding_costs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resharding_costs</span></code></pre></div></div>
</section>
<section id="pyexector" class="level2">
<h2 class="anchored" data-anchor-id="pyexector">PyExector</h2>
<p>trt llm之前通过编译的方式发现使用起来不方便，因此他也模仿vllm，提供了一个python的executor，直接动态执行大模型。并且他新的接口就做了相当的精简：</p>
<p><img src="https://zhen8838.github.io/posts/vllm/trt_attn.png" class="img-fluid"></p>
</section>
</section>
<section id="mlc-llm" class="level1">
<h1>mlc llm</h1>
<p>mlc这里就不看调度的过程了，只看kv cache，attention是如何和编译器集成的。</p>
<p><img src="https://zhen8838.github.io/posts/vllm/tvm_attn.png" class="img-fluid"></p>
<p>tvm中首先是在vm中定义了基础的kv cache state接口，然后实现了具体的kv cache管理逻辑。然后AttentionKVCacheObj中包含了一个最重要的函数AttentionWithFusedQKV。tvm为了在python端可以集成不同的 attention实现，是在python中调用vm的kv cache的create，在create中将不同的attention计算函数作为packed func传入。最终执行时是vm调用AttentionWithFusedQKV，AttentionWithFusedQKV中调用自身的tir_attention_decode_cpu/tir_attention_decode_gpu等等函数。</p>
<p>他这套逻辑还是比较复杂的，需要在python和cpp中转换多次。</p>
</section>
<section id="sglang" class="level1">
<h1>sglang</h1>
<p>这是sglang在attention部分的类图： <img src="https://zhen8838.github.io/posts/vllm/sglang_attn.png" class="img-fluid"></p>
</section>
<section id="问题汇总" class="level1">
<h1>问题汇总</h1>
<section id="vllm问题" class="level2">
<h2 class="anchored" data-anchor-id="vllm问题">vllm问题</h2>
<ol type="1">
<li>TypeError: must be called with a dataclass type or instance</li>
</ol>
<p>发现是torch 2.5.1 cu118不能用triton 3.2，需要降级到3.1</p>
<ol start="2" type="1">
<li>RuntimeError: NCCL error: unhandled cuda error (run with NCCL_DEBUG=INFO for details)</li>
</ol>
<p>检查detail发现是runtime的nccl是cu12的</p>
<ol start="3" type="1">
<li>json.decoder.JSONDecodeError: Extra data: line 5298 column 2 (char 479924)</li>
</ol>
<p>发现是之前下载的模型的json有问题，重新下载就行了</p>
<ol start="4" type="1">
<li>RuntimeError: Triton Error [CUDA]: device kernel image is invalid</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span> torch._dynamo.exc.BackendCompilerFailed: backend=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'inductor'</span> raised:</span>
<span id="cb27-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span> RuntimeError: Triton Error <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">CUDA</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>: device kernel image is invalid</span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span> Set TORCH_LOGS=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+dynamo"</span> and TORCHDYNAMO_VERBOSE=1 for more information</span>
<span id="cb27-5"></span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span> You can suppress this exception and fall back to eager by setting:</span>
<span id="cb27-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span>     import torch._dynamo</span>
<span id="cb27-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[rank0]:</span>     torch._dynamo.config.suppress_errors = True</span></code></pre></div></div>
<p>这个应该是triton默认只能编译出最新的cuda版本的代码,把本地的ptxas替换掉triton中的：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cp</span> /usr/local/cuda/bin/ptxas /root/miniconda3/envs/vllm/lib/python3.10/site-packages/triton/backends/nvidia/bin/ptxas</span></code></pre></div></div>
<ol start="5" type="1">
<li><code>NCCL WARN NCCL cannot be captured in a graph</code></li>
</ol>
<p>好像是安装的nccl版本和cuda 11.8还是兼容？</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">misc/strongstream.cc:53</span> NCCL WARN NCCL cannot be captured in a graph if either it wasn<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'t built with CUDA runtime &gt;= 11.3 or if the installed CUDA driver &lt; R465.</span></span></code></pre></div></div>
<p>我现在的版本是<code>nvidia-nccl-cu11-2.21.5</code>,卸载之后重装老的版本</p>
<pre><code>❯ pip install nvidia-nccl-cu11==2.19.3 -i https://download.pytorch.org/whl/cu118</code></pre>
<p>好像也不行，可能是因为老的版本的nccl就没有支持capture graph的功能，需要重新编译nccl，但是实际上可以<code>--enforce-eager</code>跳过这个问题。</p>
</section>
<section id="trt-llm问题" class="level2">
<h2 class="anchored" data-anchor-id="trt-llm问题">trt llm问题</h2>
<ol type="1">
<li>cuda版本问题</li>
</ol>
<p>trt llm和cuda版本是强绑定的，所以如果cuda 版本不到，就直接没法运行，所以只能安装老版本的trt llm。</p>
<ol start="2" type="1">
<li>tensorrt bindings的问题</li>
</ol>
<p>我发现使用pip安装的tensorrt llm中的tensorrt 调用的是tensorrt bindings，然后我安装他得到的是8.6.1版本，这个不是我想要的。解决方法是pip卸载tensorrt，然后用trt llm中的shell脚本安装tensorrt。</p>
<ol start="3" type="1">
<li>mpi版本问题</li>
</ol>
<p>pip安装trt llm的时候总是报错编译mpi4py失败，然后我查看了一下，发现是mpi版本的问题，默认apt安装openmpi得到40+版本了，但是trt llm中需要的是3.1.5，所以解决方案是不要apt装openmpi，通过conda-forge安装3.1.5版本</p>
</section>
<section id="scaled-dot-product-attention-sdpa-精度问题" class="level2">
<h2 class="anchored" data-anchor-id="scaled-dot-product-attention-sdpa-精度问题">scaled dot product attention (SDPA) 精度问题</h2>
<p>我发现在mac上使用 <code>torch.nn.functional.scaled_dot_product_attention</code> 与自己实现的 <code>scaled_dot_product_attention</code> 得到的结果精度有差异。但是如果设定了SDPA的实现为MATH就不会有精度差异，并且是否设定MATH的backend也会导致精度问题，我就很难理解默认的backend是什么。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb31-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Optional</span>
<span id="cb31-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb31-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.nn.attention <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SDPBackend, sdpa_kernel</span>
<span id="cb31-5"></span>
<span id="cb31-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> scaled_dot_product_attention(query: torch.Tensor, key: torch.Tensor, value: torch.Tensor, attn_mask: Optional[torch.Tensor] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, dropout_p: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, is_causal: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, scale: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> torch.Tensor:</span>
<span id="cb31-7">    L, S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), key.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb31-8">    scale_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> math.sqrt(query.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> scale <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> scale</span>
<span id="cb31-9">    attn_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(L, S, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query.device)</span>
<span id="cb31-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> is_causal:</span>
<span id="cb31-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> attn_mask <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb31-12">        temp_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(L, S, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>).tril(diagonal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb31-13">        attn_bias.masked_fill_(temp_mask.logical_not(), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-inf"</span>))</span>
<span id="cb31-14">        attn_bias.to(query.dtype)</span>
<span id="cb31-15"></span>
<span id="cb31-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attn_mask <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb31-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attn_mask.dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>:</span>
<span id="cb31-18">            attn_bias.masked_fill_(attn_mask.logical_not(), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-inf"</span>))</span>
<span id="cb31-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb31-20">            attn_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attn_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> attn_bias</span>
<span id="cb31-21"></span>
<span id="cb31-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if enable_gqa:</span></span>
<span id="cb31-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     key = key.repeat_interleave(query.size(-3)//key.size(-3), -3)</span></span>
<span id="cb31-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     value = value.repeat_interleave(query.size(-3)//value.size(-3), -3)</span></span>
<span id="cb31-25"></span>
<span id="cb31-26">    attn_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> key.transpose(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale_factor</span>
<span id="cb31-27">    attn_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> attn_bias</span>
<span id="cb31-28">    attn_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.softmax(attn_weight, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-29">    attn_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.dropout(attn_weight, dropout_p, train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb31-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> attn_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> value</span>
<span id="cb31-31"></span>
<span id="cb31-32">q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-33">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-34">v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-35">mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)</span>
<span id="cb31-36"></span>
<span id="cb31-37">y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scaled_dot_product_attention(</span>
<span id="cb31-38">    q, k, v, attn_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask, dropout_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb31-39"></span>
<span id="cb31-40">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-41">k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.repeat_interleave(k, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-42">v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.repeat_interleave(v, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb31-43">mask2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)</span>
<span id="cb31-44">y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scaled_dot_product_attention(</span>
<span id="cb31-45">    q2, k2, v2, attn_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2, dropout_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb31-46"> </span>
<span id="cb31-47"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.allclose(y1, y2.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>))</span>
<span id="cb31-48"></span>
<span id="cb31-49"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> sdpa_kernel([SDPBackend.MATH]):</span>
<span id="cb31-50">  y3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.nn.functional.scaled_dot_product_attention(</span>
<span id="cb31-51">      q2, k2, v2, attn_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2, dropout_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb31-52"> </span>
<span id="cb31-53"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.allclose(y2, y3)</span>
<span id="cb31-54"></span>
<span id="cb31-55">y3_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.nn.functional.scaled_dot_product_attention(</span>
<span id="cb31-56">    q2, k2, v2, attn_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2, dropout_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, is_causal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb31-57"> </span>
<span id="cb31-58"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.allclose(y3, y3_1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># will fail</span></span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>推理框架</category>
  <guid>https://zhen8838.github.io/posts/vllm.html</guid>
  <pubDate>Fri, 14 Feb 2025 01:39:39 GMT</pubDate>
</item>
<item>
  <title>DISTAL: The Distributed Tensor Algebra Compiler</title>
  <link>https://zhen8838.github.io/posts/distal.html</link>
  <description><![CDATA[ 




<p>这篇论文主要是介绍了一个分布式张量代数编译器， 它通过自定义的DSL可以帮助我们快速生成分布式计算代码。</p>
<!--more-->
<section id="index-notation" class="level1">
<h1>Index Notation</h1>
<p>首先这篇论文是在<a href="http://tensor-compiler.org">taco</a>之上实现的，计算的描述依旧是index notation, 例如： <img src="https://latex.codecogs.com/png.latex?%0AA(i,%20j)%20=%20B(i,%20k)%20*%20C(k,%20j)%0A"></p>
<p>和其他的<a href="https://zhuanlan.zhihu.com/p/674882975">tensor expression dsl</a>类似, 也同样是用相对简单的代码构建出对应的循环/计算的ir。对于这个例子，它的ir是：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1">forall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> forall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> forall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))))</span></span></code></pre></div></div>
</section>
<section id="tensor-distribution-notation" class="level1">
<h1>Tensor Distribution Notation</h1>
<p>distal很好的发扬了多面体模型的思想，数据分布到不同的机器上的本质就是数据点的集合被放置到了不同的机器上，因此他采用了多面体中映射的概念，通过tensor distribution notation来描述数据点集合和设备的映射关系来表达数据分布： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5Ctext%7BMachine%7D:%20%5Cmathcal%7BM%7D%5C%20%5C%20%5C%20%20%5Ctext%7BTensors%7D:%20%5Cmathcal%7BT%7D%20%20%5C%5C%0A&amp;%5Ctext%7BDimension%20Variables%7D:%20d%20%5C%5C%0A&amp;%5Ctext%7BDimension%20Name%7D%5C%20%5C%20%20n%20::=%20d%20%7C%20%5Cmathbin%7BN%7D%20%7C%20*%20%5C%5C%0A&amp;%5Ctext%7BTensor%20Distribution%7D%5C%20%5C%20%5Cmathcal%7BD%7D%20::=%20%5Cmathcal%7BT%7D_%7Bd%5E+%7D%5Cmapsto_%7Bn%5E+%7D%20%5Cmathcal%7BM%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>其中<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D_%7Bd%5E+%7D">描述的tensor本身，由于tensor的维度个数可能是动态的，因此用多个维度变量<img src="https://latex.codecogs.com/png.latex?d%5E+">来表示， 维度变量的个数等于tensor的维度。而机器<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">的描述则是多个维度名<img src="https://latex.codecogs.com/png.latex?n%5E+">，维度名的个数等于拓扑的维度，注意维度名可以由维度变量/正整数/通配符<code>*</code>表示，这为描述数据分布提供了较大的灵活性。 同时这里隐含了一个约束就是</p>
<p>下面来看几个具体的例子， 首先假设<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">的shape为<code>[100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BD%7D">的个数是<code>[10]</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 32%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>预设</th>
<th>描述</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bx%7D%20%5Cmapsto_%7Bx%7D%20%5Cmathcal%7BM%7D"></td>
<td>每个设备拥有<code>[10]</code>的数据</td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100,100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bxy%7D%20%5Cmapsto_%7Bx%7D%20%5Cmathcal%7BM%7D"></td>
<td>每个设备拥有<code>[10,y]</code>的数据</td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100,100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10,10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bxy%7D%20%5Cmapsto_%7Bxy%7D%20%5Cmathcal%7BM%7D"></td>
<td>每个设备拥有<code>[10,10]</code>的数据</td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100,100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10,10,10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bxy%7D%20%5Cmapsto_%7Bxy0%7D%20%5Cmathcal%7BM%7D"></td>
<td>某一个平面的每个设备拥有<code>[10,10]</code>的数据</td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100,100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10,10,10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bxy%7D%20%5Cmapsto_%7Bxy*%7D%20%5Cmathcal%7BM%7D"></td>
<td>每个平面的每个设备拥有<code>[10,10]</code>的数据</td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D">:<code>[100,100,100]</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">: <code>[10,10]</code></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D%20_%7Bxyz%7D%20%5Cmapsto_%7Bxy%7D%20%5Cmathcal%7BM%7D"></td>
<td>每个设备拥有<code>[10,10,100]</code>的数据</td>
</tr>
</tbody>
</table>
<p>对应上述表格中每一个例子的具体示意图如下： <img src="https://zhen8838.github.io/posts/distal/distribution-samples.png" class="img-fluid"></p>
<p>可以把tensor看作为一系列坐标-值的集合，machine可以看作是坐标的集合，而tensor distribution notation <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D_%7BX%7D%5Cmapsto_%7BY%7D%5Cmathcal%7BM%7D"> 就是一个映射函数，将tensor的坐标映射到machine的坐标。由于映射的时候存在broadcast或单独指定的情况，因此这种映射并不一定是一对多或多对一映射，为了实现复杂的映射，实际上映射函数由两部分组合而成，第一部分是<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BP%7D:%20%5Cmathcal%7BT%7D%20%5Cmapsto%20%5Ctext%7Bcolor%7D">，第二部分<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D:%20%5Ctext%7Bcolor%7D%20%5Cmapsto%20%5Cmathcal%7BM%7D">, 相当于先进行多对一映射再进行一对多映射，其中<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bcolor%7D">作为独一无二的标记存在，并且<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bcolor%7D">由<img src="https://latex.codecogs.com/png.latex?Y">中有效的维度变量组合而成：<img src="https://latex.codecogs.com/png.latex?(X%20%5Cbigcap%20Y)%20%5Csubseteq%20Y">。 举个例子，假设<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D:%20%5B4,4%5D">,<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D:%20%5B2,2,2%5D">, distribution notation为<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BT%7D_%7Bxy%7D%20%5Cmapsto_%7Bxy*%7D%20%5Cmathcal%7BM%7D">, 那么映射<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BP%7D">如下： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cmathcal%7BP%7D%20=%20%5C%7B%0A&amp;%5C%7B%20(0,0),(1,0),(0,1),(1,1)%20%5C%7D%20%5Cmapsto%20%20(0,0),%0A%5C%7B%20(2,0),(3,0),(2,1),(3,1)%20%5C%7D%20%5Cmapsto%20%20(0,1),%20%5C%5C%0A&amp;%5C%7B%20(0,2),(1,2),(0,3),(1,3)%20%5C%7D%20%5Cmapsto%20%20(1,0),%0A%5C%7B%20(2,2),(3,2),(2,3),(3,3)%20%5C%7D%20%5Cmapsto%20%20(0,0)%20%5C%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>而映射<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D">如下： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cmathcal%7BF%7D%20=%5C%7B%0A%20%20&amp;(0,0)%20%5Cmapsto%20%5C%7B(0,0,0),(0,0,1)%5C%7D,%0A%20%20(0,1)%20%5Cmapsto%20%5C%7B(0,1,0),(0,1,1)%5C%7D,%5C%5C%0A%20%20&amp;(1,0)%20%5Cmapsto%20%5C%7B(1,0,0),(1,0,1)%5C%7D,%0A%20%20(0,0)%20%5Cmapsto%20%5C%7B(0,0,0),(0,0,1)%5C%7D%0A%5C%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>通过上述这种分阶段的简单映射从而实现了复杂的映射。</p>
</section>
<section id="computation-schedule" class="level1">
<h1>Computation Schedule</h1>
<p>考虑这样一段计算：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb2-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb2-3">    A[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> B[j]</span></code></pre></div></div>
<p>使用多面体模型表示他所对应的迭代域为：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">domain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isl.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{ S[i, j] : 0 &lt;= i &lt; 3 and 0 &lt;= j &lt; 3}"</span>)</span></code></pre></div></div>
<p>如图所示：</p>
<p><img src="https://zhen8838.github.io/posts/distal/domain.png" class="img-fluid"></p>
<section id="distribute" class="level2">
<h2 class="anchored" data-anchor-id="distribute">Distribute</h2>
<p>distal在taco的基础上使用distribute的调度来修改迭代域，从而表示分布式计算。内部的实现如下：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1">distribute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>IndexVar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>IndexVar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>IndexVar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> local<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Machine m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">):</span></span>
<span id="cb4-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Divide each dimension by the corresponding machine dimension.</span></span>
<span id="cb4-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i in range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">):</span></span>
<span id="cb4-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reorder loops so each outer divided variable is on the outside.</span></span>
<span id="cb4-5">    divide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> local<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> </span>
<span id="cb4-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Distribute all of the outer divided variables.</span></span>
<span id="cb4-7">  reorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span id="cb4-8">  distribute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>实际上就是将循环进行split后再进行reorder，再标记外层循环与machine进行对应。</p>
<p>当distribution notation为<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7Ba%7D_%7Bx%7D%20%5Cmapsto_%7Bx%7D%20%5Cmathcal%7BM%7D">,<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7Bb%7D_%7Bx%7D%20%5Cmapsto_%7Bx%7D%20%5Cmathcal%7BM%7D">, 那么对应的分布式调度为<code>distribute(i,io,ii,M)</code>, 经过调度后的迭代域如下：</p>
<p><img src="https://zhen8838.github.io/posts/distal/domain_distribute.png" class="img-fluid"></p>
<p>灰色区域所表示的是单独的分布式节点，在循环i上进行分布式后，所有的循环j都被划分到了不同的处理器节点上。</p>
</section>
<section id="communicate" class="level2">
<h2 class="anchored" data-anchor-id="communicate">Communicate</h2>
<p>当数据分布在不同的处理器上时，在发生计算时就需要将所依赖的数据从别的处理器节点上获取，因此需要进行数据的通信。基于distribution notation以及多面体分析，我们可以计算得到每一次迭代所需要传输的数据。将这种数据依赖以及循环j的前三次迭代绘制出来，如下所示：</p>
<p><img src="https://zhen8838.github.io/posts/distal/communicate_naive.png" class="img-fluid"></p>
<p>可以看到，<code>a,b</code>在循环i上进行分布，那么每个i的迭代对应他们的一部分数据区域，在每次j的迭代中，每个节点会需要从其他节点获取到b的部分数据。当然这是基于数据的分布式情况以及依赖分析所得到的naive 通信方式。</p>
<p>在上面这种情况下，如果采用一个更大块的通信操作，直接从节点获取多次计算所需要的数据，而不是每次迭代都获取数据，那么性能可能会更好，这就引出了通信频率和内存使用的trade-off。为了在这种trade-off的场景下可以进行调节，distal提供了<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bcommunicate%7D(%5Cmathcal%7BT%7D,%20i)">的调度。他通过指定迭代循环的方式，配合数据分布以及数据依赖分析，把迭代循环内部所有嵌套循环所依赖的数据放到所指定循环的开始来获取。比如执行<code>distribute(b,i)</code>后，计算如图所示：</p>
<p><img src="https://zhen8838.github.io/posts/distal/communicate_opt.png" class="img-fluid"></p>
<p>distal的communicate调度是进行了简化设计，因为如果要指定send/receive或者设备编号等，整个事情就会变的非常复杂。</p>
</section>
<section id="rotate" class="level2">
<h2 class="anchored" data-anchor-id="rotate">Rotate</h2>
<p>许多分布式算法采用脉动的方式实现，处理器反复将数据shift到相邻节点。脉动算法可以有效利用互连的机器架构，并通过避免对相同数据的竞争来提高性能。</p>
<p>首先继续从<code>distribute(i)</code>的调度开始，默认可以认为他执行的是broadcast的通信操作，在每个时间片上，都会向所有处理器发送对相同数据的通信请求，如下图所示： <img src="https://zhen8838.github.io/posts/distal/rotate_naive.png" class="img-fluid"></p>
<p>为了表达脉动计算，distal引入rotate调度, 他是通过引入时间维度的映射，让j的迭代空间在时间上旋转，从而实现脉动式通信模式。如下图所示，实际上现在的横轴已经不是j的迭代空间了，而是时间维度，真正的j的迭代空间在每个时间片上发生了旋转。 如果对于每个i的迭代，j的迭代空间被旋转且j的第i次迭代先发生，那么称整个execution space具备脉动模式： <img src="https://zhen8838.github.io/posts/distal/rotate_opt.png" class="img-fluid"></p>
<p>给定一组索引变量<img src="https://latex.codecogs.com/png.latex?I">，目标索引变量<img src="https://latex.codecogs.com/png.latex?t">, 以及结果索引变量<img src="https://latex.codecogs.com/png.latex?r">, <code>rotate(t,I,r)</code>的调度会另迭代空间<img src="https://latex.codecogs.com/png.latex?t">根据<img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bi%5Cin%20I%7D%20i%20%5Cmod%20%5Ctext%7Bextent(t)%7D">发生旋转。 旋转后，对于所有的<img src="https://latex.codecogs.com/png.latex?i%5Cin%20I">，给定其一个固定的剩余迭代<img src="https://latex.codecogs.com/png.latex?i'%5Cin%20(I-i)">, <img src="https://latex.codecogs.com/png.latex?r">的相同迭代会在<img src="https://latex.codecogs.com/png.latex?i">的不同迭代上发生。假设<img src="https://latex.codecogs.com/png.latex?t">在<img src="https://latex.codecogs.com/png.latex?i,j">两个维度上进行了rotate, 那么每次<img src="https://latex.codecogs.com/png.latex?i">或<img src="https://latex.codecogs.com/png.latex?j">的迭代开始时,<img src="https://latex.codecogs.com/png.latex?r">的值都是不同的。</p>
</section>
</section>
<section id="case-studies" class="level1">
<h1>Case Studies</h1>
<p>distal中采用Tensor Distribution Notation和Computation Schedule可以组合起来表达各种各样的分布式算法。当然大量分布式算法都集中在分布式矩阵乘法算法上。因此distal展示了实现各种分布式矩阵乘算法的例子：</p>
<p><img src="https://zhen8838.github.io/posts/distal/examples.png" class="img-fluid"></p>
<section id="summa" class="level2">
<h2 class="anchored" data-anchor-id="summa">Summa</h2>
<p>首先定义各种分布式tensor以及循环域。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Place each tensor onto a processor grid.</span></span>
<span id="cb5-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> gx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>make<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gridX"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Int32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> gy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>make<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gridY"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Int32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>gx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TensorDistribution<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-7"></span>
<span id="cb5-8">  Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> Format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-9">  Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> Format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-10">  Tensor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> Format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Dense<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-11"></span>
<span id="cb5-12">  IndexVar i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"j"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jn"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ii<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"il"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ji<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jl"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ki<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ki"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ko"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-13">  IndexVar iln<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iln"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-14">  a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-15"></span>
<span id="cb5-16">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> placeALowered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowerLegionSeparatePartitionCompute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getPlacementStatement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeLegionA"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-17">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> placeBLowered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowerLegionSeparatePartitionCompute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getPlacementStatement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeLegionB"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-18">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> placeCLowered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lowerLegionSeparatePartitionCompute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getPlacementStatement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeLegionC"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>采用distal提供的调度接口：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> stmt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getAssignment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>concretize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> </span>
<span id="cb6-2">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>distribute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ii<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ji<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>divide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ki<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ii<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ji<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ki<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb6-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>communicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>communicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>communicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>这里每一步的调度返回值都可以打印为文本形式：</p>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 89%">
</colgroup>
<thead>
<tr class="header">
<th>schedule</th>
<th>stmt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>a(i, j) = b(i, k) * c(k, j);</td>
<td>forall(i, forall(j, forall(k, a(i,j) += b(i,k) * c(k,j))))</td>
</tr>
<tr class="even">
<td>distribute({i, j}, {io, jo}, {ii, ji}, grid)</td>
<td>suchthat(forall(distFused, forall(il, forall(jl, forall(k, a(i,j) += b(i,k) * c(k,j)))), Distributed, NoRaces), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)))</td>
</tr>
<tr class="odd">
<td>divide(k, ko, ki, gx)</td>
<td>suchthat(forall(distFused, forall(il, forall(jl, forall(ko, forall(ki, a(i,j) += b(i,k) * c(k,j))))), Distributed, NoRaces), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)) and divide(k, ko, ki, gridX))</td>
</tr>
<tr class="even">
<td>reorder({ko, ii, ji, ki})</td>
<td>suchthat(forall(distFused, forall(ko, forall(il, forall(jl, forall(ki, a(i,j) += b(i,k) * c(k,j))))), Distributed, NoRaces), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)) and divide(k, ko, ki, gridX))</td>
</tr>
<tr class="odd">
<td>communicate(a(i, j), jo)</td>
<td>suchthat(forall(distFused, forall(ko, forall(il, forall(jl, forall(ki, a(i,j) += b(i,k) * c(k,j))))), Distributed, NoRaces, transfers: transfer(a(i,j))), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)) and divide(k, ko, ki, gridX))</td>
</tr>
<tr class="even">
<td>communicate(b(i, k), ko)</td>
<td>suchthat(forall(distFused, forall(ko, forall(il, forall(jl, forall(ki, a(i,j) += b(i,k) * c(k,j)))), transfers: transfer(b(i,k))), Distributed, NoRaces, transfers: transfer(a(i,j)), transfer(b(i,k))), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)) and divide(k, ko, ki, gridX))</td>
</tr>
<tr class="odd">
<td>communicate(c(i, j), ko)</td>
<td>suchthat(forall(distFused, forall(ko, forall(il, forall(jl, forall(ki, a(i,j) += b(i,k) * c(k,j)))), transfers: transfer(b(i,k)), transfer(c(i,j))), Distributed, NoRaces, transfers: transfer(a(i,j)), transfer(b(i,k)), transfer(c(i,j))), divide(i, in, il, gridX) and divide(j, jn, jl, gridY) and multiFuse({in, jn}, reorder(in, jn)) and divide(k, ko, ki, gridX))</td>
</tr>
</tbody>
</table>
<p>如果采用伪代码的形式可以更好理解：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># naive</span></span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, M):</span>
<span id="cb7-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N):</span>
<span id="cb7-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K):</span>
<span id="cb7-5">      a[i,j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> b[i,k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c[k,j]</span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># distribute</span></span>
<span id="cb7-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> io <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jo <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Y): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ii <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Y):</span>
<span id="cb7-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K):</span>
<span id="cb7-12">          a[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> b[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c[k,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji]</span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># divide</span></span>
<span id="cb7-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> io <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jo <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Y): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ii <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-17">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Y):</span>
<span id="cb7-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ko <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X):</span>
<span id="cb7-19">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ki <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-20">            a[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> b[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ki] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c[ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ki,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji]</span>
<span id="cb7-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reorder</span></span>
<span id="cb7-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> io <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jo <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Y): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ko <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X):</span>
<span id="cb7-25">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ii <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Y):</span>
<span id="cb7-27">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ki <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-28">            a[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> b[io<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ii,ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ki] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c[ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ki,jo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ji]</span>
<span id="cb7-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># communicate</span></span>
<span id="cb7-30"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> io <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jo <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Y): <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> parallel</span>
<span id="cb7-32">    sub_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load(a[M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X,N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y])</span>
<span id="cb7-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ko <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X):</span>
<span id="cb7-34">      sub_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load(b[M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X,K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X])</span>
<span id="cb7-35">      sub_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load(c[K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>X,N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Y])</span>
<span id="cb7-36">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ii <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> jj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Y):</span>
<span id="cb7-38">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ki <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> X):</span>
<span id="cb7-39">            sub_a[ii,ji] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> sub_b[ii,ki] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sub_c[ki,ji]</span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/distal.html</guid>
  <pubDate>Tue, 04 Feb 2025 11:58:45 GMT</pubDate>
</item>
<item>
  <title>triton-cpu初体验</title>
  <link>https://zhen8838.github.io/posts/triton-cpu-lesson-1.html</link>
  <description><![CDATA[ 




<p>体验一下triton cpu，看看是否有想象中的效果。</p>
<!--more-->
<section id="下载" class="level1">
<h1>1. 下载</h1>
<p>因为triton他依赖一个特定版本的llvm，所以必须要clone 完整的llvm再切过去，下载就浪费我半天= =</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> git clone https://github.com/triton-lang/triton-cpu.git                                                       </span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> git clone https://github.com/llvm/llvm-project.git </span></code></pre></div></div>
</section>
<section id="编译" class="level1">
<h1>2. 编译</h1>
<p>triton给出的编译方法是<code>pip install -e .</code>， 但是我还是想用cmake的方式自己编译， 然后遇到了一堆问题。。</p>
<section id="llvm-编译" class="level2">
<h2 class="anchored" data-anchor-id="llvm-编译">2.1 llvm 编译</h2>
<p>llvm可以参考他的ci中的编译方式, 他给每个平台都给出了详细的编译命令。</p>
</section>
<section id="triton-编译选项" class="level2">
<h2 class="anchored" data-anchor-id="triton-编译选项">2.2 triton 编译选项</h2>
<p>如果只有cpu后端， 那么就使用下面的选项:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"LLVM_LIBRARY_DIR"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xxxx/llvm-project/install/lib"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TRITON_BUILD_PYTHON_MODULE"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TRITON_BUILD_PROTON"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TRITON_CODEGEN_BACKENDS"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TRITON_BUILD_UT"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="cmake-bug-修复" class="level2">
<h2 class="anchored" data-anchor-id="cmake-bug-修复">2.3 cmake bug 修复</h2>
<p>cpu后端这句话会报错， 先注释掉</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Override sleef's output directory with our own</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set_target_properties(sleef PROPERTIES LIBRARY_OUTPUT_DIRECTORY ${CMAKE_LIBRARY_OUTPUT_DIRECTORY})</span></span></code></pre></div></div>
</section>
<section id="cpp-编译错误修复" class="level2">
<h2 class="anchored" data-anchor-id="cpp-编译错误修复">2.4 cpp 编译错误修复</h2>
<p>由于triton他的opt里面用了所有的后端的pass， 但是我们又没有编译nv/amd， 所以需要修改<code>bin/RegisterTritonDialects.h</code>, 把编译时报错的地方都注释掉。 然后<code>third_party/nvidia/include/TritonNVIDIAGPUToLLVM/Utility.h</code>中还有一个nv的函数找不到定义， 自己手动写个实现：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> canSkipBarSync<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>before<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>after<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="python-加载段错误修复" class="level2">
<h2 class="anchored" data-anchor-id="python-加载段错误修复">2.5 python 加载段错误修复</h2>
<p>我用的python3.8， 好像在mac会和pybind会有奇怪的问题，需要修改cmake：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb5-1">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">NOT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">APPLE</span>)</span>
<span id="cb5-2">      <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">link_libraries</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">${Python3_LIBRARIES}</span>)</span>
<span id="cb5-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">endif</span>()</span></code></pre></div></div>
</section>
<section id="软链接" class="level2">
<h2 class="anchored" data-anchor-id="软链接">2.6 软链接</h2>
<p>triton的python编译脚本中有自动copy后端文件到指定目录， 这里我们手动就需要自己软链接</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> cd python/triton/backends</span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> mkdir cpu</span>
<span id="cb6-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> cd cpu</span>
<span id="cb6-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> xxxx/triton-cpu/third_party/cpu/backend/driver.py driver.py               </span>
<span id="cb6-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> xxxx/triton-cpu/third_party/cpu/backend/compiler.py compiler.py</span>
<span id="cb6-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> cd triton-cpu/python/triton/_C</span>
<span id="cb6-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> xxxx/triton-cpu/out/build/debug/libtriton.so libtriton.so              </span>
<span id="cb6-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> xxxx/triton-cpu/out/build/debug/third_party/cpu/libTritonCPURuntime.dylib libTritonCPURuntime.dylib                </span>
<span id="cb6-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> xxxx/triton-cpu/out/build/debug/third_party/cpu/sleef/lib/libsleef.dylib libsleef.dylib                </span></code></pre></div></div>
</section>
<section id="环境变量配置" class="level2">
<h2 class="anchored" data-anchor-id="环境变量配置">2.7 环境变量配置</h2>
<p>下面三个是debug使用的。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PYTHONPATH</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xxxx/triton-cpu/out/build/debug:xxxx/triton-cpu/python"</span></span>
<span id="cb7-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">TRITON_KERNEL_DUMP</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span>
<span id="cb7-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">TRITON_DEBUG</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span>
<span id="cb7-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LLVM_IR_ENABLE_DUMP</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span></code></pre></div></div>
</section>
<section id="python-执行报错" class="level2">
<h2 class="anchored" data-anchor-id="python-执行报错">2.8 python 执行报错</h2>
<p>我这里是python3.8 但是他写了一个3.11才有的特性, 所以修改掉</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _init_slots(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb8-2">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Initialize the slots of this class """</span></span>
<span id="cb8-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, val <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.arg_properties.items():</span>
<span id="cb8-4">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">setattr</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, (name[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> name.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tt."</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> name) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.property_values[name]), val)</span></code></pre></div></div>
<p>还有一个是mac中选择编译器的问题, 修改文件<code>python/triton/runtime/build.py</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> system <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Darwin'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> clang <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb9-2">            cc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> clang</span>
<span id="cb9-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb9-4">            cc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gcc <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> gcc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> clang</span></code></pre></div></div>
</section>
</section>
<section id="运行" class="level1">
<h1>3. 运行</h1>
<section id="vector-add" class="level2">
<h2 class="anchored" data-anchor-id="vector-add">3.1 vector add</h2>
<p>我尝试执行最简单的例子，但是他会卡死在生成asm，然后我发现dump的llvm ir非常奇怪， 有32768个数： <img src="https://zhen8838.github.io/posts/triton-cpu-lesson-1/triton-vec-add.JPG" class="img-fluid"> 然后发现vector add中又有:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">CPU_ST_THRESHOLD <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span></span></code></pre></div></div>
<p>然后尝试一下缩小这个阈值， 果然就可以正常编译了= =。 但是还有omp的问题， 因为apple自带的apple-clang是没有omp功能的。</p>
<p>可以使用conda安装omp然后修改<code>python/triton/runtime/build.py</code>中mac的配置，并且下面之前添加的openmp需要注释掉，添加上编译选项/头文件/库。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">system</span> == <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Darwin"</span>:</span>
<span id="cb11-2">        <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cc_cmd</span> += [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-undefined"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dynamic_lookup"</span>]</span>
<span id="cb11-3">        <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cc_cmd</span> += [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-Xpreprocessor'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-fopenmp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-lomp'</span>]</span>
<span id="cb11-4">        <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">include_dirs</span> += <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xxxxx/miniforge3/envs/ci/include'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb11-5">        <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">library_dirs</span> += <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xxxxx/miniforge3/envs/ci/lib'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb11-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Don't use libgcc on clang + macos</span></span>
<span id="cb11-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clang"</span> in cc:</span>
<span id="cb11-8">            <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">libraries.remove</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gcc"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb11-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb11-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb11-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb11-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not os.environ.get("TRITON_DISABLE_OPENMP", None):</span></span>
<span id="cb11-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   cc_cmd += ["-fopenmp"]</span></span></code></pre></div></div>
<p>现在终于可以正常运行vector add:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">❯</span> python python/tutorials/01-vector-add.py</span>
<span id="cb12-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tensor</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[0.5151,</span> 1.6826, 0.9153,  ..., 0.9852, 1.2714, 1.8192]<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb12-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tensor</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[0.5151,</span> 1.6826, 0.9153,  ..., 0.9852, 1.2714, 1.8192]<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb12-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">The</span> maximum difference between torch-cpu and triton-cpu is 0.0</span>
<span id="cb12-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">The</span> maximum difference between torch-cpu-tiled and triton-cpu is 0.0</span></code></pre></div></div>
<p>我仔细观察后，发现这个<code>CPU_ST_THRESHOLD</code>其实就是<code>BLOCK_SIZE</code>的最大值，那么其实是<code>BLOCK_SIZE</code>大于512的时候就已经很难编译了，这个可能和triton编译出展开的代码关系比较大。</p>
</section>
</section>
<section id="整体流程" class="level1">
<h1>4. 整体流程</h1>
<p>通过下面这个例子可以很好理解整个启动过程：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton.language <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tl</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb13-4"></span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@triton.jit</span></span>
<span id="cb13-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> program_id_kernel(a, ConstArg: tl.constexpr):</span>
<span id="cb13-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># There are multiple 'programs' processing different data. We identify which program</span></span>
<span id="cb13-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we are here:</span></span>
<span id="cb13-10">  xid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.program_id(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-11">  yid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.program_id(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-12">  zid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.program_id(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb13-13">  tl.device_print(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id:"</span>, xid, yid, zid)</span>
<span id="cb13-14"></span>
<span id="cb13-15">  xsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.num_programs(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-16">  ysize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.num_programs(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-17">  zsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.num_programs(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb13-18">  tl.device_print(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nums:"</span>, xsize, ysize, zsize)</span>
<span id="cb13-19"></span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> grid_callback(arguments):</span>
<span id="cb13-22">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(arguments)</span>
<span id="cb13-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb13-24"></span>
<span id="cb13-25">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span>
<span id="cb13-26">program_id_kernel[grid_callback](a, ConstArg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span></code></pre></div></div>
<section id="如何并行" class="level2">
<h2 class="anchored" data-anchor-id="如何并行">4.1 如何并行？</h2>
<p>首先triton编译出来的kernel他作为一个库函数， 默认都有3维的index作为输入参数。然后runtime的driver部分手写了一个launcher去调用triton kernel，在启动时根据预先设定的<code>gridX, gridY, gridZ</code>大小，将这些index的tuple展平为1维，然后直接用openmp并行循环i即可。这里其实存在一个问题，三个id生成的循环顺序和程序是无关的，但是程序的运行出来的性能却和id的顺序有关。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> all_grids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_all_grids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>gridX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gridY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gridZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For now, use the default chunk size, total iterations / max_threads.</span></span>
<span id="cb14-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#ifdef _OPENMP</span></span>
<span id="cb14-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#pragma omp parallel for schedule(static) num_threads(max_threads)</span></span>
<span id="cb14-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// _OPENMP</span></span>
<span id="cb14-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span></span>
<span id="cb14-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> all_grids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>kernel_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)({</span>kernel_fn_args_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">',</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>kernel_fn_args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gridX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gridY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> gridZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-9">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span></span>
<span id="cb14-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span></span></code></pre></div></div>
</section>
<section id="gridx-gridy-gridz大小如何设定" class="level2">
<h2 class="anchored" data-anchor-id="gridx-gridy-gridz大小如何设定">4.2 <code>gridX, gridY, gridZ</code>大小如何设定？</h2>
<p>triton的runtime有launcher，但runtime也是被python端的jit function所调用的，在jit function启动一个kernel的时候，会把当前python端输入的参数都给到上面提到的<code>grid_callback</code>函数，此时这个函数的返回值就是<code>gridX, gridY, gridZ</code>大小。 也就是说我们可以根据当前输入tensor的尺寸选择合适的工作线程个数。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> JITFunction(KernelInterface[T]):</span>
<span id="cb15-2">    ...</span>
<span id="cb15-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, grid, warmup, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb15-4">        ...</span>
<span id="cb15-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> warmup:</span>
<span id="cb15-6">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># canonicalize grid</span></span>
<span id="cb15-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> grid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb15-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">callable</span>(grid):</span>
<span id="cb15-9">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arguments are passed as a dict to `grid`, by contract.</span></span>
<span id="cb15-10">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(jlebar): In the new launch API, pass the compiler flags as a</span></span>
<span id="cb15-11">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># second parameter to `grid`.</span></span>
<span id="cb15-12">                grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid(bound_args)</span>
<span id="cb15-13">            grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(grid)</span>
<span id="cb15-14">            grid_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb15-15">            grid_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-16">            grid_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-17"></span>
<span id="cb15-18">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># launch kernel</span></span>
<span id="cb15-19">            launch_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel.launch_metadata(grid, stream, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>non_constexpr_vals)</span>
<span id="cb15-20">            kernel.run(grid_0, grid_1, grid_2, stream, kernel.function, kernel.packed_metadata, launch_metadata,</span>
<span id="cb15-21">                       <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.CompiledKernel.launch_enter_hook, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.CompiledKernel.launch_exit_hook, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>non_constexpr_vals)</span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/triton-cpu-lesson-1.html</guid>
  <pubDate>Wed, 04 Dec 2024 09:51:20 GMT</pubDate>
</item>
<item>
  <title>分布式存储架构下的矩阵乘与编译器</title>
  <link>https://zhen8838.github.io/posts/mesh-matmul.html</link>
  <description><![CDATA[ 




<p>分布式内存计算机的出现主要是为了满足大规模计算任务对计算能力和内存容量的需求, 但是由于物理限制与成本考虑, 单处理器的性能提升存在极限, 而分布式内存计算机通过使用多个相对简单/成本较低的处理器组成集群, 可以在不突破物理限制的情况下, 以较低的成本实现更高的计算性能.</p>
<!--more-->
<p>分布式内存架构是一个多处理器计算机系统, 其中每个处理器都有自己的私有内存, 以及处理器之间某种形式的互联. 计算任务只能对本地数据进行操作, 如果需要远程数据, 则计算任务必须与一个或多个远程处理器通信.</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Distributed-Memory-Architecture.png" class="img-fluid"></p>
<p>在分布式内存架构下, 数据可以静态分布, 也可以通过节点移动; 既可以按需移动数据, 也可以提前将数据推送到新节点. 因此他的编程模型更复杂, 实现高性能计算任务时, 除了通常数据局部性还需要考虑通信开销, 也就是需要在考虑拓扑结构的同时设计数据的存储,通信的策略等. 仅仅是矩阵乘的计算就有非常多种方式, 接下来我将逐一介绍.</p>
<section id="目前常用的分布式矩阵乘方法" class="level1">
<h1>1. 目前常用的分布式矩阵乘方法</h1>
<p>目前大家对于大模型分布式可能比较熟悉, 因此我从大模型中的TP开始举例, 首先原始的TP是在一维拓扑上切分模型的权重, 也就是每个处理器节点存储<code>A[M,K], B[K,N/P]</code>大小的数据:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/TP 1D.png" class="img-fluid"></p>
<p>套用<a href="https://arxiv.org/abs/2110.15032">oneflow</a>中sbp的表示方式, 这里的切分逻辑可以表示为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20(broadcast)%20%5Ctimes%20(split(1))%20=%20(split(1))%0A%5Cend%7Baligned%7D%0A"></p>
<p>那么假设扩展到二维拓扑下, 我们可以自然的想到对K维度进行切分, 那么每个阶段存储<code>A[M,K/P], B[K/P,N/P]</code>大小的数据:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/TP 2D.png" class="img-fluid"></p>
<p>当然这里别忘记K维度切分后需要做Core间reduce, 使用sbp可以按如下描述 <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20(broadcast,%20split(1))%20%5Ctimes%20(split(1),%20split(0))%20=%20(split(1),%20partialsum)%5C%5C%0A%20%20(split(1),%20partialsum)%20%5Cxrightarrow%7B%5Ctext%7Bboxing%7D%7D%20(split(1),%20broadcast)%0A%5Cend%7Baligned%7D%0A"></p>
<p>同样还可以切分M和N:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20(split(0),%20broadcast)%20%5Ctimes%20(broadcast,%20split(1))%20=%20(split(0),%20split(1))%0A%5Cend%7Baligned%7D%0A"></p>
<p>不知道大家有没有发现, 在sbp的表示方法下, 它所指示的切分代表实际存储的数据分片, 并且计算的数据完全来自本地数据, 那么在它的表示下, 矩阵乘总是有一个维度是无法被切分的, 因为在M,K,N同时被二维拓扑切分时, 按他的逻辑所计算出的结果会不完整. 这带来的第一个问题即是每个节点的内存占用较高.</p>
</section>
<section id="cannon算法" class="level1">
<h1>2. Cannon算法</h1>
<section id="原理" class="level2">
<h2 class="anchored" data-anchor-id="原理">2.1 原理</h2>
<p>Cannon算法来自于1969年的论文<a href="https://dl.acm.org/doi/book/10.5555/905686">A cellular computer to implement the Kalman Filter Algorithm</a>, 它适用在均匀的2D mesh上实现分布式矩阵乘, 他的优势在于完全对三个维度进行切分, 不会增加内存占用:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Cannon Alg.png" class="img-fluid"></p>
<p>它将K维度的reduce依旧放在同一个core上执行, 但是同时需要把K维度进行切分, 通过时间上的迭代逐渐<code>shift</code>需要的k到目标core上. 因此需要对矩阵A,B进行预先分布, 并且此时的切分状态就无法使用类似SBP的形式表示, 需要用映射的方式来表示: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Bj,%20(i+j)%20%5C%25%20%5Csqrt%7BP%7D%5D%20%5Crightarrow%20%5Bm,k%5D%20%5C%5C%0A%20%20%5B(i+j)%20%5C%25%20%5Csqrt%7BP%7D,%20i%5D%20%5Crightarrow%20%5Bk,n%5D%20%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>下图展示了在二维mesh的第一行处理器上所分布的数据状态:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Cannon.png" class="img-fluid"></p>
<p>接下来分别是<code>矩阵乘累加</code>以及<code>shift</code>, <code>shift</code>表示在x和y方向上对A,B的数据分片进行ring的传输, 下图展示的是<code>shift</code>后数据分片变化情况:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Canon Compute.gif" class="img-fluid"></p>
</section>
<section id="实现" class="level2">
<h2 class="anchored" data-anchor-id="实现">2.2 实现</h2>
<p>下面是一个基于mpi4py实现的cannon算法实例:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpi4py <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MPI</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> viztracer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> log_sparse</span>
<span id="cb1-4">np.set_printoptions(suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> matmul(c: np.ndarray, a, b):</span>
<span id="cb1-7">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> b</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@log_sparse</span>(stack_depth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cannon(A: np.ndarray, B: np.ndarray, C: np.ndarray, P, comm2d: MPI.Cartcomm):</span>
<span id="cb1-11">  (M, K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.shape</span>
<span id="cb1-12">  N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> B.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-13">  (mTile, nTile, kTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P)</span>
<span id="cb1-14"></span>
<span id="cb1-15">  (j, i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Get_coords(rank)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># topology is row major</span></span>
<span id="cb1-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># align data</span></span>
<span id="cb1-17">  k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> j) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> P</span>
<span id="cb1-18">  a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(A[j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile:(k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile].copy())</span>
<span id="cb1-19">  b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(B[k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile:(k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile].copy())</span>
<span id="cb1-20"></span>
<span id="cb1-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute and shift</span></span>
<span id="cb1-22">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([mTile, nTile], np.float32)</span>
<span id="cb1-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(P):</span>
<span id="cb1-24">    matmul(c.view(), a, b)</span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb1-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># top right is (0,0)</span></span>
<span id="cb1-27">    right, left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Get_cart_rank([j, (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> P]), comm2d.Get_cart_rank([j, (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> P])</span>
<span id="cb1-28">    comm2d.Sendrecv_replace(a, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left, source<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>right)</span>
<span id="cb1-29">    top, down <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Get_cart_rank([(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> P, i]), comm2d.Get_cart_rank([(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> P, i])</span>
<span id="cb1-30">    comm2d.Sendrecv_replace(b, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>top, source<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>down)</span>
<span id="cb1-31"></span>
<span id="cb1-32">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare result</span></span>
<span id="cb1-33">  ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile]</span>
<span id="cb1-34">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> np.allclose(c, ref)</span>
<span id="cb1-35"></span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__main__'</span>:</span>
<span id="cb1-38">  A, B, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb1-39">  P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb1-40">  comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MPI.COMM_WORLD</span>
<span id="cb1-41">  rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Get_rank()</span>
<span id="cb1-42">  comm2d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Create_cart([P, P], [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb1-43">  cannon(A, B, C, P, comm2d)</span></code></pre></div></div>
<p>我这里构造了<code>M:11520,K:7680,N:12288</code>大小的矩阵, 并使用9个处理器执行:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mpiexec</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 9 python cannon.py               </span></code></pre></div></div>
<p>此代码的profiling结果如下: <img src="https://zhen8838.github.io/posts/mesh-matmul/Cannon Trace.png" class="img-fluid"></p>
</section>
<section id="分析" class="level2">
<h2 class="anchored" data-anchor-id="分析">2.3 分析</h2>
<p>首先我们使用<a href="https://www.cs.utexas.edu/~pingali/CSE392/2011sp/lectures/Conc_Comp.pdf">此处</a>所提出的alpha-beta模型分析代价:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Cost Model.png" class="img-fluid"></p>
<p>对于Cannon算法, 假设处理器个数为<img src="https://latex.codecogs.com/png.latex?P">, 并且矩阵三个维度均为<img src="https://latex.codecogs.com/png.latex?n">, 在忽略初始分布开销的情况下, 通信代价下限为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20Cost%20=%202(%5Csqrt%7BP%7D-1)(%5Calpha%20+%20%5Cfrac%7Bn%5E2%7D%7BP%7D%20%5Cbeta)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
</section>
<section id="summa算法" class="level1">
<h1>3. SUMMA算法</h1>
<p>SUMMA算法来源于1995年的论文<a href="https://dl.acm.org/doi/10.5555/899248">Scalable Universal Matrix Multiplication Algorithm</a>, 他克服了cannon算法限制处理器阵列必须为方形的缺点, 提出了一种更加通用以及便于实现的算法:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA Alg.png" class="img-fluid"></p>
<section id="原理-1" class="level2">
<h2 class="anchored" data-anchor-id="原理-1">3.1 原理</h2>
<p>他是典型的计算的存储分离的模式, 他同样将数据进行了完全切分, 每个节点上没有重复存储, 此时可以使用类似SBP的方式来表示: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20(split(0),%20split(1))%20%5Ctimes%20(split(0),%20split(1))%20=%20(split(0),%20split(1))%0A%5Cend%7Baligned%7D%0A"></p>
<p>对应的示意图如下:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA.png" class="img-fluid"></p>
<p>计算和使用SIMD指令进行外积形式的矩阵乘一致, 在K维度迭代, 只是数据需要从存储它的节点broadcast到其他节点:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA Compute.gif" class="img-fluid"></p>
</section>
<section id="实现-1" class="level2">
<h2 class="anchored" data-anchor-id="实现-1">3.2 实现</h2>
<p>为了简单起见, 依旧使用<code>M:11520,K:7680,N:12288</code>大小的矩阵, 并使用9个处理器执行:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpi4py <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MPI</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> viztracer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> log_sparse</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb3-4">np.set_printoptions(suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> matmul(c: np.ndarray, a, b):</span>
<span id="cb3-7">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> b</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@log_sparse</span>(stack_depth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> summa(A: np.ndarray, B: np.ndarray, C: np.ndarray, P, comm2d: MPI.Cartcomm):</span>
<span id="cb3-11">  col_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb3-12">  row_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>])</span>
<span id="cb3-13"></span>
<span id="cb3-14">  (M, K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.shape</span>
<span id="cb3-15">  N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> B.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-16">  (mTile, nTile, kTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> P)</span>
<span id="cb3-17">  (j, i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm2d.Get_coords(rank)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># topology is row major</span></span>
<span id="cb3-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># align data</span></span>
<span id="cb3-19">  a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(A[j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile].copy())</span>
<span id="cb3-20">  b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(B[j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile].copy())</span>
<span id="cb3-21"></span>
<span id="cb3-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute and broadcast</span></span>
<span id="cb3-23">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([mTile, nTile], np.float32)</span>
<span id="cb3-24">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(P):</span>
<span id="cb3-25">    Atemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.empty_like(a)</span>
<span id="cb3-26">    Btemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.empty_like(b)</span>
<span id="cb3-27">    row_comm.Bcast(Atemp, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k)</span>
<span id="cb3-28">    col_comm.Bcast(Btemp, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k)</span>
<span id="cb3-29">    matmul(c.view(), Atemp, Btemp)</span>
<span id="cb3-30"></span>
<span id="cb3-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare result</span></span>
<span id="cb3-32">  ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mTile, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile]</span>
<span id="cb3-33">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> np.allclose(c, ref)</span>
<span id="cb3-34"></span>
<span id="cb3-35"></span>
<span id="cb3-36"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__main__'</span>:</span>
<span id="cb3-37">  A, B, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb3-38">  P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb3-39">  comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MPI.COMM_WORLD</span>
<span id="cb3-40">  rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Get_rank()</span>
<span id="cb3-41">  comm2d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Create_cart([P, P], [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb3-42">  summa(A, B, C, P, comm2d)</span></code></pre></div></div>
<p>此代码的profiling结果如下: <img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA Trace.png" class="img-fluid"></p>
</section>
<section id="分析-1" class="level2">
<h2 class="anchored" data-anchor-id="分析-1">3.3 分析</h2>
<p>同样保持与之前类似的假设, 计算得通信代价下界为:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20Cost%20=%20%202%20%5Csqrt%7BP%7D%20(%5Calpha%5Clog%20%5Csqrt%7BP%7D%20+%20%5Cfrac%7Bn%5E2%7D%7BP%7D%5Cbeta)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
</section>
<section id="d-summa算法" class="level1">
<h1>4. 3D SUMMA算法</h1>
<p>3D SUMMA算法来自于论文<a href="https://ieeexplore.ieee.org/document/5389455">A three-dimensional approach to parallel matrix multiplication</a>, 主要用于三维拓扑结构下进行矩阵乘计算, 他的优点是通信量比2d summa更小:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 3D Alg.png" class="img-fluid"></p>
<section id="原理-2" class="level2">
<h2 class="anchored" data-anchor-id="原理-2">4.1 原理</h2>
<p>它首先把处理器节点构造为一个立方体拓扑结构, 然后将数据尽量切分映射到不同的节点上:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 3D.png" class="img-fluid"></p>
<p>使用SBP的表示方式来描述: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20&amp;(split(1),%20split(1),%20split(0))%20%5Ctimes%20%20(split(1),%20split(0),%20split(0))%20=%20(split(1),%20split(1),%20split(0))%20%5C%5C%0A%20%20&amp;A:%5Bi,j+l%5D%20%5Crightarrow%20%5Bm,k%5D%5C%5C%0A%20%20&amp;B:%5Bl,j+i%5D%20%5Crightarrow%20%5Bk,n%5D%5C%5C%0A%20%20&amp;C:%5Bi,j+l%5D%20%5Crightarrow%20%5Bm,n%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>为了尽量减少存储开销, 对于A,B都在三个维度进行了切分, 同时其中两个维度切的是同一个轴. 先通过<code>Allgather</code>将A,B收集并广播,然后计算矩阵乘得到<img src="https://latex.codecogs.com/png.latex?D_%7Bijl%7D">, 然后通过一个<code>Alltoall</code>将z轴的k换成了n的切分, 然后每个core单独执行reduce操作即可:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 3D Compute.png" class="img-fluid"></p>
</section>
<section id="实现-2" class="level2">
<h2 class="anchored" data-anchor-id="实现-2">4.2 实现</h2>
<p>为了简单起见, 依旧使用<code>M:11520,K:7680,N:12288</code>大小的矩阵, 并使用8个处理器执行:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpi4py <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MPI</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> viztracer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> log_sparse</span>
<span id="cb4-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb4-5">np.set_printoptions(suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@log_sparse</span>(stack_depth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> summa_3d(A: np.ndarray, B: np.ndarray, C: np.ndarray, p, comm3d: MPI.Cartcomm):</span>
<span id="cb4-9">  x_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>])</span>
<span id="cb4-10">  y_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb4-11">  z_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb4-12"></span>
<span id="cb4-13">  (M, K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.shape</span>
<span id="cb4-14">  N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> B.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-15">  (MTile, NTile, KTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p)</span>
<span id="cb4-16">  (mTile, nTile, kTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (MTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, NTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p)</span>
<span id="cb4-17">  (l, j, i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Get_coords(rank)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># topology is row major</span></span>
<span id="cb4-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># align data</span></span>
<span id="cb4-19">  a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(A[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile, l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KTile:(l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KTile]</span>
<span id="cb4-20">                           [:, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile: (j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kTile].copy())</span>
<span id="cb4-21">  b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(B[l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KTile:(l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KTile, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-22">                           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile][:, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile: (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile].copy())</span>
<span id="cb4-23"></span>
<span id="cb4-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute and passing data</span></span>
<span id="cb4-25">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros([MTile, nTile], np.float32)</span>
<span id="cb4-26">  Atemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([p, MTile, kTile], np.float32)</span>
<span id="cb4-27">  Btemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([p, KTile, nTile], np.float32)</span>
<span id="cb4-28">  y_comm.Allgather(a, Atemp)</span>
<span id="cb4-29">  x_comm.Allgather(b, Btemp)</span>
<span id="cb4-30">  Atemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Atemp.transpose([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]).reshape(MTile, KTile)</span>
<span id="cb4-31">  Btemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Btemp.transpose([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]).reshape(KTile, NTile)</span>
<span id="cb4-32">  Dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.dot(Atemp, Btemp)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [MTile, NTile]</span></span>
<span id="cb4-33">  Dr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([p, MTile, nTile], np.float32)</span>
<span id="cb4-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note that mpi4py will send data sequentially. So, we want to resplit on N. We had to split it first.</span></span>
<span id="cb4-35">  Dsend <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(np.stack(np.split(Dl, p, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb4-36">  z_comm.Alltoall(Dsend, Dr)</span>
<span id="cb4-37">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(Dr, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb4-38"></span>
<span id="cb4-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare result</span></span>
<span id="cb4-40">  ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile][:, l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile:(l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nTile]</span>
<span id="cb4-41">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> np.allclose(c, ref)</span>
<span id="cb4-42"></span>
<span id="cb4-43"></span>
<span id="cb4-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__main__'</span>:</span>
<span id="cb4-45">  A, B, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb4-46">  p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb4-47">  comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MPI.COMM_WORLD</span>
<span id="cb4-48">  rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Get_rank()</span>
<span id="cb4-49">  comm3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Create_cart([p, p, p], [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb4-50">  summa_3d(A, B, C, p, comm3d)</span></code></pre></div></div>
<p>注意由于<code>mpi4py</code>所提供一些接口限制, 中间引入了一些必要的数据重排操作来保证通信的正确性, 此代码的profiling结果如下: <img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 3D Trace.png" class="img-fluid"></p>
</section>
<section id="分析-2" class="level2">
<h2 class="anchored" data-anchor-id="分析-2">4.3 分析</h2>
<p>同样保持与之前类似的假设, 计算得通信代价下界为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20Cost%20&amp;=%202(%5Calpha%5Clog%5Csqrt%5B3%5D%7BP%7D%20+%20%5Cfrac%7B(%5Csqrt%5B3%5D%7BP%7D-1)%7D%7B%5Csqrt%5B3%5D%7BP%7D%7D%5Cfrac%7BN%5E2%7D%7BP%7D%5Cbeta)%20+%20(%5Calpha%5Clog%5Csqrt%5B3%5D%7BP%7D%20+%20%5Cfrac%7B(%5Csqrt%5B3%5D%7BP%7D-1)%7D%7B%5Csqrt%5B3%5D%7BP%7D%7D%20%5Cfrac%7BN%5E2%7D%7BP%5E%7B%5Cfrac%7B2%7D%7B3%7D%7D%7D%20%5Cbeta%20)%20%5C%5C%0A%20%20%20%20%20%20&amp;=%203%5Calpha%5Clog%5Csqrt%5B3%5D%7BP%7D%20+%20%5Cfrac%7B(%5Csqrt%5B3%5D%7BP%7D-1)%7D%7B%5Csqrt%5B3%5D%7BP%7D%7D(%5Cfrac%7B2N%5E2%7D%7BP%7D%20+%20%5Cfrac%7BN%5E2%7D%7BP%5E%7B%5Cfrac%7B2%7D%7B3%7D%7D%7D)%5Cbeta%0A%5Cend%7Baligned%7D%0A"></p>
<p>总的来说, 3D算法可以比2D算法少传输<img src="https://latex.codecogs.com/png.latex?P%5E%7B%5Cfrac%7B1%7D%7B6%7D%7D">倍的数据.</p>
</section>
</section>
<section id="d-summa-算法" class="level1">
<h1>5. 2.5D SUMMA 算法</h1>
<p>实际上2.5D算法有两种, 一种是<a href="https://link.springer.com/chapter/10.1007/978-3-642-23397-5_10">基于Cannon改进版</a>, 另一种是<a href="https://ieeexplore.ieee.org/document/6114461">基于SUMMA改进版</a>.不过他们都是在$p p d,1 d p $的拓扑结构下执行的一种泛化算法:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/2.5D Grid.png" class="img-fluid"></p>
<p>其中Cannon改进版还有存在拓扑结构为方阵的约束, 并且计算逻辑复杂:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Cannon 2.5D ALG.png" class="img-fluid"></p>
<p>后来作者提出SUMMA改进版, 可以推广到非方阵拓扑, 计算过程简单, 并且和上面的算法有相同的理论下限:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 2.5D ALG.png" class="img-fluid"></p>
<section id="原理-3" class="level2">
<h2 class="anchored" data-anchor-id="原理-3">5.1 原理</h2>
<p>支持可以变化的拓扑结构, d可以降低到1退化为2D并行, 也可以提高到p进化为3d并行. 使用SBP的表示方式来描述: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20&amp;(broadcast,%20split(1),%20split(0))%20%5Ctimes%20(broadcast,%20split(1),%20split(0))%20=%20(partialsum,%20split(1),%20split(0))%20%5C%5C%0A%20%20&amp;A:%5Bi,j%5D%20%5Crightarrow%20%5Bm,k%5D%5C%5C%0A%20%20&amp;B:%5Bi,j%5D%20%5Crightarrow%20%5Bk,n%5D%5C%5C%0A%20%20&amp;C:%5Bi,j,l%5D%20%5Crightarrow%20%5Bm,n,k%5E*%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>首先在z轴为0处分布A,B矩阵, 然后broadcast到整个阵列. 接着是横向纵向重新分布a,b, 实现在z轴重新切分K, 最后矩阵乘并在z轴reduce得到结果:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 2.5D Compute.png" class="img-fluid"></p>
</section>
<section id="实现-3" class="level2">
<h2 class="anchored" data-anchor-id="实现-3">5.2 实现</h2>
<p>为了简单起见, 依旧使用<code>M:11520,K:7680,N:12288</code>大小的矩阵, 并使用18个处理器执行:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpi4py <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MPI</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> viztracer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> log_sparse</span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb5-5">np.set_printoptions(suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@log_sparse</span>(stack_depth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb5-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> summa_2_5d(A: np.ndarray, B: np.ndarray, C: np.ndarray, p, d, comm3d: MPI.Cartcomm):</span>
<span id="cb5-9">  x_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>])</span>
<span id="cb5-10">  y_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb5-11">  z_comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Sub([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb5-12"></span>
<span id="cb5-13">  (M, K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.shape</span>
<span id="cb5-14">  N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> B.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-15">  (MTile, NTile, KPTile, KDTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> p, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> d)</span>
<span id="cb5-16">  (l, j, i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm3d.Get_coords(rank)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># topology is row major</span></span>
<span id="cb5-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># align data</span></span>
<span id="cb5-18">  a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(A[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-19">                           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.ones([MTile, KPTile], np.float32)</span>
<span id="cb5-20">  b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ascontiguousarray(B[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-21">                           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.ones([KPTile, NTile], np.float32)</span>
<span id="cb5-22">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros([MTile, NTile], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>)</span>
<span id="cb5-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute and passing data</span></span>
<span id="cb5-24"></span>
<span id="cb5-25">  z_comm.Bcast(a, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-26">  z_comm.Bcast(b, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-27">  ktile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> math.gcd(KPTile, KDTile)</span>
<span id="cb5-28">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>((l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KDTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> ktile, ((l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KDTile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> ktile):</span>
<span id="cb5-29">    aroot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> KPTile)</span>
<span id="cb5-30">    Atemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.copy(a[:, (k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (aroot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile):</span>
<span id="cb5-31">                      ((k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (aroot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile)]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> aroot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.empty([MTile, ktile], np.float32)</span>
<span id="cb5-32">    y_comm.Bcast(Atemp, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aroot)</span>
<span id="cb5-33"></span>
<span id="cb5-34">    broot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> KPTile)</span>
<span id="cb5-35">    Btemp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.copy(b[(k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (broot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile):</span>
<span id="cb5-36">                      ((k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ktile) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (broot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> KPTile), :]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> broot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.empty([ktile, NTile], np.float32)</span>
<span id="cb5-37">    x_comm.Bcast(Btemp, root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>broot)</span>
<span id="cb5-38">    np.add(c, np.dot(Atemp, Btemp), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>c)</span>
<span id="cb5-39"></span>
<span id="cb5-40">  cr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty([MTile, NTile], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb5-41">  z_comm.Reduce(c, cr)</span>
<span id="cb5-42"></span>
<span id="cb5-43">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare result</span></span>
<span id="cb5-44">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb5-45">    ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MTile, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> NTile]</span>
<span id="cb5-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> np.allclose(cr, ref)</span>
<span id="cb5-47"></span>
<span id="cb5-48"></span>
<span id="cb5-49"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__main__'</span>:</span>
<span id="cb5-50">  A, B, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>), np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C.npy'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb5-51">  p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb5-52">  d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-53">  comm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MPI.COMM_WORLD</span>
<span id="cb5-54">  rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Get_rank()</span>
<span id="cb5-55">  comm3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> comm.Create_cart([d, p, p], [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb5-56">  summa_2_5d(A, B, C, p, d, comm3d)</span></code></pre></div></div>
<p>实现的时候需要考虑跟多的细节, 因为他这里实际上重新对K进行了切分, 所以迭代k的时候需要按更小的块来广播, 此代码的profiling结果如下: <img src="https://zhen8838.github.io/posts/mesh-matmul/SUMMA 2.5D Trace.png" class="img-fluid"></p>
</section>
<section id="分析-3" class="level2">
<h2 class="anchored" data-anchor-id="分析-3">5.3 分析</h2>
<p>假设处理器维度为<img src="https://latex.codecogs.com/png.latex?p,p,d">, 并且忽略第一次的分布的代价, 计算通信代价为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20Cost%20&amp;%20=%202%5Calpha%20%5Clog%20p%20%20+%202%5Cfrac%7Bn%5E2%7D%7Bpd%7D%20%5Cbeta%20+%20%20%5Calpha%20%5Clog%20d+%202%5Cfrac%7B(d-1)n%5E2%7D%7Bd%7D%20%20%5Cbeta%20%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>注意到SUMMA 2.5D实际上在d上多存储A,B矩阵.</p>
</section>
</section>
<section id="大模型中的2.5d与3d并行" class="level1">
<h1>6. 大模型中的2.5D与3D并行</h1>
<section id="tesseract" class="level2">
<h2 class="anchored" data-anchor-id="tesseract">6.1 <a href="https://arxiv.org/pdf/2105.14500">Tesseract</a></h2>
<p>Tesseract实际上就是在大模型训练中被大家所熟知的2.5D并行, 他注意到了SUMMA 2.5D算法额外的内存开销问题, 提出进一步切分A矩阵:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>A</th>
<th>B</th>
<th>C</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="https://zhen8838.github.io/posts/mesh-matmul/Tesseract A.png" class="img-fluid"></td>
<td><img src="https://zhen8838.github.io/posts/mesh-matmul/Tesseract B.png" class="img-fluid"></td>
<td><img src="https://zhen8838.github.io/posts/mesh-matmul/Tesseract C.png" class="img-fluid"></td>
</tr>
</tbody>
</table>
<p>并且把拓扑结构构造为<img src="https://latex.codecogs.com/png.latex?p,p,d">的形式来更有效的分配数据和计算.</p>
<p>可以在结果中发现2.5D在进化到3D并行时取得了最好的效果.</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Tesseract Result.png" class="img-fluid"></p>
</section>
<section id="nus版3d并行" class="level2">
<h2 class="anchored" data-anchor-id="nus版3d并行">6.2 <a href="https://arxiv.org/pdf/2105.14450">NUS版3D并行</a></h2>
<p>这篇论文有三个改进, 分别是负载均衡, 优化矩阵矩阵乘, 优化矩阵向量乘. 但他这里的提到原始的3D并行只在两个维度切分A,B矩阵这是不对的, 本文第四节严格按照3D并行原论文进行了实现, 实际上是对于A矩阵的K是在<code>j,l</code>,以及B矩阵的N在<code>j,i</code>都做了进一步的切分的.</p>
<p>不过NUS版对于A矩阵的进一步切分维度确实与原论文不同: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20A:%5Bi+j,l%5D%20%5Crightarrow%20%5BM,K%5D%5C%5C%0A%20%20B:%5Bl,%20j+i%5D%20%5Crightarrow%20%5BK,N%5D%0A%5Cend%7Balign%7D%0A"></p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/NUS 3D.png" class="img-fluid"></p>
<p>最终取得了良好的效果, 但是他这里并没有和Tesseract来对比:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/NUS 3D Result.png" class="img-fluid"></p>
</section>
</section>
<section id="t10-inter-core-connected-compiler" class="level1">
<h1>7. <a href="https://arxiv.org/abs/2408.04808">T10: Inter-core Connected Compiler</a></h1>
<p>T10是针对核间互联架构IPU所提出的专用编译器, 对于不太了解的读者可以先参考<a href="https://zhuanlan.zhihu.com/p/1899480206">冯Jungle​的解读</a>, 本文就直接分析T10所提出的rTensor抽象的底层逻辑. 首先T10提出了在核间互联架构上有一种内存高效的计算模式:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/T10 Compute Pattern.png" class="img-fluid"></p>
<p>即多个core之间切分矩阵, 计算后通过ring的方式交换子矩阵, 再计算得下一部分的结果, 这样可以在空间和时间的角度同时切分矩阵, 从而最小化内存的使用量.</p>
<section id="rtensor抽象" class="level2">
<h2 class="anchored" data-anchor-id="rtensor抽象">7.1 rTensor抽象</h2>
<p>为了在编译器中表达这样一种计算模式, 因此他提出了rTensor的抽象:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RotatingTensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">  vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb6-3">  DataType type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-4">  vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> spatial_partition_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-5">  vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> temporal_partition_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb6-6">  vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> rotating_pace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>rTensor中的参数解释:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20&amp;f_s%5EX%20:%20%5Ctextbf%7BSpatial%20Partition%20Factor%7D,%5C%20%5Ctext%7BSpatially%20partitions%20a%20tensor%20X%20into%20sub-tensors.%7D%20%5C%5C%0A%20%20&amp;f_t%5EX%20:%20%5Ctextbf%7BTemporal%20Partition%20Factor%7D,%5C%20%5Ctext%7BTemporally%20partitions%20a%20sub-tensor%20of%20X%20into%20sub-tensor%20partitions.%7D%20%5C%5C%0A%20%20&amp;rp%20:%20%5Ctextbf%7BRotating%20Pace%7D,%5C%20%5Ctext%7BSpecifies%20how%20sub-tensor%20partitions%20are%20shifted%20among%20cores.%7D%5C%5C%0A%20%20&amp;F_%7Bop%7D:%20%20%5Ctextbf%7B%20Operator%20Partition%20Factor%7D,%5C%20%5Ctext%7BSpatially%20partitions%20an%20entire%20operator%20into%20sub-operators.%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>下面给定一个rTensor具体实例, 通过执行示意图来理解每个参数的含义:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/T10 rTensor.png" class="img-fluid"></p>
<p>上图中首先通过<img src="https://latex.codecogs.com/png.latex?f_s">在空间上切分矩阵, 然后由于矩阵在计算上的数据依赖, 是无法再使用空间上的并行, 因此采用<img src="https://latex.codecogs.com/png.latex?f_t">在时间维度上切分矩阵, 最后使用<img src="https://latex.codecogs.com/png.latex?rp">选择每次传输的数据块大小. 并且看到右下角的例子中<img src="https://latex.codecogs.com/png.latex?rp">可以小于时间上的分块, 对应到实际计算中就可以用于平衡计算和通信的时间.</p>
</section>
<section id="自动搜索rtensor" class="level2">
<h2 class="anchored" data-anchor-id="自动搜索rtensor">7.2 自动搜索rTensor</h2>
<p>目前有了形式化的描述方法, 那么就可以考虑如何构造搜索域并自动化搜索最优执行方式. T10并没有采用随机添加rTensor的配置来构造搜索域, 而是通过对原始计算语义上的切分来先行构造rTensor可选的配置域. 这也就是上一小节中<img src="https://latex.codecogs.com/png.latex?F_%7Bop%7D">的作用, 他根据当前op的计算定义来<strong>对矩阵计算进行切分</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20&amp;C%5BM,N%5D%20%5Cmathrel%7B+%7D=%20A%5BM,K%5D%20*%20B%5BK,N%5D%20%5C%5C%0A%20%20%5Ctext%7Bif%20%7D%20&amp;F_%7Bop%7D%5Bm,k,n%5D%20:%5C%5C%0A%20%20%5Ctext%7Beach%20core:%20%7D%20&amp;C%5B%5Cfrac%7BM%7D%7Bm%7D,%5Cfrac%7BN%7D%7Bn%7D%5D%20%5Cmathrel%7B+%7D=%20A%5B%5Cfrac%7BM%7D%7Bm%7D,%5Cfrac%7BK%7D%7Bk%7D%5D%20*%20B%5B%5Cfrac%7BK%7D%7Bk%7D,%5Cfrac%7BN%7D%7Bn%7D%5D%20%5C%5C%0A%20%20&amp;%5Ctext%7Btotal%20cores%7D%20=%20%5Cprod_%7Bi=0%7D%5E%7B2%7D%20F_%7Bop%7D%5Bi%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>假设<img src="https://latex.codecogs.com/png.latex?F_%7Bop%7D">确定时, 就可以确定总core数, 以及每个core上的子任务所依赖的数据量: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20&amp;%20%20C%5B2,3%5D%20%5Cmathrel%7B+%7D=%20A%5B2,6%5D%20*%20B%5B6,3%5D%20%5C%5C%0A%20%20&amp;F_%7Bop%7D%20=%20%5B2,1,3%5D%20:%5C%5C%0A%20%20%5Ctext%7Beach%20core:%20%7D%20&amp;%20C%5B1,1%5D%20%5Cmathrel%7B+%7D=%20A%5B1,6%5D%20*%20B%5B6,1%5D%20%5C%5C%0A%20%20&amp;%5Ctext%7Btotal%20cores%7D%20=%206%0A%5Cend%7Baligned%7D%0A"></p>
<p>通过子任务的数据量, 就可以<strong>推导出三个矩阵的空间切分参数</strong>: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cbegin%7Bmatrix%7D%0A%20%20%20&amp;%20%5Ctextbf%7Bm%7D%20&amp;%20%5Ctextbf%7Bk%7D%20&amp;%20%5Ctextbf%7Bn%7D%20%5C%5C%0A%20%20F_%7Bop%7D%20&amp;%202%20&amp;%201%20&amp;%203%20%5C%5C%0A%20%20f_s%5EA%20&amp;%202%20&amp;%201%20&amp;%20%5C%5C%0A%20%20f_s%5EB%20&amp;%20%20&amp;%201%20&amp;%203%20%5C%5C%0A%20%20f_s%5EC%20&amp;%202%20&amp;%20%20&amp;%203%0A%5Cend%7Bmatrix%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>观察上表可以发现A,B,C矩阵都有一个维度不参与他们的空间切分, 但实际上为了计算出最终结果, 这个不参与空间切分的维度是被当前矩阵完全依赖的, T10称这个维度为<code>missing axis</code>, 因此采用时间切分来分割<code>missing axis</code>. 比如当前一共6个core, B矩阵在空间上被切分了3组, 那么还剩下<img src="https://latex.codecogs.com/png.latex?P%20=%20%5Cfrac%7B6%7D%7B3%7D%20=%202">组可以用于切分, 因此按这个逻辑<strong>推导时间切分</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cbegin%7Bmatrix%7D%0A%20%20%20&amp;%20%5Ctextbf%7Bm%7D%20&amp;%20%5Ctextbf%7Bk%7D%20&amp;%20%5Ctextbf%7Bn%7D%20%5C%5C%0A%20%20F_%7Bop%7D%20&amp;%202%20&amp;%201%20&amp;%203%20%5C%5C%0A%20%20f_s%5EA%20&amp;%202%20&amp;%201%20&amp;%20%5C%5C%0A%20%20f_t%5EA%20&amp;%20%5Ccolor%7Bblue%7D1%20&amp;%20%5Ccolor%7Bred%7D3%20&amp;%20%5C%5C%0A%20%20f_s%5EB%20&amp;%20%20&amp;%201%20&amp;%203%20%5C%5C%0A%20%20f_t%5EB%20&amp;%20&amp;%20%5Ccolor%7Bred%7D2%20&amp;%20%5Ccolor%7Bblue%7D1%20%5C%5C%0A%20%20f_s%5EC%20&amp;%202%20&amp;%20%20&amp;%203%20%5C%5C%0A%20%20f_t%5EC%20&amp;%20%5Ccolor%7Bblue%7D1%20&amp;%20&amp;%20%5Ccolor%7Bblue%7D1%20%5C%5C%0A%5Cend%7Bmatrix%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>注意, T10限制了<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BP%7D%7B%5Cprod%20f_t%7D">必须是整数, 因为它其实就是ring的圈数, 如果非整数就无法支持. 当<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BP%7D%7B%5Cprod%20f_t%7D">大于1时, 则表明ring的圈不止一个, 那么为了保证每个圈都可以得到正确的数据, 就需要把子张量复制<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BP%7D%7B%5Cprod%20f_t%7D">次.</p>
<p>最后进行<strong>旋转参数对齐</strong>, 按照上面的切分, 可以发现A的K维度在分为3组, 而B的K维度被分为2组, 那么每个节点上所拥有的K分块大小并不一样, 这个时候只能按小的K分块进行计算和旋转:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20rp%5EA%20&amp;=%20%5B0,k%5EA%5D%5C%5C%0A%20%20rp%5EB%20&amp;=%20%5Bk%5EB,0%5D%20%5C%5C%0A%20%20k%5EA%20,%20k%5EB%20&amp;%5Cin%20%5B1,%5Cmin(2,3)%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>整体的流程如图所示:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/T10 Partitioning.png" class="img-fluid"></p>
</section>
<section id="算子内与算子间trade-off" class="level2">
<h2 class="anchored" data-anchor-id="算子内与算子间trade-off">7.3 算子内与算子间trade-off</h2>
<p>对于每个算子,都存在大量涉及不同空间和时间以及旋转因子确定的执行计划. 此外一个端到端的模型由众多算子组成, 这就产生了一个巨大的组合优化空间. T10采用的是两级权衡, 首先对每个算子搜索执行时间和内存消耗的最优平衡, 再在不同算子间最优计划之上优化全局内存分配, 这里就不进一步展开了.</p>
</section>
<section id="子张量放置" class="level2">
<h2 class="anchored" data-anchor-id="子张量放置">7.4 子张量放置</h2>
<p>优化内存分配之后, 还需要考虑数据放置问题, 因为ring shift只能在相邻节点之间传输数据, 如果初始数据放置的位置不合理, 会导致计算错误, 这在Cannon算法中称为<code>align data</code>过程. 而T10可以从编译器的角度, 看到上下算子的执行计算, 这给他们提供了全局张量放置优化机会. 比如一个算子的计算依赖于另一个算子的输出, T10会将这些相关的子张量放置在合适的核上, 减少数据准备过程的开销. 并且T10还总是按照阵列轴的方向升序排列数据, 避免出现乱序带来的错误.</p>
<p>在这个3x3阵列上, T10所放置的子张量如图所示:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/T10 Align.png" class="img-fluid"></p>
<p>可以回到第一节查看Cannon算法的初始放置, 两者是一模一样的.</p>
</section>
<section id="分析-4" class="level2">
<h2 class="anchored" data-anchor-id="分析-4">7.5 分析</h2>
<p>因此T10的本质是形式化与泛化了Cannon算法, 并将其用于核间互联架构. 那么他的问题也与Cannon一样, 即通信量会比SUMMA 3D等方法大, 比SUMMA 2D方法少<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B%5Csqrt%7BP%7D%7D">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20Cost%20=%202(%5Csqrt%7BP%7D-1)(%5Calpha%20+%20%5Cfrac%7Bn%5E2%7D%7BP%7D%20%5Cbeta)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
</section>
<section id="parallel-matrix-multiplication-a-systematic-journey" class="level1">
<h1>8. <a href="https://epubs.siam.org/doi/10.1137/140993478">Parallel Matrix Multiplication: A Systematic Journey</a></h1>
<p>这篇文章是blis作者Flame等人所写, 他通过系统性分析, 提出一种形式化的描述推导出SUMMA 2D/3D矩阵乘, 并分析不同的尺寸的矩阵下如何选择不同的数据广播策略.</p>
<p>首先他通过一种类似<img src="https://latex.codecogs.com/png.latex?x%5B(0,1),()%5D">来表示数据在节点上的切分状态, 这里表示的是x的M在阵列的行列均切分, N没有切分, 然后基于mpi的通信原语对切分状态进行转换: <img src="https://zhen8838.github.io/posts/mesh-matmul/Flame Formula.png" class="img-fluid"></p>
<p>而后基于切分状态描述不同的算法, 并且根据不同的输入尺寸设计不同的计算方法, 下图左侧是Stationary C算法, 右侧是Stationary A算法:</p>
<p><img src="https://zhen8838.github.io/posts/mesh-matmul/Flame ALG.png" class="img-fluid"></p>
<p>Stationary C 算法, 在<img src="https://latex.codecogs.com/png.latex?m=n">, 且方阵的情况对于任意的k值都有较好的弱可扩展性. Stationary A 算法, 虽然其通信开销相对较大, 但在<img src="https://latex.codecogs.com/png.latex?m">和<img src="https://latex.codecogs.com/png.latex?k">较大而<img src="https://latex.codecogs.com/png.latex?n">较小时, 该算法能够实现较好的并行性, 因为在这种情况下通信量减少.</p>
<p>最终, 总结在二维阵列上计算矩阵乘的通信量下限为<img src="https://latex.codecogs.com/png.latex?%5COmega(%5Cfrac%7Bn%5E2%7D%7B%5Csqrt%7BP%7D%7D">, 在二维阵列上计算矩阵乘的通信量下限为<img src="https://latex.codecogs.com/png.latex?%5COmega(%5Cfrac%7Bn%5E2%7D%7B%5Csqrt%5B3%5D%7BP%5E2%7D%7D)">, 但是具体的场景还需要根据矩阵乘的尺寸带来的不同的通信量, 来选择不同的计算方法.</p>
</section>
<section id="总结" class="level1">
<h1>9. 总结</h1>
<ol type="1">
<li>传统分布式矩阵乘的论文所计算的通信量通常假设矩阵大小相同, 但实际上需要分析当前场景下不同尺寸的通信开销.</li>
<li>T10是一个好的例子, 但是他的计算模式还在固定在Cannon算法, 如何推广到SUMMA?</li>
<li>如何推广更高维度阵列下的矩阵乘切分和映射?</li>
<li>如何对于一个支持RMA(Remote Memory Access)的架构, 是直接读取远端数据还是通过broadcast的方式把计算模式回落到SUMMA或Cannon?
<ol type="1">
<li>理论上RMA所需要读取的数据量与SUMMA是一致的, 但实现性能可能需要进一步测试.</li>
</ol></li>
</ol>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/mesh-matmul.html</guid>
  <pubDate>Thu, 07 Nov 2024 10:14:47 GMT</pubDate>
</item>
<item>
  <title>机器学习编译概念科普</title>
  <link>https://zhen8838.github.io/posts/mlc-tutorial.html</link>
  <description><![CDATA[ 




<p>带大家建立一个对机器学习编译的基本概念.</p>
<!--more-->
<section id="什么是机器学习编译" class="level1">
<h1>什么是机器学习编译?</h1>
<p>机器学习编译 (machine learning compilation, MLC) 是指，将机器学习算法从开发阶段，通过变换和优化算法，使其变成部署状态。</p>
<p><strong>开发形式</strong> 是指我们在开发机器学习模型时使用的形式。典型的开发形式包括用 PyTorch、TensorFlow 或 JAX 等通用框架编写的模型描述，以及与之相关的权重。</p>
<p><strong>部署形式</strong> 是指执行机器学习应用程序所需的形式。它通常涉及机器学习模型的每个步骤的支撑代码、管理资源（例如内存）的控制器，以及与应用程序开发环境的接口（例如用于 android 应用程序的 java API）。</p>
<p><img src="https://mlc.ai/_images/dev-deploy-form.png" class="img-fluid"></p>
<p>机器学习编译通常有以下几个目标：</p>
<p><strong>集成与最小化依赖</strong> 部署过程通常涉及集成 (Integration)，即将必要的元素组合在一起以用于部署应用程序。 例如，如果我们想启用一个安卓相机应用程序来检测猫，我们将需要图像分类模型的必要代码，但不需要模型无关的其他部分（例如，我们不需要包括用于 NLP 应用程序的embedding table）。代码集成、最小化依赖项的能力能够减小应用的大小，并且可以使应用程序部署到的更多的环境。</p>
<p><strong>利用硬件加速</strong> 每个部署环境都有自己的一套原生加速技术，并且其中许多是专门为机器学习开发的。机器学习编译的一个目标就是是利用硬件本身的特性进行加速。 我们可以通过构建调用原生加速库的部署代码或生成利用原生指令（如 TensorCore）的代码来做到这一点。</p>
<p><strong>通用优化</strong> 有许多等效的方法可以运行相同的模型执行。 MLC 的通用优化形式是不同形式的优化，以最小化内存使用或提高执行效率的方式转换模型执行。</p>
<p>这些目标没有严格的界限。例如，集成和硬件加速也可以被视为通用优化。根据具体的应用场景，我们可能对一些模型和生产环境对感兴趣，或者我们可能对部署到多个并选择最具成本效益的问题感兴趣。</p>
<p>重要的是，机器学习编译不一定表示单一稳定的解决方案。事实上，随着硬件和模型数量的增长，许多机器学习编译实践涉及与来自不同背景的开发人员的合作。硬件开发人员需要支持他们最新的硬件加速，机器学习工程师需要实现额外的优化，而同时算法工程师也引入了新模型。</p>
<section id="机器学习编译中的关键要素" class="level2">
<h2 class="anchored" data-anchor-id="机器学习编译中的关键要素">机器学习编译中的关键要素</h2>
<p>让我们首先回顾一个两层神经网络模型执行的例子。</p>
<p>在这个特定的模型中，我们通过展平输入图像中的像素来获取向量 (Vector)；然后，我们应用线性变换，将输入图像投影到长度为 200 的向量上，并运行ReLU 激活函数。最后，我们将其映射到长度为 10 的向量，向量的每个元素对应于图像属于该特定类别的可能性大小。</p>
<p><strong>张量 (Tensor)</strong> 是执行中最重要的元素。张量是表示神经网络模型执行的输入、输出和中间结果的多维数组。</p>
<p><strong>张量函数 (Tensor functions)</strong> 神经网络的“知识”被编码在权重和接受张量和输出张量的计算序列中。我们将这些计算称为张量函数。值得注意的是，张量函数不需要对应于神经网络计算的单个步骤。部分计算或整个端到端计算也可以看作张量函数。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/mlc-elem-transform.png" class="img-fluid figure-img"></p>
<figcaption>mlc-elem-transform</figcaption>
</figure>
</div>
<p>我们有多种方法可以在特定环境中实现模型执行。 上面的例子展示了一个例子。 值得注意的是，有两个区别： 首先，第一个linear层和relu计算被折叠成一个 linear_relu 函数，这需要有一个特定的linear_relu的详细实现。 当然，现实世界的用例，linear_relu 可以通过各种代码优化技术来实现，其中一些技术在的后面的课程中会进行介绍。 机器学习编译的过程就是是将上图左侧的内容转换为右侧的过程。在不同的场景中，这个过程可以是手动完成的，也可以使用一些自动转换工具，或两者兼而有之。</p>
</section>
<section id="元张量函数" class="level2">
<h2 class="anchored" data-anchor-id="元张量函数">元张量函数</h2>
<p>在上一章的概述中，我们介绍到机器学习编译的过程可以被看作张量函数之间的变换。一个典型的机器学习模型的执行包含许多步将输入张量之间转化为最终预测的计算步骤，其中的每一步都被称为元张量函数 (primitive tensor function)。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/primitive_tensor_func.png" class="img-fluid figure-img"></p>
<figcaption>元张量函数</figcaption>
</figure>
</div>
<p>在上面这张图中，张量算子 <code>linear</code>, <code>add</code>, <code>relu</code> 和 <code>softmax</code> 均为元张量函数。特别的是，许多不同的抽象能够表示（和实现）同样的元张量函数（正如下图所示）。我们可以选择调用已经预先编译的框架库（如 <code>torch.add</code> 和 <code>numpy.add</code>）并利用在 Python 中的实现。在实践中，元张量函数被例如 C 或 C++ 的低级语言所实现，并且在一些时候会包含一些汇编代码。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/tensor_func_abstractions.png" class="img-fluid figure-img"></p>
<figcaption>同一个元张量函数的不同形式</figcaption>
</figure>
</div>
<p>许多机器学习框架都提供机器学习模型的编译过程，以将元张量函数变换为更加专门的、针对特定工作和部署环境的函数。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/tensor_func_transformation.png" class="img-fluid figure-img"></p>
<figcaption>元张量函数间的变换</figcaption>
</figure>
</div>
<p>上面这张图展示了一个元张量函数 <code>add</code> 的实现被变换至另一个不同实现的例子，其中在右侧的代码是一段表示可能的组合优化的伪代码：左侧代码中的循环被拆分出长度为 <code>4</code> 的单元，<code>f32x4.add</code> 对应的是一个特殊的执行向量加法计算的函数。</p>
</section>
<section id="张量程序抽象" class="level2">
<h2 class="anchored" data-anchor-id="张量程序抽象">张量程序抽象</h2>
<p>上一节谈到了对元张量函数变换的需要。为了让我们能够更有效地变换元张量函数，我们需要一个有效的抽象来表示这些函数。</p>
<p>通常来说，一个典型的元张量函数实现的抽象包含了以下成分：存储数据的多维数组，驱动张量计算的循环嵌套以及计算部分本身的语句。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/tensor_func_elements.png" class="img-fluid figure-img"></p>
<figcaption>元张量函数中的典型成分</figcaption>
</figure>
</div>
<p>我们称这类抽象为<strong>张量程序抽象</strong>。张量程序抽象的一个重要性质是，他们能够被一系列有效的程序变换所改变。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/tensor_func_seq_transform.png" class="img-fluid figure-img"></p>
<figcaption>一个元张量函数的序列变换</figcaption>
</figure>
</div>
<p>例如，我们能够通过一组变换操作（如循环拆分、并行和向量化）将上图左侧的一个初始循环程序变换为右侧的程序。</p>
<section id="张量程序抽象中的其它结构" class="level3">
<h3 class="anchored" data-anchor-id="张量程序抽象中的其它结构">张量程序抽象中的其它结构</h3>
<p>重要的是，我们不能任意地对程序进行变换，比方说这可能是因为一些计算会依赖于循环之间的顺序。但幸运的是，我们所感兴趣的大多数元张量函数都具有良好的属性（例如循环迭代之间的独立性）。</p>
<p>张量程序可以将这些额外的信息合并为程序的一部分，以使程序变换更加便利。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mlc.ai/_images/tensor_func_iteration.png" class="img-fluid figure-img"></p>
<figcaption>循环迭代作为张量程序的额外信息</figcaption>
</figure>
</div>
<p>举个例子，上面图中的程序包含额外的 <code>T.axis.spatial</code> 标注，表明 <code>vi</code> 这个特定的变量被映射到循环变量 <code>i</code>，并且所有的迭代都是独立的。这个信息对于执行这个程序而言并非必要，但会使得我们在变换这个程序时更加方便。在这个例子中，我们知道我们可以安全地并行或者重新排序所有与 <code>vi</code> 有关的循环，只要实际执行中 <code>vi</code> 的值按照从 <code>0</code> 到 <code>128</code> 的顺序变化。</p>
</section>
</section>
<section id="总结" class="level2">
<h2 class="anchored" data-anchor-id="总结">总结</h2>
<ul>
<li>元张量函数表示机器学习模型计算中的单个单元计算。
<ul>
<li>一个机器学习编译过程可以有选择地转换元张量函数的实现。</li>
</ul></li>
<li>张量程序是一个表示元张量函数的有效抽象。
<ul>
<li>关键成分包括: 多维数组，循环嵌套，计算语句。</li>
<li>程序变换可以被用于加速张量程序的执行。</li>
<li>张量程序中额外的结构能够为程序变换提供更多的信息。</li>
</ul></li>
</ul>
</section>
</section>
<section id="张量优化的程序变换方法" class="level1">
<h1>张量优化的程序变换方法</h1>
<p>当我们在谈“优化”的时候，我们的目标是什么？如何通过“优化操作”，得到性能的提升呢？要解答这些疑问，我们需要了解硬件的基础的体系结构，了解硬件如何工作，才能在软件上实现算法的时候，尽可能去考虑利用硬件的一些特性，来做到高效的、极致的优化。 <img src="https://mlc.ai/_images/cpu_arch.png" class="img-fluid"></p>
<p>上图是典型的存储理器层次结构：主存容量大，访问速度慢，寄存器和缓存读取速度快，但容量有限。在寄存器的层级上，CPU可以在一个时钟周期内访问它们，如果CPU去访问外部的DDR的话，延迟是非常大的，大概是200个时钟周期左右。如果CPU去访问cache的话，一般需要6到12个cycle就够了。 所以，两个重要的优化宗旨:</p>
<ol type="1">
<li><p><strong>优化内存访问</strong>: 充分利用寄存器和高速缓存去存数据。</p></li>
<li><p><strong>提高并行性</strong>: 充分利用SIMD进行指令向量化和多核心并行.</p></li>
</ol>
<p>接下来我们定义一个简单的例子, 两个matmul之间有一个elemwise的操作:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty((M, K), requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>)</span>
<span id="cb1-2">B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty((K, L), requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>)</span>
<span id="cb1-3">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.matmul(A, B)</span>
<span id="cb1-4">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.exp(C)</span>
<span id="cb1-5">E <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty((L, N), requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E'</span>)</span>
<span id="cb1-6">F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.matmul(D, E)</span></code></pre></div></div>
<p>我们将使用tvm把上述计算过程描述为tenor function, 并使用tvm的调度原语进行程序变换. 大家可以通过pip安装tvm来一起上手执行接下来的代码:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span>  pip install mlc-ai-nightly <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> https://mlc.ai/wheels</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tvm</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> te</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tir</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm.script <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ir <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> I</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm.script <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tir <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> T</span>
<span id="cb3-7"></span>
<span id="cb3-8">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb3-9">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span></span>
<span id="cb3-10">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb3-11">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3072</span></span>
<span id="cb3-12"></span>
<span id="cb3-13"></span>
<span id="cb3-14">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.placeholder((M, K), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>)</span>
<span id="cb3-15">B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.placeholder((K, L), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>)</span>
<span id="cb3-16">rk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.reduce_axis((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rk'</span>)</span>
<span id="cb3-17">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.compute((M, L), <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> m, l: te.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(A[m, rk] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B[rk, l], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[rk]), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb3-18">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.compute((M, L), <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> m, l: te.exp(C[m, l]), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>)</span>
<span id="cb3-19">E <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.placeholder((L, N), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E'</span>)</span>
<span id="cb3-20">rl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.reduce_axis((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, L), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rl'</span>)</span>
<span id="cb3-21">F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.compute((M, N), <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> m, n: te.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(D[m, rl] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> E[rl, n], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[rl]), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23">tir_sch: te.Schedule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_schedule([C.op, D.op, F.op])</span>
<span id="cb3-24">tvm.lower(tir_sch, [A, B, E]).show()</span></code></pre></div></div>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"from_legacy_te_schedule"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>), <span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">1048576</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        F <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">3145728</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        C_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            C_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rk <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">2048</span>):
                cse_var_1: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
                A_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>A<span style="color: #AA22FF; font-weight: bold">.</span>data)
                B_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>B<span style="color: #AA22FF; font-weight: bold">.</span>data)
                C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">=</span> C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">+</span> A_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2048</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk] <span style="color: #AA22FF; font-weight: bold">*</span> B_1[rk <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l]
        C_2 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            cse_var_2: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
            C_2[cse_var_2] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C_1[cse_var_2])
        <span style="color: #008000; font-weight: bold">for</span> m, n <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>):
            F_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>F)
            F_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rl <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">1024</span>):
                cse_var_3: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n
                E_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>E<span style="color: #AA22FF; font-weight: bold">.</span>data)
                F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">=</span> F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">+</span> C_2[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl] <span style="color: #AA22FF; font-weight: bold">*</span> E_1[rl <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n]
</pre>
</div>
<p>我们来先测试未经优化的程序执行速度:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">a_nd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.nd.array(np.random.randn(M, K).astype(np.float32))</span>
<span id="cb4-2">b_nd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.nd.array(np.random.randn(K, L).astype(np.float32))</span>
<span id="cb4-3">e_nd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.nd.array(np.random.randn(L, N).astype(np.float32))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"></span>
<span id="cb5-2">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch, [A, B, E], target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb5-3">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu(), number<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb5-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 6.2369096530000006 sec</code></pre>
<section id="优化内存访问" class="level2">
<h2 class="anchored" data-anchor-id="优化内存访问">优化内存访问</h2>
<p>考虑matmul的native实现时, 在机器上是这样执行的:</p>
<p><img src="https://siboehm.com/assets/img/MMM/Basic_MMM.png" class="img-fluid"></p>
<p>通常，处理器使用固定大小的cache line（通常为 64 字节）从内存加载数据。当迭代 A 的行时，我们在第一个条目上发生了缓存未命中。处理器的高速缓存行提取也将在其中保存接下来的 15 个浮点数，这是对高速缓存的良好利用。 然而，对于矩阵 B，我们沿着列走，每一步都会发生cache miss, 这个就产生了严重的内存开销.</p>
<p><img src="https://siboehm.com/assets/img/MMM/cache-unaware-dot-product.png" class="img-fluid"></p>
<section id="loop-reorder" class="level3">
<h3 class="anchored" data-anchor-id="loop-reorder">1. loop reorder</h3>
<p>为了解决对于B矩阵的非连续访问导致的cache miss问题, 我们重新排序了两个矩阵乘的循环, 改变对于B矩阵的访问顺序.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">tir_sch: te.Schedule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_schedule([C.op, D.op, F.op])</span>
<span id="cb7-2">m,l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.axis</span>
<span id="cb7-3">(k,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.reduce_axis</span>
<span id="cb7-4">tir_sch[C].reorder(m,k,l)</span>
<span id="cb7-5">m,n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.axis</span>
<span id="cb7-6">(l,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.reduce_axis</span>
<span id="cb7-7">tir_sch[F].reorder(m,l,n)</span>
<span id="cb7-8"></span>
<span id="cb7-9">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch, [A, B, E], target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb7-10">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb7-13">tvm.lower(tir_sch, [A, B, E]).show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.4165279375 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"from_legacy_te_schedule"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>), <span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">1048576</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        F <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">3145728</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        C_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">for</span> l_init <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">1024</span>):
                C_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rk, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>):
                cse_var_1: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
                A_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>A<span style="color: #AA22FF; font-weight: bold">.</span>data)
                B_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>B<span style="color: #AA22FF; font-weight: bold">.</span>data)
                C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">=</span> C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">+</span> A_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2048</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk] <span style="color: #AA22FF; font-weight: bold">*</span> B_1[rk <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l]
        C_2 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            cse_var_2: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
            C_2[cse_var_2] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C_1[cse_var_2])
        <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">1024</span>):
            F_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>F)
            <span style="color: #008000; font-weight: bold">for</span> n_init <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">3072</span>):
                F_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rl, n <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>):
                cse_var_3: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n
                E_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>E<span style="color: #AA22FF; font-weight: bold">.</span>data)
                F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">=</span> F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">+</span> C_2[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl] <span style="color: #AA22FF; font-weight: bold">*</span> E_1[rl <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n]
</pre>
</div>
</section>
<section id="tiling" class="level3">
<h3 class="anchored" data-anchor-id="tiling">2. tiling</h3>
<p>可以发现仅通过loop reorder就可以让执行速度提升10倍. 虽然现在每一次load的cache miss减少了, 但是考虑整个的矩阵乘执行过程:</p>
<p><img src="https://siboehm.com/assets/img/MMM/Basic_tiling_inner.png" class="img-fluid"></p>
<p>目前的计算模式是固定A矩阵的一行, 然后反复加载B矩阵的所有行, 但是考虑到cache如果为32kb时, 在这个例子中只能缓存2=32*1024/4/4096行的B矩阵, 那么也就是最多两行之后就后来的B矩阵数据就会将之前cache中存储的数据驱除出去, 为了解决这个问题, 我们的方法就是通过切分K循环, 让他分为多个block, 使得每个block内部的B矩阵将会被缓存在cache中:</p>
<p><img src="https://siboehm.com/assets/img/MMM/Tiling_on_inner.png" class="img-fluid"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">tir_sch: te.Schedule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_schedule([C.op, D.op, F.op])</span>
<span id="cb9-2">m, l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.axis</span>
<span id="cb9-3">(k,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.reduce_axis</span>
<span id="cb9-4">ko, ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[C].split(k, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb9-5">tir_sch[C].reorder(ko, m, ki, l)</span>
<span id="cb9-6"></span>
<span id="cb9-7">m, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.axis</span>
<span id="cb9-8">(l,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.reduce_axis</span>
<span id="cb9-9">lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[F].split(l, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb9-10">tir_sch[F].reorder(lo, m, li, n)</span>
<span id="cb9-11"></span>
<span id="cb9-12">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch, [A, B, E], target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb9-13">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb9-14"></span>
<span id="cb9-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb9-16">tvm.lower(tir_sch, [A, B, E]).show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.3838193083 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"from_legacy_te_schedule"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>), <span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">1048576</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        F <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">3145728</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        C_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m_init, l_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            C_1[m_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
        <span style="color: #008000; font-weight: bold">for</span> rk_outer, m, rk_inner, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">256</span>, <span style="color: #008000">1024</span>, <span style="color: #008000">8</span>, <span style="color: #008000">1024</span>):
            cse_var_1: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
            A_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>A<span style="color: #AA22FF; font-weight: bold">.</span>data)
            B_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>B<span style="color: #AA22FF; font-weight: bold">.</span>data)
            C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">=</span> C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">+</span> A_1[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2048</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_inner] <span style="color: #AA22FF; font-weight: bold">*</span> B_1[rk_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8192</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l]
        C_2 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            cse_var_2: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
            C_2[cse_var_2] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C_1[cse_var_2])
        F_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>F)
        <span style="color: #008000; font-weight: bold">for</span> m_init, n_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>):
            F_1[m_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
        <span style="color: #008000; font-weight: bold">for</span> rl_outer, m, rl_inner, n <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">128</span>, <span style="color: #008000">1024</span>, <span style="color: #008000">8</span>, <span style="color: #008000">3072</span>):
            cse_var_3: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n
            E_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>E<span style="color: #AA22FF; font-weight: bold">.</span>data)
            F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">=</span> F_1[cse_var_3] <span style="color: #AA22FF; font-weight: bold">+</span> C_2[m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_inner] <span style="color: #AA22FF; font-weight: bold">*</span> E_1[rl_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">24576</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n]
</pre>
</div>
<p>可以发现虽然对reduce维度添加了tiling,但是最终的性能没有什么提升. 那是因为要考虑A/B/C矩阵都存储在cache中时, 很有可能B矩阵的一行都无法完全缓存起来, 因此实施tiling优化时通常是多个维度同时进行的:</p>
<p><img src="https://siboehm.com/assets/img/MMM/full_tiling.png" class="img-fluid"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">tir_sch: te.Schedule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_schedule([C.op, D.op, F.op])</span>
<span id="cb11-2">m, l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.axis</span>
<span id="cb11-3">(k,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C.op.reduce_axis</span>
<span id="cb11-4">mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[C].split(m, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb11-5">ko, ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[C].split(k, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb11-6">lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[C].split(l, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb11-7">tir_sch[C].reorder(mo, lo, ko, mi, ki, li)</span>
<span id="cb11-8"></span>
<span id="cb11-9">m, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.axis</span>
<span id="cb11-10">(l,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.op.reduce_axis</span>
<span id="cb11-11">mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[F].split(m, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb11-12">lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[F].split(l, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb11-13">no, ni <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch[F].split(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb11-14">tir_sch[F].reorder(mo, no, lo, mi, li, ni)</span>
<span id="cb11-15"></span>
<span id="cb11-16">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch, [A, B, E], target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb11-17">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb11-18"></span>
<span id="cb11-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb11-20">tvm.lower(tir_sch, [A, B, E]).show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.3760715791 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"from_legacy_te_schedule"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>), <span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">1048576</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        F <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>allocate([<span style="color: #008000">3145728</span>], <span style="color: #BA2121">"float32"</span>, <span style="color: #BA2121">"global"</span>)
        C_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m_outer, l_outer <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">128</span>):
            <span style="color: #008000; font-weight: bold">for</span> m_inner_init, l_inner_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                C_1[m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16384</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_inner_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rk_outer, m_inner, rk_inner, l_inner <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">256</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
                cse_var_2: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> l_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span>
                cse_var_1: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16384</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> cse_var_2 <span style="color: #AA22FF; font-weight: bold">+</span> l_inner
                A_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>A<span style="color: #AA22FF; font-weight: bold">.</span>data)
                B_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2097152</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>B<span style="color: #AA22FF; font-weight: bold">.</span>data)
                C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">=</span> C_1[cse_var_1] <span style="color: #AA22FF; font-weight: bold">+</span> A_1[m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32768</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2048</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_inner] <span style="color: #AA22FF; font-weight: bold">*</span> B_1[rk_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8192</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> cse_var_2 <span style="color: #AA22FF; font-weight: bold">+</span> l_inner]
        C_2 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1048576</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>C)
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            cse_var_3: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> l
            C_2[cse_var_3] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C_1[cse_var_3])
        <span style="color: #008000; font-weight: bold">for</span> m_outer, n_outer <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">384</span>):
            F_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>F)
            <span style="color: #008000; font-weight: bold">for</span> m_inner_init, n_inner_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                F_1[m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">49152</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_inner_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            <span style="color: #008000; font-weight: bold">for</span> rl_outer, m_inner, rl_inner, n_inner <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">128</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
                cse_var_5: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> n_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span>
                cse_var_4: T<span style="color: #AA22FF; font-weight: bold">.</span>int32 <span style="color: #AA22FF; font-weight: bold">=</span> m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">49152</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> cse_var_5 <span style="color: #AA22FF; font-weight: bold">+</span> n_inner
                E_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">3145728</span>,), data<span style="color: #AA22FF; font-weight: bold">=</span>E<span style="color: #AA22FF; font-weight: bold">.</span>data)
                F_1[cse_var_4] <span style="color: #AA22FF; font-weight: bold">=</span> F_1[cse_var_4] <span style="color: #AA22FF; font-weight: bold">+</span> C_2[m_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16384</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">1024</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_inner] <span style="color: #AA22FF; font-weight: bold">*</span> E_1[rl_outer <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">24576</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_inner <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> cse_var_5 <span style="color: #AA22FF; font-weight: bold">+</span> n_inner]
</pre>
</div>
</section>
<section id="loop-fusion" class="level3">
<h3 class="anchored" data-anchor-id="loop-fusion">3. loop fusion</h3>
<p>loop fusion是将两个循环中的语句放到一起, 减少对于同一个数据的重用距离, 增加了数据的局部性, 考虑我们的例子中, 当矩阵C计算结束后才能开始下一个exp的计算, 这个时候原本访问到最后一行的数据又被推出cache中重新加载第一行的数据. 此时时候可以把exp的计算放在第一个matmul的tile计算结束后立即计算.</p>
<p>但是因为tvm的中缺少更加详细的分析, 导致某些合法的调度并没有被tvm te(tensor expression)的调度原语所支持, 因此接下来采用tvm后来提出Tensor IR抽象, 在tir中提供了比te(tensor expression)中更多的调度方式, 比如reindex/cache_index/merge/decompose_reduction等方法, 当无法通过调度原语来达到想要的优化变化时甚至可以直接通过手写的方法来支持.</p>
<p>接下来先将前面的te抽象转换为tir抽象:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">prim_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_prim_func([A, B, E, F])</span>
<span id="cb13-2">prim_func.show()</span></code></pre></div></div>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
    T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
    <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
    C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
    D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
    <span style="color: #008000; font-weight: bold">for</span> m, l, rk <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>):
        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
            v_m, v_l, v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SSR"</span>, [m, l, rk])
            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
    <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
            v_m, v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SS"</span>, [m, l])
            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
            D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
    <span style="color: #008000; font-weight: bold">for</span> m, n, rl <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>, <span style="color: #008000">1024</span>):
        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
            v_m, v_n, v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SSR"</span>, [m, n, rl])
            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
            F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
<p>tir中以block为单位来调度源代码, 这里通过tir来实现和之前te中相同的调度策略:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">f_nd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.nd.empty((M, N), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir.Schedule(prim_func)</span>
<span id="cb15-2">m, l, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb15-3">mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(m, [M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>])</span>
<span id="cb15-4">ko, ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(k, [K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb15-5">lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(l, [L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb15-6">tir_sch.reorder(mo, lo, ko, mi, ki, li)</span>
<span id="cb15-7"></span>
<span id="cb15-8">m, n, l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>)</span>
<span id="cb15-9">mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(m, [M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>])</span>
<span id="cb15-10">lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(l, [L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb15-11">no, ni <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(n, [N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb15-12">tir_sch.reorder(mo, no, lo, mi, li, ni)</span>
<span id="cb15-13"></span>
<span id="cb15-14">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb15-15">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb15-16"></span>
<span id="cb15-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb15-18">tir_sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 1.0223547624999998 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0, l_0, rk_0, m_1, rk_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">128</span>, <span style="color: #008000">256</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
                v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                v_m, v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SS"</span>, [m, l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
        <span style="color: #008000; font-weight: bold">for</span> m_0, n_0, rl_0, m_1, rl_1, n_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">384</span>, <span style="color: #008000">128</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
                v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                v_n <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_1)
                v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">1024</span>, rl_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
<p>这里可以发现相同调度下, tir速度慢了许多, 这是由于tir的函数默认将init操作放到循环内部导致的, 我们暂时忽略这个问题. 只关注通过fusion之后是否能产生性能提升:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">mo, lo, ko, mi, ki, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb17-2"></span>
<span id="cb17-3">m1, l1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>)</span>
<span id="cb17-4">m1o, m1i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(m1, [M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>])</span>
<span id="cb17-5">l1o, l1i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(l1, [L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb17-6">tir_sch.reorder(m1o, l1o, m1i, l1i)</span>
<span id="cb17-7"></span>
<span id="cb17-8">tir_sch.merge(lo, l1o)</span>
<span id="cb17-9">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb17-10">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb17-13">tir_sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.8789533792 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0_m, l_0_m <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">128</span>):
            <span style="color: #008000; font-weight: bold">for</span> rk_0, m_1, rk_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">256</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
                    v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                    v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                    v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                        C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                    C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
            <span style="color: #008000; font-weight: bold">for</span> m_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                    v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                    v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                    D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
        <span style="color: #008000; font-weight: bold">for</span> m_0, n_0, rl_0, m_1, rl_1, n_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">384</span>, <span style="color: #008000">128</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
                v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                v_n <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_1)
                v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">1024</span>, rl_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
<p>可以发现通过fusion elemwise的操作有微弱的速度提升. 其实还有更加激进的fusion, 这个例子中还可以合并两个matmul的m循环. 虽然合并两个循环的m循环是一个合法的优化, 但通过tir去merge是会触发错误的, 因此这里通过手动修改代码的方式来实现这个调度:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm.script <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ir <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> I</span>
<span id="cb19-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm.script <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tir <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> T</span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@I.ir_module</span></span>
<span id="cb19-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Module:</span>
<span id="cb19-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@T.prim_func</span></span>
<span id="cb19-7">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main(A: T.Buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>), B: T.Buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>), E: T.Buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3072</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>), F: T.Buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3072</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>)):</span>
<span id="cb19-8">    T.func_attr({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tir.noalias"</span>: T.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)})</span>
<span id="cb19-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with T.block("root"):</span></span>
<span id="cb19-10">    C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.alloc_buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb19-11">    D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.alloc_buffer((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>))</span>
<span id="cb19-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m_0_m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> T.grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>):</span>
<span id="cb19-13">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> l_0_m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> T.grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>):</span>
<span id="cb19-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> rk_0, m_1, rk_1, l_1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> T.grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb19-15">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> T.block(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>):</span>
<span id="cb19-16">            v_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, m_0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m_1)</span>
<span id="cb19-17">            v_l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, l_0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> l_1)</span>
<span id="cb19-18">            v_rk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, rk_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rk_1)</span>
<span id="cb19-19">            T.reads(A[v_m, v_rk], B[v_rk, v_l])</span>
<span id="cb19-20">            T.writes(C[v_m, v_l])</span>
<span id="cb19-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> T.init():</span>
<span id="cb19-22">              C[v_m, v_l] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.float32(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb19-23">            C[v_m, v_l] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[v_m, v_l] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> A[v_m, v_rk] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B[v_rk, v_l]</span>
<span id="cb19-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m_1, l_1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> T.grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb19-25">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> T.block(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>):</span>
<span id="cb19-26">            v_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, m_0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m_1)</span>
<span id="cb19-27">            v_l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, l_0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> l_1)</span>
<span id="cb19-28">            T.reads(C[v_m, v_l])</span>
<span id="cb19-29">            T.writes(D[v_m, v_l])</span>
<span id="cb19-30">            D[v_m, v_l] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.exp(C[v_m, v_l])</span>
<span id="cb19-31">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n_0, rl_0, m_1, rl_1, n_1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> T.grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb19-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> T.block(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>):</span>
<span id="cb19-33">          v_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, m_0_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m_1)</span>
<span id="cb19-34">          v_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.spatial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3072</span>, n_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n_1)</span>
<span id="cb19-35">          v_rl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.axis.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, rl_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rl_1)</span>
<span id="cb19-36">          T.reads(D[v_m, v_rl], E[v_rl, v_n])</span>
<span id="cb19-37">          T.writes(F[v_m, v_n])</span>
<span id="cb19-38">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> T.init():</span>
<span id="cb19-39">            F[v_m, v_n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T.float32(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb19-40">          F[v_m, v_n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F[v_m, v_n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> D[v_m, v_rl] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> E[v_rl, v_n]</span>
<span id="cb19-41"></span>
<span id="cb19-42"></span>
<span id="cb19-43">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(Module, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb19-44">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb19-45"></span>
<span id="cb19-46"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.792521475 sec</code></pre>
<p>其实还有更多的优化手段, 但是在tensor ir不方便实现, 比如通过lift allocation + stage memory + add guard的方式来实现在外层循环申请buffer,并在内循环中逐步填充,并在此后的迭代中重复使用, 但目前还是只能通过手动修改tir代码来实现. 最近有一另个调度抽象<a href="https://exo-lang.dev">exo-lang</a>提供了这些调度手段.</p>
</section>
</section>
<section id="提高并行性" class="level2">
<h2 class="anchored" data-anchor-id="提高并行性">提高并行性</h2>
<p>现在只考虑单核的程序, 提升并行性通常就使用simd加速:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir.Schedule(Module)</span>
<span id="cb21-2">(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>_, li) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb21-3">tir_sch.vectorize(li)</span>
<span id="cb21-4">(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>_, ni) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>)</span>
<span id="cb21-5">tir_sch.vectorize(ni)</span>
<span id="cb21-6"></span>
<span id="cb21-7">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb21-8">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb21-9"></span>
<span id="cb21-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb21-11">tir_sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.2236641083 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0_m <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">for</span> l_0_m <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">128</span>):
                <span style="color: #008000; font-weight: bold">for</span> rk_0, m_1, rk_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">256</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                    <span style="color: #008000; font-weight: bold">for</span> l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">8</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
                            v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                            v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                            v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                                C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                            C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
                <span style="color: #008000; font-weight: bold">for</span> m_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                        v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                        v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                        D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
            <span style="color: #008000; font-weight: bold">for</span> n_0, rl_0, m_1, rl_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">384</span>, <span style="color: #008000">128</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>):
                <span style="color: #008000; font-weight: bold">for</span> n_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">8</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
                        v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0_m <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                        v_n <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_1)
                        v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">1024</span>, rl_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                            F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                        F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
</section>
</section>
<section id="自动程序优化" class="level1">
<h1>自动程序优化</h1>
<p>前面讨论了有许多不同的方法可以变换同一个程序, 但是由于方法多样且每个方法还存在各种参数, 通过手动优化要求开发者对于硬件架构有比较深入的理解, 因此催生了自动化优化的需求.</p>
<p>首先回顾一下之前的调度方法, 假设我们将调度方法封装成为一个函数:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> schedule_mm(tir_sch: tvm.tir.Schedule, jfactor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>):</span>
<span id="cb23-2">    m, l, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb23-3">    mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(m, [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>])</span>
<span id="cb23-4">    ko, ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(k, [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb23-5">    lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tir_sch.split(l, [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>])</span>
<span id="cb23-6">    tir_sch.reorder(mo, lo, ko, mi, ki, li)</span>
<span id="cb23-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> tir_sch</span>
<span id="cb23-8"></span>
<span id="cb23-9">prim_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_prim_func([A, B, E, F])</span>
<span id="cb23-10">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.tir.Schedule(prim_func)</span>
<span id="cb23-11">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedule_mm(tir_sch)</span>
<span id="cb23-12">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb23-13">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb23-14"></span>
<span id="cb23-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb23-16">tir_sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 6.0141817167 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0, l_0, rk_0, m_1, rk_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">128</span>, <span style="color: #008000">256</span>, <span style="color: #008000">16</span>, <span style="color: #008000">8</span>, <span style="color: #008000">8</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
                v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                v_m, v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SS"</span>, [m, l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
        <span style="color: #008000; font-weight: bold">for</span> m, n, rl <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>, <span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
                v_m, v_n, v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SSR"</span>, [m, n, rl])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
<p>除了 sch.mod, tir.Schedule 提供的另一个数据结构是历史轨迹 (trace), 它包含了 IRModule 在变换过程中所涉及的步骤. 我们可以使用以下代码将其打印出来:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tir_sch.trace)</span></code></pre></div></div>
<pre><code># from tvm import tir
def apply_trace(sch: tir.Schedule) -&gt; None:
  b0 = sch.get_block(name="C", func_name="main")
  l1, l2, l3 = sch.get_loops(block=b0)
  l4, l5 = sch.split(loop=l1, factors=[None, 16], preserve_unit_iters=True, disable_predication=False)
  l6, l7 = sch.split(loop=l3, factors=[None, 8], preserve_unit_iters=True, disable_predication=False)
  l8, l9 = sch.split(loop=l2, factors=[None, 8], preserve_unit_iters=True, disable_predication=False)
  sch.reorder(l4, l8, l6, l5, l7, l9)</code></pre>
<p>上面的历史轨迹与我们在 schedule_mm 中指定的变换一致. 需要注意的一点是, 历史轨迹加上原始程序一起, 为我们提供了一种能够完全重新生成最终输出程序的方法. 记住这一点,我们将在本章中使用历史轨迹作为检查变换的另一种方式.</p>
<section id="随机调度变换" class="level2">
<h2 class="anchored" data-anchor-id="随机调度变换">随机调度变换</h2>
<p>假设我们知道想要对原始 TensorIR 程序进行哪些变换, 并且其中一些变化的参数基于我们对底层环境的理解,例如缓存和硬件单元. 因此, 我们想指定调度的方式, 但是选择调度的一些参数这样省略一些细节. 一种自然方法是在我们的变换中添加一些随机元素, 比如下面的代码通过sample_perfect_tile来采样可能的tile size:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> stochastic_schedule_mm(s: tvm.tir.Schedule):</span>
<span id="cb27-2">  m, l, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.get_loops(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb27-3">  m_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.sample_perfect_tile(loop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb27-4">  mo, mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.split(m, m_factors)</span>
<span id="cb27-5">  k_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.sample_perfect_tile(loop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb27-6">  ko, ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.split(k, k_factors)</span>
<span id="cb27-7">  l_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.sample_perfect_tile(loop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>l, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb27-8">  lo, li <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.split(l, l_factors)</span>
<span id="cb27-9">  s.reorder(mo, lo, ko, mi, ki, li)</span>
<span id="cb27-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> s</span></code></pre></div></div>
<p>可以多次执行下面这段代码, 每次都会采样出一个随机的tile size, 在操作上可以采用多次实验然后保存下最优性能下的调度方式, 但因为过于耗时这里就不尝试了:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">prim_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> te.create_prim_func([A, B, E, F])</span>
<span id="cb28-2">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.tir.Schedule(prim_func)</span>
<span id="cb28-3">tir_sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stochastic_schedule_mm(tir_sch)</span>
<span id="cb28-4">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(tir_sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb28-5">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb28-8">tir_sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 5.9412203167 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0, l_0, rk_0, m_1, rk_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">128</span>, <span style="color: #008000">128</span>, <span style="color: #008000">512</span>, <span style="color: #008000">8</span>, <span style="color: #008000">4</span>, <span style="color: #008000">8</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C"</span>):
                v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1)
                v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1)
                v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">4</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v_m, v_rk], B[v_rk, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
        <span style="color: #008000; font-weight: bold">for</span> m, l <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                v_m, v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SS"</span>, [m, l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
        <span style="color: #008000; font-weight: bold">for</span> m, n, rl <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>, <span style="color: #008000">1024</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F"</span>):
                v_m, v_n, v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">"SSR"</span>, [m, n, rl])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(D[v_m, v_rl], E[v_rl, v_n])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v_m, v_n])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
</pre>
</div>
</section>
<section id="meta-schedule" class="level2">
<h2 class="anchored" data-anchor-id="meta-schedule">Meta Schedule</h2>
<p>在实践中, 需要使用更快速更智能的算法. tvm的meta schedule是支持搜索可能变换空间的命名空间, 他实现了如下功能</p>
<ol type="1">
<li>并行搜索</li>
<li>使用cost model来避免每次都进行benchmark</li>
<li>基于历史轨迹进行遗传搜索evolutionary search, 而不是每次都随机采样</li>
</ol>
<p>尽管工具变了, 但关键思想是保持不变的: <strong>使用随机变换在指定的程序搜索空间中找到最优的调度方式</strong>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> meta_schedule <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ms</span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disable parallel when num cores = 1.</span></span>
<span id="cb30-4">rules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.ScheduleRule.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llvm'</span>)</span>
<span id="cb30-5">newrules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb30-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> rule <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rules:</span>
<span id="cb30-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(rule, ms.schedule_rule.ParallelizeVectorizeUnroll):</span>
<span id="cb30-8">    newrules.append(ms.schedule_rule.ParallelizeVectorizeUnroll(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb30-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb30-10">    newrules.append(rule.clone())</span>
<span id="cb30-11">mutators <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.Mutator.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llvm'</span>)</span>
<span id="cb30-12">newmutators <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb30-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mutators:</span>
<span id="cb30-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(m, ms.mutator.MutateParallel):</span>
<span id="cb30-15">    newmutators.append(ms.mutator.MutateParallel(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb30-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb30-17">    newmutators.append(m.clone())</span>
<span id="cb30-18">sg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.space_generator.PostOrderApply(sch_rules<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>newrules)</span>
<span id="cb30-19"></span>
<span id="cb30-20">database <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.tune_tir(</span>
<span id="cb30-21">    mod<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prim_func,</span>
<span id="cb30-22">    target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm --num-cores=1"</span>,</span>
<span id="cb30-23">    max_trials_global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,</span>
<span id="cb30-24">    num_trials_per_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,</span>
<span id="cb30-25">    work_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./tune_tmp"</span>,</span>
<span id="cb30-26">    num_tuning_cores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb30-27">    space<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sg,</span>
<span id="cb30-28">)</span>
<span id="cb30-29"></span>
<span id="cb30-30">sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.tir_integration.compile_tir(database, prim_func, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm --num-cores=1"</span>)</span></code></pre></div></div>
<pre><code>2024-08-08 15:05:06 [INFO] Logging directory: ./tune_tmp/logs
2024-08-08 15:05:06 [INFO] LocalBuilder: max_workers = 4
2024-08-08 15:05:06 [INFO] LocalRunner: max_workers = 1
2024-08-08 15:05:07 [INFO] [task_scheduler.cc:159] Initializing Task #0: "main"</code></pre>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Name
</th>
<th>
FLOP
</th>
<th>
Weight
</th>
<th>
Speed (GFLOPS)
</th>
<th>
Latency (us)
</th>
<th>
Weighted Latency (us)
</th>
<th>
Trials
</th>
<th>
Done
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
main
</td>
<td>
10737418240
</td>
<td>
1
</td>
<td>
N/A
</td>
<td>
N/A
</td>
<td>
N/A
</td>
<td>
0
</td>
<td>
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>2024-08-08 15:05:07 [DEBUG] [task_scheduler.cc:318] 
 ID | Name |        FLOP | Weight | Speed (GFLOPS) | Latency (us) | Weighted Latency (us) | Trials | Done 
----------------------------------------------------------------------------------------------------------
  0 | main | 10737418240 |      1 |            N/A |          N/A |                   N/A |      0 |      
----------------------------------------------------------------------------------------------------------
Total trials: 0
Total latency (us): 0


Total trials: 0
Total latency (us): 0

2024-08-08 15:05:07 [INFO] [task_scheduler.cc:180] TaskScheduler picks Task #0: "main"
2024-08-08 15:05:11 [INFO] [task_scheduler.cc:193] Sending 64 sample(s) to builder
2024-08-08 15:05:27 [INFO] [task_scheduler.cc:195] Sending 64 sample(s) to runner
2024-08-08 15:09:35 [DEBUG] XGB iter   0: tr-p-rmse: 0.549968   tr-a-peak@32: 0.877909  tr-rmse: 0.348221   tr-rmse: 0.348221
2024-08-08 15:09:35 [DEBUG] XGB iter  25: tr-p-rmse: 0.070855   tr-a-peak@32: 1.000000  tr-rmse: 0.397401   tr-rmse: 0.397401
2024-08-08 15:09:35 [DEBUG] XGB iter  50: tr-p-rmse: 0.070855   tr-a-peak@32: 1.000000  tr-rmse: 0.397401   tr-rmse: 0.397401
2024-08-08 15:09:35 [DEBUG] XGB stopped. Best iteration: [14] tr-p-rmse:0.07086 tr-a-peak@32:1.00000    tr-rmse:0.39740 tr-rmse:0.39740 
2024-08-08 15:09:35 [INFO] [task_scheduler.cc:237] [Updated] Task #0: "main"</code></pre>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Name
</th>
<th>
FLOP
</th>
<th>
Weight
</th>
<th>
Speed (GFLOPS)
</th>
<th>
Latency (us)
</th>
<th>
Weighted Latency (us)
</th>
<th>
Trials
</th>
<th>
Done
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
main
</td>
<td>
10737418240
</td>
<td>
1
</td>
<td>
64.5722
</td>
<td>
166285.3613
</td>
<td>
166285.3613
</td>
<td>
64
</td>
<td>
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>Total trials: 64
Total latency (us): 166285

2024-08-08 15:09:35 [DEBUG] [task_scheduler.cc:318] 
 ID | Name |        FLOP | Weight | Speed (GFLOPS) | Latency (us) | Weighted Latency (us) | Trials | Done 
----------------------------------------------------------------------------------------------------------
  0 | main | 10737418240 |      1 |        64.5722 |  166285.3613 |           166285.3613 |     64 |      
----------------------------------------------------------------------------------------------------------
Total trials: 64
Total latency (us): 166285

2024-08-08 15:09:35 [INFO] [task_scheduler.cc:260] Task #0 has finished. Remaining task(s): 0</code></pre>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Name
</th>
<th>
FLOP
</th>
<th>
Weight
</th>
<th>
Speed (GFLOPS)
</th>
<th>
Latency (us)
</th>
<th>
Weighted Latency (us)
</th>
<th>
Trials
</th>
<th>
Done
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
main
</td>
<td>
10737418240
</td>
<td>
1
</td>
<td>
64.5722
</td>
<td>
166285.3613
</td>
<td>
166285.3613
</td>
<td>
64
</td>
<td>
Y
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>Total trials: 64
Total latency (us): 166285

2024-08-08 15:09:35 [DEBUG] [task_scheduler.cc:318] 
 ID | Name |        FLOP | Weight | Speed (GFLOPS) | Latency (us) | Weighted Latency (us) | Trials | Done 
----------------------------------------------------------------------------------------------------------
  0 | main | 10737418240 |      1 |        64.5722 |  166285.3613 |           166285.3613 |     64 |    Y 
----------------------------------------------------------------------------------------------------------
Total trials: 64
Total latency (us): 166285</code></pre>
<p>尝试执行一下自动搜索出的最终程序, 可以发现性能提升了非常多倍, 从7s到了0.16s:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">rt_lib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvm.build(sch.mod, target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm"</span>)</span>
<span id="cb35-2">f_timer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt_lib.time_evaluator(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__tvm_main__"</span>, tvm.cpu())</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of transformed sch.mod </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f_timer(a_nd, b_nd, e_nd, f_nd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb35-5">sch.mod.show()</span></code></pre></div></div>
<pre><code>Time cost of transformed sch.mod 0.16998505 sec</code></pre>
<div class="highlight" style="background: ">
<pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">2048</span>), <span style="color: #BA2121">"float32"</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">2048</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">"float32"</span>), E: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>), F: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>), <span style="color: #BA2121">"float32"</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">"tir.noalias"</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block("root"):</span>
        C <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        D <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>))
        F_global <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">3072</span>))
        <span style="color: #008000; font-weight: bold">for</span> m_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>serial(<span style="color: #008000">32</span>, annotations<span style="color: #AA22FF; font-weight: bold">=</span>{<span style="color: #BA2121">"pragma_auto_unroll_max_step"</span>: <span style="color: #008000">512</span>, <span style="color: #BA2121">"pragma_unroll_explicit"</span>: <span style="color: #008000">1</span>}):
            <span style="color: #008000; font-weight: bold">for</span> l_0, m_1, l_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">2</span>, <span style="color: #008000">1</span>, <span style="color: #008000">32</span>):
                <span style="color: #008000; font-weight: bold">for</span> m_2_init, l_2_init, m_3_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">32</span>, <span style="color: #008000">2</span>, <span style="color: #008000">1</span>):
                    <span style="color: #008000; font-weight: bold">for</span> l_3_fused_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">8</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C_init"</span>):
                            v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_2_init <span style="color: #AA22FF; font-weight: bold">+</span> m_3_init)
                            v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">512</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_2_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_3_fused_init)
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>block_attr({<span style="color: #BA2121">"meta_schedule.tiling_structure"</span>: <span style="color: #BA2121">"SSRSRS"</span>})
                            C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                <span style="color: #008000; font-weight: bold">for</span> rk_0, m_2, l_2, rk_1, m_3 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">128</span>, <span style="color: #008000">32</span>, <span style="color: #008000">2</span>, <span style="color: #008000">16</span>, <span style="color: #008000">1</span>):
                    <span style="color: #008000; font-weight: bold">for</span> l_3_fused <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">8</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"C_update"</span>):
                            v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_2 <span style="color: #AA22FF; font-weight: bold">+</span> m_3)
                            v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, l_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">512</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_2 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> l_3_fused)
                            v_rk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">2048</span>, rk_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> rk_1)
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l], A[v_m, v_rk], B[v_rk, v_l])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v_m, v_l])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>block_attr({<span style="color: #BA2121">"meta_schedule.tiling_structure"</span>: <span style="color: #BA2121">"SSRSRS"</span>})
                            C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> C[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">+</span> A[v_m, v_rk] <span style="color: #AA22FF; font-weight: bold">*</span> B[v_rk, v_l]
        <span style="color: #008000; font-weight: bold">for</span> m_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>serial(<span style="color: #008000">4</span>, annotations<span style="color: #AA22FF; font-weight: bold">=</span>{<span style="color: #BA2121">"pragma_auto_unroll_max_step"</span>: <span style="color: #008000">512</span>, <span style="color: #BA2121">"pragma_unroll_explicit"</span>: <span style="color: #008000">1</span>}):
            <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">256</span>, <span style="color: #008000">1024</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"D"</span>):
                    v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">256</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                    v_l <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, ax1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[v_m, v_l])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(D[v_m, v_l])
                    D[v_m, v_l] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>exp(C[v_m, v_l])
            <span style="color: #008000; font-weight: bold">for</span> n_0, m_1, n_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">1</span>, <span style="color: #008000">4</span>, <span style="color: #008000">16</span>):
                <span style="color: #008000; font-weight: bold">for</span> m_2_init, n_2_init, m_3_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">32</span>, <span style="color: #008000">6</span>, <span style="color: #008000">2</span>):
                    <span style="color: #008000; font-weight: bold">for</span> n_3_fused_init <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">32</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F_init"</span>):
                            v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">256</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">64</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_2_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_3_init)
                            v_n <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">192</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_2_init <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_3_fused_init)
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F_global[v_m, v_n])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>block_attr({<span style="color: #BA2121">"meta_schedule.tiling_structure"</span>: <span style="color: #BA2121">"SSRSRS"</span>})
                            F_global[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0.0</span>)
                <span style="color: #008000; font-weight: bold">for</span> rl_0, m_2, n_2, rl_1, m_3 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">128</span>, <span style="color: #008000">32</span>, <span style="color: #008000">6</span>, <span style="color: #008000">8</span>, <span style="color: #008000">2</span>):
                    <span style="color: #008000; font-weight: bold">for</span> n_3_fused <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>vectorized(<span style="color: #008000">32</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F_update"</span>):
                            v_m <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">256</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">64</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_2 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">2</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_3)
                            v_n <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">3072</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">192</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_2 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">32</span> <span style="color: #AA22FF; font-weight: bold">+</span> n_3_fused)
                            v_rl <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">1024</span>, rl_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">8</span> <span style="color: #AA22FF; font-weight: bold">+</span> rl_1)
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(F_global[v_m, v_n], D[v_m, v_rl], E[v_rl, v_n])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F_global[v_m, v_n])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>block_attr({<span style="color: #BA2121">"meta_schedule.tiling_structure"</span>: <span style="color: #BA2121">"SSRSRS"</span>})
                            F_global[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">=</span> F_global[v_m, v_n] <span style="color: #AA22FF; font-weight: bold">+</span> D[v_m, v_rl] <span style="color: #AA22FF; font-weight: bold">*</span> E[v_rl, v_n]
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">192</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">"F_global"</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, m_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">256</span> <span style="color: #AA22FF; font-weight: bold">+</span> m_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">64</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">3072</span>, n_1 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">192</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(F_global[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(F[v0, v1])
                        F[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> F_global[v0, v1]
</pre>
</div>
<p>但是…, 如果我们使用预先手写好的高度优化的算子, 比如通过numpy来测试一下性能:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> numpy_fn(a, b, e, f):</span>
<span id="cb37-2">  c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.matmul(a, b)</span>
<span id="cb37-3">  np.exp(c, out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>c)</span>
<span id="cb37-4">  np.matmul(c, e, out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f)</span>
<span id="cb37-5"></span>
<span id="cb37-6"></span>
<span id="cb37-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> numpy_benchmark():</span>
<span id="cb37-8">  a_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(M, K).astype(np.float32)</span>
<span id="cb37-9">  b_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(K, L).astype(np.float32)</span>
<span id="cb37-10">  e_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(L, N).astype(np.float32)</span>
<span id="cb37-11">  f_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty((M, N), np.float32)</span>
<span id="cb37-12">  times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb37-13">  time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.testing.measure(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'numpy_fn(a_np, b_np, e_np, f_np)'</span>, times)</span>
<span id="cb37-14">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Time cost of numpy </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sec"</span>)</span>
<span id="cb37-15"></span>
<span id="cb37-16"></span>
<span id="cb37-17"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> threadpoolctl <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threadpool_limits</span>
<span id="cb37-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> np.testing.suppress_warnings() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sup:</span>
<span id="cb37-19">  sup.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">RuntimeWarning</span>)</span>
<span id="cb37-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> threadpool_limits(limits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, user_api<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb37-21">    numpy_benchmark()</span></code></pre></div></div>
<pre><code>Time cost of numpy 0.10500000000000001 sec</code></pre>
<p>可以发现虽然没有任何的fusion, 但手写算子还是优于自动搜索的结果. 这其实就是体现了目前的自动搜索方法所存在的局限性, 高度优化的gemm库中为了减少加载A/B矩阵的cache miss会进行online packing的操作, 比如blis的论文中的gebp策略:</p>
<p><img src="https://www.researchgate.net/profile/Robert-Van-De-Geijn/publication/307564216/figure/fig1/AS:614108009340951@1523426167579/Left-The-GotoBLAS-algorithm-for-matrix-matrix-multiplication-as-refactored-in-BLIS.png" class="img-fluid"></p>
<p>gebp策略的本质其实是fuse了<code>pack(A)</code>,<code>pack(B)</code>,<code>matmul(Packed(A),Packed(B),C)</code>这三个操作, 而tvm只专注于<code>matmul(A,B,C)</code>内部的变化策略, 所以他难以达到最优. 不过blis所提出的策略也只对支持simd指令的cpu有效, 对于dsa架构的tensor core来说, 就需要重新基于优化的原则来设计分块策略, 这是一个复杂的过程.</p>
</section>
</section>
<section id="更多资料" class="level1">
<h1>更多资料</h1>
<ol type="1">
<li>Optimizing Compilers Modern Architectures</li>
<li><a href="https://arxiv.org/pdf/2207.04296">TensorIR: An Abstraction for Automatic Tensorized Program Optimization</a></li>
<li><a href="https://www.researchgate.net/publication/307564216_BLISlab_A_Sandbox_for_Optimizing_GEMM?_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6Il9kaXJlY3QiLCJwYWdlIjoiX2RpcmVjdCJ9fQ">BLISlab: A Sandbox for Optimizing GEMM</a></li>
</ol>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/mlc-tutorial.html</guid>
  <pubDate>Thu, 08 Aug 2024 11:31:36 GMT</pubDate>
</item>
<item>
  <title>benchmark的经验与技巧</title>
  <link>https://zhen8838.github.io/posts/benchmark-notes.html</link>
  <description><![CDATA[ 




<p>为了公平对比性能都不是一件容易的事情. 各个框架的runtime都可能存在一些不同配置, 需要把他们安排到统一基准线去对比才有意义.</p>
<!--more-->
<section id="tvm" class="level1">
<h1>TVM</h1>
<section id="meta-schedule-禁用多线程" class="level2">
<h2 class="anchored" data-anchor-id="meta-schedule-禁用多线程">meta schedule 禁用多线程</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tvm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> meta_schedule <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ms</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disable parallel when num cores = 1.</span></span>
<span id="cb1-4">rules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.ScheduleRule.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llvm'</span>)</span>
<span id="cb1-5">newrules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> rule <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rules:</span>
<span id="cb1-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(rule, ms.schedule_rule.ParallelizeVectorizeUnroll):</span>
<span id="cb1-8">    newrules.append(ms.schedule_rule.ParallelizeVectorizeUnroll(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-10">    newrules.append(rule.clone())</span>
<span id="cb1-11">mutators <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.Mutator.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llvm'</span>)</span>
<span id="cb1-12">newmutators <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mutators:</span>
<span id="cb1-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(m, ms.mutator.MutateParallel):</span>
<span id="cb1-15">    newmutators.append(ms.mutator.MutateParallel(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb1-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-17">    newmutators.append(m.clone())</span>
<span id="cb1-18">sg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.space_generator.PostOrderApply(sch_rules<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>newrules)</span>
<span id="cb1-19"></span>
<span id="cb1-20">database <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.tune_tir(</span>
<span id="cb1-21">    mod<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prim_func,</span>
<span id="cb1-22">    target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm --num-cores=1"</span>,</span>
<span id="cb1-23">    max_trials_global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,</span>
<span id="cb1-24">    num_trials_per_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,</span>
<span id="cb1-25">    work_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./tune_tmp"</span>,</span>
<span id="cb1-26">    num_tuning_cores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb1-27">    space<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sg,</span>
<span id="cb1-28">)</span>
<span id="cb1-29"></span>
<span id="cb1-30">sch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms.tir_integration.compile_tir(database, prim_func, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llvm --num-cores=1"</span>)</span></code></pre></div></div>
</section>
</section>
<section id="numpy" class="level1">
<h1>numpy</h1>
<section id="numpy-禁止多线程" class="level2">
<h2 class="anchored" data-anchor-id="numpy-禁止多线程">numpy 禁止多线程</h2>
</section>
</section>
<section id="iree" class="level1">
<h1>iree</h1>
<section id="iree-benchmark" class="level2">
<h2 class="anchored" data-anchor-id="iree-benchmark">iree benchmark</h2>
<p>基本流程</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">iree-compile</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-2">  iree/matmul.mlir <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-hal-target-backends</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llvm-cpu <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-target-cpu</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>host <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-target-cpu-features</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>host <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-loop-interleaving</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-slp-vectorization</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-loop-unrolling</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--iree-llvmcpu-loop-vectorization</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--compile-mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>std <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> out/iree/matmul.vmbf</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">iree-benchmark-module</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--module</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>out/iree/matmul.vmbf <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--device</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>local-task <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--task_topology_cpu_ids</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>0,1,2,3 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>abs <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1x1024x2048xf32=2 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1x2048x512xf32=1</span></code></pre></div></div>
<p>–iree-hal-target-backends: - cuda - llvm-cpu, - cpu target 存在下面这些类型 - aarch64 - AArch64 (little endian) - aarch64_32 - AArch64 (little endian ILP32) - aarch64_be - AArch64 (big endian) - arm - ARM - arm64 - ARM64 (little endian) - arm64_32 - ARM64 (little endian ILP32) - armeb - ARM (big endian) - riscv32 - 32-bit RISC-V - riscv64 - 64-bit RISC-V - thumb - Thumb - thumbeb - Thumb (big endian) - wasm32 - WebAssembly 32-bit - wasm64 - WebAssembly 64-bit - x86 - 32-bit X86: Pentium-Pro and above - x86-64 - 64-bit X86: EM64T and AMD64 - metal-spirv - rocm - vmvx - vmvx-inline - vulkan-spirv</p>
<p>–iree-benchmark-module –list_devices - local-sync:// synchronous, single-threaded driver that executes work inline - local-task:// asynchronous, multithreaded driver built on IREE’s “task” system</p>
</section>
</section>
<section id="系统性能峰值测试" class="level1">
<h1>系统性能峰值测试</h1>
<section id="带宽性能测试" class="level2">
<h2 class="anchored" data-anchor-id="带宽性能测试">带宽性能测试</h2>
<p>暂时没有找到测试l1,l2 cache带宽的工具, 但是有<a href="https://github.com/intel/lmbench.git">lm_bench</a>可以测试带宽的各种指标. 他提供了传统的bw mem:</p>
<p>bw_mem_cp [ -P &lt;并行度&gt; ] [ -W &lt;热身次数&gt; ] [ -N &lt;重复次数&gt; ] 大小 rd|wr|rdwr|cp|fwr|frd|bzero|bcopy [对齐]</p>
<p>描述</p>
<p>bw_mem 分配两倍指定内存量，将其归零，然后将前半部分复制到后半部分。将每秒移动的兆字节数作为结果进行报告。 大小规范可能以“k”或“m”结尾，表示千字节 (* 1024) 或兆字节 (* 1024 * 1024)。</p>
<p>输出</p>
<p>输出格式为 CB”%0.2f %.2f“, 兆字节，兆字节每秒，即 8.00 25.33</p>
<p>bw_mem 中有九种不同的内存基准。它们各自测量读取、写入或复制数据的方法略有不同。</p>
<ol type="1">
<li>rd, 测量将数据读入处理器的时间。它计算整数值数组的总和。它每次访问四个字。</li>
<li>wr, 测量将数据写入内存的时间。它为整数值数组的每个内存分配一个常量值。它每次访问四个字。</li>
<li>rdwr 测量将数据读入内存然后将数据写入同一内​​存位置的时间。对于数组中的每个元素，它将当前值添加到运行总和中，然后再为元素分配新的（常量）值。它每次访问四个字。</li>
<li>cp 测量将数据从一个位置复制到另一个位置的时间。它执行数组复制：dest[i] = source[i]。它每次访问四个字。</li>
<li>frd 测量将数据读入处理器的时间。它计算整数值数组的总和。</li>
<li>fwr 测量将数据写入内存的时间。它为整数值数组的每个内存分配一个常量值。</li>
<li>fcp 测量将数据从一个位置复制到另一个位置的时间。它执行数组复制：dest[i] = source[i]。</li>
<li>bzero 测量系统清零内存的速度。</li>
<li>bcopy 测量系统复制数据的速度。</li>
</ol>
<p>内存利用率</p>
<p>此基准测试最多可将请求的内存移动三倍。Bcopy 将使用 2-3 倍的内存带宽：从源读取一次，然后写入目标。写入通常会导致缓存行读取，然后在稍后的某个时间点写回缓存行。如果处理器架构实现了“加载缓存行”和“存储缓存行”指令（以及“getcachelinesize”），内存利用率可能会减少 1/3。</p>
<p>首先测到频率为</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/usr/lib/lmbench/bin/x86_64-linux-gnu/mhz</span></span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2448</span> MHz, 0.4085 nanosec clock</span></code></pre></div></div>
<p>再测l1大小的读取</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/usr/lib/lmbench/bin/x86_64-linux-gnu/bw_mem</span> 32K rd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-N</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>10</span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0.032000</span> 100634.84</span></code></pre></div></div>
<p>然后计算byte/cycle:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7BByte%7D%7BHz%7D%20=%20%5Cfrac%7BMB%5Ctimes%201024%20%5Ctimes%201024%7D%7BS%7D%20%5Cdiv%20%5Cfrac%7BMHz%5Ctimes%2010%5E6%7D%7BS%7D%20=%2043%20B/Hz%0A%5Cend%7Baligned%7D%0A"></p>
<p>计算写入带宽, 这里就勉强算一半吧.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/usr/lib/lmbench/bin/x86_64-linux-gnu/bw_mem</span> 32K wr <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-N</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>10</span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0.032000</span> 56970.93</span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>边缘计算</category>
  <guid>https://zhen8838.github.io/posts/benchmark-notes.html</guid>
  <pubDate>Thu, 08 Aug 2024 08:32:50 GMT</pubDate>
</item>
<item>
  <title>Ampl学习</title>
  <link>https://zhen8838.github.io/posts/ampl-learn.html</link>
  <description><![CDATA[ 




<p>熟悉一下ampl的语法.</p>
<!--more-->
<section id="表达式系统" class="level1">
<h1>表达式系统</h1>
<section id="indexing-expressions" class="level2">
<h2 class="anchored" data-anchor-id="indexing-expressions">Indexing expressions</h2>
<p>索引表达式用于构造一个用于索引的多维集合, 因此他是通过<code>{}</code>包裹, 中间使用<code>,</code>分割的多个set expressions.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">indexing</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> sexpr-list </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb1-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sexpr-list </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> lexpr </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sexpr-list</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb1-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  sexpr </span></span>
<span id="cb1-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  dummy-member in sexpr</span></span>
<span id="cb1-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  sexpr-list, sexpr</span></span></code></pre></div></div>
<p>比如:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">{A, B}</span>
<span id="cb2-2">{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1..3</span>, B}</span>
<span id="cb2-3">{i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> A, B} <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i可以给后续使用.</span></span>
<span id="cb2-4">{i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> A, j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> B}</span></code></pre></div></div>
</section>
<section id="common-expressions" class="level2">
<h2 class="anchored" data-anchor-id="common-expressions">Common expressions</h2>
<p>通用表达式主要表示数学运算等内容</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expr</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  number </span></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  variable </span></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  expr arith-op expr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # arith-op is + - less * / mod div ˆ ** </span></span>
<span id="cb3-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  unary-op expr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # unary-op is `+`, `-` </span></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  built-in( exprlist )</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # built-in is `sin` `cos` ...</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  if lexpr then expr [ else expr ] </span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  reduction-op indexing expr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # reduction-op is sum prod max min </span></span>
<span id="cb3-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  ( expr )</span></span></code></pre></div></div>
<p>例子reduction op + indexing expr + (expr binary-op expr):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span> {i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Prod} cost[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Make[i]</span></code></pre></div></div>
</section>
<section id="logical-expressions" class="level2">
<h2 class="anchored" data-anchor-id="logical-expressions">Logical expressions</h2>
<p>逻辑表达式是需要返回true或false的表达式</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lexpr</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  expr </span></span>
<span id="cb5-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  expr compare-op expr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # compare-op is &lt; &lt;= = == != &lt;&gt; &gt; &gt;= </span></span>
<span id="cb5-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  lexpr logic-op lexpr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # logic-op is or || and &amp;&amp; </span></span>
<span id="cb5-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  not lexpr </span></span>
<span id="cb5-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  member in sexpr </span></span>
<span id="cb5-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  member not in sexpr </span></span>
<span id="cb5-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  sexpr within sexpr </span></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  sexpr not within sexpr </span></span>
<span id="cb5-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  opname indexing lexpr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # opname is `exists` or `forall` </span></span>
<span id="cb5-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  ( lexpr )</span></span></code></pre></div></div>
</section>
<section id="set-expressions" class="level2">
<h2 class="anchored" data-anchor-id="set-expressions">Set expressions</h2>
<p>set表达式专门用于构造set</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sexpr</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb6-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> [ member [ </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> member . . . ] ] </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span>
<span id="cb6-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  sexpr set-op sexpr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # set-op is `union`, `diff`, `symdiff`, `inter`, `cross` </span></span>
<span id="cb6-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  opname indexing sexpr</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # opname is `union` or `inter` </span></span>
<span id="cb6-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  expr .. expr [ by expr ]</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # .. 表示线性增长, 可以添加by来指定stride</span></span>
<span id="cb6-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  setof indexing member</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  #  member是指set元素构造, setof也就是利用indexing来构造包含有member的set.</span></span>
<span id="cb6-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  if lexpr then sexpr else sexpr </span></span>
<span id="cb6-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  ( sexpr ) </span></span>
<span id="cb6-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  interval </span></span>
<span id="cb6-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  infinite-set</span></span>
<span id="cb6-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  indexing</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # indexing表达式也属于set expr的一种</span></span>
<span id="cb6-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interval</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb6-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  interval [ a , b ]</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a ≤ x ≤ b}</span></span>
<span id="cb6-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  interval ( a , b ]</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a &lt; x ≤ b}</span></span>
<span id="cb6-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  interval [ a , b )</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a ≤ x &lt; b}</span></span>
<span id="cb6-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  interval ( a , b )</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a &lt; x &lt; b}</span></span>
<span id="cb6-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer [ a , b ]</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a ≤ x ≤ b and x ∈ I}</span></span>
<span id="cb6-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer ( a , b ]</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a &lt; x ≤ b and x ∈ I}</span></span>
<span id="cb6-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer [ a , b )</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a ≤ x &lt; b and x ∈ I}</span></span>
<span id="cb6-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer ( a , b )</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #  {x: a &lt; x &lt; b and x ∈ I}</span></span></code></pre></div></div>
<p>例子:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">ampl: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> setof {i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1..5</span>} (i,iˆ<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-2">ampl: display y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb7-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</section>
</section>
<section id="声明系统" class="level1">
<h1>声明系统</h1>
<p>声明系统的通用格式如下:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Aentity%5C%20name%5C%20alias_%7Bopt%7D%5C%20indexing%7Bopt%7D%5C%20body%7Bopt%7D;%0A%5Cend%7Baligned%7D%0A"></p>
<p>这里entity有<code>set, param, var, arc, minimize, maximize, subject to, node</code>, 这里<code>alias</code>是<code>=</code>号.</p>
<section id="set-declarations" class="level2">
<h2 class="anchored" data-anchor-id="set-declarations">Set declarations</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Aset%5C%20name%5C%20alias_%7Bopt%7D%5C%20indexing%7Bopt%7D%5C%20attributes%7Bopt%7D;%0A%5Cend%7Baligned%7D%0A"></p>
<p>这里<code>attributes</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attribute</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb8-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  dimen n </span></span>
<span id="cb8-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  within sexpr </span></span>
<span id="cb8-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  = sexpr </span></span>
<span id="cb8-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  default sexpr</span></span></code></pre></div></div>
</section>
<section id="parameter-declarations" class="level2">
<h2 class="anchored" data-anchor-id="parameter-declarations">Parameter declarations</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Aparam%5C%20name%5C%20alias_%7Bopt%7D%5C%20indexing%7Bopt%7D%5C%20attributes%7Bopt%7D;%0A%5Cend%7Baligned%7D%0A"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attribute</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb9-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  binary </span></span>
<span id="cb9-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer </span></span>
<span id="cb9-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  symbolic </span></span>
<span id="cb9-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  relop expr </span></span>
<span id="cb9-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  in sexpr </span></span>
<span id="cb9-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  = expr </span></span>
<span id="cb9-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  default expr </span></span>
<span id="cb9-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relop</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> =</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ==</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> !=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;&gt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &gt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &gt;=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>这里symbolic表示可能是字符串或者数值</p>
</section>
<section id="variable-declarations" class="level2">
<h2 class="anchored" data-anchor-id="variable-declarations">Variable declarations</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Avar%5C%20name%5C%20alias_%7Bopt%7D%5C%20indexing%7Bopt%7D%5C%20attributes%7Bopt%7D;%0A%5Cend%7Baligned%7D%0A"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attribute</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb10-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  binary </span></span>
<span id="cb10-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  integer </span></span>
<span id="cb10-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  symbolic </span></span>
<span id="cb10-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  &gt;= expr</span></span>
<span id="cb10-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  &lt;= expr </span></span>
<span id="cb10-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  := expr </span></span>
<span id="cb10-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  default expr </span></span>
<span id="cb10-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  = expr </span></span>
<span id="cb10-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  coeff indexing_opt constraint expr</span></span>
<span id="cb10-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  cover indexing_opt constraint</span></span>
<span id="cb10-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  obj indexing_opt objective expr</span></span>
<span id="cb10-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  in sexpr </span></span>
<span id="cb10-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  suffix sufname expr</span></span></code></pre></div></div>
</section>
</section>
<section id="编程逻辑" class="level1">
<h1>编程逻辑</h1>
<section id="set的理解" class="level2">
<h2 class="anchored" data-anchor-id="set的理解">set的理解</h2>
<p>如果对应python中的概念, 实际ampl中的set应该是一个展平的list, list中的元素为tuple, 这个tuple就是member, set的维度指的是member这个tuple的维度. 比如这个例子, set就是多个2维的tuple组成的list, 多维的var或者param实际上就是将set A的元素作为key来索引:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'set A = {1..2, 2..3};'</span>)</span>
<span id="cb11-2">ap.display(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>)</span>
<span id="cb11-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-4"></span>
<span id="cb11-5">ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'var B </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{A}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> binary;'</span>)</span>
<span id="cb11-6">ap.display(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>)</span>
<span id="cb11-7">B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span></span>
<span id="cb11-8"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-9"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-10"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-11"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div></div>
</section>
<section id="下标索引" class="level2">
<h2 class="anchored" data-anchor-id="下标索引">下标索引</h2>
<p>只用通过set构造出来的var和param才能使用下标索引, 对于set本身, 需要进行排序后通过内置函数进行访问, 而且ordered只支持1维的set.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'set D = {3..1 by -1} ordered;'</span>)</span>
<span id="cb12-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-3">ap.display(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'first(D)'</span>)</span>
<span id="cb12-4">first(D) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span></code></pre></div></div>
</section>
<section id="数据加载" class="level2">
<h2 class="anchored" data-anchor-id="数据加载">数据加载</h2>
<p>对于参数来说, 指定十分麻烦, 但是还好ampl的python api提供了通过list/dict/pandas的方式来辅助指定参数:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">ap.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param domain { 1..3 };"</span>)</span>
<span id="cb13-2">ap.param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'domain'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8192</span>]</span>
<span id="cb13-3">ap.display(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'domain'</span>)</span>
<span id="cb13-4">domain [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span></span>
<span id="cb13-5"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span></span>
<span id="cb13-6"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span></span>
<span id="cb13-7"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8192</span></span>
<span id="cb13-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</section>
<section id="中间变量定义" class="level2">
<h2 class="anchored" data-anchor-id="中间变量定义">中间变量定义</h2>
<p>通常我们会定义一个中间变量为别的计算计算的结果, 实际上这些中间变量也都是通过约束来表示的, 在ortools里面是给我们封装好了, 但是在ampl中需要分两步定义:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">var loadA integer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-2">subject to LoadA_c : loadA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>运筹学</category>
  <guid>https://zhen8838.github.io/posts/ampl-learn.html</guid>
  <pubDate>Fri, 14 Jun 2024 06:46:02 GMT</pubDate>
</item>
<item>
  <title>Constraints Solver Internals</title>
  <link>https://zhen8838.github.io/posts/constraints-solver-internals.html</link>
  <description><![CDATA[ 




<!-- 添加介绍 -->
<p>关于ortools中<code>Constraints Solver</code>的内部逻辑.</p>
<!--more-->
<p>首先是数据结构:</p>
<pre class="plantuml"><code>@startuml

class Decision {
  &lt;color:green&gt; 表示在搜索树中的一个选择点, Apply向右, Refute向左. &lt;/color&gt;
  + void {abstract} Apply(Solver* s)&lt;color:green&gt; // 决策执行时调用 &lt;/color&gt;
  + void {abstract} Refute(Solver* s) &lt;color:green&gt; // 回溯后调用 &lt;/color&gt;
  + void {abstract} Accept(DecisionVisitor* visitor)
}

class Solver {
  + DefaultSolverParameters() ConstraintSolverParameters
  + AddConstraint(Constraint*)
  + Solve(DecisionBuilder*, vector&lt;SearchMonitor*&gt;)
}

class DecisionBuilder {
  &lt;color:green&gt; 构造搜索树 &lt;/color&gt;
  + Decision* Next(Solver*)  &lt;color:green&gt; 返回下一步决策, 如果为空则结束. &lt;/color&gt;
  + void AppendMonitors(Solver*, vector&lt;SearchMonitor*&gt;*) &lt;color:green&gt; 搜索开始前添加monitor. &lt;/color&gt;
  + void Accept(ModelVisitor*)
}

class RestoreAssignment {
  &lt;color:green&gt; 只执行一次, 将Assignment全部恢复到Var &lt;/color&gt;
}

DecisionBuilder &lt;|-- RestoreAssignment

class StoreAssignment {
  &lt;color:green&gt; 只执行一次, 将Var当前值存储到Assignment &lt;/color&gt;
}

DecisionBuilder &lt;|-- StoreAssignment

DecisionBuilder *--- Decision

class Demon {
  &lt;color:green&gt; 传播队列的基础元素, 负责在变量值域中传播变量的约束以及删除不满足约束的值 &lt;/color&gt;
  &lt;color:green&gt; 主要思想是附加到变量上监听变量的修改. &lt;/color&gt;
  + void {abstract} Run(Solver* s) &lt;color:green&gt; //  &lt;/color&gt;
  + DemonPriority {abstract} priority() &lt;color:green&gt; // 执行的优先级 &lt;/color&gt;
  + void inhibit(Solver* s) &lt;color:green&gt; // 在当前位置抑制demon &lt;/color&gt;
  + void desinhibit(Solver* s) &lt;color:green&gt; // 解除之前的抑制 &lt;/color&gt;
}

class PropagationBaseObject {
  + Solver* solver() 
  + void FreezeQueue()
  + void UnfreezeQueue()
  + void EnqueueDelayedDemon(Demon* const d)
  + void EnqueueVar(Demon* const d)
  + void ExecuteAll(const SimpleRevFIFO&lt;Demon*&gt;&amp; demons)
  + void EnqueueAll(const SimpleRevFIFO&lt;Demon*&gt;&amp; demons)
}

abstract class Constraint {
  &lt;color:green&gt; 建模约束 &lt;/color&gt;
  + void {abstract} Post() &lt;color:green&gt; // 在solve过程中将demon附加到var上. &lt;/color&gt;
  + void {abstract} InitialPropagate() &lt;color:green&gt; // 初始化传播, 在Post之后调用 &lt;/color&gt;
  void PostAndPropagate() &lt;color:green&gt; // 在root节点是同时做两件事 &lt;/color&gt;
  + void {abstract} Accept(ModelVisitor* visitor)
  bool IsCastConstraint() &lt;color:green&gt; // 是否是cast到integer &lt;/color&gt;
  + IntVar*{abstract} Var(); &lt;color:green&gt; // 返回代表约束满足的bool var, 如果为Null表示不支持 &lt;/color&gt;
} 

PropagationBaseObject &lt;|-- Constraint

class CastConstraint {
  &lt;color:green&gt; 特殊的约束 &lt;/color&gt;
  + IntVar* target_var() 
}

Constraint &lt;|-- CastConstraint

class IntExpr {
  &lt;color:green&gt; 整数表达式, 建模的基础, 可以进行如下操作 &lt;/color&gt;
  &lt;color:green&gt;  1. 查询边界值 &lt;/color&gt;
  &lt;color:green&gt;  2. 设定边界值 &lt;/color&gt;
  &lt;color:green&gt;  3. 监听边界值改变 &lt;/color&gt;
  &lt;color:green&gt;  4. 构造对应var &lt;/color&gt;
  + int64_t  {abstract} Min();
  + void  {abstract} SetMin(int64_t m);
  + int64_t  {abstract} Max();
  + void  {abstract} SetMax(int64_t m);
  + void  {abstract} Range(int64_t* l, int64_t* u);
  + void  {abstract} SetRange(int64_t l, int64_t u);
  + void  {abstract} SetValue(int64_t v);
  + bool  {abstract} Bound();
  + bool  {abstract} IsVar();
  + IntVar* {abstract}  Var();
  + void  {abstract} WhenRange(Demon* d);
}

PropagationBaseObject &lt;|-- IntExpr

class IntVar {
  &lt;color:green&gt; Var也是表达式 &lt;/color&gt;
  + int64_t {abstract} Value()
  + void {abstract} RemoveValue(int64_t v)
  + void {abstract} RemoveInterval(int64_t l, int64_t u)
  + void {abstract} RemoveValues(const std::vector&lt;int64_t&gt;&amp; values);
  + void {abstract} SetValues(const std::vector&lt;int64_t&gt;&amp; values);
  + void {abstract} WhenBound(Demon* d)
  + void WhenBound(Solver::Closure closure)
  + void WhenBound(Solver::Action action)
  + void {abstract} WhenDomain(Demon* d)
  + void WhenDomain(Solver::Closure closure)
  + void WhenDomain(Solver::Action action)
  + uint64_t {abstract} Size()
  + bool {abstract} Contains(int64_t v)
  + IntVarIterator*{abstract}  MakeHoleIterator(bool reversible)
  + IntVarIterator*{abstract}  MakeDomainIterator(bool reversible)
  + int64_t {abstract} OldMin()
  + int64_t {abstract} OldMax()
  + int {abstract} VarType() const;
  + IntVar* {abstract} IsEqual(int64_t constant)
  + IntVar* {abstract} IsDifferent(int64_t constant)
  + IntVar* {abstract} IsGreaterOrEqual(int64_t constant)
  + IntVar* {abstract} IsLessOrEqual(int64_t constant)
  + int index()
}

IntExpr &lt;|-- IntVar


abstract class SearchMonitor {
  + void {abstract} EnterSearch()
  + void {abstract} RestartSearch()
  + void {abstract} ExitSearch()
  + void {abstract} BeginNextDecision(DecisionBuilder* b)
  + void {abstract} EndNextDecision(DecisionBuilder* b, Decision* d)
  + void {abstract} ApplyDecision(Decision* d)
  + void {abstract} RefuteDecision(Decision* d)
  + void {abstract} AfterDecision(Decision* d, bool apply)
  + void {abstract} BeginFail()
  + void {abstract} EndFail()
  + void {abstract} BeginInitialPropagation()
  + void {abstract} EndInitialPropagation()
  + bool {abstract} AcceptSolution()
  + bool {abstract} AtSolution()
  + void {abstract} NoMoreSolutions()
  + bool {abstract} LocalOptimum()
  + bool {abstract} AcceptDelta(Assignment* delta, Assignment* deltadelta)
  + void {abstract} AcceptNeighbor()
  + void {abstract} AcceptUncheckedNeighbor()
  + bool {abstract} IsUncheckedSolutionLimitReached(
  + void {abstract} PeriodicCheck()
  + int {abstract} ProgressPercent()
  + void {abstract} Accept(ModelVisitor* visitor)
  + void {abstract} Install() &lt;b&gt;&lt;color:green&gt; // 注册自身&lt;/color&gt; 
}

class SolutionCollector {
  &lt;color:green&gt; 收集添加过的变量 &lt;/color&gt;
  + void Add(IntVar* var)
  + void Add(const std::vector&lt;IntVar*&gt;&amp; vars)
  + void Add(IntervalVar* var)
  + void Add(const std::vector&lt;IntervalVar*&gt;&amp; vars)
  + void Add(SequenceVar* var)
  + void Add(const std::vector&lt;SequenceVar*&gt;&amp; vars)
  + void AddObjective(IntVar* objective)
  + void AddObjectives(const std::vector&lt;IntVar*&gt;&amp; objectives)
}

SearchMonitor &lt;|-- SolutionCollector

class ObjectiveMonitor {
  &lt;color:green&gt; 优化目标监控基类 &lt;/color&gt;
  + IntVar* ObjectiveVar(int index)
  + IntVar* MinimizationVar(int index)
  + int64_t Step(int index)
  + bool Maximize(int index)
  + int64_t BestValue(int index)
  + int Size()
  + void EnterSearch()
  + bool AtSolution()
  + bool AcceptDelta(Assignment* delta, Assignment* deltadelta)
  + void Accept(ModelVisitor* visitor)
}

SearchMonitor &lt;|-- ObjectiveMonitor

class OptimizeVar {
  &lt;color:green&gt; 概括目标, 指定方向, 变量, 步幅即可 &lt;/color&gt;
  + int64_t best()
  + IntVar* var()
  + void BeginNextDecision(DecisionBuilder* db)
  + void RefuteDecision(Decision* d)
  + bool AtSolution()
  + bool AcceptSolution()
  + void ApplyBound()
}

ObjectiveMonitor &lt;|-- OptimizeVar


class SearchLimit {
  + void EnterSearch() 
  + void BeginNextDecision(DecisionBuilder* b) 
  + void PeriodicCheck() 
  + void RefuteDecision(Decision* d) 
  + void Install()
  + bool crossed() &lt;b&gt;&lt;color:green&gt; // 检查limit是否已经失败 &lt;/color&gt;  
  + bool Check() &lt;b&gt;&lt;color:green&gt; // 检查limit状态 &lt;/color&gt;  
  + bool {abstract} CheckWithOffset(absl::Duration offset) &lt;b&gt;&lt;color:green&gt; // 自定义检查方法 &lt;/color&gt;  
}

SearchMonitor &lt;|-- SearchLimit

class RegularLimit {
  &lt;color:green&gt; 基于搜索时间/探索分支数/失败错误来限制搜索 &lt;/color&gt;
  + bool CheckWithOffset(absl::Duration offset)
} 

class ImprovementSearchLimit {
  &lt;color:green&gt;基于目标变量的改善率或者词典序进行限制.&lt;/color&gt;
  + int64_t wall_time()
  + int64_t branches()
  + int64_t failures()
  + int64_t solutions()
  + bool CheckWithOffset(absl::Duration offset)
} 

SearchLimit &lt;|-- RegularLimit
SearchLimit &lt;|-- ImprovementSearchLimit


class IntervalVar {
  &lt;color:green&gt;包含duration的var.&lt;/color&gt;
}

PropagationBaseObject &lt;|-- IntervalVar

class SequenceVar {
  &lt;color:green&gt;包含多个IntervalVar.&lt;/color&gt;
  + IntervalVar* Interval(int index)
}

PropagationBaseObject &lt;|-- SequenceVar

class AssignmentElement {

}
class IntVarElement {

}

AssignmentElement &lt;|-- IntVarElement

class IntervalVarElement {

}

AssignmentElement &lt;|-- IntervalVarElement

class SequenceVarElement {

}

AssignmentElement &lt;|-- SequenceVarElement

class Assignment {
  &lt;color:green&gt; 包含domain到var的映射, 用于展示solution.&lt;/color&gt;
  + void Clear();
  + bool Empty()
  + int Size()
  + int NumIntVars()
  + int NumIntervalVars()
  + int NumSequenceVars()
  + void Store()
  + void Restore()
  + bool Load(const std::string&amp; filename)
}

PropagationBaseObject &lt;|-- Assignment

class Pack {
  &lt;color:green&gt; 多个var映射到bin的约束. &lt;/color&gt;
  + void AddWeightedSumLessOrEqualConstantDimension(const std::vector&lt;int64_t&gt;&amp; weights, const std::vector&lt;int64_t&gt;&amp; bounds);
  + void AddWeightedSumLessOrEqualConstantDimension(Solver::IndexEvaluator1 weights, const std::vector&lt;int64_t&gt;&amp; bounds);
  + void AddWeightedSumLessOrEqualConstantDimension(Solver::IndexEvaluator2 weights, const std::vector&lt;int64_t&gt;&amp; bounds);
  + void AddWeightedSumEqualVarDimension(const std::vector&lt;int64_t&gt;&amp; weights,const std::vector&lt;IntVar*&gt;&amp; loads);
  + void AddWeightedSumEqualVarDimension(Solver::IndexEvaluator2 weights,const std::vector&lt;IntVar*&gt;&amp; loads);
  + void AddSumVariableWeightsLessOrEqualConstantDimension(const std::vector&lt;IntVar*&gt;&amp; usage, const std::vector&lt;int64_t&gt;&amp; capacity);
  + void AddWeightedSumOfAssignedDimension(const std::vector&lt;int64_t&gt;&amp; weights,IntVar* cost_var);
  + void AddCountUsedBinDimension(IntVar* count_var);
  + void AddCountAssignedItemsDimension(IntVar* count_var);
}

Constraint &lt;|-- Pack


Constraint &lt;|-- DisjunctiveConstraint


@enduml</code></pre>
<p>其中整个优化模型由IntExpr和Constraints构成. 构建好约束后通过 DecisionBuilder来生成Decision, 每个Decision会给变量进行分配值, 分配好值</p>
<pre class="plantuml"><code>@startuml
NextSolution -&gt; BeginInitialPropagation
NextSolution &lt;- BeginInitialPropagation
NextSolution -&gt; Next : DecisionBuilder.Next() 
Next -&gt; Apply : Decision.Apply() 
Apply -&gt; SetValue  : Decision.Apply() 
SetValue -&gt; EnqueueVar : EnqueueVar the Demon Handler
EnqueueVar -&gt; Queue.Process : when freeze_level_ == 0
Queue.Process -&gt; Demon.Run : pop the enqueued demons and run it
Demon.Run -&gt; Var.ExecuteAll : exec the the constraints
@enduml</code></pre>
<!-- DecisionBuilder -> Decision -->



 ]]></description>
  <category>运筹学</category>
  <guid>https://zhen8838.github.io/posts/constraints-solver-internals.html</guid>
  <pubDate>Wed, 08 May 2024 03:24:39 GMT</pubDate>
</item>
<item>
  <title>Model Driven Optimization</title>
  <link>https://zhen8838.github.io/posts/model-driven-optimization.html</link>
  <description><![CDATA[ 




<p>关于<code>Model-Driven Optimization For Tensor Computations</code>论文的阅读笔记.</p>
<!--more-->
<section id="单内存层级建模" class="level1">
<h1>1. 单内存层级建模</h1>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Ni<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Ti1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Nj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tj1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Nk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tk1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-4">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Ti1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb1-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tj1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb1-6">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tk1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb1-7">            C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span></code></pre></div></div>
<p>以这样的矩阵乘作为例子, 进行单层内存层级的tiling建模. 首先循环变量表示为<img src="https://latex.codecogs.com/png.latex?i_%7B1%7D,i_%7B2%7D,%5Cldots,i_%7Bl+1%7D">, 其中<img src="https://latex.codecogs.com/png.latex?l">为tiling层级(我理解这个应该就是循环层级), <img src="https://latex.codecogs.com/png.latex?l==0">表示的是statement, <img src="https://latex.codecogs.com/png.latex?l+1">表示的就是最外层循环,<img src="https://latex.codecogs.com/png.latex?l==1">表示最内层循环. tilesize变量表示为<img src="https://latex.codecogs.com/png.latex?T_%7Bi_%7B1%7D%7D,T_%7Bi_%7B2%7D%7D,%5Cldots,T%7Bi_%7Bl+1%7D%7D">.</p>
<p>对于一个固定的循环order, 我们可以用上面定义的变量来建模数据移动. 令<img src="https://latex.codecogs.com/png.latex?DF(A,i)">表示的是数组<img src="https://latex.codecogs.com/png.latex?A">从循环<img src="https://latex.codecogs.com/png.latex?i">开始的被访问过的<strong>不同</strong>元素的数量(Data Footprint).令<img src="https://latex.codecogs.com/png.latex?DM(A,i)">表示在循环<img src="https://latex.codecogs.com/png.latex?i">处数组<img src="https://latex.codecogs.com/png.latex?A">从主存到cache的数据移动(Data Movement). 下面这段代码展示令如何计算这两个不同的项目, 其实他们的区别也就是在于存在数据复用的时候, 内存足迹是不改变的, 但是内存移动量在内存足迹大于cache size的时候是需要重复load的. 根据这个计算方式, 也就是表示如果有一个维度足够小, 可以让数据完整的放在cache中, 那么他的就不需要重复load.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode csharp code-with-copy"><code class="sourceCode cs"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">foreach</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>loop i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Loops<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Reverse</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// statement level</span></span>
<span id="cb2-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">foreach</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tensor A <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-6">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-7">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">foreach</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tensor A <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-9">      <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Indices</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Contains</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-10">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-11">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-12">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-13">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sum</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DF</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> CacheCapacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-15">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-17">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DM</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i − <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-19">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-21">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="多内存层级建模" class="level1">
<h1>2. 多内存层级建模</h1>
<p>目前的现代处理架构通常有多个内存层级, 更高的内存层级会有更大的存储以及更小的带宽. 假设每一个循环只能tile到其中一个内存层级, 对于一个两级内存层级的tiling示例代码如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Ni<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Ti2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Nj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tj2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Nk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tk2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-4">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Ti2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Ti1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tj2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tj1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-6">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tk2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span>Tk1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Ti1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb3-8">              <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tj1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb3-9">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tk1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span></span>
<span id="cb3-10">                  C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>k1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>k3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span></code></pre></div></div>
<p>为了适配多内存层级, 需要修改<img src="https://latex.codecogs.com/png.latex?DM">的定义为<img src="https://latex.codecogs.com/png.latex?DM(A,i,l)">表示数组<img src="https://latex.codecogs.com/png.latex?A">在循环<img src="https://latex.codecogs.com/png.latex?i">上从内存层级<img src="https://latex.codecogs.com/png.latex?l">到<img src="https://latex.codecogs.com/png.latex?l+1">的数据移动, 但原始论文只说了更新建模的代码从<code>Sum(Tensors, A =&gt; DF(A, i − 1)) &lt; CacheCapacity</code>到<code>Sum(Tensors, A =&gt; DF(A, i − 1)) &lt; CacheCapacity(l)</code>, 并没有给出完整的实现. 这里实际上每一个出现<code>DM</code>的地方都需要添加<img src="https://latex.codecogs.com/png.latex?l">参数, 那么可能需要在最外层再添加关于内存层级的循环, 但是从直觉上来说内存层级的选择这里是多分支的, 不是简单的双循环就可以构造出来的.</p>
</section>
<section id="估计执行时间" class="level1">
<h1>3. 估计执行时间</h1>
<p>这里假设访存是主要的瓶颈, 那么通过统计每个内存层级的数据移动量以及对应的带宽大小来估计总时间. 令<img src="https://latex.codecogs.com/png.latex?L">表示内存层级编号, <img src="https://latex.codecogs.com/png.latex?C_1,%5Cldots,C_%7BL%7D">表示各个内层层级, 而<img src="https://latex.codecogs.com/png.latex?C_0">表示计算单元,<img src="https://latex.codecogs.com/png.latex?C_%7BL+1%7D">表示主存. 令<img src="https://latex.codecogs.com/png.latex?BW_1,%5Cldots,BW_%7BL+1%7D">表示各个内存层级的带宽. 令<img src="https://latex.codecogs.com/png.latex?C%5C_DM_(l)">表示从内存层级<img src="https://latex.codecogs.com/png.latex?l">到<img src="https://latex.codecogs.com/png.latex?l-1">的数据移动量,<img src="https://latex.codecogs.com/png.latex?C%5C_Time(%5Cmathcal%7BP%7D,%20l)">在特定的循环排列下从内存层级<img src="https://latex.codecogs.com/png.latex?l">到<img src="https://latex.codecogs.com/png.latex?l-1">的数据移动时间. 那么给定一个固定的循环排列<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BP%7D">,对应的时间为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20C%5C_Time(%5Cmathcal%7BP%7D,%20l)%20&amp;=%20C%5C_DM(l)%20/%20BW_l%20%5C%5C%0A%20%20TotTime(%5Cmathcal%7BP%7D)%20&amp;=%20%5Cmax_%7Bl%20=%201%7D%5E%7BL+1%7D%20%5Cleft(%20C%5C_Time(%5Cmathcal%7BP%7D,%20l)%20%5Cright)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="tilesize与循环排列选择" class="level1">
<h1>4. tilesize与循环排列选择</h1>
<p>首先对于一个固定循环排列下的tile size选择就变成了一个约束求解问题: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Carg%20%5Cmin_%7Btile-sizes%7D(TotTime(%5Cmathcal%7BP%7D))%20=%20%5Carg%20%5Cmin_%7Btile-sizes%7D%5Cleft(%5Cmax_%7Bl%20=%201%7D%5E%7BL+1%7D%20%5Cleft(%20C%5C_Time(%5Cmathcal%7BP%7D,%20l)%20%5Cright)%5Cright)%0A%5Cend%7Baligned%7D%0A"></p>
<p>为了减少搜索空间, 限制对于内存层级<img src="https://latex.codecogs.com/png.latex?l">的所有内存移动量<img src="https://latex.codecogs.com/png.latex?C%5C_DM(l)">必须小于等于内存层级的容量, 令<img src="https://latex.codecogs.com/png.latex?group%5C_outer(l)">表示属于内存层级<img src="https://latex.codecogs.com/png.latex?l">的最外层循环, 构建容量约束如下: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Cforall%20l%20%5Cin%20%5B1,L%5D,%5C%20%5Csum_%7BA%5Cin%20Tensors%7D%20DM(A,%20group%5C_outer(l))%20%5Cleq%20CacheCapacity(l)%0A%5Cend%7Baligned%7D%0A"></p>
<p>但这样还是没有考虑tile size对于不同层级的访存速度影响, 需要构建一个多级约束. 令<img src="https://latex.codecogs.com/png.latex?T">表示所有的tile变量集合, <img src="https://latex.codecogs.com/png.latex?T_l">表示会影响内存层级<img src="https://latex.codecogs.com/png.latex?l">的总数据移动量<img src="https://latex.codecogs.com/png.latex?C%5C_DM(l)">的tile变量子集. 也就是多个循环可以对应同一个内存层级, 那么这些循环对应的tile变量组成的子集, 这些变量每个都会影响当前内存层级的数据移动量.</p>
<p>假设<img src="https://latex.codecogs.com/png.latex?j">是最大瓶颈的内存层级, 也就是他的时间大于其他内存层级时间: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Cforall%20i%20%5Cin%20%5B1,%20L+1%5D,%20%5C%20(C%5C_DM(j)/C%5C_BW(j))%20%5Cgeq%20(C%5C_DM(i)/C%5C_BW%20(i)%0A%5Cend%7Baligned%7D%0A"></p>
<p>当固定了<img src="https://latex.codecogs.com/png.latex?j">层级的tile size后, 下一个瓶颈的内存层级可以使用如下公式找到: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Cargmin_%7BT-T_j%7D%20(%5Cmax_%7Bl%5Cin%5B1,L+1%5D%20-%20T_j%7D%20C%5C_Time(%5Cmathcal%7BP%7D,l))%0A%5Cend%7Baligned%7D%0A"></p>
<p>但是论文中并没有详细描述怎么进行多级优化, 这里的约束应该都还是变量, 除非是求解器可以通过某种方式添加优化指导.</p>
<p>接下来就是考虑不同的循环排列, 对于两级tiling, 就有9个循环那么排列方式就有9!种. 但其实只需要考虑每个tile出来的循环内部进行排序,也就是<img src="https://latex.codecogs.com/png.latex?3!%5Ctimes3!%5Ctimes3!%20=%20216">种即可. 最终的解为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Afinal%5C_solution%20=%20%20%5Cargmin_%7B%5Cmathcal%7BP%7D%5Cin%20%5Cmathcal%7BR%7D%7D%20(%5Cargmin_%7Btile%5C_sizes%7D(TotTime(%5Cmathcal%7BP%7D)))%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="micro-kernel" class="level1">
<h1>5. micro kernel</h1>
<p>对于包含SIMD的指令集的处理器来说, 需要考虑设计一个最大硬件利用率的micro kernel, 这里需要对micro kernel也进行建模. 首先是<code>MaxIssue</code>表示一个时钟周期最大可以发射的指令数, <code>WordPerVec</code>表示指令集宽度, <code>Latency</code>表示一个指令周期所需要的时钟周期数. 假设在一个指令周期中每个时钟周期都可以发射<code>MaxIssue</code>个指令数, 并且他们之间是没有数据依赖的, 那么<code>MaxIssue * Latency</code>则是可以保证流水线打满的最小指令数, <code>MaxIssue * Latency * WordPerVec</code>则表示最小寄存器容量. 比如在<code>BLIS</code>库中,通常使用外积的方式来设计micro kernel, 但是这个kernel它需要一块布局优化后的数据块才可以开始计算, 这就要求进行<strong>packing</strong>.</p>
<p>packing的一个好处是可以减少Conflict Miss,现代处理器中cache的存放策略通常是<a href="https://en.wikipedia.org/wiki/Cache_placement_policies#Set-associative_cache">set-associative</a>, 整个缓存被划分为多个set,而这些set内部进一步被细分为lines/ways. 一个映射函数决定内存地址到set的映射. 在每个set内,一个给定的内存地址可能出现在任意一个cache line上. 当在多个不同的内存地址由于缓存映射规则而被迫存储在同一个cache line时, 由于每个缓存行只能存储一个数据块, 当一个新的数据块需要被存储到这个缓存行时, 原有的数据块必须被替换掉, 在理想情况下, 被替换的应该是最近最少使用(LRU)的数据块, 然而在某些情况下, 由于映射规则的限制, 一个不是LRU的数据块也可能被替换, 这就是发生了Conflict Miss.</p>
<p>通过选择合适tile大小,并依赖于packing设计,可以将即数据元素的排列顺序与它们将被访问的顺序相同,从而避免Conflict Miss. 虽然packed buffer在内存中是连续的存储. 但是实际上他们分散在cache中各个地方, 由于大部分的cache是无法编程的, 加载新的数据会将其他tensor从cache中驱除, 为了避免这种情况, 每个tensor拥有的cache line的数量要被小心的控制, 对于矩阵乘的例子这里计算分配给各个tensor的cache line数量: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AlineA%20=%20%5BDF(A,l)%20/%20(NumOfSets(l)*lineSize(l))%5D%20%5C%5C%0AlineB%20=%20%5BDF(B,l)%20/%20(NumOfSets(l)*lineSize(l))%5D%20%5C%5C%0AlineC%20=%20%5BDF(C,l)%20/%20(NumOfSets(l)*lineSize(l))%5D%20%5C%5C%0As.t%20Line_A(l)+Line_B(l)+Line_C(l)%20%5Cleq%20Associativity(l)%20%5C%5C%0A%5Cend%7Baligned%7D%0A"> 假设只访问A/B矩阵, 考虑在l层级的j循环, A矩阵并没有被j索引, 但是在k循环中多次访问A行, 此时A会停留在cache中, 而B矩阵的行j循环才会被访问, 因此B矩阵在cache中是流式传输的.</p>
<p>packing 会增加额外的数据移动, 为了减少packing带来的额外时间. 比如要复用pack过的数据, 但是由于cache容量的限制, 大部分情况是没办法存储整个的buffer的. 假设A时需要pack的tneosr, 设<img src="https://latex.codecogs.com/png.latex?IS">表示整个迭代空间, 令<img src="https://latex.codecogs.com/png.latex?IS_A">表示参与访问A的循环子集, 设packing在最后一层cache <img src="https://latex.codecogs.com/png.latex?ll">, 那么packing的cost为包含从主存加载以及存储数据到<img src="https://latex.codecogs.com/png.latex?ll">层上:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0APackCost%5E%7BA,%20buf%5Cin%20Mem%7D_%7Bmem%20%5Crightarrow%20l3%7D%20=%20%5Cprod_%7Bidx%20%5Cin%20IS_A%7D%20idx%0A%5Cend%7Baligned%7D%0A"></p>
<p>假设l3级别的tiling循环为<img src="https://latex.codecogs.com/png.latex?i_1%5E%7BL3%7D,i_2%5E%7BL3%7D,%5Cldots,i_l%5E%7BL3%7D">, 假设只有<img src="https://latex.codecogs.com/png.latex?i_2%5E%7BL3%7D,%20i_l%5E%7BL3%7D">是A的reuse index,那么意味着<img src="https://latex.codecogs.com/png.latex?i_2%5E%7BL3%7D,%20i_l%5E%7BL3%7D%20%5Cnotin%20IS_A">. 假设packed A在level 3进行构造, 那么代码可能类似这样: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Afor%5C%20loop&amp;%5C%20%20i_1%5E%7BL3%7D%5C%5C%0Afor%5C%20&amp;loop%5C%20%20i_2%5E%7BL3%7D%20%5C%5C%0A&amp;%20%5Cldots%5C%5C%0A&amp;for%5C%20loop%5C%20%20i_l%5E%7BL3%7D%5C%5C%0A&amp;%20%5Ctext%7BPacking%20buffer%20resides%20here;%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>注意这里packed A将会在<img src="https://latex.codecogs.com/png.latex?i_2%5E%7BL3%7D">的循环中被填充满, 即使<img src="https://latex.codecogs.com/png.latex?i_2%5E%7BL3%7D">是他的reuse index, 这意味着对于给定tenors的内部cache packing的总数据移动是tensor size和packing cache level以上的所有reuse loops的乘积. 公式化的描述如下:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bgathered%7D%0AR%20D%20X%5E%7BL%203%7D=%5Cleft%5C%7Bi_g%5E%7BL%203%7D%20%5Cmid%20i_g%20%5Cnotin%20I%20S_A%20%5Cwedge%5Cleft(%5Cexists%20i_h%20%5Cin%20I%20S_A%5Cright)%5Cleft%5Bi_g%5E%7BL%203%7D%3Ei_h%5E%7BL%203%7D%5Cright%5D%5Cright%5C%7D%20%5C%5C%0A%5Ctext%20%7B%20PackCost%20%7D%20t_%7Bm%20e%20m%20%5Crightarrow%20L%20b%7D%5E%7BA,%20b%20u%20f%20%5Cin%20L%203%7D=%5Cprod_%7Bi%20d%20x%20%5Cin%20I%20S_A%7D%20i%20d%20x%20*%20%5Cprod_%7Br%20d%20x%20%5Cin%20R%20D%20X%5E%7BL%203%7D%7D%20%5Coperatorname%7BNIter%7D(r%20d%20x)%0A%5Cend%7Bgathered%7D%0A"></p>
<p>首先令<img src="https://latex.codecogs.com/png.latex?i%5E%7BL3%7D_p%3E%20i%5E%7BL3%7D_q">表示在L3内存层级中<img src="https://latex.codecogs.com/png.latex?i%5E%7BL3%7D_p">循环在<img src="https://latex.codecogs.com/png.latex?i%5E%7BL3%7D_q">之上. 再令<img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BNIter%7D(i%5E%7BL3%7D_p)">表示循环的迭代次数, 令<img src="https://latex.codecogs.com/png.latex?Tile(i%5E%7BL3%7D_p%20)">表示索引<img src="https://latex.codecogs.com/png.latex?p">的tile大小, <img src="https://latex.codecogs.com/png.latex?N_p">表示索引<img src="https://latex.codecogs.com/png.latex?p">的全局大小(我理解就是这个tensor在<img src="https://latex.codecogs.com/png.latex?p">维度的大小). 然后<img src="https://latex.codecogs.com/png.latex?RDX%5E%7BL3%7D">表示在与A无关的循环迭代中, 存在的迭代<img src="https://latex.codecogs.com/png.latex?i_g%5E%7BL%203%7D">级别高于<img src="https://latex.codecogs.com/png.latex?i_h%5E%7BL%203%7D">, 将这些迭代的总次数累积起来与参与A的循环<img src="https://latex.codecogs.com/png.latex?idx">进行乘积.</p>
<p>对于任意内存层级的pack cost可以通过如下公式计算:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%20R%20D%20X%5E%7BL_c%7D=%5Cleft%5C%7Bi_g%5E%7BL_c%7D%20%5Cmid%20i_g%20%5Cnotin%20I%20S_A%20%5Cwedge%5Cleft(%5Cexists%20i_h%20%5Cin%20I%20S_A%5Cright)%5Cleft%5Bi_g%5E%7BL_c%7D%3Ei_h%5E%7BL_c%7D%5Cright%5D%5Cright%5C%7D%20%5C%5C%0A&amp;%20%5Ctext%20%7B%20PackCost%20%7D%20%5Coperatorname%7Bmem%7D_%7Bm%20%5Crightarrow%20L_c%7D%5E%7BA,%20b%20u%20f%20%5Cin%20L_c%7D=%5Cprod_%7Bi%20d%20x%20%5Cin%20I%20S_A%7D%20i%20d%20x%20*%20%5Cprod_%7Br%20d%20x%20%5Cin%20R%20D%20X%5E%7BL_c%7D%7D%20%5Ctext%20%7B%20NIter%20%7D(r%20d%20x)%20%5C%5C%0A&amp;%20=%5Cprod_%7Bi%20d%20x%20%5Cin%20I%20S_A%7D%20i%20d%20x%20*%20%5Cprod_%7Bi_p%20%5Cin%20R%20D%20X%5E%7BL_c%7D%7D%5Cleft(N_p%20/%20%5Ctext%20%7B%20Tile%20%7D%5Cleft(i_p%5E%7BL_c%7D%5Cright)%5Cright)%20%5C%5C%0A&amp;%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="疑问" class="level1">
<h1>6. 疑问</h1>
<ol type="1">
<li>我在思考他这里的DM和DF和显式的指定sub tensor放置在哪个循环下是否有共同性.</li>
<li>他这里的<code>group_outer(l)</code>的函数是一个离散函数, 但是求解器只能支持连续的变量, 现在问题转化为如何通过连续的变量构造出分段函数? 这个方法实际上和对于多层memory的循环加在哪个位置息息相关.</li>
<li>在约束编程中通过什么方式控制几个变量属于一个区间?</li>
<li>怎么样进行多阶段求解?</li>
<li>他这里感觉没有考虑在l1上cache packed buffer, 实际上可以开很大一块buffer, 然后在l1的循环中每次load并pack一小块, 然后在l1中缓存起来, 这样切换m/n的时候可以尽量复用.</li>
</ol>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/model-driven-optimization.html</guid>
  <pubDate>Tue, 30 Apr 2024 03:08:53 GMT</pubDate>
</item>
<item>
  <title>探索AMX: 解锁Apple Silicon隐藏性能</title>
  <link>https://zhen8838.github.io/posts/mac-amx.html</link>
  <description><![CDATA[ 




<p>自从2020年Apple发布的芯片M1/M2/M3, 至少提供了四种不同的方式可以执行高负载的计算任务:</p>
<ol type="1">
<li><p>标准的ARMv8 SIMD/NEON向量指令集.</p></li>
<li><p>苹果尚未公开文档的AMX(Apple Matrix Co-processor)指令集, 由CPU发射, 在特殊的加速器上运行.</p></li>
<li><p>神经网络处理器ANE(Apple Neural Engine)</p></li>
<li><p>Metal GPU</p></li>
</ol>
<p>在M1 Max上单核计算单精度浮点矩阵乘法时, 使用SIMD指令集<a href="https://zhuanlan.zhihu.com/p/464740681">可达到102 GFLOPS左右的性能</a>, 而使用AMX指令集最多<a href="https://github.com/corsix/amx/blob/main/fma.md#performance-m1-max">可达到<strong>1475</strong> GFLOPS!</a> 本文就来带领大家一同探索AMX指令集, 学习如何解锁这剩下的14倍算力.</p>
<!--more-->
<section id="概述" class="level1">
<h1>1. 概述</h1>
<p>先通过一张图建立起对于AMX初步了解. 考虑一个32x32的计算单元网格, 每个单元可以执行16位乘积, 或者2x2单元子网格可以执行32位乘积, 或者4x4子网格可以执行64位乘积. 为了提供此网格的输入, 有一个包含32个16位元素(或16个32位元素, 或8个64位元素)的X寄存器池, 以及一个同样包含32个16位元素(或16个32位元素, 或8个64位元素)的Y寄存器池. 使用单个指令可以执行完整的外积: 将X寄存器的每个元素与Y寄存器的每个元素相乘, 并在相应位置与Z元素一起累加. 或者可以将X寄存器的每个元素与Y寄存器的每个元素进行内积, 得到一个点的结果.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx/fig2.png" class="img-fluid figure-img"></p>
<figcaption>专利 US20180074824A1</figcaption>
</figure>
</div>
<p>AMX为以上的操作提供了LDX/LDY, FMA, LDZ/SDZ等指令. 其中FMA分为Matrix Mode和Vector Mode分别对应外积与内积两种不同的计算方式. 当然我们首选外积, 否则无法最大化利用硬件. 下面两张图分别展示了内积与外积的计算方式:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx/inner product.png" class="img-fluid figure-img"></p>
<figcaption>内积</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx/outer product.png" class="img-fluid figure-img"></p>
<figcaption>外积</figcaption>
</figure>
</div>
</section>
<section id="最小计算流程" class="level1">
<h1>2. 最小计算流程</h1>
<p>下面同样通过一张图解释清楚AMX中的寄存器规格与最小计算流程. 首先是X/Y寄存器池, 他们各有8个宽度为64 bytes的寄存器, 可以存储fp16/32/64或者i8/16/32,u8/16/32类型的数据. 接着是Z寄存器池, 他有64个宽度为64 bytes的寄存器, 用于存储X/Y寄存器外积或内积的结果. 根据第一节中描述, 2x2单元子网格来执行32位乘积, 因此执行外积时需要用到16个寄存器, 因此64个寄存器被分16组, 每组的间隔为4(64/16), 即外积结果并非是按寄存器连续存储的. (注意AMX只支持从主存中加载与存储, 无法通过通用寄存器/向量寄存器加载与存储)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx/workflow.png" class="img-fluid figure-img"></p>
<figcaption>最小计算流程</figcaption>
</figure>
</div>
<p>通过外积计算可以获得一个partial sum存储在Z寄存器池中, 接下来我们可以切换K维度从而累积partial sum得到完整的结果:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx/workflow switch k.png" class="img-fluid figure-img"></p>
<figcaption>切换K维度</figcaption>
</figure>
</div>
<p>此时重新加载不同K维度的A/B矩阵, 然后将计算结果写入到与之前同一个Z的寄存器组中实现累加.</p>
<p>当然也可以迭代M/N, 比如这个例子中保持M不变, 迭代到下一个N, 此时我们需要在Z寄存器池中另外选一组存储当前M/N的累加值: <img src="https://zhen8838.github.io/posts/mac-amx/workflow switch n.png" class="img-fluid" alt="切换K维度"></p>
</section>
<section id="理论性能测试" class="level1">
<h1>3. 理论性能测试</h1>
<p>为了用好AMX, 首先需要更加了解AMX的相关参数, 接下来一起验证理论各项性能指标.</p>
<section id="理论计算性能" class="level2">
<h2 class="anchored" data-anchor-id="理论计算性能">3.1 理论计算性能</h2>
<p>根据上一节我们清楚了Z寄存器组在float32模式下一共被分为了16组, 一次计算在每一组中得到一列结果, 因此ALU实际上被分为了4组. 这里就来验证使用不同个数的ALU组的峰值性能:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>z_nums<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-6">  AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-8">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-10">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-12">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>得到结果如下:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>ALU Nums</th>
<th>Gflop/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>405.530</td>
</tr>
<tr class="even">
<td>2</td>
<td>826.912</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1244.570</td>
</tr>
<tr class="even">
<td>4</td>
<td>1666.952</td>
</tr>
</tbody>
</table>
<p>这表明虽然每组ALU是单独配置和发射, 但是他们之间是可以并行执行的.</p>
</section>
<section id="理论数据加载性能" class="level2">
<h2 class="anchored" data-anchor-id="理论数据加载性能">3.2 理论数据加载性能</h2>
<p>这里是我设计的性能测试用例, 其中<code>reg nums</code>表示X/Y寄存器池. <code>near</code>表示是否读取内存中连续的地址,在M2 Pro中l1 Dcache 大小为65536, 因此将K设计为数倍大于l1 cache size, 当<code>near == 0</code>时需要跨过两倍大小的cache size去读取. <code>width</code>表示一次读取几个寄存器个数, 最大为4.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb2-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb2-4">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>reg_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>y_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-8">    ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-10">    ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-13">      ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-15">      ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"></span>
<span id="cb2-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-20">      AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-21">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-22">        AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-23">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-27">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-28">        AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-30">          AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-32">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-34">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>接下来我们计算数据加载时间, 得到下表:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Reg Nums</th>
<th>Near</th>
<th>X Width</th>
<th>Y Width</th>
<th>GB/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>87.1489</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>213.164</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>4</td>
<td>0</td>
<td>456.332</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>120.796</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>260.115</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>483.285</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>134.33</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>162.084</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>297.15</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>201.658</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>214.772</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>350.554</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>384.614</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>4</td>
<td>2</td>
<td>349.528</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>4</td>
<td>4</td>
<td>476.722</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>130.604</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>163.91</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>1</td>
<td>4</td>
<td>254.922</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>195.612</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>213.61</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>2</td>
<td>4</td>
<td>298.603</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>4</td>
<td>1</td>
<td>310.308</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>4</td>
<td>2</td>
<td>302.767</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>4</td>
<td>4</td>
<td>325.193</td>
</tr>
</tbody>
</table>
<p>可以发现加大读取宽度是可以翻倍带宽的, 因此这是无成本的. 读取连续摆放的数据相比于非连续读取略有提升, 这表明需要对数据摆放进行优化. 同时加载两个寄存器中也同样不会导致带宽降低, 表明可以同时加载A/B矩阵, 但需要注意尽量cache起来.</p>
</section>
<section id="理论数据存储性能" class="level2">
<h2 class="anchored" data-anchor-id="理论数据存储性能">3.3 理论数据存储性能</h2>
<p>同样在store时设计了<code>reg_num</code>,<code>near</code>,<code>width</code>等选项, 值的注意的是, 因为Z寄存器池被分为了16组, 所以每一次store时都将16组全部输出:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb3-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb3-4">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>z_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb3-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> z_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-8">      AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-9">                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>near <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width</span>
<span id="cb3-10">                              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb3-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-12">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>测试结果如下:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Reg Nums</th>
<th>Near</th>
<th>Width</th>
<th>GB/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>1</td>
<td>10.3769</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>2</td>
<td>8.93052</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>1</td>
<td>12.9423</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>2</td>
<td>12.3377</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>5.69731</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>12.3658</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>1</td>
<td>7.55092</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>2</td>
<td>13.0133</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>1</td>
<td>6.58085</td>
</tr>
<tr class="even">
<td>3</td>
<td>0</td>
<td>1</td>
<td>11.4118</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1</td>
<td>1</td>
<td>8.8847</td>
</tr>
<tr class="even">
<td>4</td>
<td>0</td>
<td>1</td>
<td>9.85956</td>
</tr>
</tbody>
</table>
<p>可以发现使用多个寄存器并无法提升带宽, 说明基本上是串行输出, 但开启两倍宽度还是可以有效提升带宽. 然而整体速度相比于计算和加载慢了数倍, 这表明我们不能频繁地加载与存储Z.</p>
</section>
</section>
<section id="设计micro-kernel" class="level1">
<h1>3. 设计Micro Kernel</h1>
<p>基于上一节中的内容, 我们可以来尝试编写一个现实世界的矩阵乘法, 为了矩阵乘法的高效, 采用自底向上的准则来设计它. 也就是说, 首先需要设计一个充分利用硬件算力的micro kernel, 接着再通过合理调用micro kernel达到极限算力.</p>
<p>首先回顾一下最基础的计算流程, 加载一列M, 加载一行N, 计算得到一块MxN. 此时明显可以发现对于X/Y/Z寄存器池都是没用充分利用的, 特别是Z寄存器池, 这意味着只使用了<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B4%7D">的算力, 所以首要目标是用满它.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx/micro kernel 0.png" class="img-fluid"></p>
<p>根据上一节, 我们可以已知最大理论计算性能以及带宽, 那么根据公式我们可以计算用满ALU时一次计算需要花费多少纳秒: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0ACompute%20Time%20%20&amp;=%20%5Cfrac%7BFLOPs%7D%7BGFLOPS%7D%5C%20~NanoSeconds%5C%5C%0ALoad%20Time%20%20&amp;=%20%5Cfrac%7BBytes%7D%7BGBS%7D%5C%20~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>接下来我们基于这个数据来设计不同的计算策略:</p>
<section id="计算策略1-加载多组n" class="level2">
<h2 class="anchored" data-anchor-id="计算策略1-加载多组n">3.1 计算策略1: 加载多组N</h2>
<p>在我的M2 Pro中, AMX最大一次可以加载<code>4*64</code> bytes, 因此可以加载1组M以及4组的N, 利用满计算单元得到<code>M*4N</code>, 然后在下一次循环中切换不同的K. 总的来说是加载一次, 计算四次, 由于X寄存器池大小限制只能多缓存一次. <img src="https://zhen8838.github.io/posts/mac-amx/micro kernel 1.png" class="img-fluid"></p>
<p>查表可知,加载带宽为254.922 GB/s,得到计算时间与数据加载时间分别为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AFLOPs%20&amp;=%202%20*%20M%20*%20N%20*%204%20=%202048%20%5C%5C%0ACompute%20Time%20&amp;=%20FLOPs%20/%201666%20%20=%201.229~NanoSeconds%20%5C%5C%0ABytes%20&amp;=%20(1%20*%20M%20+%204%20*%20N)%20*%204%20%5C%5C%0ALoad%20Time%20&amp;=%20Bytes%20/%20297.15%20=%201.076~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>两者时间基本差不多, 但他们之间的差只有<code>0.15ns</code>, 这点时间不足以在一次缓存中流水起来.</p>
</section>
<section id="计算策略2-加载多组m" class="level2">
<h2 class="anchored" data-anchor-id="计算策略2-加载多组m">3.2 计算策略2: 加载多组M</h2>
<p>同上一种策略类似, 同样也是加载一次计算四次, 计算时间与加载时间和上一小节类似, 但是这里存在一个额外问题则是对于A矩阵的列方向是不连续的, 需要先通过CPU进行转置4倍的M后才可以加载, 因此不考虑. <img src="https://zhen8838.github.io/posts/mac-amx/micro kernel 2.png" class="img-fluid"></p>
</section>
<section id="计算策略3-加载两组mn" class="level2">
<h2 class="anchored" data-anchor-id="计算策略3-加载两组mn">3.3 计算策略3: 加载两组M/N</h2>
<p>为了均匀X/Y寄存器的存储, 可以考虑加载同样大小的M/N, 也就是加载2组, 此时可以计算4次得到<code>2M*2N</code>大小的输出, 考虑到最大可以加载<code>4*64</code> bytes, 那么可以加载不同K两组M/N, 这样一次加载实际可以计算8次, 最大限度的利用算力. 此时对于X/Y寄存器池使用量是一样的, 也就是他们还可以多缓存一次: <img src="https://zhen8838.github.io/posts/mac-amx/micro kernel 3.png" class="img-fluid"></p>
<p>来动手计算一下,加载带宽为254.922 GB/s,得到计算时间与数据加载时间分别为: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AFLOPs%20&amp;=%202%20*%20M%20*%20N%20*%204%20*%202%20=%204096%20%5C%5C%0ACompute%20Time%20&amp;=%20FLOPs%20/%201666%20%20=%202.458~NanoSeconds%20%5C%5C%0ABytes%20&amp;=%20(4%20*%20M%20+%204%20*%20N)%20*%204%20%5C%5C%0ALoad%20Time%20&amp;=%20Bytes%20/%20476.722%20=%201.074~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>此时计算时间减去数据加载时间为<code>1.384 ns</code>, 大于下一次的计算时间<code>1.074 ns</code>, 那么也就表明我们可以在下一次缓存中完美的流水起来, 从而发挥出极限算力.</p>
</section>
<section id="验证计算策略3" class="level2">
<h2 class="anchored" data-anchor-id="验证计算策略3">3.4 验证计算策略3</h2>
<p>为了达到峰值的数据加载性能, 我们需要对矩阵进行布局优化, 也就是将A/B矩阵分别以32为宽度进行pack, 这样加载时是满足内存连续读取, 同时一次可以计算得到<code>2*M*N</code>的结果, 其具体迭代流程图如下: <img src="https://zhen8838.github.io/posts/mac-amx/micro kernel 3 detail.png" class="img-fluid"></p>
<p>为了简单起见我假设M/K/N都满足最小计算单元的倍数, 同时要求输入A/B矩阵都是经过布局优化的, 下面则是具体的代码:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> LoadC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> StoreC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> gepdot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curN<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> packedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> packedB<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb4-4">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"not support k%4!=0"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-6"></span>
<span id="cb4-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>LoadC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load acc value.</span></span>
<span id="cb4-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-11">        AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-12">            ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-13">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-15">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-16"></span>
<span id="cb4-17">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> curK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load [m0,k0], [m1,k0], [m0,k1], [m1,k1]</span></span>
<span id="cb4-20">      AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-21">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>packedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-22">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load [n0,k0], [n1,k0], [n0,k1], [n1,k1]</span></span>
<span id="cb4-23">      AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-24">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>packedB<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-25">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compute 8 times.</span></span>
<span id="cb4-26">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [[m0,n0],[m0,n1],</span></span>
<span id="cb4-27">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//  [m1,n0],[m1,n1]]</span></span>
<span id="cb4-28">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ik<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> fma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> fma32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>skip_z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> fma32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-31">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-32">            AMX_FMA32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>fma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-33">                          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-34">                          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-35">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-37">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-39">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-40"></span>
<span id="cb4-41">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// last time need store C.</span></span>
<span id="cb4-42">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StoreC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-44">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-45">        AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-46">            ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-47">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-49">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-50"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>在<code>M = 16 * 2, K = 8192, N = 16 * 2</code>的情况下测试, 得到<code>1632.13 Gflop/s</code>的性能, 达到了峰值性能的<code>0.979%</code>.:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[----------]</span> 1 test from test_amx</span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> RUN      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot</span></span>
<span id="cb5-3">             <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Gflop/s:</span> 1632.13</span>
<span id="cb5-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span>       OK <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1032</span> ms<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[----------]</span> 1 test from test_amx <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1032</span> ms total<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
</section>
</section>
<section id="设计分块方案" class="level1">
<h1>4. 设计分块方案</h1>
<p>如果在没有AI Compiler提前优化的情况下, 我们是没办法得到内存优化好的输入数据的, 那么就需要考虑计算的同时进行布局优化. 并且上一节的例子中我没有设置很大的M和N, 而现实中需要切换M与N, 此时又带来另一个分块大小的问题.</p>
<p>如果是使用SIMD来进行计算, 那么论文<a href="https://dl.acm.org/doi/10.1145/1356052.1356053">Anatomy of High-Performance Matrix Multiplication</a>中已经给出了一个很好的分块解决方案:</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx/goto blas.png" class="img-fluid"></p>
<p>即最内层使用<code>gebp</code>核. 但是<code>gebp</code>它需要反复的加载和存储C矩阵, 对于CPU寄存器来说他的带宽足够大, 只需要Nr远大于Kc就可以均摊掉访问C矩阵的内存开销, 对于AMX来说Z寄存器的带宽只有X/Y寄存器带宽的几十分之一, 显然是无法均摊的, 因此我们肯定不能采用论文中的计算方法: <img src="https://zhen8838.github.io/posts/mac-amx/gebp.png" class="img-fluid"></p>
<p>因此我这里抛砖引玉, 实现了一个简易的两级分块策略, M中循环N用于复用A矩阵, 把K迭代放在循环最内层以适配<code>gepdot</code>核, 同时在每个KTile中pack一小块A并缓存起来, 这样循环N时可以避免重复执行:</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx/gepdot general.png" class="img-fluid"></p>
<p>最终代码如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> matmul <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> PackedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> NTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-6">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-7">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// each time pack local innertile.</span></span>
<span id="cb6-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-9">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-11">              PackedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb6-12">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-13">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-15">        gepdot_general<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> mo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> no<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-16">                                        PackedA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-17">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-19">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>测试性能达到了Apple所提供库的70%性能:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> RUN      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot_general</span></span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gepdot</span> general   Gflop/s: 998.291</span>
<span id="cb7-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cblas_sgemm</span>      Gflop/s: 1398.95</span>
<span id="cb7-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span>       OK <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot_general</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">582</span> ms<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>其实计算策略3中是计算瓶颈的, 按理论值计算流水之后实际大约还剩<code>0.3ns</code>时间可以分配给数据加载, 如果可以很好的建模CPU内存操作耗时, 理论上是可以做到把pack A矩阵的过程掩盖起来, 从而达到理论峰值. 不过从cblas_sgemm的实测性能来看, 应该也没有完全掩藏起来, 超越Apple闭源库这个具有挑战性的任务就交给读者们了👻.</p>
</section>
<section id="疑问" class="level1">
<h1>5. 疑问</h1>
<p>我设计了一个测试AMX加载数据是否会更新cache的用例:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 65536 是cache size */</span></span>
<span id="cb8-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb8-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb8-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-5"></span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-9">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb8-10">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-15">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb8-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-18"></span>
<span id="cb8-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-21">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb8-22">        ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)(</span>C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)));</span></span>
<span id="cb8-23">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>其中func1永远只加载同一个位置的数据, func2按顺序加载连续的数据, func3每次加载跨度大于l1 cache size的数据, 最终结果如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func1:</span> 29.9743 GB/s</span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func2:</span> 219.201 GB/s</span>
<span id="cb9-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func3:</span> 9.74711 GB/s</span></code></pre></div></div>
<p>func2与func3的结果表示l1 cache对于AMX来说也是重要的, 但是我无法理解func1与func2的差异, 理论上被访问过的数据应该会缓存在cache中, 而从结果上来看被缓存的似乎是当前所加载地址后面部分的数据, 这个问题可能需要更了解体系结构的读者才能解答.</p>
</section>
<section id="总结" class="level1">
<h1>6. 总结</h1>
<p>至此本文所有的内容介绍完毕, 我所使用的全部测试代码在<a href="https://github.com/zhen8838/leetcode/blob/main/meta_program/test_amx.cpp">这里获取</a>(Verified on M2 Pro). 而本文所依赖的信息来源于Peter Cawley等人的<a href="https://github.com/corsix/amx">逆向成果</a>, 其中包含了更多指令介绍以及使用方法.</p>


</section>

 ]]></description>
  <category>体系结构</category>
  <guid>https://zhen8838.github.io/posts/mac-amx.html</guid>
  <pubDate>Tue, 23 Apr 2024 10:17:49 GMT</pubDate>
</item>
<item>
  <title>Explore AMX instructions: Unlock the performance of Apple Silicon</title>
  <link>https://zhen8838.github.io/posts/mac-amx_en.html</link>
  <description><![CDATA[ 




<p>Since 2020, Apple has published M1/M2/M3. They have at least four different ways to perform high-intensity computing tasks.</p>
<ol type="1">
<li><p>Standard arm NEON instructions.</p></li>
<li><p>Undocumented AMX (Apple Matrix Co-processor) instructions. Issued by the CPU and performed on the co-processor.</p></li>
<li><p>Apple Neural Engine</p></li>
<li><p>Metal GPU</p></li>
</ol>
<p>If we use ARM NEON instructions to accelerate the sgemm kernel on the single core of the M1 Max, It can achieve a <a href="https://github.com/pigirons/conv3x3_m1">performance of around 102 GFLOPS</a>. But if use AMX instructions it can <a href="https://github.com/corsix/amx/blob/main/fma.md#performance-m1-max">achieve 1475 GFLOPS</a>!</p>
<p>In this article, I will introduce how you can leverage the AMX instructions to unlock the potential performance of Apple Silicon. And the all code I used in <a href="https://github.com/zhen8838/leetcode/blob/main/meta_program/test_amx.cpp">here</a> (Verified on M2 Pro). This article refers to the <a href="https://github.com/corsix/amx">work of Peter Cawley et al</a>, which contains more instructions and usage methods.</p>
<!--more-->
<section id="overview" class="level1">
<h1>1. Overview</h1>
<p>A good one-image summary of AMX is the following figure from abandoned patent US20180074824A1. Consider a 32x32 grid of compute units, where each unit can perform 16-bit multiply-accumulate, or a 2x2 subgrid of units can perform 32-bit multiply-accumulate, or a 4x4 subgrid can perform 64-bit multiply-accumulate. To feed this grid, there is a pool of X registers each containing 32 16-bit elements (or 16 32-bit elements, or 8 64-bit elements) and a pool of Y registers similarly containing 32 16-bit elements (or 16 32-bit elements, or 8 64-bit elements). A single instruction can perform a full outer product: multiply every element of an X register with every element of a Y register, and accumulate with the Z element in the corresponding position.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/fig2.png" class="img-fluid figure-img"></p>
<figcaption>abandoned patent US20180074824A1</figcaption>
</figure>
</div>
<p>AMX provides LDX/LDY, FMA, LDZ/SDZ instructions. Where FMA has Matrix Mode and Vector Mode corresponding to outer product and inner product computation methods. The following two diagrams illustrate how the inner and outer products are calculated:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/inner product.png" class="img-fluid figure-img"></p>
<figcaption>inner product</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/outer product.png" class="img-fluid figure-img"></p>
<figcaption>outer product</figcaption>
</figure>
</div>
<p>According to the diagrams, we know that the outer product has more hardware parallelism than the inner product.</p>
</section>
<section id="minimum-workflow" class="level1">
<h1>2. Minimum Workflow</h1>
<p>We also use one-image to explain the minimum calculation process and register specifications in AMX.</p>
<p>First, the X/Y register pool, each of them has 8 registers with a width of 64 bytes, can store data of type fp16/32/64 or i8/16/32, u8/16/32. Then there is the Z register pool, which has 64 registers with a width of 64 bytes, used to store the result of the outer product or inner product of the X/Y registers.</p>
<p>According to the description in the first section, the 2x2 cell subgrid performs 32-bit product, so 16 registers are required to perform the outer product, so the 64 registers are divided into 16 groups, and the interval of each group is 4 (64/16), that is, the outer product results are not stored continuously by register. (⚠️ AMX only supports loading and storage from main memory, and cannot be loaded and stored through general purpose registers/vector registers)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/workflow.png" class="img-fluid figure-img"></p>
<figcaption>minimum workflow</figcaption>
</figure>
</div>
<p>We can obtain a partial sum stored in the Z register pool through the outer product execution, and then we can switch the K dimension(matmul’s reduction dimension) to accumulate the partial sum to get the complete result.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/workflow switch k.png" class="img-fluid figure-img"></p>
<figcaption>switch reduction dimension</figcaption>
</figure>
</div>
<p>Reload the tile from A/B matrices of different K dimensions and then accumulate results to the same Z register group.</p>
<p>Or iterate the M/N dimension. In this example, we keep M unchanged and iterate to the next N. Meanwhile, we need to choose another group in the Z register pool to store the partial sum of the current M/N.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/workflow switch n.png" class="img-fluid figure-img"></p>
<figcaption>switch n dimension</figcaption>
</figure>
</div>
</section>
<section id="theoretical-performance-metrics" class="level1">
<h1>3. Theoretical Performance Metrics</h1>
<p>In order to make good use of AMX, we must first understand the relevant metrics of AMX. So I have designed several tests to verify the theoretical performance metrics.</p>
<section id="computation-performance" class="level2">
<h2 class="anchored" data-anchor-id="computation-performance">3.1 Computation Performance</h2>
<p>From the previous section, we clearly know that the Z register group is divided into 16 groups in float32 datatype, and a computation results in a column in each group, so the ALU is actually divided into 4 groups. Here is to verify the peak performance of different ALU number enabled:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>z_nums<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matfp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>dtype_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matfp_dtype_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>f32f32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-6">  AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-8">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-10">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z_nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-12">    AMX_MATFP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>The results as following:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>ALU Nums</th>
<th>Gflop/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>405.530</td>
</tr>
<tr class="even">
<td>2</td>
<td>826.912</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1244.570</td>
</tr>
<tr class="even">
<td>4</td>
<td>1666.952</td>
</tr>
</tbody>
</table>
<p>This shows that although each group of ALUs is individually configured and emitted, but they can be executed in parallel.</p>
</section>
<section id="load-performance" class="level2">
<h2 class="anchored" data-anchor-id="load-performance">3.2 Load Performance</h2>
<p>Here is the load performance test case I designed, where <code>reg nums</code> represents the whether to load data into the X and Y register at the same time. <code>near</code> indicates whether to read consecutive addresses in memory. In M2 Pro, the l1 Dcache size is <code>65536</code>, so <code>K</code> is designed larger than the l1 Dcache size. When <code>near == 0</code>, it needs to cross double cache size to load data. <code>width</code> indicates the number of registers used to read at once, The maximum number is 4 in M2.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb2-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb2-4">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>reg_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>y_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-8">    ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-10">    ldx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-13">      ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-15">      ldy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"></span>
<span id="cb2-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-20">      AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-21">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-22">        AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-23">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-27">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-28">        AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>reg_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-30">          AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb2-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-32">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-34">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>After running this test, we have collected load performance metrics table:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Reg Nums</th>
<th>Near</th>
<th>X Width</th>
<th>Y Width</th>
<th>GB/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>87.1489</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>213.164</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>4</td>
<td>0</td>
<td>456.332</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>120.796</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>260.115</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>483.285</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>134.33</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>162.084</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>297.15</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>201.658</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>214.772</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>350.554</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>384.614</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>4</td>
<td>2</td>
<td>349.528</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>4</td>
<td>4</td>
<td>476.722</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>130.604</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>163.91</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>1</td>
<td>4</td>
<td>254.922</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>195.612</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>213.61</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>2</td>
<td>4</td>
<td>298.603</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>4</td>
<td>1</td>
<td>310.308</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>4</td>
<td>2</td>
<td>302.767</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>4</td>
<td>4</td>
<td>325.193</td>
</tr>
</tbody>
</table>
<p>We can get some analysis from the table above. 1. increasing the <code>width</code> can double the bandwidth, so this is a free lunch. 2. consecutive reads is fast than non-consecutive reads, indicating we should optimize the data layout. 3. loading two registers and loading two groups in same register pool at the same time also not result in bandwidth reduction, indicating that the A/B matrix can be loaded at the same time.</p>
</section>
<section id="store-performance" class="level2">
<h2 class="anchored" data-anchor-id="store-performance">3.3 Store Performance</h2>
<p>Same like above, in store performance test also has <code>reg_num</code>,<code>near</code>,<code>width</code> options. But notice that the <code>STZ</code> instruction will store 16 groups from the Z register pool at the same time.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb3-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb3-4">perf_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>near<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>z_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> ldst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb3-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> z_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-8">      AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-9">                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>near <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> CNear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width</span>
<span id="cb3-10">                              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb3-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-12">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>Result:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Reg Nums</th>
<th>Near</th>
<th>Width</th>
<th>GB/s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>1</td>
<td>10.3769</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>2</td>
<td>8.93052</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>1</td>
<td>12.9423</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>2</td>
<td>12.3377</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>5.69731</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>2</td>
<td>12.3658</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>1</td>
<td>7.55092</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>2</td>
<td>13.0133</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>1</td>
<td>6.58085</td>
</tr>
<tr class="even">
<td>3</td>
<td>0</td>
<td>1</td>
<td>11.4118</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1</td>
<td>1</td>
<td>8.8847</td>
</tr>
<tr class="even">
<td>4</td>
<td>0</td>
<td>1</td>
<td>9.85956</td>
</tr>
</tbody>
</table>
<p>It can be found that using multiple registers does not increase bandwidth, indicating that it is basically a serial store, but twice the width can still effectively increase bandwidth. However, the overall speed is several times slower than computing and loading, indicating that we cannot load and store Z frequently.</p>
</section>
</section>
<section id="design-micro-kernel" class="level1">
<h1>4. Design Micro Kernel</h1>
<p>Based on the previous section’s observation, we can trying to build the sgemm kernel. For efficiency, we design it according to the bottom-up principle. First we need to design a micro kernel that makes full use of the hardware’s computing performance, then call the micro kernel in blocks to ensure the overall performance.</p>
<p>Review the most basic calculation process, load a column of M, load a row of N, and calculate a piece of MxN. it is obvious that the X/Y/Z register pool is not fully filled, especially the Z register pool, which means that only <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B4%7D"> is used, so the first goal is to use it up.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/micro kernel 0.png" class="img-fluid"></p>
<p>From the previous section, we know the maximum theoretical computational performance and bandwidth, so according to the formula we can calculate how many nanoseconds are needed for computation and loading.: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0ACompute%20Time%20%20&amp;=%20%5Cfrac%7BFLOPs%7D%7BGFLOPS%7D%5C%20~NanoSeconds%5C%5C%0ALoad%20Time%20%20&amp;=%20%5Cfrac%7BBytes%7D%7BGBS%7D%5C%20~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>Next we design different calculation strategies based on the performance data and formulas.</p>
<section id="strategy-1-load-1m-and-4n" class="level2">
<h2 class="anchored" data-anchor-id="strategy-1-load-1m-and-4n">4.1 Strategy 1: Load 1M and 4N</h2>
<p>In my M2 Pro, AMX can load up to <code>4 * 64</code> bytes at a time, so it can load <code>1</code> group of M and <code>4</code> groups of N, and use the full 4 ALU for to get <code>M * 4N</code>, and then switch different K in the next loop. In total, it is loaded once and calculated 4 times, and can only be cached once more due to the size limit of the X register pool.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/micro kernel 1.png" class="img-fluid"></p>
<p>Looking up the table, we can see that the loading bandwidth is 297.15 GB/s, and the compute time and load time are respectively: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AFLOPs%20&amp;=%202%20*%20M%20*%20N%20*%20ALU%20=%202%20*%2016%20*%2016%20*%204%20=%202048%20%5C%5C%0ACompute%20Time%20&amp;=%20FLOPs%20/%201666%20%20=%201.229~NanoSeconds%20%5C%5C%0ABytes%20&amp;=%20(1%20*%20M%20+%204%20*%20N)%20*%204%20=%20320%20%5C%5C%0ALoad%20Time%20&amp;=%20Bytes%20/%20297.15%20=%201.076~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>The difference between they times is only <code>0.15</code>ns, which is not enough to load the data required for the next loop, causing the ALU to fail to working continuously.</p>
</section>
<section id="strategy-2-load-4m-and-1n" class="level2">
<h2 class="anchored" data-anchor-id="strategy-2-load-4m-and-1n">4.2 Strategy 2: Load 4M and 1N</h2>
<p>Similar to the previous strategy, but there is an additional problem here that the column direction of the A matrix is non-contiguous, and it needs to be transposed <code>4</code> times M by the CPU before loading, so it is not considered.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/micro kernel 2.png" class="img-fluid"></p>
</section>
<section id="strategy-3-load-2m-and-2n" class="level2">
<h2 class="anchored" data-anchor-id="strategy-3-load-2m-and-2n">4.3 Strategy 3: Load 2M and 2N</h2>
<p>In order to balance the storage usage of X/Y registers, we consider loading M/N of the same size, that is, loading 2 groups. We can calculate <code>4</code> times to get the <code>2M * 2N</code> output.</p>
<p>In my M2 Pro, the maximum loaded data is <code>4 * 64</code> bytesat a time, so if load 2M and 2N of two different K, it means that can actually be calculated <code>8</code> times, maximizing the utilization of ALU. And we can prepare the next loop’s input data in a free space of the X/Y register pools.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/micro kernel 3.png" class="img-fluid"></p>
<p>Look up the table and get a bandwidth of 476.722 GB/s, which is taken into the formula to calculate: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AFLOPs%20&amp;=%202%20*%20M%20*%20N%20*%204%20*%202%20=%204096%20%5C%5C%0ACompute%20Time%20&amp;=%20FLOPs%20/%201666%20%20=%202.458~NanoSeconds%20%5C%5C%0ABytes%20&amp;=%20(4%20*%20M%20+%204%20*%20N)%20*%204%20%5C%5C%0ALoad%20Time%20&amp;=%20Bytes%20/%20476.722%20=%201.074~NanoSeconds%0A%5Cend%7Baligned%7D%0A"></p>
<p>The compute time minus the load time is <code>1.384</code> ns, which is greater than the next load time of <code>1.074</code> ns, indicating that we can perfectly stream the computation, thus exerting the maximum computing performance.</p>
</section>
<section id="verify-strategy-3" class="level2">
<h2 class="anchored" data-anchor-id="verify-strategy-3">4.4 Verify Strategy 3</h2>
<p>In order to achieve peak data loading performance, we need to optimize the layout of the matrix, that is, pack the A/B matrix with a width of 32, so that the loading is satisfied with contiguous memory reading, and the result of <code>2 * M * N</code> can be calculated at one time. The specific iteration flowchart is as follows:</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/micro kernel 3 detail.png" class="img-fluid"></p>
<p>For the simplicity, I assume that M/K/N are multiples of the smallest computing unit, and the input A/B matrix is required to be optimized for layout. Here is the code:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> LoadC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> StoreC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> gepdot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> curN<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> packedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> packedB<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb4-4">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"not support k%4!=0"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-6"></span>
<span id="cb4-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>LoadC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load acc value.</span></span>
<span id="cb4-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-11">        AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-12">            ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-13">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-15">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-16"></span>
<span id="cb4-17">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> curK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load [m0,k0], [m1,k0], [m0,k1], [m1,k1]</span></span>
<span id="cb4-20">      AMX_LDY<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-21">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>packedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-22">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// load [n0,k0], [n1,k0], [n0,k1], [n1,k1]</span></span>
<span id="cb4-23">      AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple_four<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-24">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>packedB<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-25">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compute 8 times.</span></span>
<span id="cb4-26">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [[m0,n0],[m0,n1],</span></span>
<span id="cb4-27">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//  [m1,n0],[m1,n1]]</span></span>
<span id="cb4-28">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ik<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> fma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> fma32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>skip_z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> fma32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-31">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-32">            AMX_FMA32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>fma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>z_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-33">                          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-34">                          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x_offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>ik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-35">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-37">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-39">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-40"></span>
<span id="cb4-41">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// last time need store C.</span></span>
<span id="cb4-42">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StoreC<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> om<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-44">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-45">        AMX_STZ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb4-46">            ldstz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb4-47">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-49">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-50"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>Tested under the conditions of <code>M = 16 * 2, K = 8192, N = 16 * 2</code>, we obtained <code>1632.13 Gflop/s</code> performance, reaching <code>97.9%</code> of the peak performance.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[----------]</span> 1 test from test_amx</span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> RUN      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot</span></span>
<span id="cb5-3">             <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Gflop/s:</span> 1632.13</span>
<span id="cb5-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span>       OK <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1032</span> ms<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[----------]</span> 1 test from test_amx <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1032</span> ms total<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
</section>
</section>
<section id="design-online-packing-scheme" class="level1">
<h1>5. Design Online Packing Scheme</h1>
<p>If the layout of the input data is not optimized, then it is necessary to perform packing while considering the calculation. And in the example in the previous section, I did not set a large M and N, but in reality, I need to switch M and N, which brings another tiling size problem.</p>
<p>If we are using SIMD instructions for calculation, then a good online packing solution has been proposed in the paper <a href="https://dl.acm.org/doi/10.1145/1356052.1356053">Anatomy of High-Performance Matrix Multiplication</a>:</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/goto blas.png" class="img-fluid"></p>
<p>this paper choose the <code>GEBP</code> as micro kernel, However, <code>GEBP</code> requires repeated load and store of the C matrix. For CPU general purpose registers, its bandwidth is large enough. As long as <code>Nr</code> is much larger than <code>Kc</code>, the memory overhead of accessing the C matrix can be averaged.</p>
<p>But for AMX instructions, the bandwidth of the Z registers is only a few tenths of the bandwidth of the X/Y register, which obviously cannot be averaged. Therefore, we have to design a new method.</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/gebp.png" class="img-fluid"></p>
<p>So I have implemented a simple two-level tiling strategy here. The loop <code>N</code> in <code>M</code> is used to reuse the A matrix, and the <code>K</code> dimension is placed in the innermost layer of the loop to fit the <code>gepdot</code> kernel.</p>
<p>At the same time, a small piece of <code>A</code> is packed in each <code>KTile</code> and cached, so that recompute can be avoided when looping <code>N</code>:</p>
<p><img src="https://zhen8838.github.io/posts/mac-amx_en/gepdot general.png" class="img-fluid"></p>
<p>final code:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> matmul <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> PackedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> NTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-6">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-7">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// each time pack local innertile.</span></span>
<span id="cb6-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>no <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-9">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> MTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-11">              PackedA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb6-12">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-13">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-15">        gepdot_general<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>KTile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ko <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> KTile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> mo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> no<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-16">                                        PackedA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ko<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-17">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-19">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></div>
<p>The test performance achieved 70% of the performance of the libraries provided by Apple CBlas:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> RUN      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot_general</span></span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gepdot</span> general   Gflop/s: 998.291</span>
<span id="cb7-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cblas_sgemm</span>      Gflop/s: 1398.95</span>
<span id="cb7-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span>       OK <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test_amx.test_gepdot_general</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">582</span> ms<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>In fact, the strategy 3 is the bottleneck of the calculation, according to the theoretical performance value of the calculation of the pipeline after the actual remaining about “0.3ns” time can be assigned to the data load. Theoretically it can hidden the A matrix packing overhead, so as to reach the peak performance. So Beyond the Apple closed source library this challenging task to the readers 👻.</p>
</section>
<section id="further-questions" class="level1">
<h1>5. Further Questions</h1>
<p>I have designed a test case to check whether AMX loading data updates the cache:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 65536 是cache size */</span></span>
<span id="cb8-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb8-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{};</span></span>
<span id="cb8-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-5"></span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-9">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb8-10">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-15">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>M<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]));</span></span>
<span id="cb8-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-18"></span>
<span id="cb8-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> func3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-21">    AMX_LDX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb8-22">        ldxy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>register_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>bind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)(</span>C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)));</span></span>
<span id="cb8-23">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>Where <code>func1</code> always loads data at the same location, <code>func2</code> loads consecutive data in sequence, and <code>func3</code> loads data with a stride greater than l1 Dcache size each time. The final result is as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func1:</span> 29.9743 GB/s</span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func2:</span> 219.201 GB/s</span>
<span id="cb9-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">func3:</span> 9.74711 GB/s</span></code></pre></div></div>
<p>The results of <code>func2</code> and <code>func3</code> indicate that the l1 Dcache is also important for AMX, but I can’t understand the difference between <code>func1</code> and <code>func2</code>. Theoretically, the accessed data should be cached in the cache, but from the results, it seems that the cached data is the data behind the current loading address. This question may require readers who know more about the architecture to answer.</p>


</section>

 ]]></description>
  <category>体系结构</category>
  <guid>https://zhen8838.github.io/posts/mac-amx_en.html</guid>
  <pubDate>Tue, 23 Apr 2024 10:17:49 GMT</pubDate>
</item>
<item>
  <title>macos中bundle的使用</title>
  <link>https://zhen8838.github.io/posts/macos-bundle.html</link>
  <description><![CDATA[ 




<p>研究一下在macos中如何编译bundle文件并动态加载并运行.</p>
<!--more-->
<p>使用gcc编译macos程序的时候, 可以通过<code>-bundle</code>选项来指示, 编译出来就是一个包含资源和可执行代码的包. 使用 -bundle 选项时, 还需要指定一个入口点, 通常是 main 函数. 它的好处是使得开发者能够创建动态加载的代码模块, 这些模块可以包含可执行代码和资源, 并且可以被其他应用程序在运行时加载和使用.</p>
<section id="简单例子" class="level2">
<h2 class="anchored" data-anchor-id="简单例子">简单例子</h2>
<p>来自苹果开源库的<a href="https://opensource.apple.com/source/dyld/dyld-852.2/unit-tests/test-cases/">dyld测试例子</a></p>
<p>bundle.c</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdbool.h&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// test to see if bss section is properly expanded </span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> mydata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> checkdata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-10">  printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"check data!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> mydata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>main.c</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;Availability.h&gt;</span></span>
<span id="cb2-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;mach-o/dyld.h&gt;</span></span>
<span id="cb2-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdbool.h&gt;</span></span>
<span id="cb2-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>CheckFunc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)();</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// these APIs are only available on Mac OS X - not iPhone OS</span></span>
<span id="cb2-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#if __MAC_OS_X_VERSION_MIN_REQUIRED</span></span>
<span id="cb2-11">    NSObjectFileImage ofi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>NSCreateObjectFileImageFromFile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test.bundle"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>ofi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span></span>
<span id="cb2-13">        NSObjectFileImageSuccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSCreateObjectFileImageFromFile failed");</span></span>
<span id="cb2-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"></span>
<span id="cb2-18">    NSModule mod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NSLinkModule<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ofi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test.bundle"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NSLINKMODULE_OPTION_NONE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>mod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> NULL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSLinkModule failed");</span></span>
<span id="cb2-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-23"></span>
<span id="cb2-24">    NSSymbol sym <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NSLookupSymbolInModule<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>mod<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_checkdata"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sym <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> NULL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSLookupSymbolInModule failed");</span></span>
<span id="cb2-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-29"></span>
<span id="cb2-30">    CheckFunc func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NSAddressOfSymbol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sym<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSAddressOfSymbol failed");</span></span>
<span id="cb2-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-35"></span>
<span id="cb2-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>NSUnLinkModule<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>mod<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NSUNLINKMODULE_OPTION_NONE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSUnLinkModule failed");</span></span>
<span id="cb2-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-40"></span>
<span id="cb2-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>NSDestroyObjectFileImage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ofi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-42">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// FAIL("NSDestroyObjectFileImage failed");</span></span>
<span id="cb2-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-44">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-45"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif</span></span>
<span id="cb2-46">    printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"funck</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// PASS("bundle-basic");</span></span>
<span id="cb2-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-49"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>执行</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clang</span> bundle.c <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-bundle</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> test.bundle</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clang</span> main.c</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./a.out</span></span></code></pre></div></div>
</section>
<section id="使用cmake" class="level2">
<h2 class="anchored" data-anchor-id="使用cmake">使用cmake</h2>
<p>注意cmake的<code>MACOS_BUNDLE</code>和链接选项的bundle并不是一个东西. 所以用那个选项是无法得到正确的结果的.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cmake_minimum_required</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">VERSION</span> 3.0 FATAL_ERROR<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 设置项目名称和版本</span></span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">project</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test.bundle</span> VERSION 1.0<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 指定 C++ 标准</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set(CMAKE_CXX_STANDARD 11)</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set(CMAKE_CXX_STANDARD_REQUIRED True)</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 添加一个 macOS bundle 可执行文件</span></span>
<span id="cb4-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">add_executable</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test.bundle</span> bundle.c<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb4-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">target_link_options</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">test.bundle</span> PUBLIC <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-bundle</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果有需要，可以链接库</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># target_link_libraries(test.bundle SomeLibrary)</span></span>
<span id="cb4-15"></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 包含 CMake 的 macOS 应用程序 bundle 模块</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># include(CMakeOSXBundleInfo)</span></span></code></pre></div></div>
</section>
<section id="一些问题" class="level2">
<h2 class="anchored" data-anchor-id="一些问题">一些问题</h2>
<section id="link问题" class="level3">
<h3 class="anchored" data-anchor-id="link问题">1. link问题</h3>
<p>我在正式的项目本来是使用<code>nostdlib static</code>来编译的, 然后现在链接选项添加了<code>-bundle</code>后就遇到这个问题:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ld:</span> warning: ignoring <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e,</span> not used for output type</span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0</span>  0x1041d2f2c  __assert_rtn + 72</span>
<span id="cb5-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span>  0x1041a7984  ld::AtomFileConsolidator::addAtomFile<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ld::AtomFile</span> const<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span>, ld::AtomFile const<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span>, bool<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">+</span> 4952</span>
<span id="cb5-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2</span>  0x1041b34e4  ld::AtomFileConsolidator::addAtomFile<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ld::AtomFile</span> const<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">+</span> 148</span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3</span>  0x1041d1430  ld::pass::stubs<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ld::Options</span> const<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> ld::AtomFileConsolidator<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">+</span> 1464</span>
<span id="cb5-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">4</span>  0x1041bad60  ld::AtomFileConsolidator::resolve<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">+</span> 12744</span>
<span id="cb5-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5</span>  0x104142b40  main + 9308</span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ld:</span> Assertion failed: <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">slot</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> _sideTableBuffer.size<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">))</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> function addAtom, file AtomFileConsolidator.cpp, line 2278.</span>
<span id="cb5-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">clang:</span> error: linker command failed with exit code 1 <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">use</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-v</span> to see invocation<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>搜索之后发现是linker升级的原因, 可以通过<code>-ld_classic</code>来避免.</p>
</section>
<section id="全局变量冲突的问题" class="level3">
<h3 class="anchored" data-anchor-id="全局变量冲突的问题">2. 全局变量冲突的问题</h3>
<p>我现在是同时添加多个bundle的模块, 然后调用每个模块中的函数, 目前不同的模板都是存在相同名字的全局变量, 这导致在执行的过程中同一个程序的不同的函数中取到的全局变量的地址是不同的, 从而出现问题. 我改成dylib的形式, 然后使用dlopen去加载函数, 也会出现同样的问题, 所以我怀疑这个问题就是和mac os的底层实现有关. 但是又不能一次只加载一个代码, 这样的话每个kernel启动前都需要load一次可执行文件, 性能就炸了.</p>
<p>尝试使用类似下面这种静态函数的方式来规避全局变量, 发现也不行:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">nncase_runtime_cpu_mt_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">g_cpu_mt</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">nncase_runtime_cpu_mt_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>from<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">nncase_runtime_cpu_mt_t</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">g_mt</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>from <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> NULL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">g_mt</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> from<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">g_mt</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>目前的总结:</p>
<ol type="1">
<li>非extern
<ol type="1">
<li>加static, 两个cpp中的全局变量不是同一个.</li>
<li>不加static, 两个cpp中的会自己定义两次全局变量, 然后编译的过程中报错多重定义.</li>
</ol></li>
<li>extern
<ol type="1">
<li>不论是在哪个cpp里面实现, 加载多个程序之后都会出现冲突.</li>
</ol></li>
<li>同名函数中静态变量, 同样他也会被优化成类似全局变量的形式然后出现混乱.</li>
<li>给全局变量进行编号也无效, 实际上可能是因为实例化出来的c++函数在全局符号表中发生了冲突, 导致kernel0中执行了kernel7的tensor copy.</li>
</ol>


</section>
</section>

 ]]></description>
  <category>操作系统</category>
  <guid>https://zhen8838.github.io/posts/macos-bundle.html</guid>
  <pubDate>Wed, 13 Mar 2024 14:06:19 GMT</pubDate>
</item>
<item>
  <title>Affine Fusion Pass浅析</title>
  <link>https://zhen8838.github.io/posts/affine-fusion.html</link>
  <description><![CDATA[ 




<p>学习<code>mlir</code>中<code>Affine Fusion Pass</code>, 主要关注依赖分析部分.</p>
<!--more-->
<section id="准备工作" class="level1">
<h1>1. 准备工作</h1>
<p>首先我们的待测试的<code>ir</code>为:</p>
<pre class="mlir"><code>module {
  func.func @main(%arg0: memref&lt;8x128x384xf32&gt;, %arg1: memref&lt;8x384x512xf32&gt;, %arg2: memref&lt;8x128x512xf32&gt;, %arg3: memref&lt;8x512x64xf32&gt;, %arg4: memref&lt;8x128x64xf32&gt;) {
    affine.for %arg5 = 0 to 8 {
      affine.for %arg6 = 0 to 128 {
        affine.for %arg7 = 0 to 512 {
          affine.for %arg8 = 0 to 384 {
            %0 = affine.load %arg0[%arg5, %arg6, %arg8] : memref&lt;8x128x384xf32&gt;
            %1 = affine.load %arg1[%arg5, %arg8, %arg7] : memref&lt;8x384x512xf32&gt;
            %2 = affine.load %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;
            %3 = arith.mulf %0, %1 : f32
            %4 = arith.addf %2, %3 : f32
            affine.store %4, %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;
          }
        }
      }
    }
    affine.for %arg5 = 0 to 8 {
      affine.for %arg6 = 0 to 128 {
        affine.for %arg7 = 0 to 64 {
          affine.for %arg8 = 0 to 512 {
            %0 = affine.load %arg2[%arg5, %arg6, %arg8] : memref&lt;8x128x512xf32&gt;
            %1 = affine.load %arg3[%arg5, %arg8, %arg7] : memref&lt;8x512x64xf32&gt;
            %2 = affine.load %arg4[%arg5, %arg6, %arg7] : memref&lt;8x128x64xf32&gt;
            %3 = arith.mulf %0, %1 : f32
            %4 = arith.addf %2, %3 : f32
            affine.store %4, %arg4[%arg5, %arg6, %arg7] : memref&lt;8x128x64xf32&gt;
          }
        }
      }
    }
    return
  }
}</code></pre>
</section>
<section id="performfusionsintodestunsigned-dstid-unsigned-maxsrcusercount" class="level1">
<h1>2. <code>performFusionsIntoDest(unsigned dstId, unsigned maxSrcUserCount)</code></h1>
<ol type="1">
<li><p>进入<code>affine fusion pass</code>之后, 通过<code>dstId</code>在<code>MemRefDependenceGraph</code>中找到<code>producer</code>的<code>affine for</code>节点作为<code>src</code>节点. 在我们的例子中, 显然是融合上下两个循环块.</p></li>
<li><p>通过<code>gatherProducerConsumerMemrefs(srcId, dstId, mdg, producerConsumerMemrefs)</code>收集<code>src</code>节点与<code>dst</code>节点中的存在生产消费链接的<code>store/load</code>.</p></li>
<li><p>通过<code>dstLoopDepthTest = getInnermostCommonLoopDepth(dstMemrefOps)</code>获取<code>dst</code>节点中的内存操作的循环层级, 我们的例子中的循环深度为4.</p></li>
<li><p>遍历目标循环的深度<code>[1, dstLoopDepthTest]</code>通过<code>FusionResult result = affine::canFuseLoops(...) }</code>测试能否将<code>src loop</code>放到<code>dest loop</code>中</p></li>
</ol>
</section>
<section id="affinecanfuseloopssrcaffineforop-dstaffineforop-i-depthsliceunionsi---1-strategy" class="level1">
<h1>3. <code>affine::canFuseLoops(srcAffineForOp, dstAffineForOp, i, &amp;depthSliceUnions[i - 1], strategy)</code></h1>
<p>验证是否可以<code>fusion</code>是一个复杂的过程. 经过一些琐碎的边界条件处理后, 开始执行判断过程.</p>
<ol type="1">
<li><p><code>numCommonLoops = affine::getNumCommonSurroundingLoops(*srcForOp, *dstForOp);</code>检查两个<code>op</code>外围是否存在共同的循环, 目前的例子中并没有.</p></li>
<li><p><code>switch (fusionStrategy.getStrategy())</code>根据不同的策略放入不同的关键路径<code>op</code>, 这里<code>opsA</code>表示producer, <code>opsB</code>表示consumer的.</p></li>
<li><p><code>sliceComputationResult = affine::computeSliceUnion(strategyOpsA, opsB, dstLoopDepth, numCommonLoops, isSrcForOpBeforeDstForOp, srcSlice)</code></p></li>
</ol>
<section id="computesliceunion" class="level2">
<h2 class="anchored" data-anchor-id="computesliceunion">3.1 <code>computeSliceUnion</code></h2>
<p>计算<code>opsA</code>和<code>OpsB</code>在指定循环层级位置计算得到的<code>slice bounds</code>是否满足他们之间的依赖. 首先对于producer来说只有写出是重要的, 因此这里的opsA为<code>affine.store %4, %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;</code>. 对于consumer来说, 读写同样重要, 因此此时的opsB为</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x512xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x512x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-4">affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p>因为我们需要测试前一个执行节点的内存对后面所有的执行的内存的依赖关系, 所以这里是一个全排列组合的测试:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> opsA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    MemRefAccess srcAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> opsB<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-4">      MemRefAccess dstAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-5">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>memref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> dstAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-8">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>如果他们读写的是同一块<code>memref</code>, 那么也就是存在着依赖, 那么就可能存在着潜在的依赖, 需要进行进一步的依赖测试:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> readReadAccesses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isa<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>AffineReadOpInterface<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>srcAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>opInst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span></span>
<span id="cb4-2">                        isa<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>AffineReadOpInterface<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>dstAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>opInst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-3">FlatAffineValueConstraints dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Check dependence between 'srcAccess' and 'dstAccess'.</span></span>
<span id="cb4-5">DependenceResult result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> checkMemrefAccessDependence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 如果操作的是同一个buffer, 那么需要检查依赖 */</span></span>
<span id="cb4-6">    srcAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*loopDepth=*/</span>numCommonLoops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*dependenceComponents=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*allowRAR=*/</span>readReadAccesses<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
</section>
<section id="checkmemrefaccessdependence" class="level2">
<h2 class="anchored" data-anchor-id="checkmemrefaccessdependence">3.2 <code>checkMemrefAccessDependence</code></h2>
<p>此时我们的<code>src/dst</code>分别为:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Checking</span> for dependence at depth: 1 between:</span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mlir-asm-printer:</span> Verifying operation: func.func</span>
<span id="cb5-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">affine.store</span> %4, %arg2[%arg5, %arg6, %arg7] : memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>8x128x512xf32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mlir-asm-printer:</span> Verifying operation: func.func</span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%0</span> = affine.load %arg2[%arg5, %arg6, %arg8] : memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>8x128x512xf32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p>接下来从<code>access</code>中获得对应的<code>access relation</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Create access relation from each MemRefAccess.</span></span>
<span id="cb6-2">FlatAffineRelation srcRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>failed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getAccessRelation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))</span></span>
<span id="cb6-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> DependenceResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Failure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>failed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dstAccess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getAccessRelation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))</span></span>
<span id="cb6-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> DependenceResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Failure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>首先展示srcRel和dstRel的FlatAffineRelation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">srcRel:</span>
<span id="cb7-2">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> constraints</span>
<span id="cb7-4">(Value  Value   Value   Value   <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    const)</span>
<span id="cb7-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-6"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-8"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-9"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-10"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-11"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-12"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-13"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-14"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-15"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">383</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-16">dstRel:</span>
<span id="cb7-17">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-18"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> constraints</span>
<span id="cb7-19">(Value  Value   Value   Value   <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>    const)</span>
<span id="cb7-20"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-21"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-22"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-23"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-24"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-25"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-26"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-27"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-28"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-29"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-30"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div></div>
<p>这里需要先讲解一下mlir中的PresburgerSpace的变量类型<code>enum class VarKind { Symbol, Local, Domain, Range, SetDim = Range };</code>:</p>
<ol type="1">
<li>Symbol, 表示一个固定但是展示未知的值.</li>
<li>Local, 表示的是存在量化变量(existentially quantified variables), 我理解就是farkas引理中的lambda系数, 可以通过约束求解来消除. 考虑这个一个space为<code>(x,exists q)</code>, 约束为<code>1 &lt;= x &lt;= 7, x = 2q</code>, 此时x为维度变量,q为存在量化变量, 即<code>(x) : (exists q : q &lt;= x &lt;= 7, x = 2q)</code>. 此时带入一些值进去, 可以得到满足约束的结果集<code>{(2,1),(4,2),(6,3)}</code></li>
<li>Dimension变量被进一步分为Domain 和 Range变量.</li>
</ol>
<p>在mlir中多面体是和ir深度结合的,比如这里的FlatAffineValueConstraints中是包含了PresburgerSpace以及AffineValue的, 上面输出依赖多面体中的Value列实际上就是一个affine ir的ssa value, 这个例子中其实就是四个迭代变量<code>%arg5,%arg6,%arg7,%arg8</code>. 并且access relation中的<code>numDomainDims</code>和<code>numRangeDims</code>与presburger space中的<code>numDomainVars</code>和<code>numRangeVars</code>并不是一致的. 上面两个约束他们的domainDims和RangeDims分别都是4和3, 但是这些dim对应的变量类型都是<code>SetDim = Range</code>, 所以上面两个relation的Ranges变量个数为<code>4+3=7</code></p>
<p>将两个relation写为isl的形式如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">srcRel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [i0,i1,i2,i3] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> [l0,l1,l2] : </span>
<span id="cb8-2"> i0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-3"> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> </span>
<span id="cb8-4"> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-6"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-8"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span></span>
<span id="cb8-9">dstRel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [j0,j1,j2,j3] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> [l0,l1,l2] : </span>
<span id="cb8-10"> j0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-11"> j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-12"> j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> l2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-13"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-14"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-15"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span></span>
<span id="cb8-16"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span></code></pre></div></div>
<p>这里获得对应的他们对应的domain:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1">FlatAffineValueConstraints srcDomain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> srcRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getDomainSet<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb9-2">FlatAffineValueConstraints dstDomain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getDomainSet<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div></div>
<p>此时srcDomain和dstDomain的约束多面体分别如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">srcDomain:</span>
<span id="cb10-2">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb10-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> constraints</span>
<span id="cb10-4">(Value  Value   Value   Value   Local   Local   Local   const)</span>
<span id="cb10-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-6"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-8"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-9"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-10"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-11"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-12"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-13"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-14"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-15"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">383</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-16"></span>
<span id="cb10-17">dstDomain:</span>
<span id="cb10-18">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb10-19"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> constraints</span>
<span id="cb10-20">(Value  Value   Value   Value   Local   Local   Local   const)</span>
<span id="cb10-21"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-22"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-23"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-24"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-25"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-26"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-27"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-28"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-29"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-30"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-31"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div></div>
<p>实际domain的约束多面体和access relation的多面体并无大的区别, 将一些变量的类型进行了转换, 同时作为一个set他是不存在domain dims和range dims的.</p>
<p>然后组合两个<code>relation</code>, 这里的compose实际上等价<code>srcRel.apply_range(dstRel)</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1">  dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>inverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-2">  dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>compose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// src.domain -&gt; [src.range == dst.domain] -&gt; dst.range</span></span></code></pre></div></div>
<p><code>compose</code>后此时<code>dstRel</code>为:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span> constraints</span>
<span id="cb12-3">(Value  Value   Value   Value   Value   Value   Value   Value   const)</span>
<span id="cb12-4"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-6"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-8"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-9"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-10"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-11"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-12"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-13"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-14"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">383</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-15"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-16"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-17"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-18"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-19"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-20"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-21"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-22"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div></div>
<p>这里的Range为8是因为只存在上下两个循环迭代变量的range变量, 此时的domain dims和range dims均为4, 用isl形式表示应该是:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">{ [i0, i1, i2, i3] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> [j0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i0, j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i1, j2, j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i2] : <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> j3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> }</span></code></pre></div></div>
<p>得到新的<code>dstRel</code>后, 添加顺序约束, 也就是当他们的外侧还存在有共享循环时, 需要添加顺序约束, 目前这个例子中没有共享循环, 所以也不做什么.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add 'src' happens before 'dst' ordering constraints.</span></span>
<span id="cb14-2">addOrderingConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcDomain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstDomain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> loopDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>dstRel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>最终就是检查约束<code>dstRel.isEmpty()</code>, 这里<code>isEmpty</code>检查的是否存在整数解, 也就是在当前order下上面的map约束是否能满足.</p>
</section>
<section id="getcomputationslicestate" class="level2">
<h2 class="anchored" data-anchor-id="getcomputationslicestate">3.3 <code>getComputationSliceState</code></h2>
<p>上面这个case检测到存在依赖, 接下来计算依赖的slice大小:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1">mlir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>getComputationSliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb15-2">    Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>depSourceOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>depSinkOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-3">    FlatAffineValueConstraints <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> loopDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> isBackwardSlice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ComputationSliceState <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>首先这个case传入的参数<code>depSourceOp</code>为前一个块的store, <code>depSinkOp</code>为后一个块的load,<code>dependenceConstraints</code>为上一步计算得到的dst-&gt;src的map, <code>loopDepth</code>为需要合并到的循环深度, 当前为1. <code>isBackwardSlice</code>为true, 因为source op是在sink op前执行的.</p>
<p>因为我们要计算的是插入到<code>loopDepth</code>时的slice大小, 那么第一步则是要删除所有高于<code>loopDepth</code>的维度. 因为是反向依赖, 所以dst loop的var在后面, 因此pos为<code>src loop nums + loopDepth = 5</code>, 然后num为<code>dst loop nums - loopDepth = 3</code> .</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Project out dimensions other than those up to 'loopDepth'.</span></span>
<span id="cb16-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isBackwardSlice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> numSrcLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> loopDepth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> loopDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb16-4">      isBackwardSlice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> numDstLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> loopDepth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> numSrcLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> loopDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-5">  dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>projectOut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>消除不需要的变量后, <code>dependenceConstraints</code>为如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">Domain: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Range: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, Symbols: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Locals: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> constraints</span>
<span id="cb17-3">(Value  Value   Value   Value   Value   const)</span>
<span id="cb17-4"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-6"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-8"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-9"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-10"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-11"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-12"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">383</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-13"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-14"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>       <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div></div>
<p>等价于:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">{ [i0, i1, i2, i3] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> [j0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i0] : <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> i3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">383</span> }</span></code></pre></div></div>
<p>获得循环迭代的SSAValue, 这里因为是backward,因此src变量的起点为0, 总个数在这个例子中为4.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb19-1">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add slice loop IV values to 'sliceState'.</span></span>
<span id="cb19-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isBackwardSlice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> loopDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> numSliceLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isBackwardSlice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> numSrcLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> numDstLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-4">dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getValues<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-5">                                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>ivs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-6"></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Set up lower/upper bound affine maps for the slice.</span></span>
<span id="cb19-8">sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>lbs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> AffineMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-9">sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>ubs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> AffineMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-10"></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Get bounds for slice IVs in terms of other IVs, symbols, and constants.</span></span>
<span id="cb19-12">dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getSliceBounds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-13">                                      depSourceOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getContext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb19-14">                                      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>lbs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>ubs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>更新后<code>sliceState-&gt;ivs</code>中存在了<code>i0,i1,i2,i3</code>四个变量. 同时为slice state的lower bounds 和 upper bounds分配好四个affine map, 并通过ir的连接关系得到这些affine map. <code>getSliceBounds</code>是将从offset开始的前num个维度变量上下界作为剩余变量的map, 也就是说要基于上一步的依赖约束得到基于dst为domain所对应src domain的上下界, 由于上一步中project掉了三个dst的循环变量, 因此bounds map的domain维度为1, 同时因为<code>i0=j0</code>, 因此得到的lower bounds为<code>[(d0) -&gt; (d0), (d0) -&gt; (0), (d0) -&gt; (0), (d0) -&gt; (0)]</code>, upper bounds为<code>[(d0) -&gt; (d0 + 1), (d0) -&gt; (128), (d0) -&gt; (512), (d0) -&gt; (384)]</code>.</p>
<p>接下来获取dst循环的iter var value, 因为这里project out之后所以<code>numDimsAndSymbols</code>, 然后又跳过了<code>offset + numSliceLoopIVs</code>, 因此这里<code>sliceBoundOperands</code>只保留了一个<code>j0</code>. 然后将这个vector再分配给<code>lbOperands, ubOperands</code>. 最好这里的insertPoint就是dst loop在loop depth的位置.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb20-1">  SmallVector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> sliceBoundOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> numDimsAndSymbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getNumDimAndSymbolVars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> numDimsAndSymbols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-5">      sliceBoundOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dependenceConstraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-7">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-8"></span>
<span id="cb20-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Give each bound its own copy of 'sliceBoundOperands' for subsequent</span></span>
<span id="cb20-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// canonicalization.</span></span>
<span id="cb20-11">  sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>lbOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> sliceBoundOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-12">  sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>ubOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>numSliceLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> sliceBoundOperands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-13"></span>
<span id="cb20-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Set destination loop nest insertion point to block start at 'dstLoopDepth'.</span></span>
<span id="cb20-15">  sliceState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>insertPoint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb20-16">      isBackwardSlice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> dstLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>loopDepth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>getBody<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()-&gt;</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb20-17">                      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>loopDepth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>getBody<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()-&gt;</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span></code></pre></div></div>
<p>此时如果不考虑复杂的情况, sliceState就算是更新完毕了. 这里直接回到了canFuseLoops之后.</p>
</section>
</section>
<section id="isfusionprofitable" class="level1">
<h1>4. isFusionProfitable</h1>
<p>前面是遍历了dst循环的四个insert point, 检测在这些循环内能否插入source循环.在我们的这个例子中, 显然四个层级都可以插入source 循环. 那么就需要找到最合适的循环插入位置.</p>
<p>首先获得srcloop的循环变量, 然后拿到是两个循环分析结果.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute cost of sliced and unsliced src loop nest.</span></span>
<span id="cb21-2">  SmallVector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>AffineForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-3">  getAffineForIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>srcOpInst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-4"></span>
<span id="cb21-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Walk src loop nest and collect stats.</span></span>
<span id="cb21-6">  LoopNestStats srcLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>getLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>srcLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb21-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-9"></span>
<span id="cb21-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute cost of dst loop nest.</span></span>
<span id="cb21-11">  LoopNestStats dstLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-12">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>getLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dstForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>dstLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb21-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>然后计算原始src loop的cost, 以及dst loop的cost</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute op instance count for the src loop nest without iteration slicing.</span></span>
<span id="cb22-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> srcLoopNestCost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> srcLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb22-3"></span>
<span id="cb22-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute src loop nest write region size.</span></span>
<span id="cb22-5">  MemRefRegion srcWriteRegion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcStoreOpInst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>getLoc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb22-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>failed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcWriteRegion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>compute<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcStoreOpInst<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*loopDepth=*/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-7">    LLVM_DEBUG<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>llvm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>dbgs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-8">               <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unable to compute MemRefRegion for source operation</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb22-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-10">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-11"></span>
<span id="cb22-12">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> maybeSrcWriteRegionSizeBytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb22-13">      srcWriteRegion<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getRegionSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>maybeSrcWriteRegionSizeBytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb22-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> srcWriteRegionSizeBytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>maybeSrcWriteRegionSizeBytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-17"></span>
<span id="cb22-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute op instance count for the src loop nest.</span></span>
<span id="cb22-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> dstLoopNestCost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dstForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>然后开始固定每一种循环合并方式并计算fusion之后的cost</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> maxLegalFusionDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> ComputationSliceState <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>slice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> depthSliceUnions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb23-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Skip slice union if it wasn't computed for this depth.</span></span>
<span id="cb23-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>isEmpty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb23-5">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-6"></span>
<span id="cb23-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> fusedLoopNestComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>getFusionComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>srcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> srcLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-9">                              dstLoopNestStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-10">                              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>fusedLoopNestComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-11">      LLVM_DEBUG<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>llvm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>dbgs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unable to compute fusion compute cost</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-12">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb23-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb23-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb23-17">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="getfusioncomputecost" class="level1">
<h1>4.1 getFusionComputeCost</h1>
<p>进入基于当前的slice state计算循环次数, 这里<code>slice.ivs</code>包含了src的四个循环迭代变量, 将他们对应的for op作为key, 循环次数作为value.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb24-1">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> mlir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>buildSliceTripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb24-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> ComputationSliceState <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-3">    llvm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>SmallDenseMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> numSrcLoopIVs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ivs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Populate map from AffineForOp -&gt; trip count</span></span>
<span id="cb24-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> numSrcLoopIVs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-7">    AffineForOp forOp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getForInductionVarOwner<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ivs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb24-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>op <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getOperation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-9">    AffineMap lbMap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>lbs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb24-10">    AffineMap ubMap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> slice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ubs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb24-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> tripCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getConstDifference<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lbMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ubMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Slice bounds are created with a constant ub - lb difference.</span></span>
<span id="cb24-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>tripCount<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>has_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb24-14">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>tripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span>op<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tripCount<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-17">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>当前的loop depth为4, 对应ComputationSliceState的lbs和ubs分别为:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">lbs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d0)</span>
<span id="cb25-2">ubs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-3">lbs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d1)</span>
<span id="cb25-4">ubs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-5">lbs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d3)</span>
<span id="cb25-6">ubs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (d3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-7">lbs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-8">ubs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] : (d0, d1, d2, d3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span>)</span></code></pre></div></div>
<p>最终得到tripCountMap中的trip count则分别为<code>1,1,1,384</code>.</p>
<p>使用tripCountMap累乘得到所依赖的slice的循环次数, 当前为<code>384</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb26-1">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> sliceIterationCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getSliceIterationCount<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sliceTripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>最后, 计算当前slice的ComputeCost, 计算好后将cost添加到dst的insert point, 再重新计算dst的compute cost.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb27-1">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute op instance count for the src loop nest with iteration slicing.</span></span>
<span id="cb27-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> sliceComputeCost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getComputeCostHelper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb27-3">      srcForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> srcStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>sliceTripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-4"></span>
<span id="cb27-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute cost of fusion for this depth.</span></span>
<span id="cb27-6">  computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>insertPointParent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sliceComputeCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-7"></span>
<span id="cb27-8">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>computeCost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb27-9">      getComputeCostHelper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dstForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dstStats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-10">                           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*tripCountOverrideMap=*/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></div>
<p>getComputeCostHelper是一个递归+回溯的过程, 首先逐渐递归到最内层循环, 获得当前计算的statement的cost. 假设上一步中<code>computeCostMap[insertPointParent] = 2364</code>, 那么在最内存循环原本的opCount为<code>6</code>, 检测到<code>computeCostMap</code>存在值, 那么累加opCount得到<code>2372</code>, 接下来在逐步累乘tirp count.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb28-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> getComputeCostHelper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb28-2">    Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> LoopNestStats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb28-3">    llvm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>SmallDenseMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tripCountOverrideMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb28-4">    DenseMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Operation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 'opCount' is the total number operations in one iteration of 'forOp' body,</span></span>
<span id="cb28-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// minus terminator op which is a no-op.</span></span>
<span id="cb28-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> opCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>opCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>loopMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> childForOp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>loopMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-10">      opCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> getComputeCostHelper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>childForOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> tripCountOverrideMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb28-11">                                      computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-13">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add in additional op instances from slice (if specified in map).</span></span>
<span id="cb28-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>computeCostMap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>find<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> computeCostMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-18">      opCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-20">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Override trip count (if specified in map).</span></span>
<span id="cb28-22">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int64_t</span> tripCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tripCountMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb28-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tripCountOverrideMap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tripCountOverrideMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>find<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>forOp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> tripCountOverrideMap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-26">      tripCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-27">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-28">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Returns the total number of dynamic instances of operations in loop body.</span></span>
<span id="cb28-30">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> tripCount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> opCount<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="update-bestdstloopdepth" class="level1">
<h1>4.2 Update bestDstLoopDepth</h1>
<p>计算到fuse loop的cost之后, 计算得到fusion后增加的计算比例系数:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb29-1">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> additionalComputeFraction <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb29-2">        fusedLoopNestComputeCost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span></span>
<span id="cb29-3">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>srcLoopNestCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dstLoopNestCost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span></span>
<span id="cb29-4">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>最终打印在每一个层的fuse之后的结果:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb30-1">  evaluating fusion profitability at depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb30-2">   additional compute fraction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5400.00</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb30-3">   storage reduction factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span></span>
<span id="cb30-4">   fused nest cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77510737920</span></span>
<span id="cb30-5">   src write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-6">   slice write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-7"></span>
<span id="cb30-8">  evaluating fusion profitability at depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb30-9">   additional compute fraction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5400.00</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb30-10">   storage reduction factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span></span>
<span id="cb30-11">   fused nest cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77510737920</span></span>
<span id="cb30-12">   src write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-13">   slice write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-14"></span>
<span id="cb30-15">  evaluating fusion profitability at depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb30-16">   additional compute fraction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.00</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb30-17">   storage reduction factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span></span>
<span id="cb30-18">   fused nest cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1409286144</span></span>
<span id="cb30-19">   src write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-20">   slice write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-21"></span>
<span id="cb30-22">  evaluating fusion profitability at depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-23">   additional compute fraction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.00</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb30-24">   storage reduction factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span></span>
<span id="cb30-25">   fused nest cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1409286144</span></span>
<span id="cb30-26">   src write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb30-27">   slice write region size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span></code></pre></div></div>
<p>最终他默认选择在更内层fusion:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb31-1">LoopFusion fusion stats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb31-2">  best loop depth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb31-3">  src loop nest compute cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1207959552</span></span>
<span id="cb31-4">  dst loop nest compute cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">201326592</span></span>
<span id="cb31-5">  fused loop nest compute cost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1409286144</span></span>
<span id="cb31-6">   src mem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9961472</span></span>
<span id="cb31-7">   dst mem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3407872</span></span>
<span id="cb31-8">   fused mem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5505024</span></span>
<span id="cb31-9">   slice mem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2097152</span></span>
<span id="cb31-10"> fusion is most profitable at depth <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> with <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> redundant computation <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> a <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">58.823529</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> storage reduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb31-11">Fused src loop <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> into dst loop <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> at depth <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb31-12"></span>
<span id="cb31-13">affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-14">  affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-15">    affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-16">      affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x384xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x384x512xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x512xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arith<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mulf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32</span>
<span id="cb31-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arith<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>addf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32</span>
<span id="cb31-22">        affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x512xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-23">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-25">    affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-26">      affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x512xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x512x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arith<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mulf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32</span>
<span id="cb31-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arith<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>addf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> f32</span>
<span id="cb31-32">        affine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[%</span>arg5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>arg7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> memref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">x128x64xf32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-33">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-35">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-36"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>affine loop fusion虽然最终的结果并不一定是好的, 因为他这里没有考虑内存层级以及数据复用等因素, 不过把这些内容作为约束多面体最佳使用实践来学习帮助非常大.</p>


</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/affine-fusion.html</guid>
  <pubDate>Thu, 11 Jan 2024 08:00:08 GMT</pubDate>
</item>
<item>
  <title>TileFlow: A Framework for Modeling Fusion Dataflow via Tree-based Analysis</title>
  <link>https://zhen8838.github.io/posts/tile-flow.html</link>
  <description><![CDATA[ 




<p>学习<code>TileFlow</code>这篇论文中是如何进行多个内存层级的<code>tiling</code>.</p>
<!--more-->
<section id="输入格式描述" class="level1">
<h1>1. 输入格式描述</h1>
<p>输入需要如下几个文件, 每个文件描述了不同的内容.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tileflow</span> arch/arch.yaml prob/prob.yaml map/map.yaml macro.yaml </span></code></pre></div></div>
<section id="arch.yaml" class="level2">
<h2 class="anchored" data-anchor-id="arch.yaml">1.1 arch.yaml</h2>
<p>描述了整个芯片的架构层级.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">architecture</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">version</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> System</span></span>
<span id="cb2-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb2-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">local</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MainMemory</span></span>
<span id="cb2-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DRAM </span></span>
<span id="cb2-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">block-size</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16384</span></span>
<span id="cb2-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">word-bits</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.3</span></span>
<span id="cb2-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.9</span></span>
<span id="cb2-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb2-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Buffer </span></span>
<span id="cb2-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb2-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">local</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cache </span></span>
<span id="cb2-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> SRAM</span></span>
<span id="cb2-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">word-bits</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">block_size</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16384</span></span>
<span id="cb2-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb2-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span></span>
<span id="cb2-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # 16 </span></span>
<span id="cb2-29"></span>
<span id="cb2-30"></span>
<span id="cb2-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> PE</span></span>
<span id="cb2-33"></span>
<span id="cb2-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">local</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> RegFile[0..255] </span></span>
<span id="cb2-36"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> regfile</span></span>
<span id="cb2-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meshX</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meshY</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">block_size</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb2-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">word-bits</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span></span>
<span id="cb2-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_bandwidth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span></span>
<span id="cb2-45"></span>
<span id="cb2-46"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> mac[0..255] </span></span>
<span id="cb2-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> intmac </span></span>
<span id="cb2-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb2-49"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">word-bits</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-50"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meshX</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meshY</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span></code></pre></div></div>
</section>
<section id="prob.yaml" class="level2">
<h2 class="anchored" data-anchor-id="prob.yaml">1.2 prob.yaml</h2>
<p>这里其实类似<code>halide</code>, 需要列出所有共享的迭代变量, 然后下面每个算子都是用这些维度来构建. 具体可以<a href="https://timeloop.csail.mit.edu/timeloop/input-formats/problem">参考这里</a>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">problem</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">io</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ins</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> A, B, D</span></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outs</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> E</span></span>
<span id="cb3-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dimensions</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">N</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">instance</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M </span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">N</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">N</span></span>
<span id="cb3-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> L</span></span>
<span id="cb3-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">K</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> K</span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ops</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GEMM1</span></span>
<span id="cb3-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dimensions</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data-spaces</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> C </span></span>
<span id="cb3-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read-write</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">True</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> A </span></span>
<span id="cb3-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> B</span></span>
<span id="cb3-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ins</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> A, B</span></span>
<span id="cb3-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">out</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> C</span></span>
<span id="cb3-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GEMM2 </span></span>
<span id="cb3-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dimensions</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">N</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb3-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data-spaces</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> E </span></span>
<span id="cb3-36"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">N</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read-write</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">True</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> C</span></span>
<span id="cb3-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">M</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> D </span></span>
<span id="cb3-45"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">projection</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-46"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">L</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">N</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span></span>
<span id="cb3-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ins</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> C, D</span></span>
<span id="cb3-49"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">out</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> E </span></span></code></pre></div></div>
<p>对应的计算如下所示:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb4-2">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb4-3">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> </span>
<span id="cb4-4">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb4-5">C[M,L] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A[M,K] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> B[K,L]</span>
<span id="cb4-6">E[M,N] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[M,L] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> D[L,N]</span></code></pre></div></div>
</section>
<section id="map.yaml" class="level2">
<h2 class="anchored" data-anchor-id="map.yaml">1.3 map.yaml</h2>
<p>map是一个比较重要的配置, 这里重点说明一下. <code>type</code>分为temporal表示顺序执行和spatial表示并行执行. <code>factors: M = MO N = NO K= KO</code>表示它将M/N/K维度分别分为MO/NO/KO块.<code>permutation: NMK</code>表示循环从内到外分别为<code>NMK</code>. 这里的<code>factors: M=MM K=KM N=NI</code>表示再次切分这里的三个维度. <code>multicast: true</code>表示多播. <code>split: 1</code>表示映射到硬件xy.</p>
<p>原始文档<a href="https://timeloop.csail.mit.edu/timeloop/input-formats/mapping">参考这里</a>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapping</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=MO </span></span>
<span id="cb5-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MainMemory </span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Scope </span></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Sequential </span></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> K=KO L=LO</span></span>
<span id="cb5-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bypass</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">C</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb5-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MainMemory</span></span>
<span id="cb5-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">profile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb5-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op1</span></span>
<span id="cb5-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> K=KM L=LI M=MM</span></span>
<span id="cb5-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> LMK</span></span>
<span id="cb5-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cache </span></span>
<span id="cb5-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op1 </span></span>
<span id="cb5-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb5-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile</span></span>
<span id="cb5-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Spatial </span></span>
<span id="cb5-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=SX K=SY</span></span>
<span id="cb5-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MK</span></span>
<span id="cb5-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cache</span></span>
<span id="cb5-36"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op1 </span></span>
<span id="cb5-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span></span>
<span id="cb5-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal  </span></span>
<span id="cb5-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=1 L=1 K=1</span></span>
<span id="cb5-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MLK </span></span>
<span id="cb5-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> RegFile</span></span>
<span id="cb5-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op1 </span></span>
<span id="cb5-45"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span></span>
<span id="cb5-46"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Op</span></span>
<span id="cb5-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">              </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GEMM1 </span></span>
<span id="cb5-49"></span>
<span id="cb5-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # A common spatial tile</span></span>
<span id="cb5-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile</span></span>
<span id="cb5-52"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-53"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> L=LO N=NO</span></span>
<span id="cb5-54"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MainMemory</span></span>
<span id="cb5-55"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">profile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb5-56"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bypass</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">C</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb5-57"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op2</span></span>
<span id="cb5-58"></span>
<span id="cb5-59"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-60"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-61"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-62"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=MM L=LM N=NI</span></span>
<span id="cb5-63"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> NML </span></span>
<span id="cb5-64"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cache</span></span>
<span id="cb5-65"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op2</span></span>
<span id="cb5-66"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb5-67"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-68"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile</span></span>
<span id="cb5-69"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Spatial </span></span>
<span id="cb5-70"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=SX L=SY</span></span>
<span id="cb5-71"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-72"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ML</span></span>
<span id="cb5-73"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cache</span></span>
<span id="cb5-74"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op2</span></span>
<span id="cb5-75"></span>
<span id="cb5-76"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-77"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Tile </span></span>
<span id="cb5-78"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> temporal </span></span>
<span id="cb5-79"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factors</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> M=1 L=1 N=1 </span></span>
<span id="cb5-80"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permutation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> MLN </span></span>
<span id="cb5-81"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> RegFile</span></span>
<span id="cb5-82"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> op2</span></span>
<span id="cb5-83"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span></span>
<span id="cb5-84"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtree</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb5-85"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">            </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node-type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Op</span></span>
<span id="cb5-86"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">              </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GEMM2</span></span></code></pre></div></div>
<p>之前tile flow, 可以得到初始化时的一些关键信息:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-----------------</span>Mapping<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---------------</span></span>
<span id="cb6-2">root: <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xa23020</span></span>
<span id="cb6-3">read: A B E D update: E </span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MO), MainMemory</span>
<span id="cb6-5">  read: A B E D update: E fill: A B E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-6">  Scope: Sequential{</span>
<span id="cb6-7">    read: A B fill: A B </span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:KO), MainMemory</span>
<span id="cb6-9">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LO), MainMemory</span>
<span id="cb6-10">        read: C A B update: C fill: A B </span>
<span id="cb6-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:KM), Cache</span>
<span id="cb6-12">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MM), Cache</span>
<span id="cb6-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LI), Cache</span>
<span id="cb6-14">              read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb6-15">              <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Y), Cache</span>
<span id="cb6-16">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X), Cache</span>
<span id="cb6-17">                  read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb6-18">                  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-19">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-20">                      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-21">                        read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb6-22">                        Op: GEMM1(A,B,)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>C</span>
<span id="cb6-23"></span>
<span id="cb6-24">    read: E D update: E fill: E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LO), MainMemory</span>
<span id="cb6-26">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:NO), MainMemory</span>
<span id="cb6-27">        read: C E D update: E fill: E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LM), Cache</span>
<span id="cb6-29">          <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MM), Cache</span>
<span id="cb6-30">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:NI), Cache</span>
<span id="cb6-31">              read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-32">              <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Y), Cache</span>
<span id="cb6-33">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X), Cache</span>
<span id="cb6-34">                  read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-35">                  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-36">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-37">                      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb6-38">                        read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb6-39">                        Op: GEMM2(C,D,)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>E</span>
<span id="cb6-40"></span>
<span id="cb6-41">  }</span>
<span id="cb6-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---------------------------------------</span></span>
<span id="cb6-43">constraints:</span>
<span id="cb6-44">        KO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>KM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim K</span></span>
<span id="cb6-45">        LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim L</span></span>
<span id="cb6-46">        MO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim M</span></span>
<span id="cb6-47">        LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim L</span></span>
<span id="cb6-48">        MO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim M</span></span>
<span id="cb6-49">        NO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>NI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loopcount constraint for tiling of dim N</span></span>
<span id="cb6-50">        (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory constraint at Tile::op1::RegFile::Temporal</span></span>
<span id="cb6-51">        (Max(MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>KM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>KM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">131072</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory constraint at Tile::op1::Cache::Temporal</span></span>
<span id="cb6-52">        (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory constraint at Tile::op2::RegFile::Temporal</span></span>
<span id="cb6-53">        (Max(MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>NI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>NI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">131072</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory constraint at Tile::op2::Cache::Temporal</span></span>
<span id="cb6-54">        (MO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(KO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>KM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>Max(KO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>KM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>MO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,MM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,NO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>NI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>Max(LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,LO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>LM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Max(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,NO<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>NI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">524288</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory constraint at Tile::MainMemory::Temporal</span></span>
<span id="cb6-55">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Resource constraint at Tile::op1::Cache::Spatial</span></span>
<span id="cb6-56">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Resource constraint at Tile::op2::Cache::Spatial</span></span>
<span id="cb6-57">        Max(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Resource constraint at Scope::Sequential</span></span>
<span id="cb6-58"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==============</span>Checker END<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">================</span></span></code></pre></div></div>
<p>其实我对于tileflow最好奇的一点是 temporal buffer是在哪个内存层级申请的, 通过上面这个constraints很好的解释了这一点. 他应该是在每个tile node上都会开buffer, 对于op1在cache上的这个node上设定了c为pypass, 因此他的大小计算为<code>C[MM*16,L]</code>, 而其他两个buffer就是根据factor来计算的:<code>A[MM*16,KM*16]</code>以及<code>B[KM*16,LI]</code>.</p>
</section>
<section id="执行结果" class="level2">
<h2 class="anchored" data-anchor-id="执行结果">1.4 执行结果</h2>
<p>这里应该是只搜索了buffer size.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span>Optimal Mapping:</span>
<span id="cb7-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-----------------</span>Nest Analysis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">----------------</span></span>
<span id="cb7-3">Tile::MainMemory::Temporal,</span>
<span id="cb7-4">strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> </span>
<span id="cb7-5">read: A B E D update: E </span>
<span id="cb7-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MO(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)), MainMemory</span>
<span id="cb7-7">   read: A B E D update: E fill: A B E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-8">   Scope: Sequential</span>
<span id="cb7-9">   {</span>
<span id="cb7-10">      Tile::op1::MainMemory::Temporal,</span>
<span id="cb7-11">      strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> </span>
<span id="cb7-12">      read: A B fill: A B </span>
<span id="cb7-13">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:KO(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)), MainMemory</span>
<span id="cb7-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LO(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), MainMemory</span>
<span id="cb7-15">            Tile::op1::Cache::Temporal,</span>
<span id="cb7-16">            strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> </span>
<span id="cb7-17">            read: C A B update: C fill: A B </span>
<span id="cb7-18">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:KM(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)), Cache</span>
<span id="cb7-19">              <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MM(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)), Cache</span>
<span id="cb7-20">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LI(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>)), Cache</span>
<span id="cb7-21">                     Tile::op1::Cache::Spatial,</span>
<span id="cb7-22">                     strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> </span>
<span id="cb7-23">                     read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb7-24">                     <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Y), Cache</span>
<span id="cb7-25">                       <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X), Cache</span>
<span id="cb7-26">                           Tile::op1::RegFile::Temporal,</span>
<span id="cb7-27">                           strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> </span>
<span id="cb7-28">                           read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb7-29">                           <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-30">                             <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-31">                               <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-32">                                    read: C A B update: C fill: C A B write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: C </span>
<span id="cb7-33">                                    Op: GEMM1(A,B,)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>C</span>
<span id="cb7-34"></span>
<span id="cb7-35">                                    repFactor:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-36">                                    accesses:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-37">                                    expanison:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb7-38">      Tile::op2::MainMemory::Temporal,</span>
<span id="cb7-39">      strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> </span>
<span id="cb7-40">      read: E D update: E fill: E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-41">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LO(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), MainMemory</span>
<span id="cb7-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:NO(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), MainMemory</span>
<span id="cb7-43">            Tile::op2::Cache::Temporal,</span>
<span id="cb7-44">            strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">511</span> </span>
<span id="cb7-45">            read: C E D update: E fill: E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:LM(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)), Cache</span>
<span id="cb7-47">              <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:MM(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)), Cache</span>
<span id="cb7-48">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:NI(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)), Cache</span>
<span id="cb7-49">                     Tile::op2::Cache::Spatial,</span>
<span id="cb7-50">                     strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> </span>
<span id="cb7-51">                     read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-52">                     <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Y), Cache</span>
<span id="cb7-53">                       <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) (Spatial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X), Cache</span>
<span id="cb7-54">                           Tile::op2::RegFile::Temporal,</span>
<span id="cb7-55">                           strides,low,high:MNKL[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ,[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> </span>
<span id="cb7-56">                           read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-57">                           <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> N <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-58">                             <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> L <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-59">                               <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), RegFile</span>
<span id="cb7-60">                                    read: C E D update: E fill: C E D write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>back: E </span>
<span id="cb7-61">                                    Op: GEMM2(C,D,)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>E</span>
<span id="cb7-62"></span>
<span id="cb7-63">                                    repFactor:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-64">                                    accesses:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-65">                                    expanison:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb7-66">   }</span>
<span id="cb7-67">Cycle: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140288</span>, Energy: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.18771e+08</span></span>
<span id="cb7-68"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--------------</span>END Nest Analysis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---------------</span></span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>编译器</category>
  <guid>https://zhen8838.github.io/posts/tile-flow.html</guid>
  <pubDate>Fri, 29 Dec 2023 09:41:46 GMT</pubDate>
</item>
<item>
  <title>hugging face llama使用</title>
  <link>https://zhen8838.github.io/posts/hf-llama.html</link>
  <description><![CDATA[ 




<p>记录一下使用hugging face llama推理时遇到的问题.</p>
<!--more-->
<p>首先使用如下代码进行推理:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoConfig, AutoModel</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LlamaModel, LlamaConfig, LlamaTokenizerFast, LlamaForCausalLM</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoTokenizer</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torchsummary <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> summary</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb1-6">logging.basicConfig(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(levelname)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(message)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logging.DEBUG)</span>
<span id="cb1-7">logger <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logging.getLogger(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'transformers'</span>)</span>
<span id="cb1-8">logger.setLevel(logging.DEBUG)</span>
<span id="cb1-9"></span>
<span id="cb1-10">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LlamaTokenizerFast.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/workspace/llama_test/llama-tokenizer"</span>)</span>
<span id="cb1-11">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My name is Mariama, my favorite"</span></span>
<span id="cb1-12">inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer(prompt, return_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>)</span>
<span id="cb1-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(inputs)</span>
<span id="cb1-14"></span>
<span id="cb1-15">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoConfig.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/data/llama-65b-hf/"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-16">config.torch_dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span></span>
<span id="cb1-17">config.use_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb1-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(config)</span>
<span id="cb1-19"></span>
<span id="cb1-20">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LlamaForCausalLM.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/data/llama-65b-hf/"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb1-21"></span>
<span id="cb1-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model init!"</span>)</span>
<span id="cb1-23">generate_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.generate(inputs.input_ids, max_new_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb1-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(generate_ids)</span></code></pre></div></div>
<p>这里得到的输入为<code>tensor([[    1,  1619,  1024,   338,  1085,  2829, 29874, 29892,   590, 25448]])</code>, attention_mask为<code>tensor([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1]])</code></p>
<section id="generate过程" class="level1">
<h1>generate过程</h1>
<ol type="1">
<li><p>加载模型的<code>generation.json</code> <code>GenerationConfig {       "bos_token_id": 0,       "eos_token_id": 1,       "max_new_tokens": 32,       "pad_token_id": -1,       "use_cache": false     }</code></p></li>
<li><p>配置最大长度</p>
<p><code>generation_config.max_length = generation_config.max_new_tokens + input_ids_length</code>目前是32+10 = 42</p></li>
<li><p>greedy_search</p>
<p>根据输出策略, 进入<code>greedy_search</code>进行推理.</p>
<ol type="1">
<li>循环推理</li>
<li>准备输入 <code>'input_ids':      tensor([[    1,  1619,  1024,   338,  1085,  2829, 29874, 29892,   590, 25448]])      'position_ids':      tensor([[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]])      'past_key_values':      None      'use_cache':      False      'attention_mask':      tensor([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1]])</code></li>
<li>进入forward</li>
<li>decode layers. 输出hidden_states为<code>torch.Size([1, 10, 8192])</code></li>
<li>执行lm head, 得到logits为<code>torch.Size([1, 10, 32000])</code></li>
<li>取logits最后一个<code>torch.Size([1, 32000])</code>求最大概率 这里我得到的是<code>color</code>. 而整个输出得到是<code># name is Ktha and and I friends color</code>. 本来以为是输入<code>&lt;s&gt; xxx</code> 会得到<code>xxxy</code>这样, 然后取<code>y</code>作为一个输出. 现在看来其实前面部分也会被脑补一些.</li>
</ol></li>
</ol>


</section>

 ]]></description>
  <category>深度学习</category>
  <guid>https://zhen8838.github.io/posts/hf-llama.html</guid>
  <pubDate>Tue, 26 Dec 2023 05:48:12 GMT</pubDate>
</item>
</channel>
</rss>
