<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>cmake踩坑&amp;爬坑 | Zheng's Notes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">cmake踩坑&amp;爬坑</h1><a id="logo" href="/.">Zheng's Notes</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">cmake踩坑&amp;爬坑</h1><div class="post-meta">2021-04-25<span> | </span><span class="category"><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake-%E6%9C%80%E5%B0%8F%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.</span> <span class="toc-text">cmake 最小模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add_subdirectory"><span class="toc-number">2.</span> <span class="toc-text">add_subdirectory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%80%9A%E9%85%8D%E7%AC%A6%E6%89%BE%E5%88%B0%E6%BA%90%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">利用通配符找到源文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#macro%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">macro使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E8%A2%AB%E8%BD%AC%E4%B9%89"><span class="toc-number">5.</span> <span class="toc-text">空格被转义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%AD%A3%E7%A1%AE%E6%80%A7"><span class="toc-number">6.</span> <span class="toc-text">检查正确性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E6%9F%90%E4%B8%AA%E6%96%87%E4%BB%B6%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%9F%E6%88%90"><span class="toc-number">7.</span> <span class="toc-text">为某个文件添加依赖，自定义生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E9%BB%98%E8%AE%A4target%E8%BE%93%E5%87%BA%E4%BD%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">cmake默认target输出位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E5%AF%BC%E5%87%BApseudo-target%E5%B9%B6%E8%BF%9B%E8%A1%8C%E8%B0%83%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">cmake导出pseudo
target，并进行调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E5%AE%89%E8%A3%85target%E8%AE%BE%E7%BD%AE%E5%85%B6%E5%90%8D%E5%AD%97"><span class="toc-number">10.</span> <span class="toc-text">cmake安装target设置其名字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84"><span class="toc-number">11.</span> <span class="toc-text">cmake安装目录路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">12.</span> <span class="toc-text">cmake函数返回值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E5%86%99%E5%85%A5%E5%A4%9A%E8%A1%8Cinclude"><span class="toc-number">13.</span> <span class="toc-text">cmake写入多行include</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmake%E8%8E%B7%E5%8F%96target-%E7%9A%84library-path"><span class="toc-number">14.</span> <span class="toc-text">cmake获取target 的library
path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined-reference-to-pthread_create"><span class="toc-number">15.</span> <span class="toc-text">undefined reference to
&#96;pthread_create&#39;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#macos%E4%B8%AD%E7%9A%84rpath%E9%97%AE%E9%A2%98"><span class="toc-number">16.</span> <span class="toc-text">macos中的rpath问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#conan%E6%94%AF%E6%8C%81riscv"><span class="toc-number">17.</span> <span class="toc-text">conan支持riscv</span></a></li></ol></div></div><div class="post-content"><p>最近实习了，每天都要和cmake打交道，记录一些时常要用的东西和遇到的问题。</p>
<span id="more"></span>
<h2 id="cmake-最小模板">cmake 最小模板</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.9)</span><br><span class="line">project(xxx)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#设定编译参数</span><br><span class="line">set(CMAKE_CXX_STANDARD 11)</span><br><span class="line"> </span><br><span class="line">#设定源码列表.cpp</span><br><span class="line">aux_source_directory(&lt;dir&gt; &lt;variable&gt;)</span><br><span class="line">#比如:aux_source_directory($&#123;CMAKE_SOURCE_DIR&#125; DIR)  </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">#设定头文件路径</span><br><span class="line">include_directories(../include/)</span><br><span class="line">#include_directories(&quot;路径1&quot;  “路径2”...)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#设定链接库的路径（一般使用第三方非系统目录下的库）</span><br><span class="line">link_directories(../build/)</span><br><span class="line">#link_directories(&quot;路径1&quot;  “路径2”...)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#添加子目录,作用相当于进入子目录里面，展开子目录的CMakeLists.txt</span><br><span class="line">#同时执行，子目录中的CMakeLists.txt一般是编译成一个库，作为一个模块</span><br><span class="line">#在父目录中可以直接引用子目录生成的库</span><br><span class="line">#add_subdirectory(math)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#生成动/静态库</span><br><span class="line">#add_library(动/静态链接库名称  SHARED/STATIC(可选，默认STATIC)  源码列表)</span><br><span class="line">#可以单独生成多个模块</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#生成可执行文件</span><br><span class="line">add_executable(myLevealDB   $&#123;SOURCE_FILES&#125; )</span><br><span class="line">#比如：add_executable(hello_world    $&#123;SOURCE_FILES&#125;)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">target_link_libraries(xxx pthred glog)#就是g++ 编译选项中-l后的内容，不要有多余空格</span><br><span class="line"> </span><br><span class="line"># ADD_CUSTOM_COMMAND( #执行shell命令</span><br><span class="line">#           TARGET myLevelDB </span><br><span class="line">#           POST_BUILD #在目标文件myLevelDBbuild之后，执行下面的拷贝命令，还可以选择PRE_BUILD命令将</span><br><span class="line"># 会在其他依赖项执行前执行  PRE_LINK命令将会在其他依赖项执行完后执行  POST_BUILD命令将会在目# 标构建完后执行。</span><br><span class="line">#           COMMAND cp ./myLevelDB  ../</span><br><span class="line"># )</span><br></pre></td></tr></table></figure>
<h2 id="add_subdirectory">add_subdirectory</h2>
<p>用<code>add_subdirectory</code>可以很方便的控制是否编译子目录，比如我们将测试代码放到<code>test</code>中，在根目录的cmakelist里面选择是否编译单元测试文件。</p>
<h2 id="利用通配符找到源文件">利用通配符找到源文件</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file(GLOB SOURCE_FILES $&#123;CMAKE_SOURCE_DIR&#125;/test_*.cpp)</span><br><span class="line">add_executable(cpp_test $&#123;SOURCE_FILES&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="macro使用">macro使用</h2>
<table>
<thead>
<tr class="header">
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ARGV#</td>
<td># 是一个下标，0 指向第一个参数，累加</td>
</tr>
<tr class="even">
<td>ARGV</td>
<td>所有的定义时要求传入的参数</td>
</tr>
<tr class="odd">
<td>ARGN</td>
<td>定义时要求传入的参数以外的参数列表</td>
</tr>
<tr class="even">
<td>ARGC</td>
<td>传入的实际参数的个数，也就是调用函数是传入的参数个数</td>
</tr>
</tbody>
</table>
<p>当要收集额外参数的时候，不能直接在宏的入口处写参数，因为那里的参数是必须传入的，只能直接传入然后用if进行解析。
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">macro(add_code name)</span><br><span class="line">    if($&#123;ARGC&#125; GREATER 2)</span><br><span class="line">        set(gen_name $&#123;ARGV1&#125;)</span><br><span class="line">        set(gen_variable $&#123;ARGV2&#125;)</span><br><span class="line">    else()</span><br><span class="line">        set(gen_name $&#123;name&#125;)</span><br><span class="line">        set(gen_variable &quot;&quot;)</span><br><span class="line">    endif()</span><br><span class="line">    add_custom_target(gen_$&#123;name&#125; </span><br><span class="line">        COMMAND $&#123;CMAKE_RUNTIME_OUTPUT_DIRECTORY&#125;/gen_all -g halide_$&#123;name&#125; -n halide_$&#123;gen_name&#125; -o $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/kernels -e c_header,assembly,schedule,stmt_html target=host-no_asserts-no_bounds_query &quot;$&#123;gen_variable&#125;&quot;)</span><br><span class="line">    add_dependencies(gen_$&#123;name&#125; gen_all)</span><br><span class="line">endmacro()</span><br></pre></td></tr></table></figure></p>
<h2 id="空格被转义">空格被转义</h2>
<p>我想输入一个参数为<code>"kernel_width=3 kernel_height=3"</code>然后执行命令，但是我发现执行命令的时候变成了这样：
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kernel_width=3\ kernel_height=3</span><br></pre></td></tr></table></figure></p>
<p>这个是因为cmake为了区别于他多个变量赋值的问题，我们可以用两个方式解决
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set(testfiles &quot;test1&quot; &quot;test2&quot;) \\ 1. 直接多个变量赋值</span><br><span class="line">set(testfiles &quot;kernel_width=3;kernel_height=3&quot;) \\ 2. 使用分号隔开</span><br></pre></td></tr></table></figure></p>
<h2 id="检查正确性">检查正确性</h2>
<p>有时候我们可能需要检查cmake的内部变量是不是有错误，要加message比较麻烦，我们可以这样：
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make VERBOSE=1 </span><br></pre></td></tr></table></figure></p>
<h2
id="为某个文件添加依赖自定义生成">为某个文件添加依赖，自定义生成</h2>
<p>使用custom
command，然后把生成的src添加到一个新的的target中，然后目标target依赖这个target。
要注意，我们生成的源文件不能直接加到目标target中，因为一开始没有生成代码，会导致cmake
config出错，得找找方法去解决一下。 <figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT testData.cpp</span><br><span class="line">  <span class="keyword">COMMAND</span> reswrap </span><br><span class="line">  ARGS    testData.src &gt; testData.cpp</span><br><span class="line">  DEPENDS testData.src </span><br><span class="line">)</span><br><span class="line"><span class="keyword">add_custom_target</span>(evaluator_k510.update SOURCES <span class="variable">$&#123;KERNEL_SRCS&#125;</span>)</span><br><span class="line"><span class="keyword">add_dependencies</span>(evaluator_k510 evaluator_k510.update)</span><br></pre></td></tr></table></figure></p>
<p>如果是在没有依赖，那么可以自己加个<code>dummy.cpp</code>然后强制把需要生成的文件给添加上</p>
<h2 id="cmake默认target输出位置">cmake默认target输出位置</h2>
<p>在编译时通过<code>add_executable()</code>生成的可执行文件，以及利用<code>add_library( SHARED )</code>的文件，默认输出到<code>CMAKE_RUNTIME_OUTPUT_DIRECTORY</code>，通常是<code>build/bin</code>目录。</p>
<h2 id="cmake导出pseudo-target并进行调用">cmake导出pseudo
target，并进行调用</h2>
<p>我首先用<code>add_custom_command</code>生成了一个lib，但是这个lib不是cmake构建的，所以不能直接被cmake调用，并且如果他是一个lib，必须要先写个<code>add_library</code>制作一个伪目标，然后再把他真实的lib添加上去，然后才能正常使用这个target。
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add_library(hkg_$&#123;os_name&#125;_runtime INTERFACE)</span><br><span class="line">target_link_libraries(hkg_$&#123;os_name&#125;_runtime INTERFACE $&#123;CMAKE_LIBRARY_OUTPUT_DIRECTORY&#125;/halide_runtime_$&#123;os_name&#125;.$&#123;suffix&#125; -ldl)</span><br><span class="line">add_library(hkg::$&#123;os_name&#125;_runtime ALIAS hkg_$&#123;os_name&#125;_runtime)</span><br></pre></td></tr></table></figure></p>
<p>更加复杂的例子在这里<code>https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#interface-libraries</code></p>
<h2 id="cmake安装target设置其名字">cmake安装target设置其名字</h2>
<p>当我们设置自定义目标的时候，用别名<code>ALIAS</code>可以指定在整个构建过程中的target的使用名字，但是如果这个target需要导出（也就是被第三方库使用时），他的名字还得使用<code>set_target_properties</code>设置一下。
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(Halide::Generator ALIAS Halide_Generator)</span><br><span class="line"><span class="keyword">set_target_properties</span>(Halide_Generator PROPERTIES EXPORT_NAME Generator)</span><br></pre></td></tr></table></figure></p>
<h2 id="cmake安装目录路径">cmake安装目录路径</h2>
<p>cmake真的处处是坑，如果想install一个目录下的所有东西，那么必须这样写:
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">install</span>(DIRECTORY <span class="keyword">include</span>/</span><br><span class="line">        DESTINATION <span class="keyword">include</span>)</span><br></pre></td></tr></table></figure>
如果少了一个<code>/</code>安装后就会出现<code>include/include</code>的情况</p>
<h2 id="cmake函数返回值">cmake函数返回值</h2>
<p>cmake里面是没有函数返回值的，所以必须要在函数中设置变量的值，同时指定他的scope，同时还需要注意设置变量的写法。或者说传递变量的名字然后用${name}的方法完成了c中类似指针的功能🤣。</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FUNCTION</span>(MY_FUNC_WITH_RET ret)</span><br><span class="line">    <span class="comment"># The following line works by accident if the name of variable in the parent</span></span><br><span class="line">    <span class="comment"># is the same as in the function</span></span><br><span class="line">    <span class="keyword">SET</span>(ret <span class="string">&quot;in function&quot;</span> PARENT_SCOPE)</span><br><span class="line">    <span class="comment"># This is the correct way to get the variable name passed to the function</span></span><br><span class="line">    <span class="keyword">SET</span>(<span class="variable">$&#123;ret&#125;</span> <span class="string">&quot;in function&quot;</span> PARENT_SCOPE)</span><br><span class="line"><span class="keyword">ENDFUNCTION</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span>(ret <span class="string">&quot;before function&quot;</span>)</span><br><span class="line">MY_FUNC_WITH_RET(ret)</span><br><span class="line"><span class="keyword">MESSAGE</span>(<span class="string">&quot;output from function = $&#123;ret&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="cmake写入多行include">cmake写入多行include</h2>
<p>还是利用configure_file，不过需要自己手动处理比较多的东西</p>
<p>简单测试，在.h.in文件中添加<code>@linux_include_list@</code>块之后执行cmake，就可以得到正确的include了。
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line">project(fuck)</span><br><span class="line">set(base_name &quot;conv2d&quot;)</span><br><span class="line">set(os_name &quot;linux&quot;)</span><br><span class="line">set(header_list &quot;&quot;)</span><br><span class="line">list(APPEND feature_list </span><br><span class="line">    &quot;avx512&quot; </span><br><span class="line">    &quot;avx2&quot; </span><br><span class="line">    &quot;sse41&quot; </span><br><span class="line">    &quot;bare&quot;)</span><br><span class="line">list(APPEND full_feature_list </span><br><span class="line">    &quot;-sse41-avx-f16c-fma-avx2-avx512&quot; </span><br><span class="line">    &quot;-avx-avx2-f16c-fma-sse41&quot;</span><br><span class="line">    &quot;-avx-f16c-sse41&quot;</span><br><span class="line">    &quot;&quot;)</span><br><span class="line"></span><br><span class="line">foreach(feature full_feature IN ZIP_LISTS feature_list full_feature_list)</span><br><span class="line">    message(&quot;$&#123;feature&#125; $&#123;full_feature&#125;&quot;)</span><br><span class="line">    list(APPEND header_list &quot;$&#123;base_name&#125;-$&#123;os_name&#125;-$&#123;feature&#125;.h&quot;)</span><br><span class="line">endforeach()</span><br><span class="line"></span><br><span class="line">set(linux_include_list &quot;&quot;)</span><br><span class="line">foreach(header IN LISTS header_list)</span><br><span class="line">    set(linux_include_list &quot;$&#123;linux_include_list&#125;\r\n#include \&quot;$&#123;header&#125;\&quot;&quot;)</span><br><span class="line">endforeach()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># set(linux_include_list $&#123;header_list&#125;)</span><br><span class="line">set(windows_include_list $&#123;header_list&#125;)</span><br><span class="line">set(osx_include_list $&#123;header_list&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">configure_file(src/conv2d.h.in $&#123;CMAKE_SOURCE_DIR&#125;/src/conv2d.h)</span><br></pre></td></tr></table></figure></p>
<h2 id="cmake获取target-的library-path">cmake获取target 的library
path</h2>
<p>我遇到了一个奇怪的bug，就是使用<code>add_library</code>添加了一组link的对象接口之后，被链接的库没有被正确写入到target中，但是cmake又无法调试，所以只能从target中获取属性再打印出来看看，因为我的link
library是interface的模式，所以要获取interface的property
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get_target_property(OUT hkg_linux_src INTERFACE_LINK_LIBRARIES)</span><br><span class="line">message(STATUS $&#123;OUT&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后我就发现了问题，即我们在编写<code>target_link_libraries</code>的时候，所有的字符串都是raw模式的，也就是说我们不需要加上双引号，我原来的写法如下
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target_link_libraries(hkg_linux_src INTERFACE $&lt;BUILD_INTERFACE:&quot;$&#123;LINUX_SRCS&#125;&quot;&gt;</span><br><span class="line">    $&lt;INSTALL_INTERFACE:&quot;$&#123;LINUX_SRCS&#125;&quot;&gt;)</span><br></pre></td></tr></table></figure> 则他的输出为 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&lt;BUILD_INTERFACE:&quot;/home/workspace/kernels_generator/include/hkg/generated_kernels/halide_conv2d_7x7_linux_bare.o&quot;&gt;</span><br></pre></td></tr></table></figure>
而这里面的字符串是原封不动的写入到target_link_libraries中的，此时多了的双引号就是引起错误的根源了。</p>
<p>所以需要这样写，就可以避免这个问题了。 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target_link_libraries(hkg_linux_src INTERFACE $&lt;BUILD_INTERFACE:$&#123;LINUX_SRCS&#125;&gt;</span><br><span class="line">    $&lt;INSTALL_INTERFACE:$&#123;LINUX_SRCS&#125;&gt;)</span><br></pre></td></tr></table></figure></p>
<h2 id="undefined-reference-to-pthread_create">undefined reference to
`pthread_create'</h2>
<p>这个问题也老奇怪了，明明添加了<code>-lphread</code>但是还是报错，发现要使用<code>-phread</code>才可以。</p>
<h2 id="macos中的rpath问题">macos中的rpath问题</h2>
<p>RPATH就是可执行文件寻找他动态链接库的路径,在linux中,大多数命令都是以以下顺序去搜索动态链接库的</p>
<ol type="1">
<li>RPATH</li>
<li>LD_LIBRARY_PATH</li>
<li>RUNPATH</li>
<li>/etc/ld.so.conf</li>
<li>builtin directories</li>
</ol>
<p>通常我们设置LD_LIBRARY_PATH为给可执行程序提供库的路径,但是如果有同时存在多个版本的库都在路径中,同时我们还需要链接不同版本的库,那应该怎么办?
这时候就需要设置RPATH或者RUNPATH,提供一个指定的路径/</p>
<p>但是macos的情况有些不同,他的连接器 dyld 使用每个 dylib
的完整路径来定位依赖的动态库。</p>
<p>可执行文件中用完整路径记录他的依赖库: <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">❯ otool -L bin/can_use_target.generator</span><br><span class="line">bin/can_use_target.generator:</span><br><span class="line">        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)</span><br><span class="line">        /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 905.6.0)</span><br></pre></td></tr></table></figure></p>
<h2 id="conan支持riscv">conan支持riscv</h2>
<p>我今天才发现Conan
build的时候没有按照编译器选择对应的arch,然后看了一下,他们官方居然都没有做rv的支持.
他可选的setting中没有rv这个平台. 最终的cmake中的修改如下:
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span>(TARGET_ARCH x86_64)</span><br><span class="line"><span class="keyword">if</span>(ENABLE_K510_RUNTIME <span class="keyword">AND</span> BUILDING_TEST)</span><br><span class="line">    <span class="comment"># NOTE you need add `riscv64` in `~/.conan/settings.yml` `arch, arch_build, arch_target` item.</span></span><br><span class="line">    <span class="comment"># refer from https://github.com/conan-io/cmake-conan/issues/307</span></span><br><span class="line">    <span class="keyword">set</span>(TARGET_ARCH <span class="string">&quot;riscv64&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">conan_cmake_run(BASIC_SETUP</span><br><span class="line">                CONANFILE conanfile-runtime.txt</span><br><span class="line">                SETTINGS compiler.cppstd=<span class="number">17</span></span><br><span class="line">                BUILD missing</span><br><span class="line">                ARCH <span class="variable">$&#123;TARGET_ARCH&#125;</span></span><br><span class="line">                ENV CC=<span class="variable">$&#123;CMAKE_C_COMPILER&#125;</span></span><br><span class="line">                ENV CXX=<span class="variable">$&#123;CMAKE_CXX_COMPILER&#125;</span></span><br><span class="line">                ENV CFLAGS=<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span></span><br><span class="line">                ENV CXXFLAGS=<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span>)</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/conan_paths.cmake)</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CPP/" rel="tag">CPP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%B8%A9%E5%9D%91%E7%BB%8F%E9%AA%8C/" rel="tag">踩坑经验</a></li></ul></div><div class="post-nav"><a class="pre" href="/2021/04/25/cpp-trick/">cpp挖坑&amp;爬坑</a><a class="next" href="/2021/04/05/bin-search-template/">二分查找-统一框架</a></div><script src="https://utteranc.es/client.js" repo="zhen8838/zhen8838.github.io" issue-term="url" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zhen8838.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>A Believing Heart Is Your Magic</p><a class="info-icon" href="mailto:597323109@qq.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/zhen8838" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">工具使用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6/">推理框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E8%AF%91%E5%99%A8/">编译器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97/">边缘计算</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%AD%B9%E5%AD%A6/">运筹学</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E6%A0%91/" style="font-size: 15px;">树</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Tensorflow/" style="font-size: 15px;">Tensorflow</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 15px;">树莓派</a> <a href="/tags/%E8%93%9D%E7%89%99/" style="font-size: 15px;">蓝牙</a> <a href="/tags/Matlab/" style="font-size: 15px;">Matlab</a> <a href="/tags/%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95/" style="font-size: 15px;">遗传算法</a> <a href="/tags/SVM/" style="font-size: 15px;">SVM</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 15px;">链表</a> <a href="/tags/%E5%8D%8A%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">半监督学习</a> <a href="/tags/GAN/" style="font-size: 15px;">GAN</a> <a href="/tags/%E6%A6%82%E7%8E%87%E8%AE%BA/" style="font-size: 15px;">概率论</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/%E9%A6%99%E6%A9%99%E6%B4%BE/" style="font-size: 15px;">香橙派</a> <a href="/tags/%E8%B8%A9%E5%9D%91%E7%BB%8F%E9%AA%8C/" style="font-size: 15px;">踩坑经验</a> <a href="/tags/LeetCode/" style="font-size: 15px;">LeetCode</a> <a href="/tags/Qt/" style="font-size: 15px;">Qt</a> <a href="/tags/%E5%A4%9A%E9%9D%A2%E4%BD%93%E6%A8%A1%E5%9E%8B/" style="font-size: 15px;">多面体模型</a> <a href="/tags/%E5%90%8E%E7%AB%AF%E4%BC%98%E5%8C%96/" style="font-size: 15px;">后端优化</a> <a href="/tags/Ampl/" style="font-size: 15px;">Ampl</a> <a href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 15px;">图像处理</a> <a href="/tags/K210/" style="font-size: 15px;">K210</a> <a href="/tags/%E4%BA%8C%E5%88%86%E6%B3%95/" style="font-size: 15px;">二分法</a> <a href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" style="font-size: 15px;">科学上网</a> <a href="/tags/%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0/" style="font-size: 15px;">损失函数</a> <a href="/tags/cmake/" style="font-size: 15px;">cmake</a> <a href="/tags/CPP/" style="font-size: 15px;">CPP</a> <a href="/tags/Conan/" style="font-size: 15px;">Conan</a> <a href="/tags/OrTools/" style="font-size: 15px;">OrTools</a> <a href="/tags/CSharp/" style="font-size: 15px;">CSharp</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA/" style="font-size: 15px;">数据增强</a> <a href="/tags/VAE/" style="font-size: 15px;">VAE</a> <a href="/tags/%E8%81%9A%E7%B1%BB%E6%96%B9%E6%B3%95/" style="font-size: 15px;">聚类方法</a> <a href="/tags/CostModel/" style="font-size: 15px;">CostModel</a> <a href="/tags/Vscode/" style="font-size: 15px;">Vscode</a> <a href="/tags/%E5%A3%B0%E9%9F%B3%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/" style="font-size: 15px;">声音信号处理</a> <a href="/tags/TVM/" style="font-size: 15px;">TVM</a> <a href="/tags/%E5%8A%A8%E6%80%81shape/" style="font-size: 15px;">动态shape</a> <a href="/tags/%E4%B8%AD%E7%AB%AF%E4%BC%98%E5%8C%96/" style="font-size: 15px;">中端优化</a> <a href="/tags/Equality-Saturation/" style="font-size: 15px;">Equality Saturation</a> <a href="/tags/stm32/" style="font-size: 15px;">stm32</a> <a href="/tags/Keras/" style="font-size: 15px;">Keras</a> <a href="/tags/Halide/" style="font-size: 15px;">Halide</a> <a href="/tags/DSL/" style="font-size: 15px;">DSL</a> <a href="/tags/%E5%A0%86%E6%A0%88/" style="font-size: 15px;">堆栈</a> <a href="/tags/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/" style="font-size: 15px;">大语言模型</a> <a href="/tags/llama/" style="font-size: 15px;">llama</a> <a href="/tags/%E5%BD%92%E4%B8%80%E5%8C%96/" style="font-size: 15px;">归一化</a> <a href="/tags/Makefile/" style="font-size: 15px;">Makefile</a> <a href="/tags/%E5%85%83%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">元学习</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">模板元编程</a> <a href="/tags/mindspore/" style="font-size: 15px;">mindspore</a> <a href="/tags/LLM/" style="font-size: 15px;">LLM</a> <a href="/tags/tvm/" style="font-size: 15px;">tvm</a> <a href="/tags/mlir/" style="font-size: 15px;">mlir</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%BB%BA%E6%A8%A1/" style="font-size: 15px;">性能建模</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/Nand2Tetris/" style="font-size: 15px;">Nand2Tetris</a> <a href="/tags/ncnn/" style="font-size: 15px;">ncnn</a> <a href="/tags/Numpy/" style="font-size: 15px;">Numpy</a> <a href="/tags/PCB/" style="font-size: 15px;">PCB</a> <a href="/tags/%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1/" style="font-size: 15px;">姿态估计</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B/" style="font-size: 15px;">人脸检测</a> <a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E9%87%8F%E5%8C%96/" style="font-size: 15px;">神经网络量化</a> <a href="/tags/Yolo/" style="font-size: 15px;">Yolo</a> <a href="/tags/Pytorch/" style="font-size: 15px;">Pytorch</a> <a href="/tags/NB-IOT/" style="font-size: 15px;">NB-IOT</a> <a href="/tags/Retinaface/" style="font-size: 15px;">Retinaface</a> <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" style="font-size: 15px;">目标检测</a> <a href="/tags/%E6%8C%87%E4%BB%A4%E9%9B%86/" style="font-size: 15px;">指令集</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 15px;">排序</a> <a href="/tags/%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/" style="font-size: 15px;">统计学习方法</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" style="font-size: 15px;">人脸识别</a> <a href="/tags/%E4%BC%98%E5%8C%96%E5%99%A8/" style="font-size: 15px;">优化器</a> <a href="/tags/%E5%90%B4%E6%81%A9%E8%BE%BE%E8%AF%BE%E7%A8%8B/" style="font-size: 15px;">吴恩达课程</a> <a href="/tags/WordCloud/" style="font-size: 15px;">WordCloud</a> <a href="/tags/Zhihu/" style="font-size: 15px;">Zhihu</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/%E5%9B%9B%E8%BD%B4%E9%A3%9E%E8%A1%8C%E5%99%A8/" style="font-size: 15px;">四轴飞行器</a> <a href="/tags/%E8%B5%84%E6%BA%90%E6%B1%87%E6%80%BB/" style="font-size: 15px;">资源汇总</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 15px;">分布式</a> <a href="/tags/%E6%97%A0%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">无监督学习</a> <a href="/tags/Apple/" style="font-size: 15px;">Apple</a> <a href="/tags/Jittor/" style="font-size: 15px;">Jittor</a> <a href="/tags/Tiramisu/" style="font-size: 15px;">Tiramisu</a> <a href="/tags/Triton/" style="font-size: 15px;">Triton</a> <a href="/tags/vllm/" style="font-size: 15px;">vllm</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/02/14/vllm/">推理框架调研</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/04/distal/">DISTAL: The Distributed Tensor Algebra Compiler</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/04/triton-cpu-lesson-1/">triton-cpu初体验</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/07/mesh-matmul/">分布式存储架构下的矩阵乘与编译器</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/08/mlc-tutorial/">机器学习编译概念科普</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/08/benchmark-notes/">benchmark的经验与技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/06/14/ampl-learn/">Ampl学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/05/08/constraints-solver-internals/">Constraints Solver Internals</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/30/model-driven-optimization/">Model Driven Optimization</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/23/mac-amx/">探索AMX: 解锁Apple Silicon隐藏性能</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Zheng's Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>