<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Affine Fusion Pass浅析 | Zheng's Notes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Affine Fusion Pass浅析</h1><a id="logo" href="/.">Zheng's Notes</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Affine Fusion Pass浅析</h1><div class="post-meta">2024-01-11<span> | </span><span class="category"><a href="/categories/%E7%BC%96%E8%AF%91%E5%99%A8/">编译器</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.5k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 23</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">1. 准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#performfusionsintodestunsigned-dstid-unsigned-maxsrcusercount"><span class="toc-number">2.</span> <span class="toc-text">2.
performFusionsIntoDest(unsigned dstId, unsigned maxSrcUserCount)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#affinecanfuseloopssrcaffineforop-dstaffineforop-i-depthsliceunionsi---1-strategy"><span class="toc-number">3.</span> <span class="toc-text">3.
affine::canFuseLoops(srcAffineForOp, dstAffineForOp, i, &amp;depthSliceUnions[i - 1], strategy)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#computesliceunion"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 computeSliceUnion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#checkmemrefaccessdependence"><span class="toc-number">3.2.</span> <span class="toc-text">3.2
checkMemrefAccessDependence</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getcomputationslicestate"><span class="toc-number">3.3.</span> <span class="toc-text">3.3
getComputationSliceState</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#isfusionprofitable"><span class="toc-number">4.</span> <span class="toc-text">4. isFusionProfitable</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#getfusioncomputecost"><span class="toc-number">5.</span> <span class="toc-text">4.1 getFusionComputeCost</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#update-bestdstloopdepth"><span class="toc-number">6.</span> <span class="toc-text">4.2 Update bestDstLoopDepth</span></a></li></ol></div></div><div class="post-content"><p>学习<code>mlir</code>中<code>Affine Fusion Pass</code>,
主要关注依赖分析部分.</p>
<span id="more"></span>
<h1 id="准备工作">1. 准备工作</h1>
<p>首先我们的待测试的<code>ir</code>为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">module &#123;</span><br><span class="line">  func.func @main(%arg0: memref&lt;8x128x384xf32&gt;, %arg1: memref&lt;8x384x512xf32&gt;, %arg2: memref&lt;8x128x512xf32&gt;, %arg3: memref&lt;8x512x64xf32&gt;, %arg4: memref&lt;8x128x64xf32&gt;) &#123;</span><br><span class="line">    affine.for %arg5 = 0 to 8 &#123;</span><br><span class="line">      affine.for %arg6 = 0 to 128 &#123;</span><br><span class="line">        affine.for %arg7 = 0 to 512 &#123;</span><br><span class="line">          affine.for %arg8 = 0 to 384 &#123;</span><br><span class="line">            %0 = affine.load %arg0[%arg5, %arg6, %arg8] : memref&lt;8x128x384xf32&gt;</span><br><span class="line">            %1 = affine.load %arg1[%arg5, %arg8, %arg7] : memref&lt;8x384x512xf32&gt;</span><br><span class="line">            %2 = affine.load %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;</span><br><span class="line">            %3 = arith.mulf %0, %1 : f32</span><br><span class="line">            %4 = arith.addf %2, %3 : f32</span><br><span class="line">            affine.store %4, %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    affine.for %arg5 = 0 to 8 &#123;</span><br><span class="line">      affine.for %arg6 = 0 to 128 &#123;</span><br><span class="line">        affine.for %arg7 = 0 to 64 &#123;</span><br><span class="line">          affine.for %arg8 = 0 to 512 &#123;</span><br><span class="line">            %0 = affine.load %arg2[%arg5, %arg6, %arg8] : memref&lt;8x128x512xf32&gt;</span><br><span class="line">            %1 = affine.load %arg3[%arg5, %arg8, %arg7] : memref&lt;8x512x64xf32&gt;</span><br><span class="line">            %2 = affine.load %arg4[%arg5, %arg6, %arg7] : memref&lt;8x128x64xf32&gt;</span><br><span class="line">            %3 = arith.mulf %0, %1 : f32</span><br><span class="line">            %4 = arith.addf %2, %3 : f32</span><br><span class="line">            affine.store %4, %arg4[%arg5, %arg6, %arg7] : memref&lt;8x128x64xf32&gt;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1
id="performfusionsintodestunsigned-dstid-unsigned-maxsrcusercount">2.
<code>performFusionsIntoDest(unsigned dstId, unsigned maxSrcUserCount)</code></h1>
<ol type="1">
<li><p>进入<code>affine fusion pass</code>之后,
通过<code>dstId</code>在<code>MemRefDependenceGraph</code>中找到<code>producer</code>的<code>affine for</code>节点作为<code>src</code>节点.
在我们的例子中, 显然是融合上下两个循环块.</p></li>
<li><p>通过<code>gatherProducerConsumerMemrefs(srcId, dstId, mdg, producerConsumerMemrefs)</code>收集<code>src</code>节点与<code>dst</code>节点中的存在生产消费链接的<code>store/load</code>.</p></li>
<li><p>通过<code>dstLoopDepthTest = getInnermostCommonLoopDepth(dstMemrefOps)</code>获取<code>dst</code>节点中的内存操作的循环层级,
我们的例子中的循环深度为4.</p></li>
<li><p>遍历目标循环的深度<code>[1, dstLoopDepthTest]</code>通过<code>FusionResult result = affine::canFuseLoops(...) &#125;</code>测试能否将<code>src loop</code>放到<code>dest loop</code>中</p></li>
</ol>
<h1
id="affinecanfuseloopssrcaffineforop-dstaffineforop-i-depthsliceunionsi---1-strategy">3.
<code>affine::canFuseLoops(srcAffineForOp, dstAffineForOp, i, &amp;depthSliceUnions[i - 1], strategy)</code></h1>
<p>验证是否可以<code>fusion</code>是一个复杂的过程.
经过一些琐碎的边界条件处理后, 开始执行判断过程.</p>
<ol type="1">
<li><p><code>numCommonLoops = affine::getNumCommonSurroundingLoops(*srcForOp, *dstForOp);</code>检查两个<code>op</code>外围是否存在共同的循环,
目前的例子中并没有.</p></li>
<li><p><code>switch (fusionStrategy.getStrategy())</code>根据不同的策略放入不同的关键路径<code>op</code>,
这里<code>opsA</code>表示producer,
<code>opsB</code>表示consumer的.</p></li>
<li><p><code>sliceComputationResult = affine::computeSliceUnion(strategyOpsA, opsB, dstLoopDepth, numCommonLoops, isSrcForOpBeforeDstForOp, srcSlice)</code></p></li>
</ol>
<h2 id="computesliceunion">3.1 <code>computeSliceUnion</code></h2>
<p>计算<code>opsA</code>和<code>OpsB</code>在指定循环层级位置计算得到的<code>slice bounds</code>是否满足他们之间的依赖.
首先对于producer来说只有写出是重要的,
因此这里的opsA为<code>affine.store %4, %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;</code>.
对于consumer来说, 读写同样重要, 因此此时的opsB为 <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">%<span class="number">0</span> = affine.load %arg2[%arg5, %arg6, %arg8] : memref&lt;<span class="number">8</span>x128x512xf32&gt;</span><br><span class="line">%<span class="number">1</span> = affine.load %arg3[%arg5, %arg8, %arg7] : memref&lt;<span class="number">8</span>x512x64xf32&gt;</span><br><span class="line">%<span class="number">2</span> = affine.load %arg4[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x64xf32&gt;</span><br><span class="line">affine.store %<span class="number">4</span>, %arg4[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x64xf32&gt;</span><br></pre></td></tr></table></figure></p>
<p>因为我们需要测试前一个执行节点的内存对后面所有的执行的内存的依赖关系,
所以这里是一个全排列组合的测试:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> *i : opsA) &#123;</span><br><span class="line">  <span class="function">MemRefAccess <span class="title">srcAccess</span><span class="params">(i)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> *j : opsB) &#123;</span><br><span class="line">    <span class="function">MemRefAccess <span class="title">dstAccess</span><span class="params">(j)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (srcAccess.memref != dstAccess.memref)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果他们读写的是同一块<code>memref</code>, 那么也就是存在着依赖,
那么就可能存在着潜在的依赖, 需要进行进一步的依赖测试:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> readReadAccesses = <span class="built_in">isa</span>&lt;AffineReadOpInterface&gt;(srcAccess.opInst) &amp;&amp;</span><br><span class="line">                        <span class="built_in">isa</span>&lt;AffineReadOpInterface&gt;(dstAccess.opInst);</span><br><span class="line">FlatAffineValueConstraints dependenceConstraints;</span><br><span class="line"><span class="comment">// Check dependence between &#x27;srcAccess&#x27; and &#x27;dstAccess&#x27;.</span></span><br><span class="line">DependenceResult result = <span class="built_in">checkMemrefAccessDependence</span>( <span class="comment">/* 如果操作的是同一个buffer, 那么需要检查依赖 */</span></span><br><span class="line">    srcAccess, dstAccess, <span class="comment">/*loopDepth=*/</span>numCommonLoops + <span class="number">1</span>,</span><br><span class="line">    &amp;dependenceConstraints, <span class="comment">/*dependenceComponents=*/</span><span class="literal">nullptr</span>,</span><br><span class="line">    <span class="comment">/*allowRAR=*/</span>readReadAccesses)</span><br></pre></td></tr></table></figure>
<h2 id="checkmemrefaccessdependence">3.2
<code>checkMemrefAccessDependence</code></h2>
<p>此时我们的<code>src/dst</code>分别为: <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Checking <span class="keyword">for</span> dependence at depth: 1 between:</span><br><span class="line">mlir-asm-printer: Verifying operation: func.func</span><br><span class="line">affine.store %4, %arg2[%arg5, %arg6, %arg7] : memref&lt;8x128x512xf32&gt;</span><br><span class="line">mlir-asm-printer: Verifying operation: func.func</span><br><span class="line">%0 = affine.load %arg2[%arg5, %arg6, %arg8] : memref&lt;8x128x512xf32&gt;</span><br></pre></td></tr></table></figure></p>
<p>接下来从<code>access</code>中获得对应的<code>access relation</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create access relation from each MemRefAccess.</span></span><br><span class="line">FlatAffineRelation srcRel, dstRel;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">failed</span>(srcAccess.<span class="built_in">getAccessRelation</span>(srcRel)))</span><br><span class="line">  <span class="keyword">return</span> DependenceResult::Failure;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">failed</span>(dstAccess.<span class="built_in">getAccessRelation</span>(dstRel)))</span><br><span class="line">  <span class="keyword">return</span> DependenceResult::Failure;</span><br></pre></td></tr></table></figure>
<p>首先展示srcRel和dstRel的FlatAffineRelation: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">srcRel:</span><br><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">7</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">0</span></span><br><span class="line"><span class="number">11</span> constraints</span><br><span class="line">(Value  Value   Value   Value   <span class="literal">None</span>    <span class="literal">None</span>    <span class="literal">None</span>    const)</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">383</span>     &gt;= <span class="number">0</span></span><br><span class="line">dstRel:</span><br><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">7</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">0</span></span><br><span class="line"><span class="number">11</span> constraints</span><br><span class="line">(Value  Value   Value   Value   <span class="literal">None</span>    <span class="literal">None</span>    <span class="literal">None</span>    const)</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">63</span>      &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>这里需要先讲解一下mlir中的PresburgerSpace的变量类型<code>enum class VarKind &#123; Symbol, Local, Domain, Range, SetDim = Range &#125;;</code>:</p>
<ol type="1">
<li>Symbol, 表示一个固定但是展示未知的值.</li>
<li>Local, 表示的是存在量化变量(existentially quantified variables),
我理解就是farkas引理中的lambda系数, 可以通过约束求解来消除.
考虑这个一个space为<code>(x,exists q)</code>,
约束为<code>1 &lt;= x &lt;= 7, x = 2q</code>,
此时x为维度变量,q为存在量化变量,
即<code>(x) : (exists q : q &lt;= x &lt;= 7, x = 2q)</code>.
此时带入一些值进去,
可以得到满足约束的结果集<code>&#123;(2,1),(4,2),(6,3)&#125;</code></li>
<li>Dimension变量被进一步分为Domain 和 Range变量.</li>
</ol>
<p>在mlir中多面体是和ir深度结合的,比如这里的FlatAffineValueConstraints中是包含了PresburgerSpace以及AffineValue的,
上面输出依赖多面体中的Value列实际上就是一个affine ir的ssa value,
这个例子中其实就是四个迭代变量<code>%arg5,%arg6,%arg7,%arg8</code>.
并且access
relation中的<code>numDomainDims</code>和<code>numRangeDims</code>与presburger
space中的<code>numDomainVars</code>和<code>numRangeVars</code>并不是一致的.
上面两个约束他们的domainDims和RangeDims分别都是4和3,
但是这些dim对应的变量类型都是<code>SetDim = Range</code>,
所以上面两个relation的Ranges变量个数为<code>4+3=7</code></p>
<p>将两个relation写为isl的形式如下: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">srcRel = [i0,i1,i2,i3] -&gt; [l0,l1,l2] : </span><br><span class="line"> i0 == l0 <span class="keyword">and</span></span><br><span class="line"> i1 == l1 <span class="keyword">and</span> </span><br><span class="line"> i2 == l2 <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= i0 &lt; <span class="number">8</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= i1 &lt; <span class="number">128</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= i2 &lt; <span class="number">512</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= i3 &lt; <span class="number">384</span></span><br><span class="line">dstRel = [j0,j1,j2,j3] -&gt; [l0,l1,l2] : </span><br><span class="line"> j0 == l0 <span class="keyword">and</span></span><br><span class="line"> j1 == l1 <span class="keyword">and</span></span><br><span class="line"> j3 == l2 <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= j0 &lt; <span class="number">8</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= j1 &lt; <span class="number">128</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= j2 &lt; <span class="number">64</span> <span class="keyword">and</span></span><br><span class="line"> <span class="number">0</span> &lt;= j3 &lt; <span class="number">512</span></span><br></pre></td></tr></table></figure></p>
<p>这里获得对应的他们对应的domain:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FlatAffineValueConstraints srcDomain = srcRel.<span class="built_in">getDomainSet</span>();</span><br><span class="line">FlatAffineValueConstraints dstDomain = dstRel.<span class="built_in">getDomainSet</span>();</span><br></pre></td></tr></table></figure>
<p>此时srcDomain和dstDomain的约束多面体分别如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">srcDomain:</span><br><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">4</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">3</span></span><br><span class="line"><span class="number">11</span> constraints</span><br><span class="line">(Value  Value   Value   Value   Local   Local   Local   const)</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">383</span>     &gt;= <span class="number">0</span></span><br><span class="line"></span><br><span class="line">dstDomain:</span><br><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">4</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">3</span></span><br><span class="line"><span class="number">11</span> constraints</span><br><span class="line">(Value  Value   Value   Value   Local   Local   Local   const)</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">63</span>      &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>实际domain的约束多面体和access relation的多面体并无大的区别,
将一些变量的类型进行了转换, 同时作为一个set他是不存在domain dims和range
dims的.</p>
<p>然后组合两个<code>relation</code>,
这里的compose实际上等价<code>srcRel.apply_range(dstRel)</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">dstRel.<span class="built_in">inverse</span>();</span><br><span class="line">dstRel.<span class="built_in">compose</span>(srcRel); <span class="comment">// src.domain -&gt; [src.range == dst.domain] -&gt; dst.range</span></span><br></pre></td></tr></table></figure>
<p><code>compose</code>后此时<code>dstRel</code>为: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">8</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">0</span></span><br><span class="line"><span class="number">19</span> constraints</span><br><span class="line">(Value  Value   Value   Value   Value   Value   Value   Value   const)</span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">383</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">63</span>      &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">511</span>     &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>这里的Range为8是因为只存在上下两个循环迭代变量的range变量,
此时的domain dims和range dims均为4, 用isl形式表示应该是:
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123; [i0, i1, i2, i3] -&gt; [j0 = i0, j1 = i1, j2, j3 = i2] : <span class="number">0</span> &lt;= i0 &lt; <span class="number">8</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i1 &lt; <span class="number">128</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i2 &lt; <span class="number">512</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i3 &lt; <span class="number">384</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= j0 &lt; <span class="number">8</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= j1 &lt; <span class="number">128</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= j2 &lt; <span class="number">64</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= j3 &lt; <span class="number">512</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>得到新的<code>dstRel</code>后, 添加顺序约束,
也就是当他们的外侧还存在有共享循环时, 需要添加顺序约束,
目前这个例子中没有共享循环, 所以也不做什么. <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Add &#x27;src&#x27; happens before &#x27;dst&#x27; ordering constraints.</span></span><br><span class="line"><span class="built_in">addOrderingConstraints</span>(srcDomain, dstDomain, loopDepth, &amp;dstRel);</span><br></pre></td></tr></table></figure></p>
<p>最终就是检查约束<code>dstRel.isEmpty()</code>,
这里<code>isEmpty</code>检查的是否存在整数解,
也就是在当前order下上面的map约束是否能满足.</p>
<h2 id="getcomputationslicestate">3.3
<code>getComputationSliceState</code></h2>
<p>上面这个case检测到存在依赖, 接下来计算依赖的slice大小:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">mlir::affine::<span class="built_in">getComputationSliceState</span>(</span><br><span class="line">    Operation *depSourceOp, Operation *depSinkOp,</span><br><span class="line">    FlatAffineValueConstraints *dependenceConstraints, <span class="type">unsigned</span> loopDepth,</span><br><span class="line">    <span class="type">bool</span> isBackwardSlice, ComputationSliceState *sliceState)</span><br></pre></td></tr></table></figure>
<p>首先这个case传入的参数<code>depSourceOp</code>为前一个块的store,
<code>depSinkOp</code>为后一个块的load,<code>dependenceConstraints</code>为上一步计算得到的dst-&gt;src的map,
<code>loopDepth</code>为需要合并到的循环深度, 当前为1.
<code>isBackwardSlice</code>为true, 因为source op是在sink
op前执行的.</p>
<p>因为我们要计算的是插入到<code>loopDepth</code>时的slice大小,
那么第一步则是要删除所有高于<code>loopDepth</code>的维度.
因为是反向依赖, 所以dst loop的var在后面,
因此pos为<code>src loop nums + loopDepth = 5</code>,
然后num为<code>dst loop nums - loopDepth = 3</code> .</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Project out dimensions other than those up to &#x27;loopDepth&#x27;.</span></span><br><span class="line"><span class="type">unsigned</span> pos = isBackwardSlice ? numSrcLoopIVs + loopDepth : loopDepth;</span><br><span class="line"><span class="type">unsigned</span> num =</span><br><span class="line">    isBackwardSlice ? numDstLoopIVs - loopDepth : numSrcLoopIVs - loopDepth;</span><br><span class="line">dependenceConstraints-&gt;<span class="built_in">projectOut</span>(pos, num);</span><br></pre></td></tr></table></figure>
<p>消除不需要的变量后, <code>dependenceConstraints</code>为如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Domain: <span class="number">0</span>, Range: <span class="number">5</span>, Symbols: <span class="number">0</span>, Locals: <span class="number">0</span></span><br><span class="line"><span class="number">11</span> constraints</span><br><span class="line">(Value  Value   Value   Value   Value   const)</span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       = <span class="number">0</span></span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> -<span class="number">1</span>     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">7</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">127</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">511</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">0</span>       <span class="number">383</span>     &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       &gt;= <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       -<span class="number">1</span>      <span class="number">7</span>       &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>等价于: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123; [i0, i1, i2, i3] -&gt; [j0 = i0] : <span class="number">0</span> &lt;= i0 &lt;= <span class="number">7</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i1 &lt;= <span class="number">127</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i2 &lt;= <span class="number">511</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= i3 &lt;= <span class="number">383</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>获得循环迭代的SSAValue, 这里因为是backward,因此src变量的起点为0,
总个数在这个例子中为4. <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// Add slice loop IV values to &#x27;sliceState&#x27;.</span></span><br><span class="line"><span class="type">unsigned</span> offset = isBackwardSlice ? <span class="number">0</span> : loopDepth;</span><br><span class="line"><span class="type">unsigned</span> numSliceLoopIVs = isBackwardSlice ? numSrcLoopIVs : numDstLoopIVs;</span><br><span class="line">dependenceConstraints-&gt;<span class="built_in">getValues</span>(offset, offset + numSliceLoopIVs,</span><br><span class="line">                                  &amp;sliceState-&gt;ivs);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up lower/upper bound affine maps for the slice.</span></span><br><span class="line">sliceState-&gt;lbs.<span class="built_in">resize</span>(numSliceLoopIVs, <span class="built_in">AffineMap</span>());</span><br><span class="line">sliceState-&gt;ubs.<span class="built_in">resize</span>(numSliceLoopIVs, <span class="built_in">AffineMap</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get bounds for slice IVs in terms of other IVs, symbols, and constants.</span></span><br><span class="line">dependenceConstraints-&gt;<span class="built_in">getSliceBounds</span>(offset, numSliceLoopIVs,</span><br><span class="line">                                      depSourceOp-&gt;<span class="built_in">getContext</span>(),</span><br><span class="line">                                      &amp;sliceState-&gt;lbs, &amp;sliceState-&gt;ubs);</span><br></pre></td></tr></table></figure></p>
<p>更新后<code>sliceState-&gt;ivs</code>中存在了<code>i0,i1,i2,i3</code>四个变量.
同时为slice state的lower bounds 和 upper bounds分配好四个affine map,
并通过ir的连接关系得到这些affine map.
<code>getSliceBounds</code>是将从offset开始的前num个维度变量上下界作为剩余变量的map,
也就是说要基于上一步的依赖约束得到基于dst为domain所对应src
domain的上下界, 由于上一步中project掉了三个dst的循环变量, 因此bounds
map的domain维度为1, 同时因为<code>i0=j0</code>, 因此得到的lower
bounds为<code>[(d0) -&gt; (d0), (d0) -&gt; (0), (d0) -&gt; (0), (d0) -&gt; (0)]</code>,
upper
bounds为<code>[(d0) -&gt; (d0 + 1), (d0) -&gt; (128), (d0) -&gt; (512), (d0) -&gt; (384)]</code>.</p>
<p>接下来获取dst循环的iter var value, 因为这里project
out之后所以<code>numDimsAndSymbols</code>,
然后又跳过了<code>offset + numSliceLoopIVs</code>,
因此这里<code>sliceBoundOperands</code>只保留了一个<code>j0</code>.
然后将这个vector再分配给<code>lbOperands, ubOperands</code>.
最好这里的insertPoint就是dst loop在loop depth的位置.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">SmallVector&lt;Value, <span class="number">4</span>&gt; sliceBoundOperands;</span><br><span class="line"><span class="type">unsigned</span> numDimsAndSymbols = dependenceConstraints-&gt;<span class="built_in">getNumDimAndSymbolVars</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; numDimsAndSymbols; ++i) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i &lt; offset || i &gt;= offset + numSliceLoopIVs) &#123;</span><br><span class="line">    sliceBoundOperands.<span class="built_in">push_back</span>(dependenceConstraints-&gt;<span class="built_in">getValue</span>(i));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Give each bound its own copy of &#x27;sliceBoundOperands&#x27; for subsequent</span></span><br><span class="line"><span class="comment">// canonicalization.</span></span><br><span class="line">sliceState-&gt;lbOperands.<span class="built_in">resize</span>(numSliceLoopIVs, sliceBoundOperands);</span><br><span class="line">sliceState-&gt;ubOperands.<span class="built_in">resize</span>(numSliceLoopIVs, sliceBoundOperands);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set destination loop nest insertion point to block start at &#x27;dstLoopDepth&#x27;.</span></span><br><span class="line">sliceState-&gt;insertPoint =</span><br><span class="line">    isBackwardSlice ? dstLoopIVs[loopDepth - <span class="number">1</span>].<span class="built_in">getBody</span>()-&gt;<span class="built_in">begin</span>()</span><br><span class="line">                    : std::<span class="built_in">prev</span>(srcLoopIVs[loopDepth - <span class="number">1</span>].<span class="built_in">getBody</span>()-&gt;<span class="built_in">end</span>());</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时如果不考虑复杂的情况, sliceState就算是更新完毕了.
这里直接回到了canFuseLoops之后.</p>
<h1 id="isfusionprofitable">4. isFusionProfitable</h1>
<p>前面是遍历了dst循环的四个insert point,
检测在这些循环内能否插入source循环.在我们的这个例子中,
显然四个层级都可以插入source 循环.
那么就需要找到最合适的循环插入位置.</p>
<p>首先获得srcloop的循环变量, 然后拿到是两个循环分析结果.
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Compute cost of sliced and unsliced src loop nest.</span></span><br><span class="line">SmallVector&lt;AffineForOp, <span class="number">4</span>&gt; srcLoopIVs;</span><br><span class="line"><span class="built_in">getAffineForIVs</span>(*srcOpInst, &amp;srcLoopIVs);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Walk src loop nest and collect stats.</span></span><br><span class="line">LoopNestStats srcLoopNestStats;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">getLoopNestStats</span>(srcLoopIVs[<span class="number">0</span>], &amp;srcLoopNestStats))</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compute cost of dst loop nest.</span></span><br><span class="line">LoopNestStats dstLoopNestStats;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">getLoopNestStats</span>(dstForOp, &amp;dstLoopNestStats))</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后计算原始src loop的cost, 以及dst loop的cost <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Compute op instance count for the src loop nest without iteration slicing.</span></span><br><span class="line">  <span class="type">uint64_t</span> srcLoopNestCost = <span class="built_in">getComputeCost</span>(srcLoopIVs[<span class="number">0</span>], srcLoopNestStats);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compute src loop nest write region size.</span></span><br><span class="line">  <span class="function">MemRefRegion <span class="title">srcWriteRegion</span><span class="params">(srcStoreOpInst-&gt;getLoc())</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">failed</span>(srcWriteRegion.<span class="built_in">compute</span>(srcStoreOpInst, <span class="comment">/*loopDepth=*/</span><span class="number">0</span>))) &#123;</span><br><span class="line">    <span class="built_in">LLVM_DEBUG</span>(llvm::<span class="built_in">dbgs</span>()</span><br><span class="line">               &lt;&lt; <span class="string">&quot;Unable to compute MemRefRegion for source operation\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::optional&lt;<span class="type">int64_t</span>&gt; maybeSrcWriteRegionSizeBytes =</span><br><span class="line">      srcWriteRegion.<span class="built_in">getRegionSize</span>();</span><br><span class="line">  <span class="keyword">if</span> (!maybeSrcWriteRegionSizeBytes.<span class="built_in">has_value</span>())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="type">int64_t</span> srcWriteRegionSizeBytes = *maybeSrcWriteRegionSizeBytes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compute op instance count for the src loop nest.</span></span><br><span class="line">  <span class="type">uint64_t</span> dstLoopNestCost = <span class="built_in">getComputeCost</span>(dstForOp, dstLoopNestStats);</span><br></pre></td></tr></table></figure></p>
<p>然后开始固定每一种循环合并方式并计算fusion之后的cost
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> i = maxLegalFusionDepth; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">  <span class="type">const</span> ComputationSliceState &amp;slice = depthSliceUnions[i - <span class="number">1</span>];</span><br><span class="line">  <span class="comment">// Skip slice union if it wasn&#x27;t computed for this depth.</span></span><br><span class="line">  <span class="keyword">if</span> (slice.<span class="built_in">isEmpty</span>())</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int64_t</span> fusedLoopNestComputeCost;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getFusionComputeCost</span>(srcLoopIVs[<span class="number">0</span>], srcLoopNestStats, dstForOp,</span><br><span class="line">                            dstLoopNestStats, slice,</span><br><span class="line">                            &amp;fusedLoopNestComputeCost)) &#123;</span><br><span class="line">    <span class="built_in">LLVM_DEBUG</span>(llvm::<span class="built_in">dbgs</span>() &lt;&lt; <span class="string">&quot;Unable to compute fusion compute cost\n&quot;</span>);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="getfusioncomputecost">4.1 getFusionComputeCost</h1>
<p>进入基于当前的slice state计算循环次数,
这里<code>slice.ivs</code>包含了src的四个循环迭代变量, 将他们对应的for
op作为key, 循环次数作为value. <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  <span class="type">bool</span> mlir::affine::<span class="built_in">buildSliceTripCountMap</span>(</span><br><span class="line">    <span class="type">const</span> ComputationSliceState &amp;slice,</span><br><span class="line">    llvm::SmallDenseMap&lt;Operation *, <span class="type">uint64_t</span>, <span class="number">8</span>&gt; *tripCountMap) &#123;</span><br><span class="line">  <span class="type">unsigned</span> numSrcLoopIVs = slice.ivs.<span class="built_in">size</span>();</span><br><span class="line">  <span class="comment">// Populate map from AffineForOp -&gt; trip count</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; numSrcLoopIVs; ++i) &#123;</span><br><span class="line">    AffineForOp forOp = <span class="built_in">getForInductionVarOwner</span>(slice.ivs[i]);</span><br><span class="line">    <span class="keyword">auto</span> *op = forOp.<span class="built_in">getOperation</span>();</span><br><span class="line">    AffineMap lbMap = slice.lbs[i];</span><br><span class="line">    AffineMap ubMap = slice.ubs[i];</span><br><span class="line">    std::optional&lt;<span class="type">uint64_t</span>&gt; tripCount = <span class="built_in">getConstDifference</span>(lbMap, ubMap);</span><br><span class="line">    <span class="comment">// Slice bounds are created with a constant ub - lb difference.</span></span><br><span class="line">    <span class="keyword">if</span> (!tripCount.<span class="built_in">has_value</span>())</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    (*tripCountMap)[op] = *tripCount;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>当前的loop depth为4, 对应ComputationSliceState的lbs和ubs分别为:
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lbs[<span class="number">0</span>] : (d0, d1, d2, d3) -&gt; (d0)</span><br><span class="line">ubs[<span class="number">0</span>] : (d0, d1, d2, d3) -&gt; (d0 + <span class="number">1</span>)</span><br><span class="line">lbs[<span class="number">1</span>] : (d0, d1, d2, d3) -&gt; (d1)</span><br><span class="line">ubs[<span class="number">1</span>] : (d0, d1, d2, d3) -&gt; (d1 + <span class="number">1</span>)</span><br><span class="line">lbs[<span class="number">2</span>] : (d0, d1, d2, d3) -&gt; (d3)</span><br><span class="line">ubs[<span class="number">2</span>] : (d0, d1, d2, d3) -&gt; (d3 + <span class="number">1</span>)</span><br><span class="line">lbs[<span class="number">3</span>] : (d0, d1, d2, d3) -&gt; (<span class="number">0</span>)</span><br><span class="line">ubs[<span class="number">3</span>] : (d0, d1, d2, d3) -&gt; (<span class="number">384</span>)</span><br></pre></td></tr></table></figure> 最终得到tripCountMap中的trip
count则分别为<code>1,1,1,384</code>.</p>
<p>使用tripCountMap累乘得到所依赖的slice的循环次数,
当前为<code>384</code>. <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int64_t</span> sliceIterationCount = <span class="built_in">getSliceIterationCount</span>(sliceTripCountMap);</span><br></pre></td></tr></table></figure></p>
<p>最后, 计算当前slice的ComputeCost, 计算好后将cost添加到dst的insert
point, 再重新计算dst的compute cost.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Compute op instance count for the src loop nest with iteration slicing.</span></span><br><span class="line"><span class="type">int64_t</span> sliceComputeCost = <span class="built_in">getComputeCostHelper</span>(</span><br><span class="line">    srcForOp, srcStats, &amp;sliceTripCountMap, &amp;computeCostMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compute cost of fusion for this depth.</span></span><br><span class="line">computeCostMap[insertPointParent] = sliceComputeCost;</span><br><span class="line"></span><br><span class="line">*computeCost =</span><br><span class="line">    <span class="built_in">getComputeCostHelper</span>(dstForOp, dstStats,</span><br><span class="line">                         <span class="comment">/*tripCountOverrideMap=*/</span><span class="literal">nullptr</span>, &amp;computeCostMap);</span><br></pre></td></tr></table></figure>
<p>getComputeCostHelper是一个递归+回溯的过程, 首先逐渐递归到最内层循环,
获得当前计算的statement的cost.
假设上一步中<code>computeCostMap[insertPointParent] = 2364</code>,
那么在最内存循环原本的opCount为<code>6</code>,
检测到<code>computeCostMap</code>存在值,
那么累加opCount得到<code>2372</code>, 接下来在逐步累乘tirp count.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">getComputeCostHelper</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Operation *forOp, LoopNestStats &amp;stats,</span></span></span><br><span class="line"><span class="params"><span class="function">    llvm::SmallDenseMap&lt;Operation *, <span class="type">uint64_t</span>, <span class="number">8</span>&gt; *tripCountOverrideMap,</span></span></span><br><span class="line"><span class="params"><span class="function">    DenseMap&lt;Operation *, <span class="type">int64_t</span>&gt; *computeCostMap)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// &#x27;opCount&#x27; is the total number operations in one iteration of &#x27;forOp&#x27; body,</span></span><br><span class="line">  <span class="comment">// minus terminator op which is a no-op.</span></span><br><span class="line">  <span class="type">int64_t</span> opCount = stats.opCountMap[forOp] - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (stats.loopMap.<span class="built_in">count</span>(forOp) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> childForOp : stats.loopMap[forOp]) &#123;</span><br><span class="line">      opCount += <span class="built_in">getComputeCostHelper</span>(childForOp, stats, tripCountOverrideMap,</span><br><span class="line">                                      computeCostMap);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Add in additional op instances from slice (if specified in map).</span></span><br><span class="line">  <span class="keyword">if</span> (computeCostMap != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">auto</span> it = computeCostMap-&gt;<span class="built_in">find</span>(forOp);</span><br><span class="line">    <span class="keyword">if</span> (it != computeCostMap-&gt;<span class="built_in">end</span>()) &#123;</span><br><span class="line">      opCount += it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Override trip count (if specified in map).</span></span><br><span class="line">  <span class="type">int64_t</span> tripCount = stats.tripCountMap[forOp];</span><br><span class="line">  <span class="keyword">if</span> (tripCountOverrideMap != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">auto</span> it = tripCountOverrideMap-&gt;<span class="built_in">find</span>(forOp);</span><br><span class="line">    <span class="keyword">if</span> (it != tripCountOverrideMap-&gt;<span class="built_in">end</span>()) &#123;</span><br><span class="line">      tripCount = it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Returns the total number of dynamic instances of operations in loop body.</span></span><br><span class="line">  <span class="keyword">return</span> tripCount * opCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="update-bestdstloopdepth">4.2 Update bestDstLoopDepth</h1>
<p>计算到fuse loop的cost之后, 计算得到fusion后增加的计算比例系数:
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> additionalComputeFraction =</span><br><span class="line">    fusedLoopNestComputeCost /</span><br><span class="line">        (<span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(srcLoopNestCost) + dstLoopNestCost) -</span><br><span class="line">    <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>最终打印在每一个层的fuse之后的结果:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">evaluating fusion profitability at depth : <span class="number">4</span></span><br><span class="line"> additional compute fraction: <span class="number">5400.00</span>%</span><br><span class="line"> storage reduction factor: <span class="number">1.00</span>x</span><br><span class="line"> fused nest cost: <span class="number">77510737920</span></span><br><span class="line"> src write region size: <span class="number">2097152</span></span><br><span class="line"> slice write region size: <span class="number">2097152</span></span><br><span class="line"></span><br><span class="line">evaluating fusion profitability at depth : <span class="number">3</span></span><br><span class="line"> additional compute fraction: <span class="number">5400.00</span>%</span><br><span class="line"> storage reduction factor: <span class="number">1.00</span>x</span><br><span class="line"> fused nest cost: <span class="number">77510737920</span></span><br><span class="line"> src write region size: <span class="number">2097152</span></span><br><span class="line"> slice write region size: <span class="number">2097152</span></span><br><span class="line"></span><br><span class="line">evaluating fusion profitability at depth : <span class="number">2</span></span><br><span class="line"> additional compute fraction: <span class="number">0.00</span>%</span><br><span class="line"> storage reduction factor: <span class="number">1.00</span>x</span><br><span class="line"> fused nest cost: <span class="number">1409286144</span></span><br><span class="line"> src write region size: <span class="number">2097152</span></span><br><span class="line"> slice write region size: <span class="number">2097152</span></span><br><span class="line"></span><br><span class="line">evaluating fusion profitability at depth : <span class="number">1</span></span><br><span class="line"> additional compute fraction: <span class="number">0.00</span>%</span><br><span class="line"> storage reduction factor: <span class="number">1.00</span>x</span><br><span class="line"> fused nest cost: <span class="number">1409286144</span></span><br><span class="line"> src write region size: <span class="number">2097152</span></span><br><span class="line"> slice write region size: <span class="number">2097152</span></span><br></pre></td></tr></table></figure>
<p>最终他默认选择在更内层fusion:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">LoopFusion fusion stats:</span><br><span class="line">  best loop depth: <span class="number">2</span></span><br><span class="line">  src loop nest compute cost: <span class="number">1207959552</span></span><br><span class="line">  dst loop nest compute cost: <span class="number">201326592</span></span><br><span class="line">  fused loop nest compute cost: <span class="number">1409286144</span></span><br><span class="line">   src mem: <span class="number">9961472</span></span><br><span class="line">   dst mem: <span class="number">3407872</span></span><br><span class="line">   fused mem: <span class="number">5505024</span></span><br><span class="line">   slice mem: <span class="number">2097152</span></span><br><span class="line"> fusion is most profitable at depth <span class="number">2</span> with <span class="number">0</span>% redundant computation <span class="keyword">and</span> a <span class="number">58.823529</span>% storage reduction.</span><br><span class="line">Fused src loop <span class="number">0</span> into dst loop <span class="number">1</span> at depth <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">affine.<span class="keyword">for</span> %arg5 = <span class="number">0</span> to <span class="number">8</span> &#123;</span><br><span class="line">  affine.<span class="keyword">for</span> %arg6 = <span class="number">0</span> to <span class="number">128</span> &#123;</span><br><span class="line">    affine.<span class="keyword">for</span> %arg7 = <span class="number">0</span> to <span class="number">512</span> &#123;</span><br><span class="line">      affine.<span class="keyword">for</span> %arg8 = <span class="number">0</span> to <span class="number">384</span> &#123;</span><br><span class="line">        %<span class="number">0</span> = affine.load %arg0[%arg5, %arg6, %arg8] : memref&lt;<span class="number">8</span>x128x384xf32&gt;</span><br><span class="line">        %<span class="number">1</span> = affine.load %arg1[%arg5, %arg8, %arg7] : memref&lt;<span class="number">8</span>x384x512xf32&gt;</span><br><span class="line">        %<span class="number">2</span> = affine.load %arg2[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x512xf32&gt;</span><br><span class="line">        %<span class="number">3</span> = arith.mulf %<span class="number">0</span>, %<span class="number">1</span> : f32</span><br><span class="line">        %<span class="number">4</span> = arith.addf %<span class="number">2</span>, %<span class="number">3</span> : f32</span><br><span class="line">        affine.store %<span class="number">4</span>, %arg2[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x512xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    affine.<span class="keyword">for</span> %arg7 = <span class="number">0</span> to <span class="number">64</span> &#123;</span><br><span class="line">      affine.<span class="keyword">for</span> %arg8 = <span class="number">0</span> to <span class="number">512</span> &#123;</span><br><span class="line">        %<span class="number">0</span> = affine.load %arg2[%arg5, %arg6, %arg8] : memref&lt;<span class="number">8</span>x128x512xf32&gt;</span><br><span class="line">        %<span class="number">1</span> = affine.load %arg3[%arg5, %arg8, %arg7] : memref&lt;<span class="number">8</span>x512x64xf32&gt;</span><br><span class="line">        %<span class="number">2</span> = affine.load %arg4[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x64xf32&gt;</span><br><span class="line">        %<span class="number">3</span> = arith.mulf %<span class="number">0</span>, %<span class="number">1</span> : f32</span><br><span class="line">        %<span class="number">4</span> = arith.addf %<span class="number">2</span>, %<span class="number">3</span> : f32</span><br><span class="line">        affine.store %<span class="number">4</span>, %arg4[%arg5, %arg6, %arg7] : memref&lt;<span class="number">8</span>x128x64xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>affine loop fusion虽然最终的结果并不一定是好的,
因为他这里没有考虑内存层级以及数据复用等因素,
不过把这些内容作为约束多面体最佳使用实践来学习帮助非常大.</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mlir/" rel="tag">mlir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E9%9D%A2%E4%BD%93%E6%A8%A1%E5%9E%8B/" rel="tag">多面体模型</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/03/13/macos-bundle/">macos中bundle的使用</a><a class="next" href="/2023/12/29/tile-flow/">TileFlow: A Framework for Modeling Fusion Dataflow via Tree-based Analysis</a></div><script src="https://utteranc.es/client.js" repo="zhen8838/zhen8838.github.io" issue-term="url" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zhen8838.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>A Believing Heart Is Your Magic</p><a class="info-icon" href="mailto:597323109@qq.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/zhen8838" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">工具使用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6/">推理框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E8%AF%91%E5%99%A8/">编译器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97/">边缘计算</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%AD%B9%E5%AD%A6/">运筹学</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E6%A0%91/" style="font-size: 15px;">树</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Tensorflow/" style="font-size: 15px;">Tensorflow</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 15px;">树莓派</a> <a href="/tags/%E8%93%9D%E7%89%99/" style="font-size: 15px;">蓝牙</a> <a href="/tags/Matlab/" style="font-size: 15px;">Matlab</a> <a href="/tags/%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95/" style="font-size: 15px;">遗传算法</a> <a href="/tags/SVM/" style="font-size: 15px;">SVM</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 15px;">链表</a> <a href="/tags/%E5%8D%8A%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">半监督学习</a> <a href="/tags/GAN/" style="font-size: 15px;">GAN</a> <a href="/tags/%E6%A6%82%E7%8E%87%E8%AE%BA/" style="font-size: 15px;">概率论</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/%E9%A6%99%E6%A9%99%E6%B4%BE/" style="font-size: 15px;">香橙派</a> <a href="/tags/%E8%B8%A9%E5%9D%91%E7%BB%8F%E9%AA%8C/" style="font-size: 15px;">踩坑经验</a> <a href="/tags/LeetCode/" style="font-size: 15px;">LeetCode</a> <a href="/tags/Qt/" style="font-size: 15px;">Qt</a> <a href="/tags/%E5%A4%9A%E9%9D%A2%E4%BD%93%E6%A8%A1%E5%9E%8B/" style="font-size: 15px;">多面体模型</a> <a href="/tags/%E5%90%8E%E7%AB%AF%E4%BC%98%E5%8C%96/" style="font-size: 15px;">后端优化</a> <a href="/tags/Ampl/" style="font-size: 15px;">Ampl</a> <a href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 15px;">图像处理</a> <a href="/tags/K210/" style="font-size: 15px;">K210</a> <a href="/tags/%E4%BA%8C%E5%88%86%E6%B3%95/" style="font-size: 15px;">二分法</a> <a href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" style="font-size: 15px;">科学上网</a> <a href="/tags/%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0/" style="font-size: 15px;">损失函数</a> <a href="/tags/cmake/" style="font-size: 15px;">cmake</a> <a href="/tags/CPP/" style="font-size: 15px;">CPP</a> <a href="/tags/Conan/" style="font-size: 15px;">Conan</a> <a href="/tags/OrTools/" style="font-size: 15px;">OrTools</a> <a href="/tags/CSharp/" style="font-size: 15px;">CSharp</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA/" style="font-size: 15px;">数据增强</a> <a href="/tags/VAE/" style="font-size: 15px;">VAE</a> <a href="/tags/%E8%81%9A%E7%B1%BB%E6%96%B9%E6%B3%95/" style="font-size: 15px;">聚类方法</a> <a href="/tags/CostModel/" style="font-size: 15px;">CostModel</a> <a href="/tags/Vscode/" style="font-size: 15px;">Vscode</a> <a href="/tags/%E5%A3%B0%E9%9F%B3%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/" style="font-size: 15px;">声音信号处理</a> <a href="/tags/TVM/" style="font-size: 15px;">TVM</a> <a href="/tags/%E5%8A%A8%E6%80%81shape/" style="font-size: 15px;">动态shape</a> <a href="/tags/%E4%B8%AD%E7%AB%AF%E4%BC%98%E5%8C%96/" style="font-size: 15px;">中端优化</a> <a href="/tags/Equality-Saturation/" style="font-size: 15px;">Equality Saturation</a> <a href="/tags/stm32/" style="font-size: 15px;">stm32</a> <a href="/tags/Keras/" style="font-size: 15px;">Keras</a> <a href="/tags/Halide/" style="font-size: 15px;">Halide</a> <a href="/tags/DSL/" style="font-size: 15px;">DSL</a> <a href="/tags/%E5%A0%86%E6%A0%88/" style="font-size: 15px;">堆栈</a> <a href="/tags/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/" style="font-size: 15px;">大语言模型</a> <a href="/tags/llama/" style="font-size: 15px;">llama</a> <a href="/tags/%E5%BD%92%E4%B8%80%E5%8C%96/" style="font-size: 15px;">归一化</a> <a href="/tags/Makefile/" style="font-size: 15px;">Makefile</a> <a href="/tags/%E5%85%83%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">元学习</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">模板元编程</a> <a href="/tags/mindspore/" style="font-size: 15px;">mindspore</a> <a href="/tags/LLM/" style="font-size: 15px;">LLM</a> <a href="/tags/tvm/" style="font-size: 15px;">tvm</a> <a href="/tags/mlir/" style="font-size: 15px;">mlir</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%BB%BA%E6%A8%A1/" style="font-size: 15px;">性能建模</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/Nand2Tetris/" style="font-size: 15px;">Nand2Tetris</a> <a href="/tags/ncnn/" style="font-size: 15px;">ncnn</a> <a href="/tags/Numpy/" style="font-size: 15px;">Numpy</a> <a href="/tags/PCB/" style="font-size: 15px;">PCB</a> <a href="/tags/%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1/" style="font-size: 15px;">姿态估计</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B/" style="font-size: 15px;">人脸检测</a> <a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E9%87%8F%E5%8C%96/" style="font-size: 15px;">神经网络量化</a> <a href="/tags/Yolo/" style="font-size: 15px;">Yolo</a> <a href="/tags/Pytorch/" style="font-size: 15px;">Pytorch</a> <a href="/tags/NB-IOT/" style="font-size: 15px;">NB-IOT</a> <a href="/tags/Retinaface/" style="font-size: 15px;">Retinaface</a> <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" style="font-size: 15px;">目标检测</a> <a href="/tags/%E6%8C%87%E4%BB%A4%E9%9B%86/" style="font-size: 15px;">指令集</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 15px;">排序</a> <a href="/tags/%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/" style="font-size: 15px;">统计学习方法</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" style="font-size: 15px;">人脸识别</a> <a href="/tags/%E4%BC%98%E5%8C%96%E5%99%A8/" style="font-size: 15px;">优化器</a> <a href="/tags/%E5%90%B4%E6%81%A9%E8%BE%BE%E8%AF%BE%E7%A8%8B/" style="font-size: 15px;">吴恩达课程</a> <a href="/tags/WordCloud/" style="font-size: 15px;">WordCloud</a> <a href="/tags/Zhihu/" style="font-size: 15px;">Zhihu</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/%E5%9B%9B%E8%BD%B4%E9%A3%9E%E8%A1%8C%E5%99%A8/" style="font-size: 15px;">四轴飞行器</a> <a href="/tags/%E8%B5%84%E6%BA%90%E6%B1%87%E6%80%BB/" style="font-size: 15px;">资源汇总</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 15px;">分布式</a> <a href="/tags/%E6%97%A0%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">无监督学习</a> <a href="/tags/Apple/" style="font-size: 15px;">Apple</a> <a href="/tags/Jittor/" style="font-size: 15px;">Jittor</a> <a href="/tags/Tiramisu/" style="font-size: 15px;">Tiramisu</a> <a href="/tags/Triton/" style="font-size: 15px;">Triton</a> <a href="/tags/vllm/" style="font-size: 15px;">vllm</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/08/28/chimera/">Chimera: An Analytical Optimizing Framework for Effective Compute-intensive Operators Fusion</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/14/vllm/">推理框架调研</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/04/distal/">DISTAL: The Distributed Tensor Algebra Compiler</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/04/triton-cpu-lesson-1/">triton-cpu初体验</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/07/mesh-matmul/">分布式存储架构下的矩阵乘与编译器</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/08/mlc-tutorial/">机器学习编译概念科普</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/08/benchmark-notes/">benchmark的经验与技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/06/14/ampl-learn/">Ampl学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/05/08/constraints-solver-internals/">Constraints Solver Internals</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/30/model-driven-optimization/">Model Driven Optimization</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Zheng's Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>