<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2019-04-12">

<title>声音信号处理-STFT变化 – Zheng’s Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-7072389654d23eff08f359f9aa0d1ee7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Zheng’s Notes</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#变换方程" id="toc-变换方程" class="nav-link active" data-scroll-target="#变换方程">变换方程</a></li>
  <li><a href="#转换一个窗口的正弦波" id="toc-转换一个窗口的正弦波" class="nav-link" data-scroll-target="#转换一个窗口的正弦波">转换一个窗口的正弦波</a>
  <ul class="collapse">
  <li><a href="#观察上图" id="toc-观察上图" class="nav-link" data-scroll-target="#观察上图">观察上图:</a></li>
  </ul></li>
  <li><a href="#分析窗口" id="toc-分析窗口" class="nav-link" data-scroll-target="#分析窗口">分析窗口</a>
  <ul class="collapse">
  <li><a href="#矩形窗函数" id="toc-矩形窗函数" class="nav-link" data-scroll-target="#矩形窗函数">矩形窗函数</a></li>
  <li><a href="#汉明窗" id="toc-汉明窗" class="nav-link" data-scroll-target="#汉明窗">汉明窗</a></li>
  <li><a href="#布莱克曼窗" id="toc-布莱克曼窗" class="nav-link" data-scroll-target="#布莱克曼窗">布莱克曼窗</a></li>
  <li><a href="#布莱克曼哈里斯窗" id="toc-布莱克曼哈里斯窗" class="nav-link" data-scroll-target="#布莱克曼哈里斯窗">布莱克曼哈里斯窗</a></li>
  </ul></li>
  <li><a href="#结果比较" id="toc-结果比较" class="nav-link" data-scroll-target="#结果比较">结果比较</a></li>
  <li><a href="#窗口尺寸" id="toc-窗口尺寸" class="nav-link" data-scroll-target="#窗口尺寸">窗口尺寸</a></li>
  <li><a href="#奇偶窗口" id="toc-奇偶窗口" class="nav-link" data-scroll-target="#奇偶窗口">奇偶窗口</a></li>
  <li><a href="#fft尺寸" id="toc-fft尺寸" class="nav-link" data-scroll-target="#fft尺寸">FFT尺寸</a></li>
  <li><a href="#跳跃" id="toc-跳跃" class="nav-link" data-scroll-target="#跳跃">跳跃</a></li>
  <li><a href="#分析真实信号" id="toc-分析真实信号" class="nav-link" data-scroll-target="#分析真实信号">分析真实信号</a>
  <ul class="collapse">
  <li><a href="#分析stft的幅度谱和相位谱" id="toc-分析stft的幅度谱和相位谱" class="nav-link" data-scroll-target="#分析stft的幅度谱和相位谱">分析STFT的幅度谱和相位谱</a></li>
  </ul></li>
  <li><a href="#逆stft" id="toc-逆stft" class="nav-link" data-scroll-target="#逆stft">逆STFT</a></li>
  <li><a href="#编程指南" id="toc-编程指南" class="nav-link" data-scroll-target="#编程指南">编程指南</a>
  <ul class="collapse">
  <li><a href="#stft" id="toc-stft" class="nav-link" data-scroll-target="#stft">STFT</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">声音信号处理-STFT变化</h1>
  <div class="quarto-categories">
    <div class="quarto-category">深度学习</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 12, 2019</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>短时傅里叶变换</p>
<!--more-->
<section id="变换方程" class="level2">
<h2 class="anchored" data-anchor-id="变换方程">变换方程</h2>
<p><span class="math display">\[
\begin{align}
X_l[k]&amp;=\sum^{N/2-1}_{n=-N/2}w[n]x[n+lH]e^{-j2\pi kn/N}\ \ \ \ l=0,1,\ldots, \\
w&amp;= 分析窗口\\
l&amp;= 帧索引\\
H&amp;= 跳跃大小
\end{align}
\]</span></p>
<p>与<code>DFT</code>几乎没有大的区别,但是有了<code>l,H</code>,是对于一个时间段进行分析. 所以输出不是单个频谱而是一系列频谱,每一个频谱都有相同的长度,但是每一个都相同,因为输入的时间片段是不一样的.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.io.wavfile <span class="im">import</span> read</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> read(<span class="st">'../sounds/oboe-A4.wav'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.8</span><span class="op">*</span>fs)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> x[start:start<span class="op">+</span><span class="dv">3</span><span class="op">*</span>M]<span class="op">/</span><span class="bu">float</span>(<span class="bu">max</span>(x))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.plot(x0)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>, <span class="dv">3</span><span class="op">*</span>M, <span class="bu">min</span>(x0), <span class="bu">max</span>(x0)<span class="op">+</span><span class="fl">5.5</span>])</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> np.zeros(<span class="dv">3</span><span class="op">*</span>M)<span class="op">+</span>offset</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>x1[<span class="dv">0</span>:M] <span class="op">+=</span> (x0[<span class="dv">0</span>:M] <span class="op">*</span> np.hamming(M))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.plot(x1,<span class="st">'b'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="fl">2.5</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.zeros(<span class="dv">3</span><span class="op">*</span>M)<span class="op">+</span>offset</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>x2[H:M<span class="op">+</span>H] <span class="op">+=</span> (x0[H:M<span class="op">+</span>H] <span class="op">*</span> np.hamming(M))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>plt.plot(x2,<span class="st">'b'</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="fl">3.5</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.zeros(<span class="dv">3</span><span class="op">*</span>M)<span class="op">+</span>offset</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>x2[H<span class="op">*</span><span class="dv">2</span>:M<span class="op">+</span>H<span class="op">*</span><span class="dv">2</span>] <span class="op">+=</span> (x0[<span class="dv">2</span><span class="op">*</span>H:M<span class="op">+</span>H<span class="op">*</span><span class="dv">2</span>] <span class="op">*</span> np.hamming(M))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.plot(x2,<span class="st">'b'</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="fl">4.5</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.zeros(<span class="dv">3</span><span class="op">*</span>M)<span class="op">+</span>offset</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>x2[H<span class="op">*</span><span class="dv">3</span>:M<span class="op">+</span>H<span class="op">*</span><span class="dv">3</span>] <span class="op">+=</span> (x0[<span class="dv">3</span><span class="op">*</span>H:M<span class="op">+</span>H<span class="op">*</span><span class="dv">3</span>] <span class="op">*</span> np.hamming(M))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>plt.plot(x2,<span class="st">'b'</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="fl">5.5</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.zeros(<span class="dv">3</span><span class="op">*</span>M)<span class="op">+</span>offset</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>x2[H<span class="op">*</span><span class="dv">4</span>:M<span class="op">+</span>H<span class="op">*</span><span class="dv">4</span>] <span class="op">+=</span> (x0[<span class="dv">4</span><span class="op">*</span>H:M<span class="op">+</span>H<span class="op">*</span><span class="dv">4</span>] <span class="op">*</span> np.hamming(M))</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>plt.plot(x2,<span class="st">'b'</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_5_1.png" class="img-fluid"></p>
<p>可以从上图观察到每一个时间片段的计算情况. 通过使用分析窗口将声音加窗与计算.最后能获得所有声音作为基本片段的总和.</p>
</section>
<section id="转换一个窗口的正弦波" class="level2">
<h2 class="anchored" data-anchor-id="转换一个窗口的正弦波">转换一个窗口的正弦波</h2>
<p><span class="math display">\[
\begin{aligned}
x[n]&amp;=A_0cos(2 \pi k_0 n/N)=\frac{A_0}{2}e^{j2\pi k_0 n/N}+\frac{A_0}{2}e^{-j2\pi k_0 n/N} \\
X[k]&amp;=\sum^{N/2-1}_{n=-N/2}w[n]x[n]e^{-j2\pi kn/N}　\\
&amp;=\sum^{N/2-1}_{n=-N/2}w[n](\frac{A_0}{2}e^{j2\pi k_0 n/N}+\frac{A_0}{2}e^{-j2\pi k_0 n/N})e^{-j2\pi kn/N} \\
&amp;=\sum^{N/2-1}_{n=-N/2}w[n]\frac{A_0}{2}e^{j2\pi k_0 n/N}e^{-j2\pi kn/N}+\sum^{N/2-1}_{n=-N/2}w[n]\frac{A_0}{2}e^{-j2\pi k_0 n/N}e^{-j2\pi kn/N}\\
&amp;=\frac{A_0}{2}\sum^{N/2-1}_{n=-N/2}w[n]e^{-j2\pi(k-k_0)n/N}+\frac{A_0}{2}\sum^{N/2-1}_{n=-N/2}w[n]e^{-j2\pi(k+k_0)n/N} \\
&amp;=\frac{A_0}{2}W[k-k_0]+\frac{A_0}{2}W[k+k_0]
\end{aligned}
\]</span></p>
<p>首先一个正弦波可以分离成两个复数信号.一个具有正频率一个具有负频率.接下来我们将<code>x</code>带入<code>stft</code>方程中,经过化简得到结果.</p>
<p>结果即为此窗口信号的频谱,频率偏移了输入信号的频率,并乘上了幅度.当然还有另一半(负频率).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft, ifft</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">63</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>f0 <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>A0 <span class="op">=</span> <span class="fl">.8</span> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> (M<span class="op">+</span><span class="dv">1</span>)<span class="op">//</span><span class="dv">2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> np.zeros(N, dtype<span class="op">=</span><span class="st">'complex'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>X2 <span class="op">=</span> np.zeros(N, dtype<span class="op">=</span><span class="st">'complex'</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> A0 <span class="op">*</span> np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>f0<span class="op">/</span>fs<span class="op">*</span>np.arange(<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>,hM))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">7</span>))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.hanning(M)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'w (hanning window)'</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>, hM), w, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>, hM, <span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>fftbuffer[:hM] <span class="op">=</span> w[hM<span class="op">-</span><span class="dv">1</span>:]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>fftbuffer[N<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>:] <span class="op">=</span> w[:hM<span class="op">-</span><span class="dv">1</span>]  </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>X1[:hN] <span class="op">=</span> X[hN:]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>X1[N<span class="op">-</span>hN:] <span class="op">=</span> X[:hN]</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X1))       </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">2</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mW'</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">40</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>pX <span class="op">=</span> np.angle(X1)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pW'</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), np.unwrap(pX), <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="bu">min</span>(np.unwrap(pX)),<span class="bu">max</span>(np.unwrap(pX))])</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'xw (windowed sinewave)'</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>xw <span class="op">=</span> x<span class="op">*</span>w</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>, hM), xw, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>, hM, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>fftbuffer[<span class="dv">0</span>:hM] <span class="op">=</span> xw[hM<span class="op">-</span><span class="dv">1</span>:]</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>fftbuffer[N<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>:] <span class="op">=</span> xw[:hM<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>X2[:hN] <span class="op">=</span> X[hN:]</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>X2[N<span class="op">-</span>hN:] <span class="op">=</span> X[:hN]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>mX2 <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X2))  </span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mXW'</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX2, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">40</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>pX <span class="op">=</span> np.angle(X2)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">6</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pXW'</span>)</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), np.unwrap(pX), <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="bu">min</span>(np.unwrap(pX)),<span class="bu">max</span>(np.unwrap(pX))])</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_5_1.png" class="img-fluid"></p>
<section id="观察上图" class="level3">
<h3 class="anchored" data-anchor-id="观察上图">观察上图:</h3>
<p>第一幅图是一个<code>汉宁窗</code>,下面则是加窗之后的正弦波.上面左边分别为汉宁窗的幅度谱与相位谱.</p>
<p>当我们对加窗之后的正弦波进行<code>DFT</code>之后,可以看到得到的幅度谱与相位谱与上面相似,只是波峰点移动到了正弦波的频率处.并且由于正负频率特性,波形是对称的.</p>
</section>
</section>
<section id="分析窗口" class="level2">
<h2 class="anchored" data-anchor-id="分析窗口">分析窗口</h2>
<p>分析窗口通常一个实函数,并且在原点周围是对称的.</p>
<p>关于窗口,中间的主瓣我们主要关注主瓣宽度,对于旁瓣我们关注与旁瓣的最高水平.</p>
<section id="矩形窗函数" class="level3">
<h3 class="anchored" data-anchor-id="矩形窗函数">矩形窗函数</h3>
<p><span class="math display">\[
\begin{aligned}
w[n]&amp;=\begin{cases}
1,\ \ \ n=-M/2,\ldots,0,\ldots,M/2 \\
0,\ \ \ n=elsewhere
\end{cases}\\
W[k]&amp;=\frac{sin(\pi k)}{sin(\pi k/M)}
\end{aligned}
\]</span></p>
<p>矩形窗是最基础的窗函数,他的时域图形比较简单,但是频域图形相当有趣.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> M<span class="op">//</span><span class="dv">2</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>mX1 <span class="op">=</span> np.zeros(N)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>fftbuffer[hN<span class="op">-</span>hM:hN<span class="op">+</span>hM]<span class="op">=</span>np.ones(M)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), fftbuffer, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN, hN, <span class="dv">0</span>, <span class="fl">1.1</span>])</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'w (rectangular window), M = 64'</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X)) </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>mX1[:hN] <span class="op">=</span> mX[hN:]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>mX1[N<span class="op">-</span>hN:] <span class="op">=</span> mX[:hN]      </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX1<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">40</span>,<span class="dv">0</span>])</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mW, N = 1024'</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>plt.annotate(<span class="st">'main-lobe'</span>, xy<span class="op">=</span>(<span class="dv">0</span>,<span class="op">-</span><span class="dv">10</span>), xytext<span class="op">=</span>(<span class="op">-</span><span class="dv">200</span>, <span class="op">-</span><span class="dv">5</span>), fontsize<span class="op">=</span><span class="dv">16</span>, arrowprops<span class="op">=</span>(<span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>, width<span class="op">=</span><span class="dv">2</span>, headwidth<span class="op">=</span><span class="dv">6</span>, shrink<span class="op">=</span><span class="fl">0.01</span>)))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>plt.annotate(<span class="st">'highest side-lobe'</span>, xy<span class="op">=</span>(<span class="dv">32</span>,<span class="op">-</span><span class="dv">13</span>), xytext<span class="op">=</span>(<span class="dv">100</span>, <span class="op">-</span><span class="dv">10</span>), fontsize<span class="op">=</span><span class="dv">16</span>, arrowprops<span class="op">=</span>(<span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>, width<span class="op">=</span><span class="dv">2</span>, headwidth<span class="op">=</span><span class="dv">6</span>, shrink<span class="op">=</span><span class="fl">0.01</span>)))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"主瓣宽度:2bins</span><span class="ch">\n</span><span class="st">旁瓣最大值:-13.3dB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_9_1.png" class="img-fluid"></p>
<pre><code>主瓣宽度:2bins
旁瓣最大值:-13.3dB</code></pre>
</section>
<section id="汉明窗" class="level3">
<h3 class="anchored" data-anchor-id="汉明窗">汉明窗</h3>
<p>最常用的窗口函数,是一个升余弦函数.</p>
<p><span class="math display">\[
\begin{aligned}
w[n]&amp;=0.5+0.5cos(2\pi n/M),\ \ \ \ n=-M/2,\ldots,0,\ldots,M/2\\
W[k]&amp;=0.5D[k]+0.25(D[k-1]+D[k+1])\ \ \ \ where D[k]=\frac{sin(\pi k)}{sin(\pi k/M)}
\end{aligned}
  \]</span></p>
<p>他的主瓣宽度更宽,旁瓣宽度更低.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> M<span class="op">//</span><span class="dv">2</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>mX1 <span class="op">=</span> np.zeros(N)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="dv">4</span>))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>fftbuffer[hN<span class="op">-</span>hM:hN<span class="op">+</span>hM]<span class="op">=</span>np.hamming(M)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), fftbuffer, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN, hN, <span class="dv">0</span>, <span class="fl">1.1</span>])</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X)) </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>mX1[:hN] <span class="op">=</span> mX[hN:]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>mX1[N<span class="op">-</span>hN:] <span class="op">=</span> mX[:hN]      </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX1<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">60</span>,<span class="dv">0</span>])</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"主瓣宽度:4 bins</span><span class="ch">\n</span><span class="st">旁瓣最高:-42.7dB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_11_0.png" class="img-fluid"></p>
<pre><code>主瓣宽度:4 bins
旁瓣最高:-42.7dB</code></pre>
</section>
<section id="布莱克曼窗" class="level3">
<h3 class="anchored" data-anchor-id="布莱克曼窗">布莱克曼窗</h3>
<p>布莱克曼窗口是两个正弦曲线的总和.</p>
<p><span class="math display">\[
\begin{aligned}
w[n]=0.42-0.5cos(2\pi n/M)+0.08cos(4\pi n/M)
\end{aligned}
\]</span></p>
<p>他比汉明窗两侧少了一些突变.所以在旁瓣方面有着显著改善.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> signal</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> M<span class="op">//</span><span class="dv">2</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>mX1 <span class="op">=</span> np.zeros(N)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="dv">4</span>))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>fftbuffer[hN<span class="op">-</span>hM:hN<span class="op">+</span>hM]<span class="op">=</span>signal.blackmanharris(M)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), fftbuffer, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN, hN, <span class="dv">0</span>, <span class="fl">1.1</span>])</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X)) </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>mX1[:hN] <span class="op">=</span> mX[hN:]</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>mX1[N<span class="op">-</span>hN:] <span class="op">=</span> mX[:hN]      </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX1<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">110</span>,<span class="dv">0</span>])</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"主瓣宽度:6 bins</span><span class="ch">\n</span><span class="st">旁瓣最大值:-58dB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_13_1.png" class="img-fluid"></p>
<pre><code>主瓣宽度:6 bins
旁瓣最大值:-58dB</code></pre>
</section>
<section id="布莱克曼哈里斯窗" class="level3">
<h3 class="anchored" data-anchor-id="布莱克曼哈里斯窗">布莱克曼哈里斯窗</h3>
<p>这是一个特殊的窗口．</p>
<p><span class="math display">\[
\begin{aligned}
w(n)=\frac{1}{M}\sum^3_{l=0}\alpha_lcos(2nl\pi /M ),\ \ \ \ n=-M/2,\ldots,0,\ldots,M/2\\
where \alpha_0=0.35875\ \ \alpha_1=0.48829\ \ \alpha_0=0.14128\ \ \alpha_0=0.01168\ \
\end{aligned}
\]</span></p>
<p>可以说他基本没有旁瓣，他的旁瓣电平低于<code>-92dB</code>。以信噪比的方式去考虑，这是一个非常重要的数字，<code>92dB</code>基本上低于<code>16</code>的底噪。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> signal</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> M<span class="op">//</span><span class="dv">2</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>mX1 <span class="op">=</span> np.zeros(N)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="dv">4</span>))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>fftbuffer[hN<span class="op">-</span>hM:hN<span class="op">+</span>hM]<span class="op">=</span>signal.blackmanharris(M)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), fftbuffer, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN, hN, <span class="dv">0</span>, <span class="fl">1.1</span>])</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(X)) </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>mX1[:hN] <span class="op">=</span> mX[hN:]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>mX1[N<span class="op">-</span>hN:] <span class="op">=</span> mX[:hN]      </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX1<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN,<span class="op">-</span><span class="dv">110</span>,<span class="dv">0</span>])</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"主瓣宽度:8 bins</span><span class="ch">\n</span><span class="st">旁瓣最大值:-92dB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_15_1.png" class="img-fluid"></p>
<pre><code>主瓣宽度:8 bins
旁瓣最大值:-92dB</code></pre>
</section>
</section>
<section id="结果比较" class="level2">
<h2 class="anchored" data-anchor-id="结果比较">结果比较</h2>
<p>现在比较几个窗口的处理的不同输出结果：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, os, sys</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'../software/models/'</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dftModel <span class="im">as</span> DF</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> utilFunctions <span class="im">as</span> UF</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft, ifft</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> UF.wavread(<span class="st">'../sounds/oboe-A4.wav'</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>pin <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.ones(<span class="dv">501</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>hM1 <span class="op">=</span> <span class="bu">int</span>(math.floor((w.size<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">2</span>)) </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>hM2 <span class="op">=</span> <span class="bu">int</span>(math.floor(w.size<span class="op">/</span><span class="dv">2</span>))  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> x[pin<span class="op">-</span>hM1:pin<span class="op">+</span>hM2]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">7</span>))</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hM1, hM2), x1, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hM1, hM2, <span class="bu">min</span>(x1), <span class="bu">max</span>(x1)])</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'x (oboe-A4.wav)'</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, w, N)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> mX <span class="op">-</span> <span class="bu">max</span>(mX)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,N<span class="op">/</span><span class="dv">4</span>,<span class="op">-</span><span class="dv">70</span>,<span class="dv">0</span>])</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>plt.title (<span class="st">'mX (rectangular window)'</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.hamming(<span class="dv">501</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, w, N)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> mX <span class="op">-</span> <span class="bu">max</span>(mX)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,N<span class="op">/</span><span class="dv">4</span>,<span class="op">-</span><span class="dv">70</span>,<span class="dv">0</span>])</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>plt.title (<span class="st">'mX (hamming window)'</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.blackman(<span class="dv">501</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, w, N)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> mX <span class="op">-</span> <span class="bu">max</span>(mX)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">4</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,N<span class="op">/</span><span class="dv">4</span>,<span class="op">-</span><span class="dv">70</span>,<span class="dv">0</span>])</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>plt.title (<span class="st">'mX (blackman window)'</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_17_0.png" class="img-fluid"></p>
</section>
<section id="窗口尺寸" class="level2">
<h2 class="anchored" data-anchor-id="窗口尺寸">窗口尺寸</h2>
<p>窗口的尺寸当然可以变化,但是尺寸的变化影响着什么? 看下面这个例子:</p>
<p>小窗口我们可以看到谐波很少,信息很少,样本很少.</p>
<p>大窗口样本很多,可以看到更多的声音细节,但是噪音也更加多.</p>
<p>所以这将是一个重要的选择.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> UF.wavread(<span class="st">'../sounds/oboe-A4.wav'</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.81</span><span class="op">*</span>fs)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> x[start:start<span class="op">+</span>N] </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">321</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(start, (start<span class="op">+</span>N), <span class="fl">1.0</span>)<span class="op">/</span>fs, x1<span class="op">*</span>np.hamming(N), <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>plt.axis([start<span class="op">/</span>fs, (start<span class="op">+</span>N)<span class="op">/</span>fs, <span class="bu">min</span>(x1<span class="op">*</span>np.hamming(N)), <span class="bu">max</span>(x1<span class="op">*</span>np.hamming(N))])</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'x1, M = 128'</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, np.hamming(N), N)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">323</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">2.0</span>,<span class="op">-</span><span class="dv">90</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX1'</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">325</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), pX, <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">2.0</span>,<span class="bu">min</span>(pX),<span class="bu">max</span>(pX)])</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pX1'</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.81</span><span class="op">*</span>fs)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> x[start:start<span class="op">+</span>N]</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x2, np.hamming(N), N)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">322</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(start, (start<span class="op">+</span>N), <span class="fl">1.0</span>)<span class="op">/</span>fs, x2<span class="op">*</span>np.hamming(N), <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>plt.axis([start<span class="op">/</span>fs, (start<span class="op">+</span>N)<span class="op">/</span>fs, <span class="bu">min</span>(x2), <span class="bu">max</span>(x2)])</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'x2, M = 1024'</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">324</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">2.0</span>,<span class="op">-</span><span class="dv">90</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX2'</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">326</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), pX, <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">2.0</span>,<span class="bu">min</span>(pX),<span class="bu">max</span>(pX)])</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pX2'</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_19_0.png" class="img-fluid"></p>
</section>
<section id="奇偶窗口" class="level2">
<h2 class="anchored" data-anchor-id="奇偶窗口">奇偶窗口</h2>
<p>另外的一个问题是,即使一个微小的差异(窗口的奇偶不同),对于相位谱影响巨大.</p>
<p>当我们做<code>fft</code>的时候,最好使用奇数窗口,这样我们的相位谱可以正好对称.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft, fftshift</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> signal</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> M<span class="op">//</span><span class="dv">2</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> signal.blackman(M)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hM, hM), w, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hM, hM<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">1.05</span>])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'w1, M=32'</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)                         </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>fftbuffer[:hM] <span class="op">=</span> w[hM:] </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>fftbuffer[N<span class="op">-</span>hM:] <span class="op">=</span> w[:hM]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(fftshift(X)))    </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN<span class="op">//</span><span class="dv">2</span>,hN<span class="op">//</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">80</span>,<span class="dv">1</span>])</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mW1'</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>pX <span class="op">=</span> np.angle(fftshift(X))</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">5</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), pX, <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span>np.pi,np.pi])</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pW1'</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">31</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>hN <span class="op">=</span> N<span class="op">//</span><span class="dv">2</span>     </span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>hM <span class="op">=</span> (M<span class="op">+</span><span class="dv">1</span>)<span class="op">//</span><span class="dv">2</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> signal.blackman(M)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hM, hM<span class="op">-</span><span class="dv">1</span>), w, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hM, hM, <span class="dv">0</span>, <span class="fl">1.05</span>])</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'w2, M=31'</span>)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>fftbuffer <span class="op">=</span> np.zeros(N) </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>fftbuffer[:hM] <span class="op">=</span> w[hM<span class="op">-</span><span class="dv">1</span>:] </span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>fftbuffer[N<span class="op">-</span>hM<span class="op">+</span><span class="dv">1</span>:] <span class="op">=</span> w[:hM<span class="op">-</span><span class="dv">1</span>]                         </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fft(fftbuffer)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>mX <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.log10(<span class="bu">abs</span>(fftshift(X)))    </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), mX<span class="op">-</span><span class="bu">max</span>(mX), <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN<span class="op">/</span><span class="dv">2</span>,hN<span class="op">/</span><span class="dv">2</span><span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">80</span>,<span class="dv">1</span>])</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mW2'</span>)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>pX <span class="op">=</span> np.angle(fftshift(X))</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">6</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN, hN), pX, <span class="st">'c'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span>hN,hN<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span>np.pi,np.pi])</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pW2'</span>)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_21_1.png" class="img-fluid"></p>
</section>
<section id="fft尺寸" class="level2">
<h2 class="anchored" data-anchor-id="fft尺寸">FFT尺寸</h2>
<p>从给定的512窗口大小开始,我们选择不同的<code>FFT</code>尺寸,第一幅图我们可以得到一个不错的图.当尺寸更大的时候我们可以得到更加光滑的图片.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, os, sys</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> UF.wavread(<span class="st">'../sounds/oboe-A4.wav'</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.8</span><span class="op">*</span>fs)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> x[start:start<span class="op">+</span>M]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>xw <span class="op">=</span> x1 <span class="op">*</span> np.hamming(M) </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">311</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(start, (start<span class="op">+</span>M), <span class="fl">1.0</span>)<span class="op">/</span>fs, xw, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>plt.axis([start<span class="op">/</span>fs, (start<span class="op">+</span>M)<span class="op">/</span>fs, <span class="bu">min</span>(xw), <span class="bu">max</span>(xw)])</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'x (oboe-A4.wav), M = 512'</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, np.hamming(N), N)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">312</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">4.0</span>,<span class="op">-</span><span class="dv">85</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX, N = 512'</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.8</span><span class="op">*</span>fs)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> x[start:start<span class="op">+</span>M]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>xw <span class="op">=</span> x1 <span class="op">*</span> np.hamming(M)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> DF.dftAnal(x1, np.hamming(M), N)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">313</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>plt.plot((fs<span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span>np.arange(mX.size)<span class="op">/</span><span class="bu">float</span>(mX.size), mX, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>,fs<span class="op">/</span><span class="fl">4.0</span>,<span class="op">-</span><span class="dv">85</span>,<span class="bu">max</span>(mX)])</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX, N = 2048'</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_23_0.png" class="img-fluid"></p>
</section>
<section id="跳跃" class="level2">
<h2 class="anchored" data-anchor-id="跳跃">跳跃</h2>
<p>这是窗函数的步进长度,称为跳跃. 下面展示两个不同的跳跃大小所带来的变化.</p>
<p>第一个例子,窗口大小为<code>201</code>,跳跃大小为<code>100</code>,大约窗大小的一半.红色线条是窗口的总和,可以看到这个总和不是很好,在震荡.</p>
<p>第二个例子,跳跃大小为窗口大小的四分之一.现在所得到的总和就是我们所需要的.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">201</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> signal.blackman(M)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> w<span class="op">/</span><span class="bu">sum</span>(w)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.zeros(N)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>pin <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>pend <span class="op">=</span> N <span class="op">-</span> M</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">211</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> pin<span class="op">&lt;</span>pend:</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    y [pin:pin<span class="op">+</span>M] <span class="op">+=</span> w1<span class="op">*</span>H</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.arange(pin, pin<span class="op">+</span>M), w, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    pin <span class="op">+=</span> H</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">0</span>, N), y, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>, N<span class="op">-</span>H, <span class="dv">0</span>, <span class="bu">max</span>(y)<span class="op">+</span><span class="fl">.01</span>])</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Blackman, M=201, H=100'</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.zeros(N)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>pin <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>pend <span class="op">=</span> N <span class="op">-</span> M</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">212</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> pin<span class="op">&lt;</span>pend:</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    y [pin:pin<span class="op">+</span>M] <span class="op">+=</span> w1<span class="op">*</span>H</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.arange(pin, pin<span class="op">+</span>M), w, <span class="st">'b'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    pin <span class="op">+=</span> H</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">0</span>, N), y, <span class="st">'r'</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="dv">0</span>, N<span class="op">-</span>H, <span class="dv">0</span>, <span class="bu">max</span>(y)<span class="op">+</span><span class="fl">.01</span>])</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Blackman, M=201, H=50'</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_25_0.png" class="img-fluid"></p>
</section>
<section id="分析真实信号" class="level2">
<h2 class="anchored" data-anchor-id="分析真实信号">分析真实信号</h2>
<p>终于我们掌握了基本原理,可以来分析一下真实的信号:</p>
<p>在第一幅图上我们看到的是幅度谱.经过<code>STFT</code>的分析,得到是一个<code>DFT</code>序列.纵轴是频率,横轴是时间,颜色强度是对应的幅值.实际上这就是常说的语谱图.</p>
<p>这里我们可以清楚的看到钢琴的四次敲击,以及横轴对钢琴的谐波反应.对于窗口的大小,如果窗口小,可以得到一个好的时间分辨率,大的窗口会得到较好的频率分辨率.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, os, sys</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stft <span class="im">as</span> STFT</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> utilFunctions <span class="im">as</span> UF</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> hamming</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> UF.wavread(<span class="st">'../sounds/piano.wav'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.hamming(<span class="dv">256</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>mX1, pX1 <span class="op">=</span> STFT.stftAnal(x, w, N, H)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">211</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>numFrames <span class="op">=</span> <span class="bu">int</span>(mX1[:,<span class="dv">0</span>].size)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>frmTime <span class="op">=</span> H<span class="op">*</span>np.arange(numFrames)<span class="op">/</span><span class="bu">float</span>(fs)                             </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>binFreq <span class="op">=</span> np.arange(mX1[<span class="dv">0</span>,:].size)<span class="op">*</span><span class="bu">float</span>(fs)<span class="op">/</span>N                         </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>plt.pcolormesh(frmTime, binFreq, np.transpose(mX1),cmap<span class="op">=</span>plt.get_cmap(<span class="st">'rainbow'</span>))</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX (piano.wav), M=256, N=256, H=128'</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>plt.autoscale(tight<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.hamming(<span class="dv">1024</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>mX2, pX2 <span class="op">=</span> STFT.stftAnal(x, w, N, H)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">212</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>numFrames <span class="op">=</span> <span class="bu">int</span>(mX2[:,<span class="dv">0</span>].size)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>frmTime <span class="op">=</span> H<span class="op">*</span>np.arange(numFrames)<span class="op">/</span><span class="bu">float</span>(fs)                             </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>binFreq <span class="op">=</span> np.arange(mX2[<span class="dv">0</span>,:].size)<span class="op">*</span><span class="bu">float</span>(fs)<span class="op">/</span>N                         </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>plt.pcolormesh(frmTime, binFreq, np.transpose(mX2),cmap<span class="op">=</span>plt.get_cmap(<span class="st">'rainbow'</span>))</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX (piano.wav), M=1024, N=1024, H=128'</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>plt.autoscale(tight<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_27_0.png" class="img-fluid"></p>
<section id="分析stft的幅度谱和相位谱" class="level3">
<h3 class="anchored" data-anchor-id="分析stft的幅度谱和相位谱">分析STFT的幅度谱和相位谱</h3>
<p>我们也可以可视化幅度谱和相位谱</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stft <span class="im">as</span> STFT</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> utilFunctions <span class="im">as</span> UF</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> hamming</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>(fs, x) <span class="op">=</span> UF.wavread(<span class="st">'../sounds/piano.wav'</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.hamming(<span class="dv">1001</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>mX, pX <span class="op">=</span> STFT.stftAnal(x, w, N, H)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">9.5</span>, <span class="dv">6</span>))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">211</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>numFrames <span class="op">=</span> <span class="bu">int</span>(mX[:,<span class="dv">0</span>].size)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>frmTime <span class="op">=</span> H<span class="op">*</span>np.arange(numFrames)<span class="op">/</span><span class="bu">float</span>(fs)                             </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>binFreq <span class="op">=</span> np.arange(N<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">1</span>)<span class="op">*</span><span class="bu">float</span>(fs)<span class="op">/</span>N                         </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>plt.pcolormesh(frmTime, binFreq, np.transpose(mX),cmap<span class="op">=</span>plt.get_cmap(<span class="st">'rainbow'</span>))</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'mX (piano.wav), M=1001, N=1024, H=256'</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>plt.autoscale(tight<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">212</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>numFrames <span class="op">=</span> <span class="bu">int</span>(pX[:,<span class="dv">0</span>].size)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>frmTime <span class="op">=</span> H<span class="op">*</span>np.arange(numFrames)<span class="op">/</span><span class="bu">float</span>(fs)                             </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>binFreq <span class="op">=</span> np.arange(N<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">1</span>)<span class="op">*</span><span class="bu">float</span>(fs)<span class="op">/</span>N                         </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>plt.pcolormesh(frmTime, binFreq, np.diff(np.transpose(pX),axis<span class="op">=</span><span class="dv">0</span>),cmap<span class="op">=</span>plt.get_cmap(<span class="st">'rainbow'</span>))</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'pX derivative (piano.wav), M=1001, N=1024, H=256'</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>plt.autoscale(tight<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_29_0.png" class="img-fluid"></p>
</section>
</section>
<section id="逆stft" class="level1">
<h1>逆STFT</h1>
<p>与IDFT相同,我们当然可以计算ISTFT.因为STFT计算出每个帧单独的频谱,所以我们采用每个帧的逆变换,最终累加. <span class="math display">\[
\begin{aligned}
    y[n]=\sum^{L-1}_{l=0}Shift_{lH,n}[\frac{1}{N}\sum^{N/2-1}_{k=-N/2}X_l[k]e^{j2\pi kn/N}]
\end{aligned}
\]</span> 每次的输出帧: <span class="math display">\[
\begin{aligned}
    yw_l[n]=x(n+lH)w[n]
\end{aligned}
\]</span> 以及输出音频信号: <span class="math display">\[
\begin{aligned}
    y[n]=\sum^{L-1}_{l=0}yw_l[n]=x[n]\sum^{L-1}_{l=0}w[n-lH]
\end{aligned}
\]</span></p>
</section>
<section id="编程指南" class="level1">
<h1>编程指南</h1>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> get_window</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>M<span class="op">=</span><span class="dv">63</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>window<span class="op">=</span>get_window(<span class="st">'hanning'</span>,M) <span class="co"># 获得窗</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>hM1<span class="op">=</span><span class="bu">int</span>(math.floor((M<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>hM2<span class="op">=</span><span class="bu">int</span>(math.floor(M<span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 填充 </span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">512</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>hN<span class="op">=</span><span class="bu">int</span>(N<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>fftbuffer<span class="op">=</span>np.zeros(N)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>fftbuffer[:hM1]<span class="op">=</span>window[hM2:]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>fftbuffer[N<span class="op">-</span>hM2:]<span class="op">=</span>window[:hM2]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># fft</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>fft(fftbuffer)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>absX<span class="op">=</span><span class="bu">abs</span>(X)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 保证小于一个最小值</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>absX[absX<span class="op">&lt;</span>np.finfo(<span class="bu">float</span>).eps]<span class="op">=</span>np.finfo(<span class="bu">float</span>).eps</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>mX<span class="op">=</span><span class="dv">20</span><span class="op">*</span>np.log10(absX)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>pX<span class="op">=</span>np.angle(X)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>mX1<span class="op">=</span>np.zeros(N)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>pX1<span class="op">=</span>np.zeros(N)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>mX1[:hN]<span class="op">=</span>mX[hN:]</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>mX1[N<span class="op">-</span>hN:]<span class="op">=</span>mX[:hN]</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>pX1[:hN]<span class="op">=</span>pX[hN:]</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>pX1[N<span class="op">-</span>hN:]<span class="op">=</span>pX[:hN]</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="op">-</span>hN,hN)<span class="op">/</span><span class="bu">float</span>(N)<span class="op">*</span>M,mX1<span class="op">-</span><span class="bu">max</span>(mX1))</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span><span class="dv">20</span>,<span class="dv">20</span>,<span class="op">-</span><span class="dv">80</span>,<span class="dv">0</span>])</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_33_0.png" class="img-fluid"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> get_window</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.fftpack <span class="im">import</span> fft</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'../software/models/'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dftModel <span class="im">as</span> DFT</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>fs<span class="op">=</span><span class="dv">44100</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>f<span class="op">=</span><span class="fl">5000.0</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>M<span class="op">=</span><span class="dv">101</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>f<span class="op">*</span>np.arange(M)<span class="op">/</span>fs)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">512</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>w<span class="op">=</span>get_window(<span class="st">'hamming'</span>,M)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>mX,pX<span class="op">=</span>DFT.dftAnal(x,w,N)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">0</span>,fs<span class="op">//</span><span class="dv">2</span>,fs<span class="op">//</span>N),mX<span class="op">-</span><span class="bu">max</span>(mX))</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_34_0.png" class="img-fluid"></p>
<section id="stft" class="level2">
<h2 class="anchored" data-anchor-id="stft">STFT</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os,sys</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> get_window</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'../software/models/'</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> utilFunctions <span class="im">as</span> UF</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stft <span class="im">as</span> STFT</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>inputfile<span class="op">=</span><span class="st">'../sounds/flute-A4.wav'</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>window<span class="op">=</span><span class="st">'hamming'</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>M<span class="op">=</span><span class="dv">801</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">1024</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>H<span class="op">=</span><span class="dv">400</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>fs,x<span class="op">=</span>UF.wavread(inputfile)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>w<span class="op">=</span>get_window(window,M)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>mX,pX<span class="op">=</span>STFT.stftAnal(x,w,N,H)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plt.pcolor(mX.T,cmap<span class="op">=</span>plt.get_cmap(<span class="st">'rainbow'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="stft/output_37_1.png" class="img-fluid"></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/zhen8838\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="zhen8838/zhen8838.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>