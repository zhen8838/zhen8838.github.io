---
title: "æ¢ç´¢AMX: è§£é”Apple Siliconéšè—æ€§èƒ½"
mathjax: true
toc: true
categories:
  - ä½“ç³»ç»“æ„
date: 2024-04-23 18:17:49
tags:
- æŒ‡ä»¤é›†
- Apple
---

è‡ªä»2020å¹´Appleå‘å¸ƒçš„èŠ¯ç‰‡M1/M2/M3, è‡³å°‘æä¾›äº†å››ç§ä¸åŒçš„æ–¹å¼å¯ä»¥æ‰§è¡Œé«˜è´Ÿè½½çš„è®¡ç®—ä»»åŠ¡:

1. æ ‡å‡†çš„ARMv8 SIMD/NEONå‘é‡æŒ‡ä»¤é›†.

2. è‹¹æœå°šæœªå…¬å¼€æ–‡æ¡£çš„AMX(Apple Matrix Co-processor)æŒ‡ä»¤é›†, ç”±CPUå‘å°„, åœ¨ç‰¹æ®Šçš„åŠ é€Ÿå™¨ä¸Šè¿è¡Œ.

3. ç¥ç»ç½‘ç»œå¤„ç†å™¨ANE(Apple Neural Engine)

4. Metal GPU

åœ¨M1 Maxä¸Šå•æ ¸è®¡ç®—å•ç²¾åº¦æµ®ç‚¹çŸ©é˜µä¹˜æ³•æ—¶, ä½¿ç”¨SIMDæŒ‡ä»¤é›†[å¯è¾¾åˆ°102 GFLOPSå·¦å³çš„æ€§èƒ½](https://zhuanlan.zhihu.com/p/464740681), è€Œä½¿ç”¨AMXæŒ‡ä»¤é›†æœ€å¤š[å¯è¾¾åˆ°**1475** GFLOPS!](https://github.com/corsix/amx/blob/main/fma.md#performance-m1-max) æœ¬æ–‡å°±æ¥å¸¦é¢†å¤§å®¶ä¸€åŒæ¢ç´¢AMXæŒ‡ä»¤é›†, å­¦ä¹ å¦‚ä½•è§£é”è¿™å‰©ä¸‹çš„14å€ç®—åŠ›.

<!--more-->


# 1. æ¦‚è¿°

å…ˆé€šè¿‡ä¸€å¼ å›¾å»ºç«‹èµ·å¯¹äºAMXåˆæ­¥äº†è§£. è€ƒè™‘ä¸€ä¸ª32x32çš„è®¡ç®—å•å…ƒç½‘æ ¼, æ¯ä¸ªå•å…ƒå¯ä»¥æ‰§è¡Œ16ä½ä¹˜ç§¯, æˆ–è€…2x2å•å…ƒå­ç½‘æ ¼å¯ä»¥æ‰§è¡Œ32ä½ä¹˜ç§¯, æˆ–è€…4x4å­ç½‘æ ¼å¯ä»¥æ‰§è¡Œ64ä½ä¹˜ç§¯. ä¸ºäº†æä¾›æ­¤ç½‘æ ¼çš„è¾“å…¥, æœ‰ä¸€ä¸ªåŒ…å«32ä¸ª16ä½å…ƒç´ (æˆ–16ä¸ª32ä½å…ƒç´ , æˆ–8ä¸ª64ä½å…ƒç´ )çš„Xå¯„å­˜å™¨æ± , ä»¥åŠä¸€ä¸ªåŒæ ·åŒ…å«32ä¸ª16ä½å…ƒç´ (æˆ–16ä¸ª32ä½å…ƒç´ , æˆ–8ä¸ª64ä½å…ƒç´ )çš„Yå¯„å­˜å™¨æ± . ä½¿ç”¨å•ä¸ªæŒ‡ä»¤å¯ä»¥æ‰§è¡Œå®Œæ•´çš„å¤–ç§¯: å°†Xå¯„å­˜å™¨çš„æ¯ä¸ªå…ƒç´ ä¸Yå¯„å­˜å™¨çš„æ¯ä¸ªå…ƒç´ ç›¸ä¹˜, å¹¶åœ¨ç›¸åº”ä½ç½®ä¸Zå…ƒç´ ä¸€èµ·ç´¯åŠ . æˆ–è€…å¯ä»¥å°†Xå¯„å­˜å™¨çš„æ¯ä¸ªå…ƒç´ ä¸Yå¯„å­˜å™¨çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œå†…ç§¯, å¾—åˆ°ä¸€ä¸ªç‚¹çš„ç»“æœ.

![ä¸“åˆ© US20180074824A1](mac-amx/fig2.png)

AMXä¸ºä»¥ä¸Šçš„æ“ä½œæä¾›äº†LDX/LDY, FMA, LDZ/SDZç­‰æŒ‡ä»¤. å…¶ä¸­FMAåˆ†ä¸ºMatrix Modeå’ŒVector Modeåˆ†åˆ«å¯¹åº”å¤–ç§¯ä¸å†…ç§¯ä¸¤ç§ä¸åŒçš„è®¡ç®—æ–¹å¼. å½“ç„¶æˆ‘ä»¬é¦–é€‰å¤–ç§¯, å¦åˆ™æ— æ³•æœ€å¤§åŒ–åˆ©ç”¨ç¡¬ä»¶. ä¸‹é¢ä¸¤å¼ å›¾åˆ†åˆ«å±•ç¤ºäº†å†…ç§¯ä¸å¤–ç§¯çš„è®¡ç®—æ–¹å¼:

![å†…ç§¯](mac-amx/inner%20product.png)

![å¤–ç§¯](mac-amx/outer%20product.png)

# 2. æœ€å°è®¡ç®—æµç¨‹

ä¸‹é¢åŒæ ·é€šè¿‡ä¸€å¼ å›¾è§£é‡Šæ¸…æ¥šAMXä¸­çš„å¯„å­˜å™¨è§„æ ¼ä¸æœ€å°è®¡ç®—æµç¨‹. é¦–å…ˆæ˜¯X/Yå¯„å­˜å™¨æ± , ä»–ä»¬å„æœ‰8ä¸ªå®½åº¦ä¸º64 bytesçš„å¯„å­˜å™¨, å¯ä»¥å­˜å‚¨fp16/32/64æˆ–è€…i8/16/32,u8/16/32ç±»å‹çš„æ•°æ®. æ¥ç€æ˜¯Zå¯„å­˜å™¨æ± , ä»–æœ‰64ä¸ªå®½åº¦ä¸º64 bytesçš„å¯„å­˜å™¨, ç”¨äºå­˜å‚¨X/Yå¯„å­˜å™¨å¤–ç§¯æˆ–å†…ç§¯çš„ç»“æœ. æ ¹æ®ç¬¬ä¸€èŠ‚ä¸­æè¿°, 2x2å•å…ƒå­ç½‘æ ¼æ¥æ‰§è¡Œ32ä½ä¹˜ç§¯, å› æ­¤æ‰§è¡Œå¤–ç§¯æ—¶éœ€è¦ç”¨åˆ°16ä¸ªå¯„å­˜å™¨, å› æ­¤64ä¸ªå¯„å­˜å™¨è¢«åˆ†16ç»„, æ¯ç»„çš„é—´éš”ä¸º4(64/16), å³å¤–ç§¯ç»“æœå¹¶éæ˜¯æŒ‰å¯„å­˜å™¨è¿ç»­å­˜å‚¨çš„. (æ³¨æ„AMXåªæ”¯æŒä»ä¸»å­˜ä¸­åŠ è½½ä¸å­˜å‚¨, æ— æ³•é€šè¿‡é€šç”¨å¯„å­˜å™¨/å‘é‡å¯„å­˜å™¨åŠ è½½ä¸å­˜å‚¨)

![æœ€å°è®¡ç®—æµç¨‹](mac-amx/workflow.png)

é€šè¿‡å¤–ç§¯è®¡ç®—å¯ä»¥è·å¾—ä¸€ä¸ªpartial sumå­˜å‚¨åœ¨Zå¯„å­˜å™¨æ± ä¸­, æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åˆ‡æ¢Kç»´åº¦ä»è€Œç´¯ç§¯partial sumå¾—åˆ°å®Œæ•´çš„ç»“æœ:

![åˆ‡æ¢Kç»´åº¦](mac-amx/workflow%20switch%20k.png)

æ­¤æ—¶é‡æ–°åŠ è½½ä¸åŒKç»´åº¦çš„A/BçŸ©é˜µ, ç„¶åå°†è®¡ç®—ç»“æœå†™å…¥åˆ°ä¸ä¹‹å‰åŒä¸€ä¸ªZçš„å¯„å­˜å™¨ç»„ä¸­å®ç°ç´¯åŠ . 

å½“ç„¶ä¹Ÿå¯ä»¥è¿­ä»£M/N, æ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­ä¿æŒMä¸å˜, è¿­ä»£åˆ°ä¸‹ä¸€ä¸ªN, æ­¤æ—¶æˆ‘ä»¬éœ€è¦åœ¨Zå¯„å­˜å™¨æ± ä¸­å¦å¤–é€‰ä¸€ç»„å­˜å‚¨å½“å‰M/Nçš„ç´¯åŠ å€¼:
![åˆ‡æ¢Kç»´åº¦](mac-amx/workflow%20switch%20n.png)


# 3. ç†è®ºæ€§èƒ½æµ‹è¯•

ä¸ºäº†ç”¨å¥½AMX, é¦–å…ˆéœ€è¦æ›´åŠ äº†è§£AMXçš„ç›¸å…³å‚æ•°, æ¥ä¸‹æ¥ä¸€èµ·éªŒè¯ç†è®ºå„é¡¹æ€§èƒ½æŒ‡æ ‡.

## 3.1 ç†è®ºè®¡ç®—æ€§èƒ½

æ ¹æ®ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¸…æ¥šäº†Zå¯„å­˜å™¨ç»„åœ¨float32æ¨¡å¼ä¸‹ä¸€å…±è¢«åˆ†ä¸ºäº†16ç»„, ä¸€æ¬¡è®¡ç®—åœ¨æ¯ä¸€ç»„ä¸­å¾—åˆ°ä¸€åˆ—ç»“æœ, å› æ­¤ALUå®é™…ä¸Šè¢«åˆ†ä¸ºäº†4ç»„. è¿™é‡Œå°±æ¥éªŒè¯ä½¿ç”¨ä¸åŒä¸ªæ•°çš„ALUç»„çš„å³°å€¼æ€§èƒ½:

```cpp
perf_func = [&z_nums]() {
  constexpr uint64_t a = matfp().dtype_mode(matfp_dtype_t::f32f32).z_row(0);
  constexpr uint64_t b = matfp().dtype_mode(matfp_dtype_t::f32f32).z_row(1);
  constexpr uint64_t c = matfp().dtype_mode(matfp_dtype_t::f32f32).z_row(2);
  constexpr uint64_t d = matfp().dtype_mode(matfp_dtype_t::f32f32).z_row(3);
  AMX_MATFP(a);
  if (z_nums > 1)
    AMX_MATFP(b);
  if (z_nums > 2)
    AMX_MATFP(c);
  if (z_nums > 3)
    AMX_MATFP(d);
};
```

å¾—åˆ°ç»“æœå¦‚ä¸‹:

| ALU Nums | Gflop/s  |
| -------- | -------- |
| 1        | 405.530  |
| 2        | 826.912  |
| 3        | 1244.570 |
| 4        | 1666.952 |

è¿™è¡¨æ˜è™½ç„¶æ¯ç»„ALUæ˜¯å•ç‹¬é…ç½®å’Œå‘å°„, ä½†æ˜¯ä»–ä»¬ä¹‹é—´æ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„.

## 3.2 ç†è®ºæ•°æ®åŠ è½½æ€§èƒ½

è¿™é‡Œæ˜¯æˆ‘è®¾è®¡çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹, å…¶ä¸­`reg nums`è¡¨ç¤ºX/Yå¯„å­˜å™¨æ± . `near`è¡¨ç¤ºæ˜¯å¦è¯»å–å†…å­˜ä¸­è¿ç»­çš„åœ°å€,åœ¨M2 Proä¸­l1 Dcache å¤§å°ä¸º65536, å› æ­¤å°†Kè®¾è®¡ä¸ºæ•°å€å¤§äºl1 cache size, å½“`near == 0`æ—¶éœ€è¦è·¨è¿‡ä¸¤å€å¤§å°çš„cache sizeå»è¯»å–. `width`è¡¨ç¤ºä¸€æ¬¡è¯»å–å‡ ä¸ªå¯„å­˜å™¨ä¸ªæ•°, æœ€å¤§ä¸º4.

```cpp
constexpr size_t K = (65536 / 4 / (16 * 4)) * 4;
float M[K * 2][16 * 4]{};
float N[K * 2][16 * 4]{};
perf_func = [&M, &N, &near, &reg_num, &x_width, &y_width]() {
  auto ldx = ldxy().register_index(0);
  auto ldy = ldxy().register_index(0);
  if (x_width >= 2)
    ldx = ldx.multiple();
  if (x_width >= 4)
    ldx = ldx.multiple_four();
  if (reg_num > 1) {
    if (y_width >= 2)
      ldy = ldy.multiple();
    if (y_width >= 4)
      ldy = ldy.multiple_four();
  }

  if (near) {
    for (size_t i = 0; i < K; i++) {
      AMX_LDX(ldx.bind(M[i]));
      if (reg_num > 1) {
        AMX_LDY(ldy.bind(N[i]));
      }
    }
  } else {
    for (size_t i = 0; i < K / 2; i++) {
      for (size_t j = 0; j < 2; j++) {
        AMX_LDX(ldx.bind(M[j * K + i]));
        if (reg_num > 1) {
          AMX_LDY(ldy.bind(N[j * K + i]));
        }
      }
    }
  }
};
```

æ¥ä¸‹æ¥æˆ‘ä»¬è®¡ç®—æ•°æ®åŠ è½½æ—¶é—´, å¾—åˆ°ä¸‹è¡¨:

| Reg Nums | Near | X Width | Y Width | GB/s    |
| -------- | ---- | ------- | ------- | ------- |
| 1        | 1    | 1       | 0       | 87.1489 |
| 1        | 1    | 2       | 0       | 213.164 |
| 1        | 1    | 4       | 0       | 456.332 |
| 1        | 0    | 1       | 0       | 120.796 |
| 1        | 0    | 2       | 0       | 260.115 |
| 1        | 0    | 4       | 0       | 483.285 |
| 2        | 1    | 1       | 1       | 134.33  |
| 2        | 1    | 1       | 2       | 162.084 |
| 2        | 1    | 1       | 4       | 297.15  |
| 2        | 1    | 2       | 1       | 201.658 |
| 2        | 1    | 2       | 2       | 214.772 |
| 2        | 1    | 2       | 4       | 350.554 |
| 2        | 1    | 4       | 1       | 384.614 |
| 2        | 1    | 4       | 2       | 349.528 |
| 2        | 1    | 4       | 4       | 476.722 |
| 2        | 0    | 1       | 1       | 130.604 |
| 2        | 0    | 1       | 2       | 163.91  |
| 2        | 0    | 1       | 4       | 254.922 |
| 2        | 0    | 2       | 1       | 195.612 |
| 2        | 0    | 2       | 2       | 213.61  |
| 2        | 0    | 2       | 4       | 298.603 |
| 2        | 0    | 4       | 1       | 310.308 |
| 2        | 0    | 4       | 2       | 302.767 |
| 2        | 0    | 4       | 4       | 325.193 |

å¯ä»¥å‘ç°åŠ å¤§è¯»å–å®½åº¦æ˜¯å¯ä»¥ç¿»å€å¸¦å®½çš„, å› æ­¤è¿™æ˜¯æ— æˆæœ¬çš„. è¯»å–è¿ç»­æ‘†æ”¾çš„æ•°æ®ç›¸æ¯”äºéè¿ç»­è¯»å–ç•¥æœ‰æå‡, è¿™è¡¨æ˜éœ€è¦å¯¹æ•°æ®æ‘†æ”¾è¿›è¡Œä¼˜åŒ–. åŒæ—¶åŠ è½½ä¸¤ä¸ªå¯„å­˜å™¨ä¸­ä¹ŸåŒæ ·ä¸ä¼šå¯¼è‡´å¸¦å®½é™ä½, è¡¨æ˜å¯ä»¥åŒæ—¶åŠ è½½A/BçŸ©é˜µ, ä½†éœ€è¦æ³¨æ„å°½é‡cacheèµ·æ¥.

## 3.3 ç†è®ºæ•°æ®å­˜å‚¨æ€§èƒ½

åŒæ ·åœ¨storeæ—¶è®¾è®¡äº†`reg_num`,`near`,`width`ç­‰é€‰é¡¹, å€¼çš„æ³¨æ„çš„æ˜¯, å› ä¸ºZå¯„å­˜å™¨æ± è¢«åˆ†ä¸ºäº†16ç»„, æ‰€ä»¥æ¯ä¸€æ¬¡storeæ—¶éƒ½å°†16ç»„å…¨éƒ¨è¾“å‡º:
```cpp
constexpr size_t K = (65536 / 4 / (16 * 4)) * 2;
float CNear[16][16 * 4]{};
float C[16][K]{};
perf_func = [&C, &CNear, &near, &z_num, &width]() {
  auto ldst = width == 2 ? ldstz().multiple() : ldstz();
  for (size_t z = 0; z < z_num; z++) {
    for (size_t m = 0; m < 16; m++) {
      AMX_STZ(ldst.row_index(m * 4 + z * width)
                  .bind(near ? CNear[m] + 16 * z * width
                              : C[m] + 16 * z * width));
    }
  }
};
```

æµ‹è¯•ç»“æœå¦‚ä¸‹:

| Reg Nums | Near | Width | GB/s    |
| -------- | ---- | ----- | ------- |
| 1        | 1    | 1     | 10.3769 |
| 1        | 1    | 2     | 8.93052 |
| 1        | 0    | 1     | 12.9423 |
| 1        | 0    | 2     | 12.3377 |
| 2        | 1    | 1     | 5.69731 |
| 2        | 1    | 2     | 12.3658 |
| 2        | 0    | 1     | 7.55092 |
| 2        | 0    | 2     | 13.0133 |
| 3        | 1    | 1     | 6.58085 |
| 3        | 0    | 1     | 11.4118 |
| 4        | 1    | 1     | 8.8847  |
| 4        | 0    | 1     | 9.85956 |

å¯ä»¥å‘ç°ä½¿ç”¨å¤šä¸ªå¯„å­˜å™¨å¹¶æ— æ³•æå‡å¸¦å®½, è¯´æ˜åŸºæœ¬ä¸Šæ˜¯ä¸²è¡Œè¾“å‡º, ä½†å¼€å¯ä¸¤å€å®½åº¦è¿˜æ˜¯å¯ä»¥æœ‰æ•ˆæå‡å¸¦å®½. ç„¶è€Œæ•´ä½“é€Ÿåº¦ç›¸æ¯”äºè®¡ç®—å’ŒåŠ è½½æ…¢äº†æ•°å€, è¿™è¡¨æ˜æˆ‘ä»¬ä¸èƒ½é¢‘ç¹åœ°åŠ è½½ä¸å­˜å‚¨Z.  

# 3. è®¾è®¡Micro Kernel

åŸºäºä¸Šä¸€èŠ‚ä¸­çš„å†…å®¹, æˆ‘ä»¬å¯ä»¥æ¥å°è¯•ç¼–å†™ä¸€ä¸ªç°å®ä¸–ç•Œçš„çŸ©é˜µä¹˜æ³•, ä¸ºäº†çŸ©é˜µä¹˜æ³•çš„é«˜æ•ˆ, é‡‡ç”¨è‡ªåº•å‘ä¸Šçš„å‡†åˆ™æ¥è®¾è®¡å®ƒ. ä¹Ÿå°±æ˜¯è¯´, é¦–å…ˆéœ€è¦è®¾è®¡ä¸€ä¸ªå……åˆ†åˆ©ç”¨ç¡¬ä»¶ç®—åŠ›çš„micro kernel, æ¥ç€å†é€šè¿‡åˆç†è°ƒç”¨micro kernelè¾¾åˆ°æé™ç®—åŠ›.

é¦–å…ˆå›é¡¾ä¸€ä¸‹æœ€åŸºç¡€çš„è®¡ç®—æµç¨‹, åŠ è½½ä¸€åˆ—M, åŠ è½½ä¸€è¡ŒN, è®¡ç®—å¾—åˆ°ä¸€å—MxN. æ­¤æ—¶æ˜æ˜¾å¯ä»¥å‘ç°å¯¹äºX/Y/Zå¯„å­˜å™¨æ± éƒ½æ˜¯æ²¡ç”¨å……åˆ†åˆ©ç”¨çš„, ç‰¹åˆ«æ˜¯Zå¯„å­˜å™¨æ± , è¿™æ„å‘³ç€åªä½¿ç”¨äº†$\frac{1}{4}$çš„ç®—åŠ›, æ‰€ä»¥é¦–è¦ç›®æ ‡æ˜¯ç”¨æ»¡å®ƒ. 

![](mac-amx/micro%20kernel%200.png)

æ ¹æ®ä¸Šä¸€èŠ‚, æˆ‘ä»¬å¯ä»¥å·²çŸ¥æœ€å¤§ç†è®ºè®¡ç®—æ€§èƒ½ä»¥åŠå¸¦å®½, é‚£ä¹ˆæ ¹æ®å…¬å¼æˆ‘ä»¬å¯ä»¥è®¡ç®—ç”¨æ»¡ALUæ—¶ä¸€æ¬¡è®¡ç®—éœ€è¦èŠ±è´¹å¤šå°‘çº³ç§’:
$$
\begin{aligned}
Compute Time  &= \frac{FLOPs}{GFLOPS}\ ~NanoSeconds\\
Load Time  &= \frac{Bytes}{GBS}\ ~NanoSeconds
\end{aligned}
$$

æ¥ä¸‹æ¥æˆ‘ä»¬åŸºäºè¿™ä¸ªæ•°æ®æ¥è®¾è®¡ä¸åŒçš„è®¡ç®—ç­–ç•¥:

## 3.1 è®¡ç®—ç­–ç•¥1: åŠ è½½å¤šç»„N

åœ¨æˆ‘çš„M2 Proä¸­, AMXæœ€å¤§ä¸€æ¬¡å¯ä»¥åŠ è½½`4*64` bytes, å› æ­¤å¯ä»¥åŠ è½½1ç»„Mä»¥åŠ4ç»„çš„N, åˆ©ç”¨æ»¡è®¡ç®—å•å…ƒå¾—åˆ°`M*4N`, ç„¶ååœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­åˆ‡æ¢ä¸åŒçš„K. æ€»çš„æ¥è¯´æ˜¯åŠ è½½ä¸€æ¬¡, è®¡ç®—å››æ¬¡, ç”±äºXå¯„å­˜å™¨æ± å¤§å°é™åˆ¶åªèƒ½å¤šç¼“å­˜ä¸€æ¬¡.
![](mac-amx/micro%20kernel%201.png)

æŸ¥è¡¨å¯çŸ¥,åŠ è½½å¸¦å®½ä¸º254.922 GB/s,å¾—åˆ°è®¡ç®—æ—¶é—´ä¸æ•°æ®åŠ è½½æ—¶é—´åˆ†åˆ«ä¸º:
$$
\begin{aligned}
FLOPs &= 2 * M * N * 4 = 2048 \\
Compute Time &= FLOPs / 1666  = 1.229~NanoSeconds \\
Bytes &= (1 * M + 4 * N) * 4 \\
Load Time &= Bytes / 297.15 = 1.076~NanoSeconds
\end{aligned}
$$

ä¸¤è€…æ—¶é—´åŸºæœ¬å·®ä¸å¤š, ä½†ä»–ä»¬ä¹‹é—´çš„å·®åªæœ‰`0.15ns`, è¿™ç‚¹æ—¶é—´ä¸è¶³ä»¥åœ¨ä¸€æ¬¡ç¼“å­˜ä¸­æµæ°´èµ·æ¥.


## 3.2 è®¡ç®—ç­–ç•¥2: åŠ è½½å¤šç»„M

åŒä¸Šä¸€ç§ç­–ç•¥ç±»ä¼¼, åŒæ ·ä¹Ÿæ˜¯åŠ è½½ä¸€æ¬¡è®¡ç®—å››æ¬¡, è®¡ç®—æ—¶é—´ä¸åŠ è½½æ—¶é—´å’Œä¸Šä¸€å°èŠ‚ç±»ä¼¼, ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé¢å¤–é—®é¢˜åˆ™æ˜¯å¯¹äºAçŸ©é˜µçš„åˆ—æ–¹å‘æ˜¯ä¸è¿ç»­çš„, éœ€è¦å…ˆé€šè¿‡CPUè¿›è¡Œè½¬ç½®4å€çš„Måæ‰å¯ä»¥åŠ è½½, å› æ­¤ä¸è€ƒè™‘.
![](mac-amx/micro%20kernel%202.png)


## 3.3 è®¡ç®—ç­–ç•¥3: åŠ è½½ä¸¤ç»„M/N 

ä¸ºäº†å‡åŒ€X/Yå¯„å­˜å™¨çš„å­˜å‚¨, å¯ä»¥è€ƒè™‘åŠ è½½åŒæ ·å¤§å°çš„M/N, ä¹Ÿå°±æ˜¯åŠ è½½2ç»„, æ­¤æ—¶å¯ä»¥è®¡ç®—4æ¬¡å¾—åˆ°`2M*2N`å¤§å°çš„è¾“å‡º, è€ƒè™‘åˆ°æœ€å¤§å¯ä»¥åŠ è½½`4*64` bytes, é‚£ä¹ˆå¯ä»¥åŠ è½½ä¸åŒKä¸¤ç»„M/N, è¿™æ ·ä¸€æ¬¡åŠ è½½å®é™…å¯ä»¥è®¡ç®—8æ¬¡, æœ€å¤§é™åº¦çš„åˆ©ç”¨ç®—åŠ›. æ­¤æ—¶å¯¹äºX/Yå¯„å­˜å™¨æ± ä½¿ç”¨é‡æ˜¯ä¸€æ ·çš„, ä¹Ÿå°±æ˜¯ä»–ä»¬è¿˜å¯ä»¥å¤šç¼“å­˜ä¸€æ¬¡:
![](mac-amx/micro%20kernel%203.png)

æ¥åŠ¨æ‰‹è®¡ç®—ä¸€ä¸‹,åŠ è½½å¸¦å®½ä¸º254.922 GB/s,å¾—åˆ°è®¡ç®—æ—¶é—´ä¸æ•°æ®åŠ è½½æ—¶é—´åˆ†åˆ«ä¸º:
$$
\begin{aligned}
FLOPs &= 2 * M * N * 4 * 2 = 4096 \\
Compute Time &= FLOPs / 1666  = 2.458~NanoSeconds \\
Bytes &= (4 * M + 4 * N) * 4 \\
Load Time &= Bytes / 476.722 = 1.074~NanoSeconds
\end{aligned}
$$

æ­¤æ—¶è®¡ç®—æ—¶é—´å‡å»æ•°æ®åŠ è½½æ—¶é—´ä¸º`1.384 ns`, å¤§äºä¸‹ä¸€æ¬¡çš„è®¡ç®—æ—¶é—´`1.074 ns`, é‚£ä¹ˆä¹Ÿå°±è¡¨æ˜æˆ‘ä»¬å¯ä»¥åœ¨ä¸‹ä¸€æ¬¡ç¼“å­˜ä¸­å®Œç¾çš„æµæ°´èµ·æ¥, ä»è€Œå‘æŒ¥å‡ºæé™ç®—åŠ›.

## 3.4 éªŒè¯è®¡ç®—ç­–ç•¥3

ä¸ºäº†è¾¾åˆ°å³°å€¼çš„æ•°æ®åŠ è½½æ€§èƒ½, æˆ‘ä»¬éœ€è¦å¯¹çŸ©é˜µè¿›è¡Œå¸ƒå±€ä¼˜åŒ–, ä¹Ÿå°±æ˜¯å°†A/BçŸ©é˜µåˆ†åˆ«ä»¥32ä¸ºå®½åº¦è¿›è¡Œpack, è¿™æ ·åŠ è½½æ—¶æ˜¯æ»¡è¶³å†…å­˜è¿ç»­è¯»å–, åŒæ—¶ä¸€æ¬¡å¯ä»¥è®¡ç®—å¾—åˆ°`2*M*N`çš„ç»“æœ, å…¶å…·ä½“è¿­ä»£æµç¨‹å›¾å¦‚ä¸‹:
![](mac-amx/micro%20kernel%203%20detail.png)

ä¸ºäº†ç®€å•èµ·è§æˆ‘å‡è®¾M/K/Néƒ½æ»¡è¶³æœ€å°è®¡ç®—å•å…ƒçš„å€æ•°, åŒæ—¶è¦æ±‚è¾“å…¥A/BçŸ©é˜µéƒ½æ˜¯ç»è¿‡å¸ƒå±€ä¼˜åŒ–çš„, ä¸‹é¢åˆ™æ˜¯å…·ä½“çš„ä»£ç :
```cpp
template <bool LoadC, bool StoreC, size_t KTile, size_t M, size_t N>
void gepdot(size_t curM, size_t curK, size_t curN,
            const float packedA[KTile][32], const float packedB[KTile][32],
            float C[M][N]) {
  static_assert(KTile % 4 == 0, "not support k%4!=0");

  if constexpr (LoadC) {
    // load acc value.
    for (size_t om = 0; om < 2; om++) {
      for (size_t m = 0; m < 16; m++) {
        AMX_STZ(
            ldstz().row_index(m * 4 + om * 2).multiple().bind(C[om * 16 + m]));
      }
    }
  }

  for (size_t k = curK; k < curK + KTile; k += 4) {
    for (size_t ok = k; ok < k + 4; ok += 2) {
      // load [m0,k0], [m1,k0], [m0,k1], [m1,k1]
      AMX_LDY(ldxy().register_index(0).multiple().multiple_four().bind(
          (void *)packedA[ok]));
      // load [n0,k0], [n1,k0], [n0,k1], [n1,k1]
      AMX_LDX(ldxy().register_index(0).multiple().multiple_four().bind(
          (void *)packedB[ok]));
      // compute 8 times.
      // [[m0,n0],[m0,n1],
      //  [m1,n0],[m1,n1]]
      for (size_t ik = ok; ik < ok + 2; ik++) {
        auto fma = ik == 0 ? fma32().skip_z() : fma32();
        for (size_t m = 0; m < 2; m++) {
          for (size_t n = 0; n < 2; n++) {
            AMX_FMA32(fma.z_row(m * 2 + n)
                          .y_offset((ik - ok) * 2 * 16 * 4 + m * 16 * 4)
                          .x_offset((ik - ok) * 2 * 16 * 4 + n * 16 * 4));
          }
        }
      }
    }
  }

  // last time need store C.
  if constexpr (StoreC) {
    for (size_t om = 0; om < 2; om++) {
      for (size_t m = 0; m < 16; m++) {
        AMX_STZ(
            ldstz().row_index(m * 4 + om * 2).multiple().bind(C[om * 16 + m]));
      }
    }
  }
}
```

åœ¨`M = 16 * 2, K = 8192, N = 16 * 2`çš„æƒ…å†µä¸‹æµ‹è¯•, å¾—åˆ°`1632.13 Gflop/s`çš„æ€§èƒ½, è¾¾åˆ°äº†å³°å€¼æ€§èƒ½çš„`0.979%`.:
```sh
[----------] 1 test from test_amx
[ RUN      ] test_amx.test_gepdot
             Gflop/s: 1632.13
[       OK ] test_amx.test_gepdot (1032 ms)
[----------] 1 test from test_amx (1032 ms total)
```

# 4. è®¾è®¡åˆ†å—æ–¹æ¡ˆ

å¦‚æœåœ¨æ²¡æœ‰AI Compileræå‰ä¼˜åŒ–çš„æƒ…å†µä¸‹, æˆ‘ä»¬æ˜¯æ²¡åŠæ³•å¾—åˆ°å†…å­˜ä¼˜åŒ–å¥½çš„è¾“å…¥æ•°æ®çš„, é‚£ä¹ˆå°±éœ€è¦è€ƒè™‘è®¡ç®—çš„åŒæ—¶è¿›è¡Œå¸ƒå±€ä¼˜åŒ–. å¹¶ä¸”ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­æˆ‘æ²¡æœ‰è®¾ç½®å¾ˆå¤§çš„Må’ŒN, è€Œç°å®ä¸­éœ€è¦åˆ‡æ¢Mä¸N, æ­¤æ—¶åˆå¸¦æ¥å¦ä¸€ä¸ªåˆ†å—å¤§å°çš„é—®é¢˜. 

å¦‚æœæ˜¯ä½¿ç”¨SIMDæ¥è¿›è¡Œè®¡ç®—, é‚£ä¹ˆè®ºæ–‡[Anatomy of High-Performance Matrix Multiplication](https://dl.acm.org/doi/10.1145/1356052.1356053)ä¸­å·²ç»ç»™å‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„åˆ†å—è§£å†³æ–¹æ¡ˆ:

![](mac-amx/goto%20blas.png)

å³æœ€å†…å±‚ä½¿ç”¨`gebp`æ ¸. ä½†æ˜¯`gebp`å®ƒéœ€è¦åå¤çš„åŠ è½½å’Œå­˜å‚¨CçŸ©é˜µ, å¯¹äºCPUå¯„å­˜å™¨æ¥è¯´ä»–çš„å¸¦å®½è¶³å¤Ÿå¤§, åªéœ€è¦Nrè¿œå¤§äºKcå°±å¯ä»¥å‡æ‘Šæ‰è®¿é—®CçŸ©é˜µçš„å†…å­˜å¼€é”€, å¯¹äºAMXæ¥è¯´Zå¯„å­˜å™¨çš„å¸¦å®½åªæœ‰X/Yå¯„å­˜å™¨å¸¦å®½çš„å‡ ååˆ†ä¹‹ä¸€, æ˜¾ç„¶æ˜¯æ— æ³•å‡æ‘Šçš„, å› æ­¤æˆ‘ä»¬è‚¯å®šä¸èƒ½é‡‡ç”¨è®ºæ–‡ä¸­çš„è®¡ç®—æ–¹æ³•:
![](mac-amx/gebp.png)

å› æ­¤æˆ‘è¿™é‡ŒæŠ›ç –å¼•ç‰, å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„ä¸¤çº§åˆ†å—ç­–ç•¥, Mä¸­å¾ªç¯Nç”¨äºå¤ç”¨AçŸ©é˜µ, æŠŠKè¿­ä»£æ”¾åœ¨å¾ªç¯æœ€å†…å±‚ä»¥é€‚é…`gepdot`æ ¸, åŒæ—¶åœ¨æ¯ä¸ªKTileä¸­packä¸€å°å—Aå¹¶ç¼“å­˜èµ·æ¥, è¿™æ ·å¾ªç¯Næ—¶å¯ä»¥é¿å…é‡å¤æ‰§è¡Œ:

![](mac-amx/gepdot%20general.png)

æœ€ç»ˆä»£ç å¦‚ä¸‹:
```cpp
auto matmul = [&]() -> void {
  constexpr size_t KTile = 32, MTile = 32, NTile = 32;
  for (size_t mo = 0; mo < M; mo += MTile) {
    float PackedA[K][MTile];
    for (size_t no = 0; no < N; no += NTile) {
      for (size_t ko = 0; ko < K; ko += KTile) {
        // each time pack local innertile.
        if (no == 0) {
          for (size_t mi = 0; mi < MTile; mi++) {
            for (size_t i = ko; i < ko + KTile; i++) {
              PackedA[i][mi] = A[mo + mi][i];
            }
          }
        }
        gepdot_general<KTile, M, K, N>(false, (ko + KTile == K), mo, ko, no,
                                        PackedA + ko, B, C);
      }
    }
  }
};
```

æµ‹è¯•æ€§èƒ½è¾¾åˆ°äº†Appleæ‰€æä¾›åº“çš„70%æ€§èƒ½:

```sh
[ RUN      ] test_amx.test_gepdot_general
gepdot general   Gflop/s: 998.291
cblas_sgemm      Gflop/s: 1398.95
[       OK ] test_amx.test_gepdot_general (582 ms)
```

å…¶å®è®¡ç®—ç­–ç•¥3ä¸­æ˜¯è®¡ç®—ç“¶é¢ˆçš„, æŒ‰ç†è®ºå€¼è®¡ç®—æµæ°´ä¹‹åå®é™…å¤§çº¦è¿˜å‰©`0.3ns`æ—¶é—´å¯ä»¥åˆ†é…ç»™æ•°æ®åŠ è½½, å¦‚æœå¯ä»¥å¾ˆå¥½çš„å»ºæ¨¡CPUå†…å­˜æ“ä½œè€—æ—¶, ç†è®ºä¸Šæ˜¯å¯ä»¥åšåˆ°æŠŠpack AçŸ©é˜µçš„è¿‡ç¨‹æ©ç›–èµ·æ¥, ä»è€Œè¾¾åˆ°ç†è®ºå³°å€¼. ä¸è¿‡ä»cblas_sgemmçš„å®æµ‹æ€§èƒ½æ¥çœ‹, åº”è¯¥ä¹Ÿæ²¡æœ‰å®Œå…¨æ©è—èµ·æ¥, è¶…è¶ŠAppleé—­æºåº“è¿™ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡å°±äº¤ç»™è¯»è€…ä»¬äº†ğŸ‘».


# 5. ç–‘é—®

æˆ‘è®¾è®¡äº†ä¸€ä¸ªæµ‹è¯•AMXåŠ è½½æ•°æ®æ˜¯å¦ä¼šæ›´æ–°cacheçš„ç”¨ä¾‹:
```cpp
constexpr size_t K = (65536 / 4 / (16 * 2)) * 8; /* 65536 æ˜¯cache size */
float N[1][16 * 2]{};
float M[K][16 * 2]{};
float *C = (float *)malloc(K * 65536);


auto func1 = [&N]() {
  for (size_t i = 0; i < K; i++) {
    AMX_LDX(ldxy().multiple().register_index(0).bind((void *)N[0]));
  }
}

auto func2 = [&M]() {
  for (size_t i = 0; i < K; i++) {
    AMX_LDX(ldxy().multiple().register_index(0).bind((void *)M[i]));
  }
}

auto func3 = [&C]() {
  for (size_t i = 0; i < K; i++) {
    AMX_LDX(
        ldxy().multiple().register_index(0).bind((void *)(C + i * K)));
  }
}
```

å…¶ä¸­func1æ°¸è¿œåªåŠ è½½åŒä¸€ä¸ªä½ç½®çš„æ•°æ®, func2æŒ‰é¡ºåºåŠ è½½è¿ç»­çš„æ•°æ®, func3æ¯æ¬¡åŠ è½½è·¨åº¦å¤§äºl1 cache sizeçš„æ•°æ®, æœ€ç»ˆç»“æœå¦‚ä¸‹:
```sh
func1: 29.9743 GB/s
func2: 219.201 GB/s
func3: 9.74711 GB/s
```

func2ä¸func3çš„ç»“æœè¡¨ç¤ºl1 cacheå¯¹äºAMXæ¥è¯´ä¹Ÿæ˜¯é‡è¦çš„, ä½†æ˜¯æˆ‘æ— æ³•ç†è§£func1ä¸func2çš„å·®å¼‚, ç†è®ºä¸Šè¢«è®¿é—®è¿‡çš„æ•°æ®åº”è¯¥ä¼šç¼“å­˜åœ¨cacheä¸­, è€Œä»ç»“æœä¸Šæ¥çœ‹è¢«ç¼“å­˜çš„ä¼¼ä¹æ˜¯å½“å‰æ‰€åŠ è½½åœ°å€åé¢éƒ¨åˆ†çš„æ•°æ®, è¿™ä¸ªé—®é¢˜å¯èƒ½éœ€è¦æ›´äº†è§£ä½“ç³»ç»“æ„çš„è¯»è€…æ‰èƒ½è§£ç­”.

# 6. æ€»ç»“

è‡³æ­¤æœ¬æ–‡æ‰€æœ‰çš„å†…å®¹ä»‹ç»å®Œæ¯•, æˆ‘æ‰€ä½¿ç”¨çš„å…¨éƒ¨æµ‹è¯•ä»£ç åœ¨[è¿™é‡Œè·å–](https://github.com/zhen8838/leetcode/blob/main/meta_program/test_amx.cpp)(Verified on M2 Pro). è€Œæœ¬æ–‡æ‰€ä¾èµ–çš„ä¿¡æ¯æ¥æºäºPeter Cawleyç­‰äººçš„[é€†å‘æˆæœ](https://github.com/corsix/amx), å…¶ä¸­åŒ…å«äº†æ›´å¤šæŒ‡ä»¤ä»‹ç»ä»¥åŠä½¿ç”¨æ–¹æ³•.
