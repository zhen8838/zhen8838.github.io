---
title: Nand2Tetris week4
mathjax: true
toc: true
categories:
  - ä½“ç³»ç»“æ„
date: 2021-05-24 00:49:25
tags:
- Nand2Tetris
---

ä¸Šå‘¨æˆ‘ä¸çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œå¥½åƒå¾ˆå¿™ï¼Œä½†æ˜¯å•¥ä¸œè¥¿éƒ½æ²¡åšå‡ºæ¥ï¼Œå¤ªéš¾å—äº†ã€‚è¿™å‘¨å¾—æ”¹æ”¹è‡ªå·±çš„ç”Ÿæ´»èŠ‚å¥äº†ã€‚è¿™å‘¨çš„è¯¾ç¨‹æ˜¯Machine Languageï¼Œåº”è¯¥æ˜¯è¦è®²å¦‚ä½•è®¾è®¡ISAäº†ã€‚

<!--more-->

# Overview

æ±‡ç¼–æ˜¯æœ€èƒ½è´´è¿‘çš„Machine Languageçš„æè¿°æ–¹å¼ï¼ŒåŒæ—¶è¿˜å…·å¤‡ä¸€å®šçš„å¯è¯»æ€§ï¼Œå¦‚ä¸‹å›¾ï¼Œè¿™é‡Œçš„æœºå™¨æŒ‡ä»¤çš„æ±‡ç¼–åŒ–è¡¨è¿°æ–¹æ³•å°±å¦‚ä¸‹ï¼š
![](nand2tetris-week4/overview-1.png)

# Machine Languages: Elements

## ä»–æ˜¯ç‰¹å®šçš„è½¯ç¡¬ä»¶æ¥å£

1.  ä»–å®šä¹‰äº†ç¡¬ä»¶æ”¯æŒæ€æ ·çš„æ“ä½œï¼ˆæ•°å­¦æ“ä½œã€é€»è¾‘æ“ä½œã€æ§åˆ¶æµï¼‰
2.  å®šä¹‰æ“ä½œæ‰§è¡Œçš„å¯¹è±¡


## å†…å­˜å±‚æ¬¡åŒ–

1.  è®¿é—®å†…å­˜åœ°å€å¼€é”€æ˜¯æ˜‚è´µçš„
    1.  éœ€è¦æ”¯æŒé•¿åœ°å€ï¼Œé‚£ä¹ˆä½æ•°éœ€è¦å¤§
    2.  ä»å†…å­˜ä¸­å–æ•°éœ€è¦æ—¶é—´

è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦è®¾è®¡å¤šä¸ªcacheï¼Œè¶Šæ¥è¿‘cpuçš„å†…å­˜å—è¶Šå°ï¼Œé€Ÿåº¦è¶Šå¿«ã€‚

å…¶ä¸­æœ€é è¿‘cpuå†…å­˜å—å°±æ˜¯registersï¼Œå…¶ä¸»è¦å­˜å‚¨ä¸€äº›cpuæ“ä½œæ—¶çš„å‚æ•°ï¼Œæ¯”å¦‚åšåŠ æ³•æ—¶ï¼Œæ‰€æ“ä½œçš„æ•°æ®å°±å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼š
![](nand2tetris-week4/registers-1.png)

# Hack Cpu architecture

```
 -----                    -----------------                 ------------------
|     |                  | [A register]    | = data out => |                  |
| rom | = instruction => |    cpu          |               | ram              |
|     |                  | [D register]    | <= data in =  | [M register]     |
 -----                    -----------------                 ------------------
```

romä¸­å­˜å‚¨äº†ä»£ç æŒ‡ä»¤ï¼ŒcpuåŠ è½½æŒ‡ä»¤ç„¶åå¯¹ramä¸­çš„æ•°æ®è¿›è¡Œè¯»å–ã€è®¡ç®—ã€å†™å…¥ç­‰æ“ä½œã€‚
Hack cpuä¸­è®¾ç½®äº†ä¸¤ç§æŒ‡ä»¤é›†ï¼ŒA-instructionå’ŒC-instructionã€‚è®¾ç½®äº†ä¸‰ç§å¯„å­˜å™¨A,D,M.
A ä¸ Dä¸­å­˜å‚¨äº†16bitçš„å€¼ï¼Œè€ŒMå¯„å­˜å™¨ä¸­å­˜å‚¨çš„æ˜¯Aä½œä¸ºåœ°å€æ—¶å¯¹åº”çš„å¯„å­˜å™¨ï¼ˆå³æŠŠAä½œä¸ºæŒ‡é’ˆï¼ŒM=*Aï¼‰

1.  A instruction

  è¯­æ³•ï¼š `@value`
  å«ä¹‰ï¼š å°†Aå¯„å­˜å™¨è®¾ç½®ä¸º`value`ï¼ŒåŒæ—¶æ„å‘³ç€Må¯„å­˜å™¨æŒ‡å‘äº†`RAM[A]`

2.  C instruction

  è¯­æ³•ï¼š`dest= comp; jump`
  å«ä¹‰ï¼šå°†compçš„å€¼è®¾ç½®åˆ°destä¸­ï¼Œå¦‚æœæ»¡è¶³è·³è½¬çš„æ“ä½œï¼Œé‚£ä¹ˆè·³è½¬åˆ°`ROM[A]`å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚
  compçš„å‘½ä»¤å¯ä»¥æ˜¯ä»»ä½•æœ‰æ„ä¹‰çš„è¿ç®—æ“ä½œï¼Œdestå¯ä»¥æ˜¯ä¸‰ç§å¯„å­˜å™¨ä¸­ä»»æ„ä¸€ä¸ªï¼Œjumpä¹Ÿå¯ä»¥æ˜¯ä»»æ„ä¸€ç§è·³è½¬æ–¹å¼ã€‚
  
# input / output

åœ¨åº•å±‚çš„æ“ä½œä¸­ï¼Œæ‰€æœ‰çš„å‘½ä»¤æˆ–è€…äº¤äº’æ–¹å¼éƒ½æ˜¯é€šè¿‡bitæµçš„æ–¹å¼æ“ä½œçš„ï¼Œä½†æ˜¯æ¯æ¬¡ä¼ è¾“æ•°æ®çš„å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œhack computerçš„è®¾è®¡å°±æ˜¯æŠŠramä¸­çš„ä¸€å—ä½œä¸ºscreen memory mapã€‚


```
 -----                    -----------------                 ------------------
|     |                  | [A register]    | = data out => |                  |
| rom | = instruction => |    cpu          |               | ram              |
|     |                  | [D register]    | <= data in =  | [M register]     |
 -----                    -----------------                |                  | 
                                                           |------------------|
                                                           | screen memory map| 
                                                            ------------------
```

é€šè¿‡ç›´æ¥å‘å¯¹åº”å†…å­˜å†™å…¥å³å¯æœ‰æ•ˆçš„æ“ä½œå±å¹•ã€‚

è¾“å…¥å‘¢ä¹Ÿç±»ä¼¼ï¼Œç›´æ¥æ˜ å°„ä¸€å—å†…å­˜åŒºåŸŸå»è¯»å–å½“å‰é”®ç›˜çš„keycodeå³å¯ã€‚

# hack programing, part 1

æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸‰ä¸ªå¯„å­˜å™¨ï¼š
```
D: data å¯„å­˜å™¨
A: address å¯„å­˜å™¨
M: å½“å‰é€‰ä¸­å†…å­˜å¯„å­˜å™¨ M=RAM[A]
```
ç›¸å½“äºæˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡é’ˆ(A),ä¸€ä¸ªä¸´æ—¶å˜é‡(D),ä¸€ä¸ªå¿«é€Ÿå–æ•°æ®æ“ä½œ(M=*A). æœ‰äº†è¿™ä¸‰æ¿æ–§,æˆ‘ä»¬å°±è¿›è¡Œä¸€äº›è®¡ç®—å•¦, ä¸¾ä¸ªğŸŒ°:
```c
// D = 10
@10 
D=A

// D++
D=D+1

// D=RAM[17]
@17
D=M

// RAM[17]=0
@17
M=0

// RAM[17] = 10
@10
D=A
@17
M=D

// RAM[5] = RAM[3]
@3
D=M
@5
M=D
```

æˆ‘ä»¬çš„`asm`ä»£ç ä¼šè¢«åŠ è½½åˆ°`rom`åŒºè¢«æ‰§è¡Œ.å› æ­¤å¯¹äºç®€å•çš„ä»£ç ,ä¹Ÿéœ€è¦åœ¨åé¢åŠ ä¸Šæ— é™å¾ªç¯,é¿å…æ‰§è¡Œäº†æœªçŸ¥çš„æŒ‡ä»¤.
æœ€åè¿˜ä»‹ç»äº†ä¸ºäº†ä¾¿äºç¼–ç¨‹,`hack assembly`æä¾›äº†å†…ç½®çš„ç¬¦å·:
```
symbol  value
R0      0
R1      1
  ....
R15     15

SCREEN  16384
KBD     24576

SP      0
LCL     1
ARG     2
THIS    3
THAT    4
```
è¿™æ ·åœ¨ä»£ç ä¸­åº”è¯¥ç¼–å†™`@R15`ç”¨äºè¡¨ç¤ºè™šæ‹Ÿå¯„å­˜å™¨. `SCREEN`ç­‰ç”¨äºå¯»å€å¤–éƒ¨`IO`.