<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2021-04-25">

<title>cpp挖坑&amp;爬坑 – Zheng’s Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-7072389654d23eff08f359f9aa0d1ee7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Zheng’s Notes</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#变长参数" id="toc-变长参数" class="nav-link active" data-scroll-target="#变长参数">变长参数</a>
  <ul class="collapse">
  <li><a href="#基本定义" id="toc-基本定义" class="nav-link" data-scroll-target="#基本定义">基本定义</a></li>
  <li><a href="#循环展开" id="toc-循环展开" class="nav-link" data-scroll-target="#循环展开">循环展开</a></li>
  <li><a href="#变参模板展开" id="toc-变参模板展开" class="nav-link" data-scroll-target="#变参模板展开">变参模板展开</a></li>
  <li><a href="#折叠表达式" id="toc-折叠表达式" class="nav-link" data-scroll-target="#折叠表达式">折叠表达式</a></li>
  <li><a href="#integer_sequence" id="toc-integer_sequence" class="nav-link" data-scroll-target="#integer_sequence">integer_sequence</a></li>
  </ul></li>
  <li><a href="#右值左值" id="toc-右值左值" class="nav-link" data-scroll-target="#右值左值">右值&amp;左值</a>
  <ul class="collapse">
  <li><a href="#一个问题" id="toc-一个问题" class="nav-link" data-scroll-target="#一个问题">一个问题</a></li>
  </ul></li>
  <li><a href="#模板" id="toc-模板" class="nav-link" data-scroll-target="#模板">模板</a>
  <ul class="collapse">
  <li><a href="#获取容器内部类型" id="toc-获取容器内部类型" class="nav-link" data-scroll-target="#获取容器内部类型">获取容器内部类型</a></li>
  <li><a href="#编译期通过类型执行不同的代码" id="toc-编译期通过类型执行不同的代码" class="nav-link" data-scroll-target="#编译期通过类型执行不同的代码">编译期通过类型执行不同的代码</a></li>
  <li><a href="#类型保存值" id="toc-类型保存值" class="nav-link" data-scroll-target="#类型保存值">类型保存值</a></li>
  <li><a href="#结构体模板元函数的套路" id="toc-结构体模板元函数的套路" class="nav-link" data-scroll-target="#结构体模板元函数的套路">结构体模板元函数的套路</a></li>
  <li><a href="#模板元函数编写与匹配的几个套路" id="toc-模板元函数编写与匹配的几个套路" class="nav-link" data-scroll-target="#模板元函数编写与匹配的几个套路">模板元函数编写与匹配的几个套路</a></li>
  <li><a href="#tuple元素进行fold-expressions中重载操作符遇到的坑" id="toc-tuple元素进行fold-expressions中重载操作符遇到的坑" class="nav-link" data-scroll-target="#tuple元素进行fold-expressions中重载操作符遇到的坑">tuple元素进行fold expressions中重载操作符遇到的坑</a></li>
  <li><a href="#变长模板匹配的模式" id="toc-变长模板匹配的模式" class="nav-link" data-scroll-target="#变长模板匹配的模式">变长模板匹配的模式</a></li>
  <li><a href="#通过隐式转换来实现零成本抽象" id="toc-通过隐式转换来实现零成本抽象" class="nav-link" data-scroll-target="#通过隐式转换来实现零成本抽象">通过隐式转换来实现零成本抽象</a></li>
  </ul></li>
  <li><a href="#类" id="toc-类" class="nav-link" data-scroll-target="#类">类</a>
  <ul class="collapse">
  <li><a href="#explicit" id="toc-explicit" class="nav-link" data-scroll-target="#explicit">explicit</a></li>
  </ul></li>
  <li><a href="#share_ptr" id="toc-share_ptr" class="nav-link" data-scroll-target="#share_ptr">share_ptr</a>
  <ul class="collapse">
  <li><a href="#构造函数" id="toc-构造函数" class="nav-link" data-scroll-target="#构造函数">构造函数</a></li>
  <li><a href="#c-munmap_chunk-invalid-pointer" id="toc-c-munmap_chunk-invalid-pointer" class="nav-link" data-scroll-target="#c-munmap_chunk-invalid-pointer">C++: munmap_chunk(): invalid pointer</a></li>
  </ul></li>
  <li><a href="#clang编译中报错-no-viable-overloaded" id="toc-clang编译中报错-no-viable-overloaded" class="nav-link" data-scroll-target="#clang编译中报错-no-viable-overloaded">clang编译<map>中报错 no viable overloaded ‘=’</map></a></li>
  <li><a href="#ld-unknown-option--z" id="toc-ld-unknown-option--z" class="nav-link" data-scroll-target="#ld-unknown-option--z">ld: unknown option: -z</a></li>
  <li><a href="#ld-unknown-corefoundation" id="toc-ld-unknown-corefoundation" class="nav-link" data-scroll-target="#ld-unknown-corefoundation">ld: unknown CoreFoundation</a></li>
  <li><a href="#m1上eigen使用fp16时的坑" id="toc-m1上eigen使用fp16时的坑" class="nav-link" data-scroll-target="#m1上eigen使用fp16时的坑">m1上eigen使用fp16时的坑</a></li>
  <li><a href="#c语言regex使用" id="toc-c语言regex使用" class="nav-link" data-scroll-target="#c语言regex使用">c语言regex使用</a></li>
  <li><a href="#linux下使用shared-memory的坑" id="toc-linux下使用shared-memory的坑" class="nav-link" data-scroll-target="#linux下使用shared-memory的坑">linux下使用shared memory的坑</a></li>
  <li><a href="#命令行调试dotnet-core的dump信息" id="toc-命令行调试dotnet-core的dump信息" class="nav-link" data-scroll-target="#命令行调试dotnet-core的dump信息">命令行调试dotnet core的dump信息</a></li>
  <li><a href="#mac中缺少gmp的问题" id="toc-mac中缺少gmp的问题" class="nav-link" data-scroll-target="#mac中缺少gmp的问题">mac中缺少gmp的问题</a></li>
  <li><a href="#mac中编译出现libclang-cpp.dylib的问题" id="toc-mac中编译出现libclang-cpp.dylib的问题" class="nav-link" data-scroll-target="#mac中编译出现libclang-cpp.dylib的问题">mac中编译出现libclang-cpp.dylib的问题</a></li>
  <li><a href="#mac中stdio.h-file-not-found" id="toc-mac中stdio.h-file-not-found" class="nav-link" data-scroll-target="#mac中stdio.h-file-not-found">mac中’stdio.h’ file not found</a></li>
  <li><a href="#动态加载的动态库无法调试的问题" id="toc-动态加载的动态库无法调试的问题" class="nav-link" data-scroll-target="#动态加载的动态库无法调试的问题">动态加载的动态库无法调试的问题</a></li>
  <li><a href="#relocation-r_riscv_jal-out-of-range" id="toc-relocation-r_riscv_jal-out-of-range" class="nav-link" data-scroll-target="#relocation-r_riscv_jal-out-of-range">relocation R_RISCV_JAL out of range</a></li>
  <li><a href="#lldb-调试pythonccsharp" id="toc-lldb-调试pythonccsharp" class="nav-link" data-scroll-target="#lldb-调试pythonccsharp">lldb 调试python/c++/csharp</a></li>
  <li><a href="#lldb-调试通过loadelf启动的可执行文件" id="toc-lldb-调试通过loadelf启动的可执行文件" class="nav-link" data-scroll-target="#lldb-调试通过loadelf启动的可执行文件">lldb 调试通过loadelf启动的可执行文件</a></li>
  <li><a href="#linux分布式资源分配" id="toc-linux分布式资源分配" class="nav-link" data-scroll-target="#linux分布式资源分配">linux分布式资源分配</a>
  <ul class="collapse">
  <li><a href="#taskset" id="toc-taskset" class="nav-link" data-scroll-target="#taskset">taskset</a></li>
  <li><a href="#numactl" id="toc-numactl" class="nav-link" data-scroll-target="#numactl">numactl</a></li>
  <li><a href="#mpi指定拓扑" id="toc-mpi指定拓扑" class="nav-link" data-scroll-target="#mpi指定拓扑">mpi指定拓扑</a></li>
  </ul></li>
  <li><a href="#perf常用命令" id="toc-perf常用命令" class="nav-link" data-scroll-target="#perf常用命令">perf常用命令</a></li>
  <li><a href="#profile-python" id="toc-profile-python" class="nav-link" data-scroll-target="#profile-python">profile python</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">cpp挖坑&amp;爬坑</h1>
  <div class="quarto-categories">
    <div class="quarto-category">编程语言</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 25, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>记录一些遇到的cpp新特性或者实现技巧上的问题。</p>
<!--more-->
<section id="变长参数" class="level2">
<h2 class="anchored" data-anchor-id="变长参数">变长参数</h2>
<p>我记得三年前我还好好学过，现在都忘光了，重新整理一下：</p>
<section id="基本定义" class="level3">
<h3 class="anchored" data-anchor-id="基本定义">基本定义</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> 获取不同长度的可变参数，打印参数的个数</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@tparam</span><span class="co"> </span><span class="cv">T</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">args</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span><span class="op">...</span> T<span class="op">&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> func<span class="op">(</span>T<span class="op">...</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> <span class="kw">sizeof</span><span class="op">...(</span>args<span class="op">)</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_varg<span class="op">,</span> basic<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  func<span class="op">();</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  func<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  func<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  func<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="ch">'3'</span><span class="op">,</span> vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;{</span><span class="dv">3</span><span class="op">});</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"> [ RUN      ] test_varg.basic</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">  0</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">  1</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">  2</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">  4</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">  [       OK ] test_varg.basic (0 ms)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="循环展开" class="level3">
<h3 class="anchored" data-anchor-id="循环展开">循环展开</h3>
<section id="错误写法" class="level4">
<h4 class="anchored" data-anchor-id="错误写法">错误写法</h4>
<p>参数匹配的时候需要注意，多个参数输入，最后会匹配到单参数的输入，但是单参数的时候不会调用无参数的终止函数。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print<span class="op">()</span> <span class="op">{</span> cout <span class="op">&lt;&lt;</span> <span class="st">" ;"</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print<span class="op">(</span>T v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> v <span class="op">&lt;&lt;</span> <span class="st">" "</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="kw">typename</span><span class="op">...</span> Args<span class="op">&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print<span class="op">(</span>T head<span class="op">,</span> Args<span class="op">...</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  print<span class="op">(</span>head<span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> <span class="st">"remain size : "</span> <span class="op">&lt;&lt;</span> <span class="kw">sizeof</span><span class="op">...(</span>args<span class="op">)</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  print<span class="op">(</span>args<span class="op">...);</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_varg<span class="op">,</span> recursive_print_error_version<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  print<span class="op">();</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  print<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  print<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="fl">2.3</span><span class="op">,</span> <span class="ch">'3'</span><span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"> [ RUN      ] test_varg.recursive_print</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">  ;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">  1 remain size : 1</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">  2 1 remain size : 2</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">  2.3 remain size : 1</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">  3 [       OK ] test_varg.recursive_print (0 ms)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="正确写法" class="level4">
<h4 class="anchored" data-anchor-id="正确写法">正确写法</h4>
<p>所以我们通常用一个无参的函数来终止，在多参数的函数中调用单个参数的处理方式。下面的例子就展示了正确的<code>log</code>函数以及一个从任意<code>base</code>累加的函数。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ic<span class="op">()</span> <span class="op">{</span> cout <span class="op">&lt;&lt;</span> <span class="st">" ; "</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="kw">typename</span><span class="op">...</span> Args<span class="op">&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ic<span class="op">(</span>T head<span class="op">,</span> Args<span class="op">...</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> head <span class="op">&lt;&lt;</span> <span class="st">" "</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>args<span class="op">...);</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>T sums<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>T<span class="op">)(-</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="kw">typename</span><span class="op">...</span> Ts<span class="op">&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>T sums<span class="op">(</span>T v<span class="op">,</span> Ts<span class="op">...</span> vs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> v <span class="op">+</span> sums<span class="op">&lt;</span>T<span class="op">&gt;(</span>vs<span class="op">...);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_varg<span class="op">,</span> recursive_print_right_version<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>sums<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">));</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>sums<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="fl">2.3</span><span class="op">,</span> <span class="fl">3.5</span><span class="op">));</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>sums<span class="op">(</span><span class="fl">2.3</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">3.5</span><span class="op">));</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">[ RUN      ] test_varg.recursive_print_right_version</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">1  ; </span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">4  ; </span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">4.8  ; </span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">[       OK ] test_varg.recursive_print_right_version (0 ms)</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="变参模板展开" class="level3">
<h3 class="anchored" data-anchor-id="变参模板展开">变参模板展开</h3>
<p>这里利用c++17中的特性方便的展开并对参数进行处理。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> toint<span class="op">(</span>T t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>t<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span><span class="op">...</span> Args<span class="op">&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> toints<span class="op">(</span>Args<span class="op">...</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> arr <span class="op">=</span> <span class="op">{</span>toint<span class="op">(</span>args<span class="op">)...};</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> arr<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">// 利用if constexpr编译期间即构造出对应的输出方式。</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Head<span class="op">,</span> <span class="kw">typename</span><span class="op">...</span> Args<span class="op">&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print2<span class="op">(</span>Head head<span class="op">,</span> Args<span class="op">...</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> head<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="kw">sizeof</span><span class="op">...(</span>args<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    cout <span class="op">&lt;&lt;</span> <span class="st">" , "</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    print2<span class="op">(</span>args<span class="op">...);</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    cout <span class="op">&lt;&lt;</span> <span class="st">" ; "</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_varg<span class="op">,</span> expand_right_version<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> arr <span class="op">=</span> toints<span class="op">(</span><span class="fl">1.2</span><span class="op">,</span> <span class="fl">2.4</span><span class="op">,</span> <span class="fl">3.6</span><span class="op">,</span> <span class="fl">4.7</span><span class="op">);</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arr<span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span> ic<span class="op">(</span>arr<span class="op">[</span>i<span class="op">]);</span> <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> arr2 <span class="op">=</span> countargs<span class="op">(</span><span class="fl">1.2</span><span class="op">,</span> <span class="fl">2.4</span><span class="op">,</span> <span class="fl">3.6</span><span class="op">,</span> <span class="fl">4.7</span><span class="op">);</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arr2<span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span> ic<span class="op">(</span>arr2<span class="op">[</span>i<span class="op">]);</span> <span class="op">}</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  print2<span class="op">(</span><span class="st">"hello"</span><span class="op">,</span> <span class="st">"word"</span><span class="op">,</span> <span class="st">"yes"</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="fl">4.5</span><span class="op">);</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>我们可以利用一个函数对每个参数进行操作，并且结合逗号表达式可以做一些别的事情。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> RUN      <span class="bu">]</span> <span class="ex">test_varg.expand_right_version</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>  <span class="kw">;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span>  <span class="kw">;</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span>  <span class="kw">;</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span>  <span class="kw">;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span>  <span class="kw">;</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>  <span class="kw">;</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span>  <span class="kw">;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span>  <span class="kw">;</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="ex">hello</span> , word , yes , 1 , 3 , 4.5 <span class="kw">;</span> </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>       OK <span class="bu">]</span> <span class="ex">test_varg.expand_right_version</span> <span class="er">(</span><span class="ex">0</span> ms<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="折叠表达式" class="level3">
<h3 class="anchored" data-anchor-id="折叠表达式">折叠表达式</h3>
<p>用折叠表达式可以把一些简单的递归写的更加简洁，但是他的运算方向和人通常认为的不同：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span><span class="op">...</span> T<span class="op">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> rsub<span class="op">(</span>T<span class="op">...</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>t <span class="op">-</span> <span class="op">...);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span><span class="op">...</span> T<span class="op">&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> lsub<span class="op">(</span>T<span class="op">...</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(...</span> <span class="op">-</span> t<span class="op">);</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_varg<span class="op">,</span> fold_expressions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> rsub<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  cout <span class="op">&lt;&lt;</span> lsub<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> RUN      <span class="bu">]</span> <span class="ex">test_varg.fold_expressions</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-13</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>       OK <span class="bu">]</span> <span class="ex">test_varg.fold_expressions</span> <span class="er">(</span><span class="ex">0</span> ms<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="integer_sequence" class="level3">
<h3 class="anchored" data-anchor-id="integer_sequence">integer_sequence</h3>
<p>利用integer_sequence我们可以展开一些数组，并对数组中的每个元素做处理，下面就给出一段编译期展开循环去计算卷积的程序：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> W<span class="op">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> conv1xM<span class="op">(</span><span class="dt">float</span><span class="op">&amp;</span> sum<span class="op">,</span> T r<span class="op">,</span> T k<span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>W<span class="op">...&gt;)</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">((</span>sum <span class="op">+=</span> r<span class="op">[</span>W<span class="op">]</span> <span class="op">*</span> k<span class="op">[</span>W<span class="op">]),</span> <span class="op">...);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> Filter_W<span class="op">,</span> <span class="kw">typename</span> T<span class="op">,</span> <span class="dt">size_t</span> Filter_H<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> H<span class="op">&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> convNxM<span class="op">(</span><span class="dt">float</span><span class="op">&amp;</span> sum<span class="op">,</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> Filter_H<span class="op">&gt;&amp;</span> r<span class="op">,</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> Filter_H<span class="op">&gt;&amp;</span> k<span class="op">,</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>             <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>H<span class="op">...&gt;)</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>conv1xM<span class="op">(</span>sum<span class="op">,</span> r<span class="op">[</span>H<span class="op">],</span> k<span class="op">[</span>H<span class="op">],</span> <span class="bu">std::</span>make_index_sequence<span class="op">&lt;</span>Filter_W<span class="op">&gt;{}),</span> <span class="op">...);</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> Filter_W<span class="op">,</span> <span class="kw">typename</span> T<span class="op">,</span> <span class="dt">size_t</span> Filter_H<span class="op">&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> convNxM<span class="op">(</span><span class="dt">float</span><span class="op">&amp;</span> sum<span class="op">,</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> Filter_H<span class="op">&gt;&amp;</span> r<span class="op">,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>             <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> Filter_H<span class="op">&gt;&amp;</span> k<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  convNxM<span class="op">&lt;</span>Filter_W<span class="op">&gt;(</span>sum<span class="op">,</span> r<span class="op">,</span> k<span class="op">,</span> <span class="bu">std::</span>make_index_sequence<span class="op">&lt;</span>Filter_H<span class="op">&gt;{});</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_tmp<span class="op">,</span> conv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="dt">size_t</span> K_h <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> K_w <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> I_h <span class="op">=</span> <span class="dv">32</span><span class="op">,</span> I_w <span class="op">=</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> kernel<span class="op">[</span>K_h <span class="op">*</span> K_w<span class="op">];</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>iota<span class="op">(</span>kernel<span class="op">,</span> kernel <span class="op">+</span> K_h <span class="op">*</span> K_w<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> image<span class="op">[</span>I_h <span class="op">*</span> I_w<span class="op">];</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>iota<span class="op">(</span>image<span class="op">,</span> image <span class="op">+</span> I_h <span class="op">*</span> I_w<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  IC<span class="op">(</span>image<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">float</span><span class="op">*,</span> K_h<span class="op">&gt;</span> r<span class="op">{</span>image<span class="op">,</span> image <span class="op">+</span> I_w<span class="op">,</span> image <span class="op">+</span> I_w <span class="op">*</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">float</span><span class="op">*,</span> K_h<span class="op">&gt;</span> k<span class="op">{</span>kernel<span class="op">,</span> kernel <span class="op">+</span> K_w<span class="op">,</span> kernel <span class="op">+</span> K_w <span class="op">*</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> sum <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  convNxM<span class="op">&lt;</span>K_w<span class="op">&gt;(</span>sum<span class="op">,</span> r<span class="op">,</span> k<span class="op">);</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  IC<span class="op">(</span>sum<span class="op">);</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>输出</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> RUN      <span class="bu">]</span> <span class="ex">test_tmp.conv</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="va">image</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="ex">:</span> 0</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="ex">sum:</span> 14835</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>       OK <span class="bu">]</span> <span class="ex">test_tmp.conv</span> <span class="er">(</span><span class="ex">0</span> ms<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>总之我们利用模板传递静态时期的常量，然后利用index sequence对当前的数组进行索引从而获得展开循环的加速效果。</p>
</section>
</section>
<section id="右值左值" class="level2">
<h2 class="anchored" data-anchor-id="右值左值">右值&amp;左值</h2>
<section id="一个问题" class="level3">
<h3 class="anchored" data-anchor-id="一个问题">一个问题</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dosomething<span class="op">(</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> arr<span class="op">)</span> <span class="op">{</span> arr<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>rvalue<span class="op">,</span> basic<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> arr<span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">};</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  dosomething<span class="op">(</span>arr<span class="op">);</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  dosomething<span class="op">(</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">});</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="模板" class="level1">
<h1>模板</h1>
<section id="获取容器内部类型" class="level3">
<h3 class="anchored" data-anchor-id="获取容器内部类型">获取容器内部类型</h3>
<p>有个很蛋疼的问题就是对于传入一个array的数据，我们的模板定义需要</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span><span class="dt">size_t</span> N<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>然后我就找了一下有没有方便的办法，发现可以这样：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Array<span class="op">&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="dt">element_type_t</span> <span class="op">=</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>remove_reference_t<span class="op">&lt;</span><span class="kw">decltype</span><span class="op">(*</span><span class="bu">std::</span>begin<span class="op">(</span><span class="bu">std::</span>declval<span class="op">&lt;</span>Array<span class="op">&amp;&gt;()))&gt;;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> N <span class="op">=</span> <span class="dv">20</span><span class="op">,</span> <span class="kw">typename</span> Array<span class="op">&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> get_same_type_array<span class="op">(</span>Array<span class="op">&amp;</span> a<span class="op">,</span> <span class="dt">element_type_t</span><span class="op">&lt;</span>Array<span class="op">&gt;</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">element_type_t</span><span class="op">&lt;</span>Array<span class="op">&gt;,</span> N<span class="op">&gt;</span> c<span class="op">{</span>b<span class="op">};</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> c<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_tmp<span class="op">,</span> <span class="dt">test_get_array_type</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="dt">size_t</span> K_h <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> K_w <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> I_h <span class="op">=</span> <span class="dv">32</span><span class="op">,</span> I_w <span class="op">=</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> kernel<span class="op">[</span>K_h <span class="op">*</span> K_w<span class="op">];</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>iota<span class="op">(</span>kernel<span class="op">,</span> kernel <span class="op">+</span> K_h <span class="op">*</span> K_w<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> image<span class="op">[</span>I_h <span class="op">*</span> I_w<span class="op">];</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>iota<span class="op">(</span>image<span class="op">,</span> image <span class="op">+</span> I_h <span class="op">*</span> I_w<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  IC<span class="op">(</span>image<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">float</span><span class="op">*,</span> K_h<span class="op">&gt;</span> r<span class="op">{</span>image<span class="op">,</span> image <span class="op">+</span> I_w<span class="op">,</span> image <span class="op">+</span> I_w <span class="op">*</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">float</span><span class="op">*,</span> K_h<span class="op">&gt;</span> k<span class="op">{</span>kernel<span class="op">,</span> kernel <span class="op">+</span> K_w<span class="op">,</span> kernel <span class="op">+</span> K_w <span class="op">*</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> b <span class="op">=</span> get_same_type_array<span class="op">&lt;</span><span class="dv">5</span><span class="op">&gt;(</span>r<span class="op">,</span> image<span class="op">);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  IC<span class="op">(</span>b<span class="op">);</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>实际上也就是静态时期的编译获得类型，然后得知输入b的类型，这样我们少输入一个模板，在多重模板迭代的过程中十分方便。</p>
<p>输出：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> RUN      <span class="bu">]</span> <span class="ex">test_tmp.test_get_array_type</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="va">image</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="ex">:</span> 0</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="ex">b:</span> [0x16ceccb30, 0x0, 0x0, 0x0, 0x0]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>       OK <span class="bu">]</span> <span class="ex">test_tmp.test_get_array_type</span> <span class="er">(</span><span class="ex">0</span> ms<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="编译期通过类型执行不同的代码" class="level2">
<h2 class="anchored" data-anchor-id="编译期通过类型执行不同的代码">编译期通过类型执行不同的代码</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Mat <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span><span class="op">*</span> data<span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">()</span> <span class="op">{</span> data <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[</span><span class="dv">100</span><span class="op">];</span> <span class="op">}</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>Mat<span class="op">(){};</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> make_mat<span class="op">(</span>T<span class="op">&amp;</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="bu">std::</span>is_pointer<span class="op">&lt;</span>T<span class="op">&gt;())</span> <span class="op">{</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    IC<span class="op">(</span><span class="st">"is pointer"</span><span class="op">);</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    m<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    IC<span class="op">(</span><span class="st">"is Mat"</span><span class="op">);</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    m<span class="op">.</span>data<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test_tmp<span class="op">,</span> integral_constant<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  Mat m1<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span><span class="op">*</span> m2 <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  make_mat<span class="op">(</span>m1<span class="op">);</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  make_mat<span class="op">(</span>m2<span class="op">);</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>输出</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span> RUN      <span class="op">]</span> test_tmp<span class="op">.</span>integral_constant</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ic<span class="op">|</span> <span class="bu">std::</span>string<span class="op">(</span><span class="st">"is Mat"</span><span class="op">):</span> <span class="st">"is Mat"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ic<span class="op">|</span> <span class="bu">std::</span>string<span class="op">(</span><span class="st">"is pointer"</span><span class="op">):</span> <span class="st">"is pointer"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>       OK <span class="op">]</span> test_tmp<span class="op">.</span>integral_constant <span class="op">(</span><span class="dv">0</span> ms<span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="类型保存值" class="level2">
<h2 class="anchored" data-anchor-id="类型保存值">类型保存值</h2>
<p>这个是我写了半天才发现c++模板的套路,其实就是把一个变量看成一个类型,下面就是把这个模板参数用两种方式表示(不过我暂时还不知道如何选择这两种方式):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">uint64_t</span> mmu_item<span class="op">,</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>          <span class="dt">uint64_t</span> start_bank<span class="op">,</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>          MMU_CONF_WIDTH width<span class="op">,</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>          <span class="dt">uint64_t</span> start_depth<span class="op">,</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">uint64_t</span> depth<span class="op">&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> inst_mmu_conf_warper</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> type <span class="op">=</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span><span class="bn">0x12</span><span class="op">,</span> mmu_item<span class="op">,</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                   start_bank<span class="op">,</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint64_t</span><span class="op">&gt;(</span>width<span class="op">),</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                                   start_depth<span class="op">,</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                                   depth<span class="op">&gt;;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="at">static</span> <span class="kw">auto</span> values <span class="op">=</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span><span class="bn">0x12</span><span class="op">,</span> mmu_item<span class="op">,</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                                                     start_bank<span class="op">,</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                                                     <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint64_t</span><span class="op">&gt;(</span>width<span class="op">),</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                                                     start_depth<span class="op">,</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                                                     depth<span class="op">&gt;{};</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="结构体模板元函数的套路" class="level2">
<h2 class="anchored" data-anchor-id="结构体模板元函数的套路">结构体模板元函数的套路</h2>
<p>其实一开始写模板看不懂就是因为c++的语法太多了,不过我们还是只需要掌握一些主要的语法就可以了.</p>
<p>我主要接触到的模板主要分以下几种表示方法.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* 模板元函数的写法 1 */</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 定义元函数的入参,这里表明这个结构体接收一个类型作为参数</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> method_1 <span class="op">{};</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">// 我们特化上面的那个元函数,通常特化直接写值,但是由于我们当前给的参数还依赖一个未知的`Value`,因此还需要给元函数再加一个模板类型.</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> Value<span class="op">&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> method_1<span class="op">&lt;</span><span class="bu">std::</span>integral_constant<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">,</span> Value<span class="op">&gt;&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 同时对于这个模板元的返回值也有两种方法,可以是一个静态的变量,也可以是对应的类型(此时那个类型其实也保存了值)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="at">static</span> <span class="dt">size_t</span> one_v <span class="op">=</span> Value <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">one_t</span> <span class="op">=</span> <span class="bu">std::</span>integral_constant<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">,</span> Value <span class="op">+</span> <span class="dv">1</span><span class="op">&gt;;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="模板元函数编写与匹配的几个套路" class="level2">
<h2 class="anchored" data-anchor-id="模板元函数编写与匹配的几个套路">模板元函数编写与匹配的几个套路</h2>
<p>在c++17之前我们可以用<code>std::enable_if</code>来决议这个匹配是不是有效的,首先对于同一个函数,他的返回值应该是一致的(保证我们思维的一致性),所以通过<code>enable_if</code>决议当前的输入类型下是否可以匹配. 下面这个例子就是把整形和array类型通过决议分开匹配,从而实现不同的<code>assgin_to_array</code>,不然输入的<code>array</code>还是会被默认匹配到第一个函数:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Is<span class="op">&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>enable_if_t<span class="op">&lt;</span><span class="bu">std::</span>is_integral_v<span class="op">&lt;</span>T<span class="op">&gt;,</span> <span class="dt">void</span><span class="op">&gt;</span> assgin_to_array<span class="op">(</span><span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>T<span class="op">)&gt;</span> <span class="op">&amp;</span>dest<span class="op">,</span> <span class="at">const</span> T <span class="op">&amp;</span>src<span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>Is<span class="op">...&gt;)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">((</span>dest<span class="op">[</span>Is<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>src <span class="op">&gt;&gt;</span> <span class="op">(</span>Is <span class="op">*</span> <span class="dv">8</span><span class="op">))),</span> <span class="op">...);</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T1<span class="op">,</span> <span class="kw">typename</span> T2<span class="op">,</span> <span class="dt">size_t</span> N<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Is<span class="op">&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>enable_if_t<span class="op">&lt;</span><span class="kw">sizeof</span><span class="op">(</span>T1<span class="op">)</span> <span class="op">==</span> <span class="kw">sizeof</span><span class="op">(</span>T2<span class="op">),</span> <span class="dt">void</span><span class="op">&gt;</span> assgin_to_array<span class="op">(</span><span class="bu">std::</span>array<span class="op">&lt;</span>T1<span class="op">,</span> N<span class="op">&gt;</span> <span class="op">&amp;</span>dest<span class="op">,</span> <span class="at">const</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T2<span class="op">,</span> N<span class="op">&gt;</span> <span class="op">&amp;</span>src<span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>Is<span class="op">...&gt;)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  copy<span class="op">(</span>dest<span class="op">.</span>data<span class="op">(),</span> src<span class="op">.</span>data<span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>Is<span class="op">...&gt;{});</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>不过现在有了<code>constexpr if</code>,我们可以直接在同一个函数中不同的操作,这里要注意一个小坑,就是<code>std::is_array</code>只能检测是不是c风格的数组,但是他不能检测<code>std::array</code>,所以我这里重写了一个<code>is_std_array</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Is<span class="op">&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">void</span> assgin_to_array<span class="op">(</span><span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>T<span class="op">)&gt;</span> <span class="op">&amp;</span>dest<span class="op">,</span> <span class="at">const</span> T <span class="op">&amp;</span>src<span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>Is<span class="op">...&gt;)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="bu">std::</span>is_integral_v<span class="op">&lt;</span>T<span class="op">&gt;)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">((</span>dest<span class="op">[</span>Is<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>src <span class="op">&gt;&gt;</span> <span class="op">(</span>Is <span class="op">*</span> <span class="dv">8</span><span class="op">))),</span> <span class="op">...);</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>is_std_array<span class="op">&lt;</span>T<span class="op">&gt;::</span>value<span class="op">)</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    copy<span class="op">(</span>dest<span class="op">.</span>data<span class="op">(),</span> src<span class="op">.</span>data<span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">std::</span>index_sequence<span class="op">&lt;</span>Is<span class="op">...&gt;{});</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tuple元素进行fold-expressions中重载操作符遇到的坑" class="level2">
<h2 class="anchored" data-anchor-id="tuple元素进行fold-expressions中重载操作符遇到的坑">tuple元素进行fold expressions中重载操作符遇到的坑</h2>
<p>我想重载<code>+</code>然后对<code>tuple</code>进行操作,但是遇到找不到重载加号的问题.最后发现这个操作必须要声明到std才有效.</p>
</section>
<section id="变长模板匹配的模式" class="level2">
<h2 class="anchored" data-anchor-id="变长模板匹配的模式">变长模板匹配的模式</h2>
<p>c++变长模板他不能匹配<code>seq&lt;Le..., Ls&gt;</code>这种模式,只能匹配<code>seq&lt;Ls,Le...&gt;</code>,也就是取第一个元素是方便的(或者前n个元素都是方便的),如果你想取最后一个元素那么就需要递归一次.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> take_head</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> Ls<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Le<span class="op">&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> take_head<span class="op">&lt;</span>seq<span class="op">&lt;</span>Ls<span class="op">,</span> Le<span class="op">...&gt;&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="at">static</span> <span class="dt">size_t</span> value <span class="op">=</span> Ls<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> A<span class="op">,</span> <span class="kw">typename</span> B<span class="op">&gt;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> take_two_head</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">size_t</span> Ls<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Le<span class="op">,</span> <span class="dt">size_t</span> Rs<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Re<span class="op">&gt;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> take_two_head<span class="op">&lt;</span>seq<span class="op">&lt;</span>Le<span class="op">...,</span> Ls<span class="op">&gt;,</span> seq<span class="op">&lt;</span>Re<span class="op">...,</span> Rs<span class="op">&gt;&gt;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="at">static</span> <span class="dt">size_t</span> value_L <span class="op">=</span> Ls<span class="op">;</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="at">static</span> <span class="dt">size_t</span> value_R <span class="op">=</span> Rs<span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test<span class="op">,</span> take_two_head<span class="op">)</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  take_two_head<span class="op">&lt;</span>seq<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">&gt;,</span> seq<span class="op">&lt;</span><span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">&gt;&gt;</span> two<span class="op">{};</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  auto lh = {} value;</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>two<span class="op">.</span>value_L<span class="op">);</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(</span>two<span class="op">.</span>value_R<span class="op">);</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="通过隐式转换来实现零成本抽象" class="level2">
<h2 class="anchored" data-anchor-id="通过隐式转换来实现零成本抽象">通过隐式转换来实现零成本抽象</h2>
<p>通过vector包</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstddef&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstring&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;optional&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;span&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;utility&gt;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;arm_neon.h&gt;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> T<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Lanes<span class="op">&gt;</span> <span class="kw">struct</span> <span class="dt">native_vector_type</span><span class="op">;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span> <span class="kw">struct</span> <span class="dt">native_vector_type</span><span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span> <span class="dv">32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> <span class="dt">float32x4_t</span><span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span> <span class="kw">struct</span> <span class="dt">native_vector_type</span><span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span> <span class="dv">4</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> <span class="dt">float32x4_t</span><span class="op">;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> T<span class="op">,</span> <span class="dt">size_t</span><span class="op">...</span> Lanes<span class="op">&gt;</span> <span class="kw">struct</span> vector <span class="op">{</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">element_type</span> <span class="op">=</span> T<span class="op">;</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">value_type</span> <span class="op">=</span> <span class="kw">typename</span> <span class="dt">native_vector_type</span><span class="op">&lt;</span>T<span class="op">,</span> Lanes<span class="op">...&gt;::</span>type<span class="op">;</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span><span class="op">:</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alignas</span><span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">value_type</span><span class="op">))</span> <span class="dt">value_type</span> <span class="va">v_</span><span class="op">;</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">(</span><span class="at">const</span> <span class="dt">value_type</span> <span class="op">&amp;</span>vec<span class="op">)</span> <span class="op">:</span> <span class="va">v_</span><span class="op">(</span>vec<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">operator</span> <span class="dt">value_type</span><span class="op">()</span> <span class="at">const</span> <span class="kw">noexcept</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">v_</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">operator</span> <span class="dt">value_type</span> <span class="op">&amp;()</span> <span class="kw">noexcept</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">v_</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> buffer<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>span<span class="op">(</span><span class="kw">reinterpret_cast</span><span class="op">&lt;</span><span class="dt">element_type</span> <span class="op">*&gt;(&amp;</span><span class="va">v_</span><span class="op">),</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>                         <span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="op">...</span> <span class="op">*</span> Lanes<span class="op">));</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span><span class="dv">4</span><span class="op">&gt;</span> <span class="op">*</span>a <span class="op">=</span> <span class="kw">new</span> vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span><span class="dv">4</span><span class="op">&gt;();</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>buffer<span class="op">()[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>buffer<span class="op">()[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span><span class="dv">4</span><span class="op">&gt;</span> b<span class="op">;</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    b<span class="op">.</span>buffer<span class="op">()[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    b<span class="op">.</span>buffer<span class="op">()[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// float32x4_t d;</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">,</span><span class="dv">4</span><span class="op">&gt;</span> c <span class="op">=</span> <span class="op">*</span>a <span class="op">*</span> b<span class="op">;</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> c<span class="op">.</span>buffer<span class="op">()[</span><span class="dv">0</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> c<span class="op">.</span>buffer<span class="op">()[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span>   </span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="类" class="level1">
<h1>类</h1>
<section id="explicit" class="level2">
<h2 class="anchored" data-anchor-id="explicit">explicit</h2>
<p>explicit是用于表示当前的构造函数不能进行隐式转换，比如如下代码：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StrBlob <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  shared_ptr<span class="op">&lt;</span>vector<span class="op">&lt;</span>string<span class="op">&gt;&gt;</span> data<span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  StrBlob<span class="op">()</span> <span class="op">:</span> data<span class="op">(</span>make_shared<span class="op">&lt;</span>vector<span class="op">&lt;</span>string<span class="op">&gt;&gt;()){};</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  StrBlob<span class="op">(</span>initializer_list<span class="op">&lt;</span>string<span class="op">&gt;</span> il<span class="op">)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> data<span class="op">(</span>make_shared<span class="op">&lt;</span>vector<span class="op">&lt;</span>string<span class="op">&gt;&gt;(</span>il<span class="op">)){};</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> data<span class="op">-&gt;</span>size<span class="op">();</span> <span class="op">};</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> use_count<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> data<span class="op">.</span>use_count<span class="op">();</span> <span class="op">};</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> string<span class="op">&amp;</span> front<span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    check<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="st">"front"</span><span class="op">);</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">-&gt;</span>front<span class="op">();</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> string<span class="op">&amp;</span> back<span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    check<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="st">"back"</span><span class="op">);</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">-&gt;</span>back<span class="op">();</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> push_back<span class="op">(</span><span class="at">const</span> string<span class="op">&amp;</span> s<span class="op">)</span> <span class="op">{</span> data<span class="op">-&gt;</span>push_back<span class="op">(</span>s<span class="op">);</span> <span class="op">}</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> pop_back<span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    check<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="st">"pop_back"</span><span class="op">);</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    data<span class="op">-&gt;</span>pop_back<span class="op">();</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> combine<span class="op">(</span>StrBlob sb<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> p <span class="op">=</span> sb<span class="op">.</span>data<span class="op">-&gt;</span>begin<span class="op">();</span> p <span class="op">!=</span> sb<span class="op">.</span>data<span class="op">-&gt;</span>end<span class="op">();</span> p<span class="op">++)</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>      data<span class="op">-&gt;</span>push_back<span class="op">(*</span>p<span class="op">);</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a> <span class="kw">private</span><span class="op">:</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> check<span class="op">(</span><span class="dt">size_t</span> i<span class="op">,</span> <span class="at">const</span> string<span class="op">&amp;</span> msg<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;=</span> data<span class="op">-&gt;</span>size<span class="op">())</span> <span class="op">{</span> <span class="cf">throw</span> out_of_range<span class="op">(</span>msg<span class="op">);</span> <span class="op">}</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test<span class="op">,</span> t_12_5<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  StrBlob b1<span class="op">{</span><span class="st">"1"</span><span class="op">,</span> <span class="st">"2"</span><span class="op">,</span> <span class="st">"3"</span><span class="op">};</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(*</span>b1<span class="op">.</span>data<span class="op">);</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  b1<span class="op">.</span>combine<span class="op">({</span><span class="st">"4"</span><span class="op">,</span> <span class="st">"5"</span><span class="op">,</span> <span class="st">"6"</span><span class="op">});</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(*</span>b1<span class="op">.</span>data<span class="op">);</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>我们在调用combine函数的时候需要的是一个StrBlob对象，但是我们实际combine的时候传入的是一个初始化列表，那么这个时候就会把隐式调用对应的构造函数，完成参数传递。这个时候如果我们给对应初始化列表的构造函数进行explicit限制，那么就会出现编译错误，要求传入一个正确的StrBlob对象。</p>
</section>
</section>
<section id="share_ptr" class="level1">
<h1>share_ptr</h1>
<section id="构造函数" class="level2">
<h2 class="anchored" data-anchor-id="构造函数">构造函数</h2>
<p>这里有点奇怪，不强行指定<code>initializer_list&lt;int&gt;</code>是无法通过编译的，这太蛋疼了。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>make_shared<span class="op">&lt;</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&gt;(</span>initializer_list<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">})</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>同时make_shared还不支持new的方式构造shared_ptr。 ## 拷贝赋值</p>
<p>他的赋值是直接把被赋值对象的内容给清空了，被赋值之后，q和 p其实都是q了，最后退出scope的时候，p的use_count会因为q的释放减少。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>TEST<span class="op">(</span>test<span class="op">,</span> shared_ptr_copy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> p <span class="op">=</span> make_shared<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> q <span class="op">=</span> make_shared<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span><span class="dv">11</span><span class="op">);</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> q<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    ic<span class="op">(*</span>q<span class="op">,</span> q<span class="op">.</span>use_count<span class="op">());</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    ic<span class="op">(*</span>p<span class="op">,</span> p<span class="op">.</span>use_count<span class="op">());</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  ic<span class="op">(*</span>p<span class="op">,</span> p<span class="op">.</span>use_count<span class="op">());</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> RUN      <span class="bu">]</span> <span class="ex">test.shared_ptr_copy</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="ex">*q:</span> 11, q.use_count<span class="er">(</span><span class="kw">)</span><span class="bu">:</span> 2</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="ex">*p:</span> 11, p.use_count<span class="er">(</span><span class="kw">)</span><span class="bu">:</span> 2</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ic</span><span class="kw">|</span> <span class="ex">*p:</span> 11, p.use_count<span class="er">(</span><span class="kw">)</span><span class="bu">:</span> 1</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>       OK <span class="bu">]</span> <span class="ex">test.shared_ptr_copy</span> <span class="er">(</span><span class="ex">0</span> ms<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="c-munmap_chunk-invalid-pointer" class="level2">
<h2 class="anchored" data-anchor-id="c-munmap_chunk-invalid-pointer">C++: munmap_chunk(): invalid pointer</h2>
<ol type="1">
<li>通常这个问题应该是delete的内存不是被new出来的。</li>
<li>指针运行时被修改</li>
<li>指针越界（数组越界赋值了，但是当时不报错）</li>
</ol>
</section>
</section>
<section id="clang编译中报错-no-viable-overloaded" class="level1">
<h1>clang编译<map>中报错 no viable overloaded ‘=’</map></h1>
<p>这个应该是clang的map头文件实现导致的,</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>    _LIBCPP_INLINE_VISIBILITY</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    __value_type<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> __value_type<span class="op">&amp;</span> __v<span class="op">)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        __ref<span class="op">()</span> <span class="op">=</span> __v<span class="op">.</span>__get_value<span class="op">();</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">*</span><span class="kw">this</span><span class="op">;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>通过clangd的类型提示发现:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span> <span class="bu">std::</span>__value_type::value_type <span class="op">&amp;</span>__get_value<span class="op">()</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>no viable overloaded <span class="ch">'='</span>GCC</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>__tree<span class="op">(</span><span class="dv">1662</span><span class="op">,</span> <span class="dv">39</span><span class="op">):</span> in instantiation of member function <span class="ch">'s</span><span class="er">td::__value_type&lt;const air::Var, int&gt;::operator=</span><span class="ch">'</span> requested here</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>这个应该就是声明了一个包含<code>const air::Var</code>类型的map,然后类型特化的时候就出错了.</p>
</section>
<section id="ld-unknown-option--z" class="level1">
<h1>ld: unknown option: -z</h1>
<p>这个也是在mac上独有的问题,gcc ld中可以通过<code>-Wl,-z,relro,-z,now,-z,noexecstack</code>传递linker的参数,但是mac上虽然也可以给apple clang提供相同的命令行,但是真正调用<code>ld</code>的时候就会报上述错误,原因就是mac上的ld真的不支持这些选项…所以关闭即可.</p>
</section>
<section id="ld-unknown-corefoundation" class="level1">
<h1>ld: unknown CoreFoundation</h1>
<p>我想给target加上link参数,但是用cmake的写法发现有个大坑, 如果直接加Wl然后选项, 再用字符串包裹起来, 是无法编译的, 但是如果不用字符串, 编译器就会把空格后面的东西识别成另一个选项.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target_link_options</span>(<span class="bn">simulator_k510</span> <span class="ot">PUBLIC</span> <span class="st">"-Wl,-framework CoreFoundation"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>所以正确做法是连续的加Wl</p>
<pre><code>target_link_options(simulator_k510 PUBLIC -Wl,-framework -Wl,CoreFoundation)</code></pre>
</section>
<section id="m1上eigen使用fp16时的坑" class="level1">
<h1>m1上eigen使用fp16时的坑</h1>
<p>在m1上eigen会检测到有fp16计算单元,此时<code>__half_raw</code>结构体中包含的就是<code>__fp16</code>类型</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> __half_raw <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(EIGEN_HAS_ARM64_FP16_SCALAR_ARITHMETIC)</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">explicit</span> EIGEN_DEVICE_FUNC EIGEN_CONSTEXPR __half_raw<span class="op">(</span>numext<span class="op">::</span><span class="dt">uint16_t</span> raw<span class="op">)</span> <span class="op">:</span> x<span class="op">(</span>numext<span class="op">::</span>bit_cast<span class="op">&lt;</span><span class="dt">__fp16</span><span class="op">&gt;(</span>raw<span class="op">))</span> <span class="op">{</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">__fp16</span> x<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">explicit</span> EIGEN_DEVICE_FUNC EIGEN_CONSTEXPR __half_raw<span class="op">(</span>numext<span class="op">::</span><span class="dt">uint16_t</span> raw<span class="op">)</span> <span class="op">:</span> x<span class="op">(</span>raw<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  numext<span class="op">::</span><span class="dt">uint16_t</span> x<span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>如果没有那么就是标准的uint16类型,所以此时不能随便将<code>__fp16</code>的<code>x</code>赋值给<code>fp16</code>,需要使用<code>Eigen::numext::bit_cast&lt;uint16_t&gt;(dst_eig_f16.x)</code>才行.</p>
</section>
<section id="c语言regex使用" class="level1">
<h1>c语言regex使用</h1>
<p>c里面的正则库是一个非常老的库,所以他的正则语法和其他语言有一部分正好相反,需要参考<a href="https://en.wikibooks.org/wiki/Regular_Expressions/POSIX_Basic_Regular_Expressions">这里</a>.</p>
</section>
<section id="linux下使用shared-memory的坑" class="level1">
<h1>linux下使用shared memory的坑</h1>
<p>我是在docker中的ubuntu容器中使用shared memory, 发现虽然可以创建shm文件,但是只要进行内存写入copy的时候就会报错<code>Bus Error</code>. 参考<a href="https://georgeoffley.com/blog/shared-memory-in-docker.html">这篇文章</a>才知道是docker本身限制的容器的shared memory大小只有64M.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> df <span class="at">-h</span> <span class="kw">|</span> <span class="fu">grep</span> shm</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">shm</span>                                                          64M   64M     0 100% /dev/shm</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="命令行调试dotnet-core的dump信息" class="level1">
<h1>命令行调试dotnet core的dump信息</h1>
<ol type="1">
<li>安装<a href="https://github.com/dotnet/diagnostics/blob/main/documentation/installing-sos-instructions.md">dotnet sos</a>
<ol type="1">
<li>注意mac m1系列需要<code>dotnet-sos install --arch Arm64</code></li>
</ol></li>
<li>然后开启core dump收集</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-c</span> unlimited</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"core.%e.%p"</span> <span class="op">&gt;</span> /proc/sys/kernel/core_pattern</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol type="1">
<li>通过lldb挂载core file</li>
</ol>
<p>这里我直接用vscode插件里面的lldb, 这个版本比较新,好用:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.vscode-server/extensions/vadimcn.vscode-lldb-1.7.2/lldb/bin/lldb</span> <span class="at">-c</span> tests/ForDebug/core..NET\ ThreadPool.298375</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>然后进去输入<code>bt</code>检查栈内容, 反正一顿调之后, 终于发现问题出在了.net过早的释放了c++的类对象. 原因是这个.net中类是对interpreter的包装,然后再构造entry funciton的对象, entry function里面包含了interpreter, 但是在调用entry function invoke的时候.net还是会把interpreter释放掉, 然后c++中就会出现runtime function运行到一半时访问了被释放的自身. 上面这个问题也只有在.net的release中才会出现, 我怀疑是因为.net优化了</p>
</section>
<section id="mac中缺少gmp的问题" class="level1">
<h1>mac中缺少gmp的问题</h1>
<p>mac中安装clang时候默认是没有gmp.h的, 但是如果安装了python的话是可以在python的inclue中找到.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> ll /Users/lisa/miniforge3/envs/dl/include <span class="kw">|</span> <span class="fu">grep</span> gmp</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-rw-r--</span>    1 lisa  staff    82K  5 15 18:32 gmp.h</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-rw-r--</span>    2 lisa  staff   126K 11 19  2020 gmpxx.h</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>然后可以添加链接库和头文件位置:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="va">CFLAGS</span><span class="op">=</span>-I/Users/lisa/miniforge3/envs/dl/include</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="va">LDFLAGS</span><span class="op">=</span>-L/Users/lisa/miniforge3/envs/dl/lib</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="mac中编译出现libclang-cpp.dylib的问题" class="level1">
<h1>mac中编译出现libclang-cpp.dylib的问题</h1>
<p>我这里是编译pet的lib, 然后make install的报错如下:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reason:</span> tried: <span class="st">'/usr/local/lib/libclang-cpp.dylib'</span> <span class="er">(</span><span class="ex">no</span> such file<span class="kw">)</span><span class="ex">,</span> <span class="st">'/usr/lib/libclang-cpp.dylib'</span> <span class="er">(</span><span class="ex">no</span> such file<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>然后发现是因为他的makefile里面调用了之前链接libclang的可执行文件extract_interface, 但是不知道为什么他的rpath没有设置对,导致还得手动设置<code>LD_LIBRARY_PATH</code>才能找到.so. 然后尝试了一下外部export环境变量,但是在makefile中并不起作用, 所以直接改了makefile: NOTE : 我这里是mac所以使用<code>DYLD_LIBRARY_PATH</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">isl.py:</span> libdep.a interface/isl.py.top</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">(</span><span class="fu">cat</span> <span class="va">$(</span><span class="ex">srcdir</span><span class="va">)</span>/interface/isl.py.top <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">DYLD_LIBRARY_PATH</span><span class="op">=</span>/Users/lisa/Documents/llvm-project/build/install/lib/ <span class="ex">isl/interface/extract_interface</span><span class="va">$(</span><span class="ex">EXEEXT</span><span class="va">)</span> <span class="dt">\</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">--language</span><span class="op">=</span>python <span class="dt">\</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>            <span class="va">$(</span><span class="ex">DEFAULT_INCLUDES</span><span class="va">)</span> <span class="at">-I</span><span class="va">$(</span><span class="ex">top_srcdir</span><span class="va">)</span>/isl/include <span class="at">-I</span><span class="va">$(</span><span class="ex">top_builddir</span><span class="va">)</span>/isl/include <span class="dt">\</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"./isl/all.h"</span><span class="kw">)</span> <span class="dt">\</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">&gt;</span> <span class="va">$@</span> <span class="kw">||</span> <span class="kw">(</span><span class="fu">rm</span> <span class="va">$@</span> <span class="kw">&amp;&amp;</span> <span class="fu">false</span><span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>找到了根本原因,其实就是他的编译器选项和clang的不同,他使用了<code>-R</code>来声明rpath, 但是clang中要使用<code>-Wl,-rpath,xxx</code>来设置rpath:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="va">CLANG_RFLAG</span><span class="op">=</span><span class="kw">`</span><span class="bu">echo</span> <span class="st">"</span><span class="va">$CLANG_LDFLAGS</span><span class="st">"</span> <span class="kw">|</span> <span class="va">$SED</span> <span class="at">-e</span> <span class="st">'s\/-L\/-R\/g'</span><span class="kw">`</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 改成如下即可.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="va">CLANG_RFLAG</span><span class="op">=</span><span class="kw">`</span><span class="bu">echo</span> <span class="st">"</span><span class="va">$CLANG_LDFLAGS</span><span class="st">"</span> <span class="kw">|</span> <span class="va">$SED</span> <span class="at">-e</span> <span class="st">'s/-L/-Wl,-rpath,/g'</span><span class="kw">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="mac中stdio.h-file-not-found" class="level1">
<h1>mac中’stdio.h’ file not found</h1>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/<span class="pp">*</span> /usr/local/include/</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="动态加载的动态库无法调试的问题" class="level1">
<h1>动态加载的动态库无法调试的问题</h1>
<p>对于一些链接优化的编译选项会导致这个问题, 最好是debug的时候关掉它。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set_property</span>(<span class="ot">TARGET</span> module <span class="ot">PROPERTY</span> <span class="ot">INTERPROCEDURAL_OPTIMIZATION</span> <span class="ot">$&lt;</span><span class="kw">NOT</span><span class="ot">:$&lt;</span><span class="kw">CONFIG</span><span class="ot">:Debug&gt;&gt;</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="relocation-r_riscv_jal-out-of-range" class="level1">
<h1>relocation R_RISCV_JAL out of range</h1>
<p>好像是因为.a太大了的缘故,导致relocation跳转不过去.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[build]</span> ld: error: /home/zqh/workspace/AndeSight_STD_v323/toolchains/nds64le-elf-mculib-v5d/bin/../lib/gcc/riscv64-elf/7.4.0/../../../../riscv64-elf/lib/libc.a<span class="er">(</span><span class="ex">lib_a-memmove.o</span><span class="kw">)</span><span class="bu">:</span><span class="er">(</span><span class="kw">function</span><span class="fu"> memmove</span><span class="kw">)</span><span class="bu">:</span> relocation R_RISCV_JAL out of range: 645800 is not in [-524288, 524287]</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[build]</span> ld: error: /home/zqh/workspace/AndeSight_STD_v323/toolchains/nds64le-elf-mculib-v5d/bin/../lib/gcc/riscv64-elf/7.4.0/../../../../riscv64-elf/lib/libc.a<span class="er">(</span><span class="ex">lib_a-memmove.o</span><span class="kw">)</span><span class="bu">:</span><span class="er">(</span><span class="kw">function</span><span class="fu"> memmove</span><span class="kw">)</span><span class="bu">:</span> relocation R_RISCV_JAL out of range: 645718 is not in [-524288, 524287]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="lldb-调试pythonccsharp" class="level1">
<h1>lldb 调试python/c++/csharp</h1>
<ol type="1">
<li>添加各种环境变量.</li>
<li>用lldb启动python <code>❯ lldb-10 /root/miniconda3/envs/ci/bin/python</code></li>
<li>进入后通过run 启动py文件 <code>(lldb) run test_mobilenetv1.py</code></li>
</ol>
</section>
<section id="lldb-调试通过loadelf启动的可执行文件" class="level1">
<h1>lldb 调试通过loadelf启动的可执行文件</h1>
<p>首先是<code>image add</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Add</span> a new module to the current target<span class="st">'s modules.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="st">Syntax: target modules add [&lt;module&gt;]</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="st">Command Options Usage:</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="st">  target modules add [-u &lt;module-uuid&gt;] [-s &lt;filename&gt;] [&lt;path&gt; [&lt;path&gt; [...]]]</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="st">       -s &lt;filename&gt; ( --symfile &lt;filename&gt; )</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="st">            Fullpath to a stand alone debug symbols file for when debug symbols</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="st">            are not in the executable.</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="st">       -u &lt;module-uuid&gt; ( --uuid &lt;module-uuid&gt; )</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="st">            A module UUID value.</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="st">     </span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="st">     This command takes options and free-form arguments.  If your arguments</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="st">     resemble option specifiers (i.e., they start with a - or --), you must use</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="st">     '</span> <span class="at">--</span> <span class="st">' between the end of the command options and the beginning of the</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="st">     arguments.</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="st">'</span>image<span class="st">' is an abbreviation for '</span>target modules<span class="st">'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>和<code>image load</code>命令:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Set</span> the load addresses for one or more sections in a target module.</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Syntax:</span> target modules load [--file <span class="op">&lt;</span>module<span class="op">&gt;</span> --uuid <span class="op">&lt;</span>uuid<span class="op">&gt;</span>] <span class="op">&lt;</span>sect-name<span class="op">&gt;</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> [<span class="op">&lt;</span>sect-name<span class="op">&gt;</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> ....]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Command</span> Options Usage:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">target</span> modules load <span class="pp">[-</span><span class="ss">lp</span><span class="pp">]</span> [-u <span class="op">&lt;</span>module-uuid<span class="op">&gt;</span>] [-f <span class="op">&lt;</span>name<span class="op">&gt;</span>] [-s <span class="op">&lt;</span>offset<span class="op">&gt;</span>] [<span class="op">&lt;</span>filename<span class="op">&gt;</span> [<span class="op">&lt;</span>filename<span class="op">&gt;</span> <span class="pp">[</span><span class="ss">...</span><span class="pp">]</span>]]</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>       <span class="ex">-f</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> <span class="er">(</span> <span class="ex">--file</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> <span class="kw">)</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>            <span class="ex">Fullpath</span> or basename for module to load.</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>       <span class="ex">-l</span> <span class="er">(</span> <span class="ex">--load</span> <span class="kw">)</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            <span class="ex">Write</span> file contents to the memory.</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>       <span class="ex">-p</span> <span class="er">(</span> <span class="ex">--set-pc-to-entry</span> <span class="kw">)</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span class="ex">Set</span> PC to the entry point. Only applicable with <span class="st">'--load'</span> option.</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>       <span class="ex">-s</span> <span class="op">&lt;</span>offset<span class="op">&gt;</span> <span class="er">(</span> <span class="ex">--slide</span> <span class="op">&lt;</span>offset<span class="op">&gt;</span> <span class="kw">)</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>            <span class="ex">Set</span> the load address for all sections to be the virtual address in</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>            <span class="ex">the</span> file plus the offset.</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>       <span class="ex">-u</span> <span class="op">&lt;</span>module-uuid<span class="op">&gt;</span> <span class="er">(</span> <span class="ex">--uuid</span> <span class="op">&lt;</span>module-uuid<span class="op">&gt;</span> <span class="kw">)</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            <span class="ex">A</span> module UUID value.</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>     <span class="ex">This</span> command takes options and free-form arguments.  If your arguments</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>     <span class="ex">resemble</span> option specifiers <span class="er">(</span><span class="ex">i.e.,</span> they start with a <span class="at">-</span> or <span class="at">--</span><span class="kw">)</span><span class="ex">,</span> you must use</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>     <span class="st">' -- '</span> between the end of the command options and the beginning of the</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>     <span class="ex">arguments.</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="st">'image'</span> is an abbreviation for <span class="st">'target modules'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="linux分布式资源分配" class="level1">
<h1>linux分布式资源分配</h1>
<p>参考资料: <a href="https://manuel.bernhardt.io/posts/2023-11-16-core-pinning/">core-pinning</a> <a href="https://www.open-mpi.org/projects/hwloc/">hwloc</a> 这里使用hwloc输出的拓扑图: <img src="cpp-trick/topo.png" class="img-fluid"></p>
<section id="taskset" class="level2">
<h2 class="anchored" data-anchor-id="taskset">taskset</h2>
<p>taskset是用于分配cpu资源, 但是在我这个物理上是128核的机器, 使用taskset是可以设定到0-255核的, 那么说明这个taskset的逻辑和物理的逻辑不一样. 但是taskset和mpi的配合好像不是很好:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> taskset <span class="at">-c</span> 0-9 mpiexec <span class="at">-n</span> 8 <span class="at">--bind-to</span> core  python summa_3d.py</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="ex">6</span> 6</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span> 2</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span> 4</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 0</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="ex">5</span> 5</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span> 1</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="ex">7</span> 7</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> 131</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> taskset <span class="at">-c</span> 0-4 mpiexec <span class="at">-n</span> 8 <span class="at">--bind-to</span> core  python summa_3d.py</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span> 4</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 0</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="ex">5</span> 5</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span> 1</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="ex">7</span> 7</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> 131</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="ex">6</span> 134</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span> 130</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="numactl" class="level2">
<h2 class="anchored" data-anchor-id="numactl">numactl</h2>
<p>numactl 是分配内存资源的, 可以和taskset一起使用, 先使用numactl. 是用前可以通过hardware查看自身机器状态</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> numactl <span class="at">--hardware</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">available:</span> 2 nodes <span class="er">(</span><span class="ex">0-1</span><span class="kw">)</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 0 size: 1019903 MB</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 0 free: 951010 MB</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 1 cpus: 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 1 size: 1032158 MB</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> 1 free: 813857 MB</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> distances:</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span>   0   1 </span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">0:</span>  10  32 </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">1:</span>  32  10 </span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> numactl <span class="at">--cpunodebind</span><span class="op">=</span>0 <span class="at">-l</span> <span class="at">--physcpubind</span><span class="op">=</span>0-64 xxx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="mpi指定拓扑" class="level2">
<h2 class="anchored" data-anchor-id="mpi指定拓扑">mpi指定拓扑</h2>
<p>这里我使用的是mpich的mpiexec, 他提供了<code>--bind-to</code>和<code>--map-by</code>两个参数, 最简单的方式是使用user的方式来设定</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> mpiexec <span class="at">-n</span> 8 <span class="at">--bind-to</span> user:0,1,2,3,3,2,1,0  python summa_3d.py</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">6</span> 1</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="ex">5</span> 2</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span> 1</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span> 2</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span> 3</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="ex">7</span> 0</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 0</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> 3</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="perf常用命令" class="level1">
<h1>perf常用命令</h1>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> perf record <span class="at">-h</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">Usage:</span> perf record [<span class="op">&lt;</span>options<span class="op">&gt;</span>] [<span class="op">&lt;</span>command<span class="op">&gt;</span>]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">or:</span> perf record [<span class="op">&lt;</span>options<span class="op">&gt;</span>] <span class="at">--</span> <span class="op">&lt;</span>command<span class="op">&gt;</span> [<span class="op">&lt;</span>options<span class="op">&gt;</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-a,</span> <span class="at">--all-cpus</span>        system-wide collection from all CPUs</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-b,</span> <span class="at">--branch-any</span>      sample any taken branches</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-B,</span> <span class="at">--no-buildid</span>      do not collect buildids in perf.data</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-c,</span> <span class="at">--count</span> <span class="op">&lt;</span>n<span class="op">&gt;</span>       event period to sample</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-C,</span> <span class="at">--cpu</span> <span class="op">&lt;</span>cpu<span class="op">&gt;</span>       list of cpus to monitor</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-d,</span> <span class="at">--data</span>            Record the sample addresses</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-D,</span> <span class="at">--delay</span> <span class="op">&lt;</span>n<span class="op">&gt;</span>       ms to wait before starting measurement after program start</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-e,</span> <span class="at">--event</span> <span class="op">&lt;</span>event<span class="op">&gt;</span>   event selector. use <span class="st">'perf list'</span> to list available events</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-F,</span> <span class="at">--freq</span> <span class="op">&lt;</span>freq or <span class="st">'max'</span><span class="op">&gt;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">profile</span> at this frequency</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-g</span>                    enables call-graph recording</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-G,</span> <span class="at">--cgroup</span> <span class="op">&lt;</span>name<span class="op">&gt;</span>   monitor event in cgroup name only</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-I,</span> <span class="at">--intr-regs[</span><span class="op">=&lt;</span>any register<span class="op">&gt;</span>]</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">sample</span> selected machine registers on interrupt, use <span class="st">'-I?'</span> to list register names</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-i,</span> <span class="at">--no-inherit</span>      child tasks do not inherit counters</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-j,</span> <span class="at">--branch-filter</span> <span class="op">&lt;</span>branch filter mask<span class="op">&gt;</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">branch</span> stack filter modes</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-k,</span> <span class="at">--clockid</span> <span class="op">&lt;</span>clockid<span class="op">&gt;</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">clockid</span> to use for events, see clock_gettime<span class="er">(</span><span class="kw">)</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-m,</span> <span class="at">--mmap-pages</span> <span class="op">&lt;</span>pages<span class="pp">[</span><span class="ss">,pages</span><span class="pp">]</span><span class="op">&gt;</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">number</span> of mmap data pages and AUX area tracing mmap pages</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-N,</span> <span class="at">--no-buildid-cache</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>                          <span class="cf">do</span> <span class="ex">not</span> update the buildid cache</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-n,</span> <span class="at">--no-samples</span>      don<span class="st">'t sample</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="st">    -o, --output &lt;file&gt;   output file name</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="st">    -P, --period          Record the sample period</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="st">    -p, --pid &lt;pid&gt;       record events on existing process id</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="st">    -q, --quiet           don'</span>t print any message</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-R,</span> <span class="at">--raw-samples</span>     collect raw sample records from all opened counters</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-r,</span> <span class="at">--realtime</span> <span class="op">&lt;</span>n<span class="op">&gt;</span>    collect data with this RT SCHED_FIFO priority</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-S,</span> <span class="at">--snapshot[</span><span class="op">=&lt;</span>opts<span class="op">&gt;</span>]</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">AUX</span> area tracing Snapshot Mode</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-s,</span> <span class="at">--stat</span>            per thread counts</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-t,</span> <span class="at">--tid</span> <span class="op">&lt;</span>tid<span class="op">&gt;</span>       record events on existing thread id</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-T,</span> <span class="at">--timestamp</span>       Record the sample timestamps</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-u,</span> <span class="at">--uid</span> <span class="op">&lt;</span>user<span class="op">&gt;</span>      user to profile</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-v,</span> <span class="at">--verbose</span>         be more verbose <span class="er">(</span><span class="ex">show</span> counter open errors, etc<span class="kw">)</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-W,</span> <span class="at">--weight</span>          sample by weight <span class="er">(</span><span class="ex">on</span> special events only<span class="kw">)</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--affinity</span> <span class="op">&lt;</span>node<span class="kw">|</span><span class="ex">cpu</span><span class="op">&gt;</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">Set</span> affinity mask of trace reading thread to NUMA node cpu mask or cpu of processed mmap buffer</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--aio[=</span><span class="op">&lt;</span>n<span class="op">&gt;</span>]       Use <span class="op">&lt;</span>n<span class="op">&gt;</span> control blocks in asynchronous trace writing mode <span class="er">(</span><span class="ex">default:</span> 1, max: 4<span class="kw">)</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--all-kernel</span>      Configure all used events to run in kernel space.</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--all-user</span>        Configure all used events to run in user space.</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--buildid-all</span>     Record build-id of all DSOs regardless of hits</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--call-graph</span> <span class="op">&lt;</span>record_mode<span class="pp">[</span><span class="ss">,record_size</span><span class="pp">]</span><span class="op">&gt;</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">setup</span> and enables call-graph <span class="er">(</span><span class="ex">stack</span> chain/backtrace<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>                                <span class="ex">record_mode:</span>    call graph recording mode <span class="er">(</span><span class="ex">fp</span><span class="kw">|</span><span class="ex">dwarf</span><span class="kw">|</span><span class="ex">lbr</span><span class="kw">)</span></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>                                <span class="ex">record_size:</span>    if record_mode is <span class="st">'dwarf'</span>, max size of stack recording <span class="er">(</span><span class="op">&lt;</span>bytes<span class="op">&gt;</span><span class="kw">)</span></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>                                                <span class="ex">default:</span> 8192 <span class="er">(</span><span class="ex">bytes</span><span class="kw">)</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>                                <span class="ex">Default:</span> fp</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--clang-opt</span> <span class="op">&lt;</span>clang options<span class="op">&gt;</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">options</span> passed to clang when compiling BPF scriptlets</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--clang-path</span> <span class="op">&lt;</span>clang path<span class="op">&gt;</span></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">clang</span> binary to use for compiling BPF scriptlets</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--dry-run</span>         Parse options then exit</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--exclude-perf</span>    don<span class="st">'t record events from perf itself</span></span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a><span class="st">        --filter &lt;filter&gt;</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a><span class="st">                          event filter</span></span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a><span class="st">        --group           put the counters into a counter group</span></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a><span class="st">        --kernel-callchains</span></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a><span class="st">                          collect kernel callchains</span></span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a><span class="st">        --mmap-flush &lt;number&gt;</span></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a><span class="st">                          Minimal number of bytes that is extracted from mmap data pages (default: 1)</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a><span class="st">        --namespaces      Record namespaces events</span></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a><span class="st">        --no-bpf-event    record bpf events</span></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a><span class="st">        --no-buffering    collect data without buffering</span></span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a><span class="st">        --overwrite       use overwrite mode</span></span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a><span class="st">        --per-thread      use per-thread mmaps</span></span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a><span class="st">        --phys-data       Record the sample physical addresses</span></span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a><span class="st">        --proc-map-timeout &lt;n&gt;</span></span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a><span class="st">                          per thread proc mmap processing timeout in ms</span></span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a><span class="st">        --running-time    Record running/enabled time of read (:S) events</span></span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a><span class="st">        --sample-cpu      Record the sample cpu</span></span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a><span class="st">        --strict-freq     Fail if the specified frequency can'</span>t be used</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--switch-events</span>   Record context switch events</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--switch-max-files</span> <span class="op">&lt;</span>n<span class="op">&gt;</span></span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">Limit</span> number of switch output generated files</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--switch-output[=</span><span class="op">&lt;</span>signal or size<span class="pp">[</span><span class="ss">BKMG</span><span class="pp">]</span> or time<span class="pp">[</span><span class="ss">smhd</span><span class="pp">]</span><span class="op">&gt;</span>]</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">Switch</span> output when receiving SIGUSR2 <span class="er">(</span><span class="ex">signal</span><span class="kw">)</span> <span class="ex">or</span> cross a size or time threshold</span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--tail-synthesize</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">synthesize</span> non-sample events at the end of output</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--timestamp-boundary</span></span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">Record</span> timestamp boundary <span class="er">(</span><span class="bu">time</span> of first/last samples<span class="kw">)</span></span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--timestamp-filename</span></span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">append</span> timestamp to output filename</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--transaction</span>     sample transaction flags <span class="er">(</span><span class="ex">special</span> events only<span class="kw">)</span></span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--user-callchains</span></span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">collect</span> user callchains</span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--user-regs[=</span><span class="op">&lt;</span>any register<span class="op">&gt;</span>]</span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>                          <span class="ex">sample</span> selected machine registers on interrupt, use <span class="st">'--user-regs=?'</span> to list register names</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--vmlinux</span> <span class="op">&lt;</span>file<span class="op">&gt;</span>  vmlinux pathname</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>perf可以通过-e记录一些特定的事件, 比如page-faults, LLC-loads用于记录cache miss</p>
<p>调用flamegraph, 注意record的时候必须要开-g收集调用栈, 并且如果用fp记录栈，还需要在编译的时候开启<code>-fnoomit-frame-pointer</code>. 这个是linux 2.6的使用方式</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/brendangregg/FlameGraph</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">FlameGraph</span><span class="op">=</span><span class="kw">`</span><span class="bu">pwd</span><span class="kw">`</span>/FlameGraph</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="ex">perf</span> record <span class="at">-g</span> your_program</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="ex">perf</span> script <span class="at">-i</span> perf.data <span class="kw">|</span> <span class="va">${FlameGraph}</span><span class="ex">/stackcollapse-perf.pl</span> <span class="kw">|</span> <span class="va">${FlameGraph}</span><span class="ex">/flamegraph.pl</span> <span class="op">&gt;</span> flamegraph.svg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>而linux 4.9以上只需要使用profile.py即可, 不过我在docker里面可能内核版本比较低, 安装bpfcc之后并没有相关的可执行文件, 不过现在是支持从conda安装.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> conda install pdrops::bcc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>但是ebpf在容器中执行需要容器有privilege权限, 否则没法使用.</p>
</section>
<section id="profile-python" class="level1">
<h1>profile python</h1>
<p>可以使用cProfile来profiling整个python脚本</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> cProfile <span class="at">--help</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage:</span> cProfile.py [-o output_file_path] [-s sort] [-m module <span class="kw">|</span> <span class="ex">scriptfile]</span> <span class="pp">[</span><span class="ss">arg</span><span class="pp">]</span> ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>然后使用<code>snakeviz</code>来可视化</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> snakeviz program.prof</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>但是snakeviz目前基本不再维护, mpi的程序可以尝试使用<code>viztracer</code>, 可以通过<code>log_sparse</code>来设定自己感兴趣的区域:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> mpiexec <span class="at">-n</span> 9  viztracer <span class="at">--pid_suffix</span> <span class="at">--log_sparse</span> <span class="at">--output_dir</span> summa_prof summa.py</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> viztracer <span class="at">--combine</span> summa_prof/result_<span class="pp">*</span>.json <span class="at">-o</span> summa_prof/result.json</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> vizviewer summa_prof/result.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/zhen8838\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="zhen8838/zhen8838.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>